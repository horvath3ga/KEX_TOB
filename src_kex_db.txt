===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\mfn_kex_AndFilter.sql =====

CREATE FUNCTION [dbo].[mfn_kex_AndFilter]
(
	@param1 varchar(max) , 
	@param2 varchar(max)  --(N'+cast(5 as varchar)+',N'+cast(15 as varchar)+')
						  --(N5,N15)
)
RETURNS INT
AS
BEGIN
	set @param2 = REPLACE(@param2,')  AND (1 IN ','')
	set @param2 = REPLACE(@param2,')  AND ([idszin] IN ','')
	set @param2 = REPLACE(@param2,')  AND (1 = ','')
	set @param2 = REPLACE(@param2,')  AND ([idszin]=','')
	if @param2=''
		return 1

	set @param2 = dbo.msk_kex_genstatus( REPLACE(@param2,'N','') )				-- (5,15) -> A0B0...E1...O1...Z0
	
	if charindex(@param1,@param2)>0 begin
		return 1
	end
	RETURN 0
END


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_allashirdetesHossz_1.sql =====

-- =============================================
-- Author:		Horváth Gábor
-- Create date: 2019.07.02
-- Description:	Advertlist alkalmzásával állás hírdetés hossz és korrigált hossz számítása
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_allashirdetesHossz](
	@AdvertID int
) RETURNS @res TABLE(
		AdvertID int,
		hossz int,
		korrigalthossz int
) AS
BEGIN
	/*
	(No column name)	AdvertID	Activation_Date	Expiraton_Date
			21579	50635388	2018. 09. 26. 0:00:00	2018. 10. 29. 0:00:00
			22041	50635388	2018. 10. 31. 0:00:00	2018. 11. 30. 0:00:00
			22493	50635388	2019. 01. 04. 0:00:00	2019. 02. 02. 0:00:00
			23159	50635388	2019. 02. 03. 0:00:00	2019. 03. 04. 0:00:00
	*/
	DECLARE @tmp_list TABLE (
		AdvertListID int,
		AdvertID int,
		Activation_Date date,
		Expiraton_Date date
	)
	
	insert into @tmp_list select MAX(AdvertListID), AdvertID, convert(varchar(12), Activation_Date, 120) as d1 ,convert(varchar(12), Expiraton_Date, 120) as d2
	from msk_kex_advertlistchangelog 
	where Advertid=@AdvertID
	group by AdvertID, Title, Activation_Date, Expiraton_Date 
	order by MAX(AdvertListID)

	DECLARE @hossz int = (SELECT TOP 1 DATEDIFF(day,Activation_Date,DATEADD(day,1,Expiraton_Date)) as hossz FROM @tmp_list )

	declare @tmp_dt table (
		dt date
	)

	DECLARE @CurI CURSOR
	DECLARE @AD date
	DECLARE @ED date
	declare @cnt int 
	DECLARE @total int

	SET @CurI = CURSOR FOR select Activation_Date, Expiraton_Date from @tmp_list
	OPEN @CurI FETCH NEXT FROM @CurI INTO @AD,@ED
	WHILE @@FETCH_STATUS = 0
	BEGIN
		set @total = DATEDIFF(day,@AD,@ED)+1
		set @cnt=0
		WHILE @cnt < @total
		BEGIN
		   insert into @tmp_dt select ( DATEADD(day , @cnt, @AD)   )
		   SET @cnt = @cnt + 1;
		END;
		FETCH NEXT FROM @CurI INTO @AD,@ED
	END;
	
	DECLARE @korrigalthossz int = (select case when cn=0 then null else cn end from (select count(*) as cn from (SELECT distinct * from @tmp_dt )t1)t2 )
	
	insert into @res select @AdvertID,@hossz,@korrigalthossz
	
	return	

	/*használata példa:
	select top(10) * from msk_kex_allasajanlatok a cross apply msk_kex_allashirdetesHossz(a.msk_kex_allasajanlatokID) h
		where h.AdvertID=a.msk_kex_allasajanlatokID
		and msk_kex_allasajanlatokID=50635388
	*/
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_felvajanlat.sql =====

CREATE FUNCTION [dbo].[msk_kex_felvajanlat]
(
	@JelentkezokID int
)
RETURNS INT
AS
BEGIN
	-- in (NULL,0,4,5)  
	-- NULL = nincs ajánlat egyáltalán
	-- 0 = üres az elfogadás mezõ (semleges)
	-- 4 = Igen ,azaz elfogadva
	-- 5 = Nem ,azaz nincs elfogadva


	RETURN (SELECT TOP 1 ISNULL(idelfogadva,0) FROM dbo.msk_kex_ajanlat WHERE deleted=0 AND PozicioID is not null AND idjelentkezo=@JelentkezokID ORDER BY datum desc )

END
/*
TEST
DECLARE @aj INT = [dbo].[msk_kex_felvajanlat](@JelentkezokID)
select [dbo].[msk_kex_felvajanlat](567)

Hány olyan van, amikor valakinek nincs IGENleges ajánlat elfogadása:
select isnull(sum(iif([dbo].[msk_kex_felvajanlat](idjelentkezo)<>4,1,0)),0) from msk_kex_ajanlat  where idjelentkezo in (567,456)
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_fn_elem_readonly.sql =====

-- =============================================
-- Author:		<Najdanovszki Krisztián>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_fn_elem_readonly] (@ElemNeve VARCHAR(200), @UserID INT, @AllasID INT)
RETURNS BIT
AS BEGIN
	DECLARE @Result BIT
	
	SET @Result = 'true'
	
	IF @ElemNeve = 'Toborzasi_folyamatgazda'
		BEGIN
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
			BEGIN
				SET @Result = 'false'
			END
		END

	IF @ElemNeve = 'Toborzo'
		BEGIN
		IF @UserID IN (SELECT idtoborzo1 FROM dbo.msk_kex_allasajanlatok WHERE Deleted=0 AND msk_kex_allasajanlatokID=@AllasID)
			OR @UserID IN (SELECT idtoborzo2 FROM dbo.msk_kex_allasajanlatok WHERE Deleted=0 AND msk_kex_allasajanlatokID=@AllasID)
			OR @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
			BEGIN
				SET @Result = 'false'
			END
		END

	IF @ElemNeve = 'Vezeto'
		BEGIN
		IF @UserID IN (SELECT Idvezeto FROM dbo.msk_kex_allasajanlat_vezetok WHERE Deleted=0 AND Idallasajanlat=@AllasID)
			OR @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF' OR
											pp.TechnicalName = 'Group_KEXTOB')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
			BEGIN 
				SET @Result = 'false'
			END
		END

	IF @ElemNeve = 'Statuszolo_vezeto'
		BEGIN
		IF @UserID IN (SELECT Idvezeto FROM dbo.msk_kex_allasajanlat_vezetok WHERE Statuszolovezeto=1 AND Deleted=0 AND Idallasajanlat=@AllasID)
			--OR @UserID IN (SELECT p.PeopleID FROM People p 
			--							LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
			--							LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
			--						WHERE	(pp.TechnicalName = 'Group_ITA' OR
			--								pp.TechnicalName = 'Group_UITA' OR
			--								pp.TechnicalName = 'Group_HOPA' OR
			--								pp.TechnicalName = 'Group_KEXTOBF')
			--								AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
			BEGIN 
				SET @Result = 'false'
			END
		END

	IF @ElemNeve = 'ITadmin'
		BEGIN
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA') 
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
			BEGIN
				SET @Result = 'false'
			END
		END

	RETURN @Result
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_fn_menu_lathatosag.sql =====

-- =============================================
-- Author:		<Najdanovszki Krisztián>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_fn_menu_lathatosag] (@MMName VARCHAR(200), @UserID INT, @AllasID INT)
RETURNS BIT
AS BEGIN
	DECLARE @Result BIT
	
	SET @Result = 'false'
	
	IF @MMName = 'MMMSKKEXKarrierExcel'
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF' OR
											pp.TechnicalName = 'Group_KEXTOB' 
											--OR pp.TechnicalName = 'Group_KEXVEZ'
											)
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
						--OR @UserID IN (SELECT idmunkaltato FROM msk_kex_allasajanlatok where Deleted = 0)
						OR @UserID IN (SELECT idvezeto FROM dbo.msk_kex_allasajanlat_vezetok where Deleted = 0)
				SET @Result = 'true'

	IF @MMName = 'MMMSKTOB'
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF' OR
											pp.TechnicalName = 'Group_KEXTOB' 
											--OR pp.TechnicalName = 'Group_KEXVEZ'
											)
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
						OR @UserID IN (SELECT Idengedelyezo FROM dbo.msk_tob_keresesikerelem where Deleted = 0)
				SET @Result = 'true'

	IF @MMName = 'MMMSKTOBEng'
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' 
											--OR pp.TechnicalName = 'Group_KEXTOBF' 
											--OR pp.TechnicalName = 'Group_KEXTOB' 
											--OR pp.TechnicalName = 'Group_KEXVEZ'
											)
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
						OR @UserID IN (SELECT Idengedelyezo FROM dbo.msk_tob_keresesikerelem where Deleted = 0)
				SET @Result = 'true'

	IF @MMName = 'ScreenMSKKEXKodszotar'
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
				SET @Result = 'true'

	IF @MMName = 'ToborzasiFolyg'
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
				SET @Result = 'true'

	IF @MMName = 'Toborzo' AND @AllasID <> 0
			IF @UserID IN (SELECT idtoborzo1 FROM dbo.msk_kex_allasajanlatok WHERE Deleted=0 AND msk_kex_allasajanlatokID=@AllasID)
			OR @UserID IN (SELECT idtoborzo2 FROM dbo.msk_kex_allasajanlatok WHERE Deleted=0 AND msk_kex_allasajanlatokID=@AllasID)
			OR @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
				SET @Result = 'true'

	IF @MMName = 'Toborzo' AND @AllasID = 0
			IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF' OR
											pp.TechnicalName = 'Group_KEXTOB')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
				SET @Result = 'true'

	IF @MMName = 'Vezeto'
		IF @UserID IN (SELECT idvezeto FROM dbo.msk_kex_allasajanlat_vezetok where Deleted = 0 AND Idallasajanlat=@AllasID)
			OR @UserID IN (SELECT idtoborzo1 FROM dbo.msk_kex_allasajanlatok WHERE Deleted=0 AND msk_kex_allasajanlatokID=@AllasID)
			OR @UserID IN (SELECT idtoborzo2 FROM dbo.msk_kex_allasajanlatok WHERE Deleted=0 AND msk_kex_allasajanlatokID=@AllasID)
			OR @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA' OR
											pp.TechnicalName = 'Group_HOPA' OR
											pp.TechnicalName = 'Group_KEXTOBF')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
				SET @Result = 'true'


	IF @MMName = 'IT_admin'
		IF @UserID IN (SELECT p.PeopleID FROM People p 
										LEFT JOIN PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
										LEFT JOIN People pp ON pgp.GroupID = pp.PeopleID
									WHERE	(pp.TechnicalName = 'Group_ITA' OR
											pp.TechnicalName = 'Group_UITA')
											AND pgp.Deleted = 0 AND pp.Deleted = 0 AND p.Deleted = 0 AND dbo.msk_aktivPeopleID(p.PeopleID)='true')
				SET @Result = 'true'

	RETURN @Result
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_fn_stvezeto_lathatosag.sql =====

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_fn_stvezeto_lathatosag] 
(
@allasajanlatID INT
)
RETURNS BIT
AS
BEGIN
	DECLARE 
	@Result BIT,
	@db int
	
	SET @Result = 'false'

	-- Ha van az állasajanlathoz tartozó vezetõ tábla nem üres IGAZzal tér vissza
	SELECT @db = COUNT(*) FROM [dbo].[msk_kex_allasajanlat_vezetok]
	WHERE Idallasajanlat = @allasajanlatID AND Deleted = 0

	IF @db>0 
	BEGIN
		SET @Result = 'true'
	END

	RETURN @Result

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_genstatus.sql =====

CREATE FUNCTION msk_kex_genstatus(@input VARCHAR(MAX))
RETURNS VARCHAR(100)
AS
BEGIN
    declare @charnum int = 18
    DECLARE @result VARCHAR(100) = REPLICATE('0', @charnum)
    DECLARE @num INT
    DECLARE @xml XML

    -- Remove parentheses and split the string into a table using XML
    SET @input = '<N>' + REPLACE(REPLACE(REPLACE(@input, '(', ''), ')', ''), ',', '</N><N>') + '</N>'
    SET @xml = CAST(@input AS XML)

    -- Update @result for each number
    SELECT @result = STUFF(@result, t.value('.', 'INT'), 1, '1')
    FROM @xml.nodes('/N') AS x(t)
    WHERE t.value('.', 'INT') BETWEEN 1 AND @charnum

    -- Combine letters with numbers
    SELECT @input = (
        SELECT SUBSTRING('ABCDEFGHIJKLMNOPQRSTUVWXYZ', number, 1) + SUBSTRING(@result, number, 1) + ';'
        FROM master.dbo.spt_values
        WHERE type = 'P' AND number BETWEEN 1 AND @charnum
        FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)')

    RETURN @input
END

/*
select dbo.msk_kex_genstatus('5,15)')
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_getFelvstatusz.sql =====


/*
-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2020.10.05
-- Description:	Jelentkezõ aktuális státusza
-- =============================================

Módosítás:
    - 2022.11.18 Tóth László
        - Kód olvashatóság javítás VALUES helyett SELECT
*/
CREATE FUNCTION [dbo].[msk_kex_getFelvstatusz] ( @JelentkezoID INT )
RETURNS @tbl TABLE (
                       [Idjelentkezo] INT
                     , [Idfelvstatusz] INT
                     , [Datum] DATE
                     , [Belepesdatum] DATE
                     , [Idelutasitasindok] INT
                     , [Idvisszalepesindok] INT
                   )
AS
BEGIN
    INSERT INTO @tbl ( [Idjelentkezo], [Idfelvstatusz], [Datum], [Belepesdatum], [Idelutasitasindok]
                     , [Idvisszalepesindok] )
                --VALUES
                --(   @JelentkezoID,         -- Idjelentkezo - int
                --    (SELECT TOP 1 Idfelvstatusz FROM dbo.msk_kex_felvstatusz WHERE Idjelentkezo=@JelentkezoID AND Deleted=0 ORDER BY Datum DESC),       -- Idfelvstatusz - int
                --    (SELECT TOP 1 Datum FROM dbo.msk_kex_felvstatusz WHERE Idjelentkezo=@JelentkezoID AND Deleted=0 ORDER BY Datum DESC),				-- Datum - date
                --    (SELECT TOP 1 Belepesdatum FROM dbo.msk_kex_felvstatusz WHERE Idjelentkezo=@JelentkezoID AND Deleted=0 ORDER BY Datum DESC),		-- Belepesdatum - date
                --    (SELECT TOP 1 Idelutasitasindok FROM dbo.msk_kex_felvstatusz WHERE Idjelentkezo=@JelentkezoID AND Deleted=0 ORDER BY Datum DESC),   -- Idelutasitasindok - int
                --    (SELECT TOP 1 Idvisszalepesindok FROM dbo.msk_kex_felvstatusz WHERE Idjelentkezo=@JelentkezoID AND Deleted=0 ORDER BY Datum DESC)   -- Idvisszalepesindok - int
                --    )
                SELECT TOP ( 1 ) @JelentkezoID
                               , [Idfelvstatusz]
                               , [Datum]
                               , [Belepesdatum]
                               , [Idelutasitasindok]
                               , [Idvisszalepesindok]
                FROM [dbo].[msk_kex_felvstatusz]
                WHERE [Idjelentkezo] = @JelentkezoID AND [Deleted] = 0
                ORDER BY [Datum] DESC

    RETURN
END
GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_getSetup.sql =====

-- =============================================
-- Author:		Horváth Gábor
-- Create date: 2022.04.05
-- Description:	MAP ApplicationSetup
-- =============================================
CREATE  function [dbo].[msk_kex_getSetup] (@Code VARCHAR(1000)
)
RETURNS VARCHAR(1000)
AS BEGIN
	DECLARE @res VARCHAR(1000) = (SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code=CONCAT('KEX_',@Code) AND Deleted=0)	
	RETURN @res
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_get_hash_1.sql =====

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2019.07.04
-- Description:	Hash (varbinary) kódot generál email és cég értékekbõl
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_get_hash] (@Email VARCHAR(255), @CegID INT)
RETURNS VARBINARY(100)
AS
BEGIN
	-- Declare the return variable here
	DECLARE @Hash VARBINARY(100) = HASHBYTES('SHA1', CONCAT(@Email,'|',@CegID))

	-- Return the result of the function
	RETURN @Hash

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_get_MJGYNeve.sql =====

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2021.01.29
-- Description:	Visszaadja az állásajánlathoz beállított MJGYk neveit
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_get_MJGYNeve]
(
	@AllasID INT
)
RETURNS VARCHAR(1000)
AS
BEGIN

	DECLARE @return VARCHAR(1000) 

	;WITH fotevkorvezetok(Name) as
			(SELECT DISTINCT p.Name FROM dbo.msk_kex_allasajanlat_vezetok av LEFT JOIN dbo.People p ON p.PeopleID=av.Idvezeto WHERE av.Deleted=0 AND av.Idallasajanlat=@AllasID AND av.Mjgy=10)
	SELECT @return=STUFF((SELECT ', ' + fotevkorvezetok.Name
	FROM fotevkorvezetok ORDER BY fotevkorvezetok.Name
	FOR XML PATH('')),1,1,'')

	RETURN @return
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_isAnonAjanlo.sql =====

CREATE FUNCTION [dbo].[msk_kex_isAnonAjanlo]
(
	@JelentkezokID int
)
RETURNS bit
AS
BEGIN
	declare @name varchar(10) = (select lower(ajanlo_nev) from msk_kex_jelentkezok where msk_kex_jelentkezokID=@JelentkezokID )
	if @name='xxx' return 1
	RETURN 0
END


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_isAnonJelentkezo.sql =====

CREATE FUNCTION [dbo].[msk_kex_isAnonJelentkezo]
(
	@JelentkezokID int
)
RETURNS bit
AS
BEGIN
	declare @name varchar(10) = (select lower(nev) from msk_kex_jelentkezok where msk_kex_jelentkezokID=@JelentkezokID )
	if @name='xxx' return 1
	RETURN 0
END


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_isMAPErvenyes.sql =====

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2022-10-18
-- Description:	
-- Érvényes ajánlás – rendszer automatikusan elemzi, hogy érvényes-e az ajánlás
--  - Ajánló toborzási szerepkörökkel rendelkezik-e? Ha igen, akkor nem érvényes az ajánlás
--  - Ajánló az adott állásajánlathoz MJGY-ként vagy vezetõként hozzá volt-e rendelve? Ha igen, akkor szintén nem érvényes az ajánlás.
-- =============================================
CREATE FUNCTION [dbo].[msk_kex_isMAPErvenyes] (@PeopleID INT, @AllasID INT)
RETURNS BIT
AS BEGIN
	DECLARE @Result BIT = 1

	IF @PeopleID IS NULL OR @PeopleID = 0
		SET @Result = 0

	IF dbo.msk_useringroups_simple(@PeopleID,'Group_KEXTOB,Group_KEXTOBF,Group_HP,Group_TOBENG')=1
		SET @Result = 0
	
	IF EXISTS(SELECT Idvezeto FROM dbo.msk_kex_allasajanlat_vezetok WHERE Idvezeto=@PeopleID AND Idallasajanlat=@AllasID AND Deleted=0)
		SET @Result = 0

	RETURN @Result
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_jelentkezokfilter.sql =====

-- =============================================
-- Author:		Horváth Gábor
-- Create date: 2023.12.01
-- Description:	Szûrõhöz használandó
-- TILOS BELÕLE TÖRÖLNI!!!!!!!!!!!!!!!!!!!!!!!! (triggrern van rajta fix beírással a kikuldeteésekbe 
-- Hozzáadni lehet!

-- ha modostjuk akkor erdemes lefuttatni az alabbi parancsot, hogy friss legyen mindenhol a rendszerben a STAT mezõ
/*
	UPDATE msk_kex_jelentkezok SET Statuszok=(SELECT 'A'+STUFF((
	SELECT code+ltrim(str(Statusz,10,0))+';' FROM msk_kex_jelentkezokfilter(msk_kex_jelentkezokID) WHERE deleted=0 ORDER BY ID
	FOR XML PATH('')) ,1,1,'') ) where deleted=0
*/
-- KEX Jelentkezõk felületre (...) egy legördülõ szûrõ mezõ kerül kialakításra, ami a jelentkezések alábbi státuszaira szûr mgpedig úgy hogy AND kapcsolat van az elemek között. 

-- A (65) 1	piros	piros	0	0
-- B 2	Ajánlatot elfogadta	kék	0	12
-- C 3	CV alapján megfelelt	narancs	1	2
-- D 4	Interjú alapján megfelelt	barna	0	9
-- E 5	Új jelentkezõ	fehér	0	1
-- F 6	Felvéve	zöld	0	13
-- G 7	Teszten megfelelt	bordó	0	10
-- H 8	Nem felelt meg	szürke	0	14
-- I 10	Orvosin megfelelt	lila	0	11
-- J 11	Elutasítva	szürke	0	15
-- K 12	Visszalépett	szürke	0	16
-- L 13	Toborzó igen	narancs	0	3
-- M 14	Toborzó talán	narancs	0	4
-- N 15	Toborzó nem	narancs	0	5
-- O 16	Vezetõ igen	narancs	0	6
-- P 17	Vezetõ talán	narancs	0	7
-- Q (81) 18	Vezetõ nem	narancs	0	8


-- Az utolsó elem a postdeploymentben vizsgálandó. Ha nincs legalább egy olyan kikuldetés melyben van, 
-- akkor le kellene futtatni a rendszeren a fenti scriptet.(postdeployment aut. futtatja) mivel az azt jelenti, hogy a kód nem friss
-- Utolsó (ennek kell szerepelnie a postdeploymentben) lekérdezhetõ ebbõl a függvénybõl is az alábbi paranccsal:
--    DECLARE @laststatuschar VARCHAR(2) = (SELECT Name FROM dbo.msk_kex_jelentkezokfilter('last'))
--    PRINT @laststatuschar
-- Ez arra jó ha bõvül vagy szûkül a lista, de arra nem, ha csak változnak az elemek, akkor kézzel le kell futtatni, vagy egy kitétel erejéig a LAST szekciót kamu értékre állítani.

-- =============================================
CREATE  FUNCTION [dbo].[msk_kex_jelentkezokfilter]( @JelentkezokID VARCHAR(20)
) RETURNS @original table (ID INT,csoport int,name varchar(100),Deleted tinyint,Statusz varchar(10),code char) 
AS
BEGIN
	SET @JelentkezokID = REPLACE(@JelentkezokID,'1=1 AND ','')

	IF @JelentkezokID = '1=1' return
	if @JelentkezokID = 'last' begin				--- FONTOS egyeztetni a INSERT-ek számával.
		INSERT INTO @original SELECT 1,1,'Q',0,'',''
		return 
	end
	declare @idszin int,@statuszok varchar(100) 
	select top 1 @idszin=idszin,@statuszok=statuszok from msk_kex_jelentkezok where msk_kex_jelentkezokID = @JelentkezokID
	insert into @original 	
		select * from dbo.[msk_kex_jelentkezokfilterdirect]( @idszin, @statuszok)

	RETURN
END

/*
frissités a trigger miatt:
UPDATE msk_kex_jelentkezok SET Statuszok=NULL
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\msk_kex_jelentkezokfilterdirect.sql =====

-- =============================================
-- Author:		Horváth Gábor
-- Create date: 2023.12.01
-- Description:	Szûrõhöz használandó
-- TILOS BELÕLE TÖRÖLNI!!!!!!!!!!!!!!!!!!!!!!!! (triggrern van rajta fix beírással a kikuldeteésekbe 
-- Hozzáadni lehet!

-- ha modostjuk akkor erdemes lefuttatni az alabbi parancsot, hogy friss legyen mindenhol a rendszerben a STAT mezõ
/*
	UPDATE msk_kex_jelentkezok SET Statuszok=(SELECT 'A'+STUFF((
	SELECT code+ltrim(str(Statusz,10,0))+';' FROM msk_kex_jelentkezokfilter(msk_kex_jelentkezokID) WHERE deleted=0 ORDER BY ID
	FOR XML PATH('')) ,1,1,'') ) where deleted=0
*/
-- KEX Jelentkezõk felületre (...) egy legördülõ szûrõ mezõ kerül kialakításra, ami a jelentkezések alábbi státuszaira szûr mgpedig úgy hogy AND kapcsolat van az elemek között. 

-- A (65) 1	piros	piros	0	0
-- B 2	Ajánlatot elfogadta	kék	0	12
-- C 3	CV alapján megfelelt	narancs	1	2
-- D 4	Interjú alapján megfelelt	barna	0	9
-- E 5	Új jelentkezõ	fehér	0	1
-- F 6	Felvéve	zöld	0	13
-- G 7	Teszten megfelelt	bordó	0	10
-- H 8	Nem felelt meg	szürke	0	14
-- I 10	Orvosin megfelelt	lila	0	11
-- J 11	Elutasítva	szürke	0	15
-- K 12	Visszalépett	szürke	0	16
-- L 13	Toborzó igen	narancs	0	3
-- M 14	Toborzó talán	narancs	0	4
-- N 15	Toborzó nem	narancs	0	5
-- O 16	Vezetõ igen	narancs	0	6
-- P 17	Vezetõ talán	narancs	0	7
-- Q (81) 18	Vezetõ nem	narancs	0	8


-- Az utolsó elem a postdeploymentben vizsgálandó. Ha nincs legalább egy olyan kikuldetés melyben van, 
-- akkor le kellene futtatni a rendszeren a fenti scriptet.(postdeployment aut. futtatja) mivel az azt jelenti, hogy a kód nem friss
-- Utolsó (ennek kell szerepelnie a postdeploymentben) lekérdezhetõ ebbõl a függvénybõl is az alábbi paranccsal:
--    DECLARE @laststatuschar VARCHAR(2) = (SELECT Name FROM dbo.msk_kex_jelentkezokfilter('last'))
--    PRINT @laststatuschar
-- Ez arra jó ha bõvül vagy szûkül a lista, de arra nem, ha csak változnak az elemek, akkor kézzel le kell futtatni, vagy egy kitétel erejéig a LAST szekciót kamu értékre állítani.

-- =============================================
CREATE  FUNCTION [dbo].[msk_kex_jelentkezokfilterdirect]( @idszin VARCHAR(20), @Statuszok varchar(100)
) RETURNS @original table (ID INT,csoport int,name varchar(100),Deleted tinyint,Statusz varchar(10),code char) 
AS
BEGIN
	insert into @original 	
		select l.msk_kex_szinid,1,nev,0,isnull(substring(value,2,8),'0'),char(l.ID) 
		from dbo.msk_kex_szin l
		left join STRING_SPLIT(@Statuszok,';') 
			on left(value,1)=char(l.ID) 

	--update @original set Statusz=case when Statusz=1 then 1 else @v end where code=char((select ID from msk_kex_szin where msk_kex_szinID=@idszin))
	update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@idszin))

	RETURN
END

/*
frissités a trigger miatt:
UPDATE msk_kex_jelentkezok SET Statuszok=NULL
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\mft_kex_felvstatusz.sql =====

CREATE FUNCTION [dbo].[mft_kex_felvstatusz]
(
	@InputParam varchar(100)
)
RETURNS @returntable TABLE
(
	LookupListID int,
	LookupValue varchar(20)
)
AS
BEGIN
	
	SET @inputparam = REPLACE(@inputparam,'1=1 AND ','') +'|||' 
	DECLARE @JelentkezokID varchar(100) = LEFT(@InputParam, CHARINDEX('|', @InputParam) - 1)
	SET @inputparam = SUBSTRING(@InputParam, CHARINDEX('|', @InputParam)+1 ,99)
	DECLARE @uj varchar(100) = LEFT(@InputParam, CHARINDEX('|', @InputParam) - 1)
	SET @inputparam = SUBSTRING(@InputParam, CHARINDEX('|', @InputParam)+1 ,99)
	DECLARE @csopi int = isnull(LEFT(@InputParam, CHARINDEX('|', @InputParam) - 1),0)

	IF @JelentkezokID='1=1' return

	IF @uj<>'New' or @csopi=1 begin --87842 miatt csopi mindent visszaad
		INSERT @returntable
		SELECT LookupListID, LookupValue
		FROM msk_kex_LookupList WITH(NOLOCK)
		WHERE GroupNum = '3' --87842 and LookupListID <> case when @csopi=1 then 6 else -1 end
		ORDER BY LookupValue
		return
	END
	ELSE BEGIN
		DECLARE @aj INT = [dbo].[msk_kex_felvajanlat](@JelentkezokID) --(SELECT TOP 1 ISNULL(idelfogadva,0) FROM dbo.msk_kex_ajanlat WHERE deleted=0 AND PozicioID is not null AND idjelentkezo=@JelentkezokID ORDER BY datum desc )
		-- aj in (0,4,5)
		IF @aj IS NULL BEGIN
			INSERT @returntable
			SELECT LookupListID, LookupValue
			FROM msk_kex_LookupList WITH(NOLOCK)
			WHERE GroupNum = '3' AND LookupListID IN (7,8)
			ORDER BY LookupValue
			return
        END
		ELSE begin
			IF @aj = 0 BEGIN
				return
			END
			ELSE BEGIN

				IF @aj = 4 BEGIN -- 4=igen
					INSERT @returntable
					SELECT LookupListID, LookupValue
					FROM msk_kex_LookupList WITH(NOLOCK)
					WHERE GroupNum = '3' AND LookupListID IN (6,7,8) --87842 and LookupListID <> case when @csopi=1 then 6 else -1 end
					ORDER BY LookupValue
					return
				END
				ELSE begin
					IF @aj = 5 BEGIN -- 5nem
						INSERT @returntable
						SELECT LookupListID, LookupValue
						FROM msk_kex_LookupList WITH(NOLOCK)
						WHERE GroupNum = '3' AND LookupListID IN (7,8)
						ORDER BY LookupValue
						return
					END
					ELSE BEGIN
						RETURN
                    end
                end
			END
        end
    end
	RETURN
END

/*
TEST
DECLARE @aj INT = (SELECT TOP 1 ISNULL(idelfogadva,0) FROM dbo.msk_kex_ajanlat WHERE deleted=0 and ORDER BY datum desc )

select * from [dbo].[mft_kex_felvstatusz]('1=1|0')
select * from [dbo].[mft_kex_felvstatusz]('4595|NoAction')
select * from [dbo].[mft_kex_felvstatusz]('4595|New')
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_allasajanlat_lezarasa.sql =====

CREATE PROCEDURE [dbo].[msk_kex_allasajanlat_lezarasa] @ProcessResultSetID INT
AS 
BEGIN
	SET NOCOUNT ON

	DROP TABLE IF EXISTS #allas_lezaras_anonimizalando_Dok
	CREATE TABLE #allas_lezaras_anonimizalando_Dok (docID INT)
	
	DECLARE @tmp_prs TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)
	INSERT INTO @tmp_prs EXECUTE dbo.osp_getPrsDataFromXml_Filters @prsID = @ProcessResultSetID

	DECLARE @tmp_user TABLE(
	UserID INT,UserName VARCHAR(100),Language VARCHAR(100))
	INSERT INTO @tmp_user EXECUTE dbo.osp_getPrsDataFromXml_UserSession @ProcessResultSetID
	DECLARE @UserID INT = (SELECT TOP 1 UserID FROM @tmp_user)
		
	DECLARE @allasID INT = (SELECT TOP 1 ornValue FROM @tmp_prs WHERE ornAlias='msk_kex_allasajanlatokID_ID')
    --84567 DECLARE @idlezarasindok INT        
	--1	Nem volt megfelelõ jelölt	0
	--2	A pozíció visszavonásra került	0
	--3	A pozíció újra meghirdetésre került	0
	--4	A pozíció betöltésre került	0
/*84567
    DECLARE 
        @clickedButton INT

    SELECT TOP 1 @clickedButton = TRY_CAST(ClickedQuestionButton AS INT) FROM ProcessResultSet WHERE ProcessResultSetID = @ProcessResultSetID
	SET @idlezarasindok=@clickedButton

    IF ISNULL(@clickedButton,0) BETWEEN 1 AND 4
	BEGIN
*/
		-- Csak lejárt állásajánlat lezárható
		IF DATEADD(DAY,-1,GETDATE()) > (SELECT datum_lejarat FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@allasID)
		BEGIN

			--Ellenõrzi, hogy az álláshoz tartozó minden jelentkezõnél be van állítva valamilyen státusz
			IF EXISTS(SELECT f.Idfelvstatusz FROM msk_kex_jelentkezok j LEFT JOIN dbo.msk_kex_felvstatusz f ON j.msk_kex_jelentkezokID=f.Idjelentkezo AND f.Deleted=0 WHERE j.idallasajanlat = @allasID AND j.Deleted = 0 AND ISNULL(f.Idfelvstatusz,0) NOT IN (6,7,8))
				BEGIN
					SELECT 'Az állásajánlat nem zárható le, mert egy vagy több jelentkezõ státusza nincs beállítva.'
					INSERT INTO msk_log (name,value,created) VALUES ('PROC:msk_kex_allasajanlat_lezarasa NEM. ID=',@allasID,GETDATE())
				END
			ELSE 
				BEGIN
					--84600 84567:
					IF EXISTS(SELECT p.StatuszID FROM msk_kex_jelentkezok j 
						LEFT JOIN dbo.msk_kex_ajanlat f ON j.msk_kex_jelentkezokID=f.Idjelentkezo AND f.Deleted=0 /*and f.idelfogadva=4*/
						LEFT JOIN dbo.msk_tob_pozicio p ON p.PozicioID=f.PozicioID AND p.Deleted=0 
						WHERE j.idallasajanlat = @allasID AND j.Deleted = 0 AND p.StatuszID=30)
						BEGIN
							SELECT 'Az állásajánlat nem zárható le, mert egy vagy több jelentkezõ Pozíciója között van foglalt.'
							INSERT INTO msk_log (name,value,created) VALUES ('PROC:msk_kex_allasajanlat_lezarasa NEMPOZ. ID=',@allasID,GETDATE())
						END
					ELSE 
						BEGIN
					--84600 84567 END
					



					INSERT INTO msk_log (name,value,created) VALUES ('PROC:msk_kex_allasajanlat_lezarasa IGEN.ID/Indok kód=',CONCAT(@allasID,'-'),GETDATE())
					--Állásajánlat törlése az effectorban
					UPDATE dbo.msk_kex_allasajanlatok SET Deleted=1, datum_lezaras=GETDATE() , idlezarasindok=1 WHERE msk_kex_allasajanlatokID = @allasID;
					/*Annonimizálás*/
					--Document tábla Deleted=9-re állítása
					;WITH Mycte (DokID)
					AS
					(
						(
						SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND cvlinkid IS NOT NULL
						UNION
						SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND JelentkezesiDokID IS NOT NULL
						UNION
						SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND AdatkezelesiDokID IS NOT NULL
						UNION
						SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND MotivaciosDokID IS NOT NULL
						UNION
						SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND MunkavallaloiDokID IS NOT NULL
						)
						EXCEPT
						(
						SELECT cvlinkid FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL
						UNION
						SELECT JelentkezesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL
						UNION
						SELECT AdatkezelesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL
						UNION
						SELECT MotivaciosDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL
						UNION
						SELECT MunkavallaloiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
						UNION
						SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL AND idallasajanlat <> @allasID
						UNION
						SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL AND idallasajanlat <> @allasID
						UNION
						SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL AND idallasajanlat <> @allasID
						UNION
						SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL AND idallasajanlat <> @allasID
						UNION
						SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL AND idallasajanlat <> @allasID
						UNION
						SELECT MunkavallaloiDokID FROM dbo.msk_map_ajanlas WHERE ISNULL(FelveteliStatusz,0) IN (0,1)
						)

					)
					UPDATE dbo.Document SET Deleted=9 
					OUTPUT [Inserted].[DocumentID]
					INTO #allas_lezaras_anonimizalando_Dok
					WHERE EXISTS (SELECT * FROM Mycte WHERE DocumentID=Mycte.DokID)
					
					/*LOG*/
					INSERT INTO [dbo].[msk_log]
					(
						[name],
						[value],
						[created]
					)
					SELECT
					'Állásajánlat lezárás anonimizálás',
					[AD].[docID],
					GETDATE()
					FROM #allas_lezaras_anonimizalando_Dok [AD]

					--Jelentkezõk anonimizálása
					UPDATE msk_kex_jelentkezok SET nev='xxx', email='xxx', telefonszam='xxx', EmailCC='xxx', 
							cvlinkid = NULL, AdatkezelesiDokID = NULL, JelentkezesiDokID = NULL, MunkavallaloiDokID = NULL, MotivaciosDokID = NULL,
							cvlink='xxx', cvtartalom='xxx', ajanlo_nev='xxx', Deleted=1
							WHERE idallasajanlat = @allasID
					UPDATE dbo.msk_kex_jelentkezok SET HASHID=iif((select top 1 hashid from dbo.msk_kex_gdpr_jelentkezok g where g.hashid=hashid ) is null,NULL,HASHID) WHERE idallasajanlat = @allasID
					
					--Emailek anonimizálása
					UPDATE dbo.msk_MailSend_Log SET Recipients='xxx', CopyRecipients='xxx', BlindCopyRecipients='xxx' 
					WHERE SentToJelentkezoID IN (SELECT msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat=@allasID) AND SentToJelentkezoTablaID=1

					--TOB álláshirdetés lezárása
					UPDATE dbo.msk_tob_allashirdetesek SET StatuszID=24 WHERE Msk_tob_allashirdetesekID=@allasID

					declare @kkID int = (select Idkeresesikerelem from msk_tob_allashirdetesek where Msk_tob_allashirdetesekID=@allasID) 
					--84600 84567:
					exec dbo.[msk_tob_keresesikerelem_masolas_betoltetlen] @kkID,@UserID
					update msk_tob_keresesikerelem set Lezaras = 1 where Msk_tob_keresesikerelemID = @kkID --#86289
					--84600 84567 END:					 


					--MAP jelölt anonimizálás
					UPDATE dbo.msk_map_ajanlas SET JeloltNev='xxx', JeloltPERNR=NULL, MunkavallaloiDokID = NULL, Vegdatum=dbo.msk_map_getma()
					FROM dbo.msk_kex_jelentkezok j 
					WHERE (SELECT Idfelvstatusz FROM dbo.msk_kex_getFelvstatusz(msk_map_ajanlas.Msk_kex_jelentkezokID))<>6 AND idallasajanlat=@allasID 
											AND j.msk_kex_jelentkezokID=msk_map_ajanlas.Msk_kex_jelentkezokID

					SELECT ''

					END

				END
		END
		ELSE SELECT 'Csak lejárt állásajánlatot lehet lezárni.'
	--END
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_anonimizalas.sql =====

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2021-09-01
-- Description:	Manuális anonimizálás, paraméterben a jelentkezõ Msk_kex_jelentkezokID-t kell megadni.
-- =============================================
CREATE PROCEDURE [dbo].[msk_kex_anonimizalas] @JelentkezoID INT	
AS 
BEGIN
	SET NOCOUNT ON
	
	DROP TABLE IF EXISTS #uzem_anonimizalando_Dok
	CREATE TABLE #uzem_anonimizalando_Dok (docID INT)

declare @Jelentkezok TABLE (
	ID int 
)

insert into @Jelentkezok (ID)   
select msk_kex_hashid FROM msk_kex_hash WHERE hash=
(SELECT Hash FROM dbo.msk_kex_hash WHERE msk_kex_hashid= (SELECT hashid FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID)
)


;WITH Mycte (DocID) AS
		(
			SELECT cvlinkid AS dok FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT JelentkezesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT AdatkezelesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT MotivaciosDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE HashID in (select id from @Jelentkezok) 
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE HashID in (select id from @Jelentkezok)
			UNION
			SELECT a.MunkavallaloiDokID FROM dbo.msk_map_ajanlas a 
				INNER JOIN dbo.msk_kex_jelentkezok j ON j.msk_kex_jelentkezokID = a.Msk_kex_jelentkezokID
				WHERE j.HashID in (select id from @Jelentkezok) AND ISNULL(a.FelveteliStatusz,0) IN (0,1)
		)
	UPDATE dbo.Document SET Deleted=9 
	OUTPUT [Inserted].[DocumentID]
	INTO #uzem_anonimizalando_Dok
	WHERE EXISTS (SELECT * FROM Mycte WHERE DocumentID=DocID)

	/*LOG*/
	INSERT INTO [dbo].[msk_log]
	(
		[name],
		[value],
		[created]
	)
	SELECT
	'Üzemeltetés anonimizálás',
	[AD].[docID],
	GETDATE()
	FROM #uzem_anonimizalando_Dok [AD]

UPDATE dbo.msk_kex_jelentkezok SET nev='xxx', email='xxx', telefonszam='xxx', EmailCC='xxx', 
						cvlinkid = NULL, AdatkezelesiDokID = NULL, JelentkezesiDokID = NULL, MunkavallaloiDokID = NULL, MotivaciosDokID = NULL,
						cvlink='xxx', cvtartalom='xxx', ajanlo_nev='xxx', Deleted=1,HASHID=NULL
WHERE HashID in (select id from @Jelentkezok) 

INSERT INTO dbo.msk_kex_felvstatusz
( Idjelentkezo,Idfelvstatusz,Datum,Belepesdatum,Idelutasitasindok,Idvisszalepesindok,Deleted,PERNR,PeopleID,VallalatonBeluli)
SELECT
    msk_kex_jelentkezokID, -- Idjelentkezo - int
    8, -- Idfelvstatusz - int
    GETDATE(), -- Datum - date
    NULL, -- Belepesdatum - date
    NULL, -- Idelutasitasindok - int
    4, -- Idvisszalepesindok - int
    0, -- Deleted - tinyint
    NULL, -- PERNR - varchar(10)
    NULL, -- PeopleID - int
    NULL  -- VallalatonBeluli - bit
FROM dbo.msk_kex_jelentkezok
WHERE HashID in (select id from @Jelentkezok)

update Msk_kex_hash set Deleted=1 where Msk_kex_hashID in (select id from @Jelentkezok)    
UPDATE dbo.msk_kex_gdpr_jelentkezok SET Idanonindok=1, nev='xxx', email='xxx', telefonszam='xxx', EmailCC='xxx', 
						cvlinkid = NULL, AdatkezelesiDokID = NULL, JelentkezesiDokID = NULL, MunkavallaloiDokID = NULL, MotivaciosDokID = NULL,
						cvlink='xxx', cvtartalom='xxx', ajanlo_nev='xxx', Deleted=1, HASHID=NULL
WHERE HashID in (select id from @Jelentkezok) 

--MAP jelölt anonimizálás
UPDATE a
SET a.JeloltNev='xxx', a.JeloltPERNR=NULL, a.MunkavallaloiDokID = NULL, a.Vegdatum=dbo.msk_map_getma(), a.FelveteliStatusz=2
FROM dbo.msk_map_ajanlas a 
INNER JOIN dbo.msk_kex_jelentkezok j ON j.msk_kex_jelentkezokID = a.Msk_kex_jelentkezokID
WHERE j.HashID in (select id from @Jelentkezok)

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_email_alairas_generalas.sql =====

CREATE PROCEDURE [dbo].[msk_kex_email_alairas_generalas]
AS
BEGIN
    SET NOCOUNT ON;

    -- Töröljük a korábbi aláírásokat.
    TRUNCATE TABLE dbo.msk_kex_emailalairas;

    /*
      A régi verzióban kurzorral, soronként dolgoztuk fel a People rekordokat,
      majd minden sor esetében lekértük az egyéb adatokat és végül az aláírást
      sablon alapján készítettük el. Az alábbi verzióban mindezt set–alapúan,
      egyetlen lekérdezéssel tesszük meg, ami jelentõsen gyorsabb.
    */
    INSERT INTO dbo.msk_kex_emailalairas (PeopleID, Alairas, Deleted)
    SELECT 
         t.PeopleID,
         -- Az email aláírás HTML sablonjának összeállítása (a REPLACE láncot string konkatenáció váltja fel)
         '<p><strong>' + ISNULL(t.Nev, '') + '</strong><br />' + ISNULL(t.Munkakor, '') + '</p>' +
         '<p>' + ISNULL(comp.Logolink1, '') + ISNULL(comp.Logolink2, '') + '</p>' +
         '<p>' + ISNULL(c.Name, '') + '<br />' + ISNULL(t.Szervezet, '') + '</p>' +
         '<p>' + ISNULL(t.Cim, '') + '<br />Mobil: ' + ISNULL(t.Mobile, '') + 
         '<br />Email: <a href="' + ISNULL(t.Email, '') + '">' + ISNULL(t.Email, '') + '</a>' +
         '<br />Honlap: <a href="http://www.mavcsoport.hu/">www.mavcsoport.hu</a></p>' AS Alairas,
         0 AS Deleted
    FROM (
        -- A People, PeopleGroupsPeople és People (csoport) táblákból beszerezzük a szükséges adatokat.
        SELECT DISTINCT
            p.PeopleID,
            p.Name AS Nev,
            UPPER(LEFT(p.STLTX, 1)) + LOWER(SUBSTRING(p.STLTX, 2, LEN(p.STLTX))) AS Munkakor,
            UPPER(LEFT(p.ORGTX, 1)) + LOWER(SUBSTRING(p.ORGTX, 2, LEN(p.ORGTX))) AS Szervezet,
            p.MHELY AS Cim,
            p.Mobile,
            p.Email,
            p.BUKRS  -- Ez a cég azonosító, mely alapján késõbb a cég adatait csatoljuk.
        FROM dbo.People p
        INNER JOIN dbo.PeopleGroupsPeople pgp ON p.PeopleID = pgp.PeopleID
        INNER JOIN dbo.People pp ON pgp.GroupID = pp.PeopleID
        WHERE p.Deleted = 0
          AND pgp.Deleted = 0
          AND pp.IsGroup = 1
          AND dbo.msk_aktivPeopleID(p.PeopleID) = 'true'
    ) t
    LEFT JOIN dbo.orn_SZI_Company c ON c.VallalatKod = t.BUKRS AND c.Deleted = 0
    LEFT JOIN dbo.msk_Company comp ON comp.BUKRS = t.BUKRS;
END


/* TESZT

exec msk_kex_email_alairas_generalas
select * from msk_kex_emailalairas

*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_email_kuldes.sql =====

CREATE PROCEDURE [dbo].[msk_kex_email_kuldes] @ID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	DECLARE @prs_table TABLE (
		rawDataID int,
		prsID int,
		DataType varchar(16), 
		xID int,
		xParentID int,
		localName varchar(512), 
		prev int,
		value varchar(max)
	)

	INSERT INTO @prs_table exec osp_getPrsDataFromXml_All @ID

	DECLARE @tmp_Cimzettek_tbl TABLE (
		ornAlias varchar(8000),
		ornType varchar(8000),
		ornValue varchar(8000),
		InOut varchar(8000)
	)
	INSERT INTO @tmp_Cimzettek_tbl exec osp_getPrsDataFromXml_Filters @prsID=@ID

	DECLARE @MailSendLogID INT
		SET @MailSendLogID = (SELECT top 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='MailSendLogID_ID' AND InOut='out')

	DECLARE	@tmp_Cimzett VARCHAR(260) 
		SET @tmp_Cimzett = (SELECT top 1 value FROM @prs_table WHERE localName='Recipients')
	DECLARE	@tmp_Masolat VARCHAR(260) 
		SET @tmp_Masolat = (SELECT top 1 value FROM @prs_table WHERE localName='CopyRecipients')
		IF @tmp_Masolat = 'null' SET @tmp_Masolat = ''
	DECLARE @tmp_Targy  VARCHAR(8000) 
		SET @tmp_Targy = (SELECT top 1 value FROM @prs_table WHERE localName='Subject')
	DECLARE @tmp_Szoveg  VARCHAR(MAX) 
		SET @tmp_Szoveg = (SELECT top 1 value FROM @prs_table WHERE localName='Body')
	DECLARE @TemplateID INT
		SET @TemplateID = (SELECT top 1 value FROM @prs_table WHERE localName='EmailTemplateID')
	DECLARE @LetrehozoID INT
		SET @LetrehozoID = (SELECT top 1 value FROM @prs_table WHERE localName='UserID')
	DECLARE @SentToJelentkezoID INT = (SELECT top 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_jelentkezokID_ID' AND InOut='in')
	DECLARE @SentToJelentkezoTablaID INT = IIF(EXISTS (SELECT top 1 value FROM @prs_table WHERE localName='SentToJelentkezoTablaID'),(SELECT top 1 value FROM @prs_table WHERE localName='SentToJelentkezoTablaID'),(SELECT top 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='SentToJelentkezoTablaID_ID'))
		
	DECLARE @AllasID INT = (SELECT TOP 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_allasajanlatokID_ID' AND InOut='in')
	DECLARE @AllasName VARCHAR(255) = (SELECT targy FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)

	DECLARE @SzolgHelyek VARCHAR(255) = (SELECT hely FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)

	DECLARE @Cimzett_neve VARCHAR(200)
	DECLARE @Kuldo_neve VARCHAR(200)
	DECLARE @Kuldo_alairas VARCHAR(MAX)

	IF @SentToJelentkezoTablaID = 1
	 BEGIN
		SET @SentToJelentkezoID = (SELECT ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_jelentkezokID_ID' AND InOut = 'in')
	 END

	IF @SentToJelentkezoTablaID = 2
	 BEGIN
		SET @SentToJelentkezoID = (SELECT ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_gdpr_jelentkezokID_ID' AND InOut = 'in')
	 END
	

	SET @Cimzett_neve = (SELECT TOP 1 nev
							FROM dbo.msk_kex_jelentkezok
							WHERE msk_kex_jelentkezokID=@SentToJelentkezoID)
	SET @Kuldo_neve = (SELECT TOP 1 Name
							FROM dbo.People
							WHERE PeopleID=@LetrehozoID)
	SET @Kuldo_alairas = (SELECT TOP 1 Alairas
							FROM dbo.msk_kex_emailalairas
							WHERE PeopleID=@LetrehozoID AND Deleted=0)

	SET @tmp_Targy = REPLACE(@tmp_Targy, '%allas_neve%', ISNULL(@AllasName, ''))

	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%cimzett%', ISNULL(@Cimzett_neve, 'Címzett'))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%kuldo%', ISNULL(@Kuldo_neve, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%kuldo_alairas%', ISNULL(@Kuldo_alairas, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%allas_neve%', ISNULL(@AllasName, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%szolg_helyek%', ISNULL(@SzolgHelyek, ''))

	UPDATE dbo.msk_MailSend_Log SET 
			       [Modul] = 'KEX'
				  ,[Recipients] = @tmp_Cimzett
				  ,[CopyRecipients] = @tmp_Masolat
				  ,[BlindCopyRecipients] = NULL
				  ,[Subject] = @tmp_Targy
				  ,[Body] = @tmp_Szoveg
				  ,[BodyFormat] = 'HTML'
				  ,[Importance] = 'Normal'
				  ,[FileAttachments] = NULL
				  ,[MailItemID] = 0
				  ,[Created] = GETDATE()
				  ,[Success] = 0
				  ,[Deleted] = 0
				  ,[EmailTemplateID] = @TemplateID
				  ,[CreatedBy] = @LetrehozoID
				  ,[SentToJelentkezoID] = @SentToJelentkezoID
				  ,[SentToJelentkezoTablaID] = @SentToJelentkezoTablaID
				  WHERE MailSendLogID = @MailSendLogID

	EXEC [dbo].[msk_SendMail_dll] 	
			@Modul = 'KEX',
			@Recipients = @tmp_Cimzett,
			@CopyRecipients  = @tmp_Masolat,
			@BlindCopyRecipients = NULL,
			@Subject = @tmp_Targy,
			@Body = @tmp_Szoveg,
			@BodyFormat = 'HTML',
			@Importance = 'Normal',
			@FileAttachments = NULL,
			@EmailTemplateID = @TemplateID,
			@CreatedBy = @LetrehozoID,
			@CimzettID = @SentToJelentkezoID,
			@CimzettTablaID = @SentToJelentkezoTablaID,
	        @MailSendLogID = @MailSendLogID


	IF @tmp_Masolat IS NOT NULL
		        UPDATE msk_kex_jelentkezok SET EmailCC = @tmp_Masolat
                WHERE msk_kex_jelentkezokID = @SentToJelentkezoID;
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_email_kuldes_csoportos_1.sql =====


CREATE PROCEDURE [dbo].[msk_kex_email_kuldes_csoportos] @ID INTEGER	
AS 
BEGIN
	SET NOCOUNT ON
	

	/* Email és küldõ adatok lekérdezése */
	DECLARE @prs_table TABLE (
		rawDataID INT,
		prsID INT,
		DataType VARCHAR(16), 
		xID INT,
		xParentID INT,
		localName VARCHAR(512), 
		prev INT,
		value VARCHAR(MAX)
	)

	INSERT INTO @prs_table EXEC osp_getPrsDataFromXml_All @ID

	/* cimzett és másolatot kap személyek lekérdezése */
	DECLARE @tmp_Cimzettek_tbl TABLE (
		ornAlias VARCHAR(8000),
		ornType VARCHAR(8000),
		ornValue VARCHAR(8000),
		InOut VARCHAR(8000)
	)
	INSERT INTO @tmp_Cimzettek_tbl EXEC osp_getPrsDataFromXml_Filters @prsID=@ID

	DECLARE @Cimzett TABLE(
		CimzettID INT
	)

	DECLARE	@EredetiSendMailID INT
		SET @EredetiSendMailID = (SELECT TOP 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='MailSendLogID_ID' AND InOut='out')
	DECLARE @EredetiDocID_table TABLE
		(DocID INT)
		INSERT INTO @EredetiDocID_table SELECT DocumentID FROM dbo.msk_email_melleklet WHERE SendMailLogID=@EredetiSendMailID
	DECLARE @tmp_Targy  VARCHAR(8000) 
		SET @tmp_Targy = (SELECT TOP 1 value FROM @prs_table WHERE localName='Subject')
	DECLARE @tmp_Szoveg_eredeti  VARCHAR(MAX) 
		SET @tmp_Szoveg_eredeti = (SELECT TOP 1 value FROM @prs_table WHERE localName='Body')
	DECLARE @TemplateID INT
		SET @TemplateID = (SELECT TOP 1 value FROM @prs_table WHERE localName='EmailTemplateID')
	DECLARE @LetrehozoID INT
		SET @LetrehozoID = (SELECT TOP 1 value FROM @prs_table WHERE localName='UserID')
	DECLARE @SentToJelentkezoID INT = (SELECT TOP 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_jelentkezokID_ID' AND InOut='in')
	DECLARE @SentToJelentkezoTablaID INT = IIF(EXISTS (SELECT TOP 1 value FROM @prs_table WHERE localName='SentToJelentkezoTablaID'),(SELECT TOP 1 value FROM @prs_table WHERE localName='SentToJelentkezoTablaID'),(SELECT TOP 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='SentToJelentkezoTablaID_ID'))

	DECLARE @AllasID INT = (SELECT TOP 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_allasajanlatokID_ID' AND InOut='in')
	DECLARE @AllasName VARCHAR(255) = (SELECT targy FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)
    
	DECLARE @SzolgHelyek VARCHAR(255) = (SELECT hely FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)

	DECLARE @Cimzett_neve VARCHAR(200)
	DECLARE @Kuldo_neve VARCHAR(200)
	DECLARE @Kuldo_alairas VARCHAR(MAX)

	SET @Kuldo_neve = (SELECT TOP 1 Name
							FROM dbo.People
							WHERE PeopleID=@LetrehozoID AND Deleted=0)
	SET @Kuldo_alairas = (SELECT TOP 1 Alairas
							FROM dbo.msk_kex_emailalairas
							WHERE PeopleID=@LetrehozoID AND Deleted=0)

	IF @SentToJelentkezoTablaID = 1
	 BEGIN
		INSERT INTO @Cimzett SELECT ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_jelentkezokID_ID' AND InOut = 'out'
	 END

	IF @SentToJelentkezoTablaID = 2
	 BEGIN
		INSERT INTO @Cimzett SELECT ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_gdpr_jelentkezokID_ID' AND InOut = 'out'
	 END

	SET @tmp_Targy = REPLACE(@tmp_Targy, '%allas_neve%', ISNULL(@AllasName, ''))

	SET @tmp_Szoveg_eredeti = REPLACE(@tmp_Szoveg_eredeti, '%kuldo%', ISNULL(@Kuldo_neve, ''))
	SET @tmp_Szoveg_eredeti = REPLACE(@tmp_Szoveg_eredeti, '%kuldo_alairas%', ISNULL(@Kuldo_alairas, ''))
	SET @tmp_Szoveg_eredeti = REPLACE(@tmp_Szoveg_eredeti, '%allas_neve%', ISNULL(@AllasName, ''))
	SET @tmp_Szoveg_eredeti = REPLACE(@tmp_Szoveg_eredeti, '%szolg_helyek%', ISNULL(@SzolgHelyek, ''))

	DECLARE @tmp_Szoveg_egyeni VARCHAR(MAX)

	DECLARE @MyCursor CURSOR;
	DECLARE @CimzettID INT;
	DECLARE @CopyCimzett_email VARCHAR(260);
	DECLARE @Cimzett_email varchar(260)
		BEGIN
			SET @MyCursor = CURSOR FOR
			select CimzettID from @Cimzett

				OPEN @MyCursor 
				FETCH NEXT FROM @MyCursor 
				INTO @CimzettID

				WHILE @@FETCH_STATUS = 0
				BEGIN

					BEGIN
						IF @SentToJelentkezoTablaID = 1
						 BEGIN
						 	SET @Cimzett_email = (SELECT email
								FROM dbo.msk_kex_jelentkezok
								WHERE msk_kex_jelentkezokID=@CimzettID)
							SET @CopyCimzett_email = (SELECT EmailCC
								FROM dbo.msk_kex_jelentkezok
								WHERE msk_kex_jelentkezokID=@CimzettID)
							SET @Cimzett_neve = (SELECT TOP 1 nev
								FROM dbo.msk_kex_jelentkezok
								WHERE msk_kex_jelentkezokID=@CimzettID)
						 END

						IF @SentToJelentkezoTablaID = 2
						 BEGIN
						 	SET @Cimzett_email = (SELECT TOP 1 email  
								FROM dbo.msk_kex_gdpr_jelentkezok
								WHERE msk_kex_gdpr_jelentkezokID=@CimzettID)
							SET @CopyCimzett_email = (SELECT TOP 1 EmailCC  
								FROM dbo.msk_kex_gdpr_jelentkezok
								WHERE msk_kex_gdpr_jelentkezokID=@CimzettID)
							SET @Cimzett_neve = (SELECT TOP 1 nev
								FROM dbo.msk_kex_gdpr_jelentkezok
								WHERE msk_kex_gdpr_jelentkezokID=@CimzettID)
						 END					

						IF @CopyCimzett_email = 'null' SET @CopyCimzett_email = ''

						SET @tmp_Szoveg_egyeni = REPLACE(@tmp_Szoveg_eredeti, '%cimzett%', ISNULL(@Cimzett_neve, 'Címzett'))

					IF @Cimzett_email IS NULL OR @Cimzett_email = ''
					BEGIN
						--nem csinál semmit, de kell hogy szerepeljen egy parancs az ELSE ág elõtt
						SET @Cimzett_email = ''
					END
					ELSE
					BEGIN						
						INSERT INTO dbo.msk_MailSend_Log
						(
						    Modul,
						    Recipients,
						    CopyRecipients,
						    BlindCopyRecipients,
						    Subject,
						    Body,
						    BodyFormat,
						    Importance,
						    FileAttachments,
						    MailItemID,
						    Created,
						    Success,
						    Deleted,
						    EmailTemplateID,
						    CreatedBy,
						    SentToJelentkezoID,
						    SentToJelentkezoTablaID
						)
						VALUES
						(   'KEX',        -- Modul - varchar(50)
						    @Cimzett_email,        -- Recipients - varchar(260)
						    @CopyCimzett_email,        -- CopyRecipients - varchar(8000)
						    NULL,        -- BlindCopyRecipients - varchar(8000)
						    @tmp_Targy,        -- Subject - varchar(200)
						    @tmp_Szoveg_egyeni,        -- Body - varchar(max)
						    'HTML',        -- BodyFormat - varchar(20)
						    'Normal',        -- Importance - varchar(100)
						    NULL,        -- FileAttachments - varchar(8000)
						    0,         -- MailItemID - int
						    GETDATE(), -- Created - datetime
						    0,      -- Success - bit
						    0,         -- Deleted - tinyint
						    @TemplateID,         -- EmailTemplateID - int
						    @LetrehozoID,         -- CreatedBy - int
						    @CimzettID,         -- SentToJelentkezoID - int
						    @SentToJelentkezoTablaID          -- SentToJelentkezoTablaID - tinyint
						    )

							DECLARE @UjSendMailLogID INT = SCOPE_IDENTITY()

							UPDATE dbo.msk_MailSend_Log SET MailItemID=@UjSendMailLogID
							WHERE MailSendLogID=@UjSendMailLogID

							INSERT INTO dbo.msk_email_melleklet SELECT DocID, @UjSendMailLogID, 0 FROM @EredetiDocID_table

							EXEC [dbo].[msk_SendMail_dll] 	
								@Modul = 'KEX',
								@Recipients = @Cimzett_email,
								@CopyRecipients  = @CopyCimzett_email,
								@BlindCopyRecipients = NULL,
								@Subject = @tmp_Targy,
								@Body = @tmp_Szoveg_egyeni,
								@BodyFormat = 'HTML',
								@Importance = 'Normal',
								@FileAttachments = NULL,
								@EmailTemplateID = @TemplateID,
								@CreatedBy = @LetrehozoID,
								@CimzettID = @CimzettID,
								@CimzettTablaID = @SentToJelentkezoTablaID,
								@MailSendLogID = @UjSendMailLogID
						END
					END
				  FETCH NEXT FROM @MyCursor
				  INTO @CimzettID 
				END; 

				CLOSE @MyCursor;
				DEALLOCATE @MyCursor;
			END;
	DELETE FROM dbo.msk_MailSend_Log WHERE MailSendLogID=@EredetiSendMailID
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_email_ujrakuldes.sql =====


CREATE PROCEDURE [dbo].[msk_kex_email_ujrakuldes] @ID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	DECLARE @prs_table TABLE (
		rawDataID int,
		prsID int,
		DataType varchar(16), 
		xID int,
		xParentID int,
		localName varchar(512), 
		prev int,
		value varchar(max)
	)

	INSERT INTO @prs_table exec osp_getPrsDataFromXml_All @ID

	DECLARE @tmp_Cimzettek_tbl TABLE (
		ornAlias varchar(8000),
		ornType varchar(8000),
		ornValue varchar(8000),
		InOut varchar(8000)
	)
	INSERT INTO @tmp_Cimzettek_tbl exec osp_getPrsDataFromXml_Filters @prsID=@ID

	--DECLARE @MailSendLogID INT
	--	SET @MailSendLogID = (SELECT top 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='MailSendLogID_ID' AND InOut='out')

	DECLARE	@tmp_Cimzett VARCHAR(260) 
		SET @tmp_Cimzett = (SELECT top 1 value FROM @prs_table WHERE localName='Recipients')
	DECLARE	@tmp_Masolat VARCHAR(260) 
		SET @tmp_Masolat = (SELECT top 1 value FROM @prs_table WHERE localName='CopyRecipients')
		IF @tmp_Masolat = 'null' SET @tmp_Masolat = ''
	DECLARE @tmp_Targy  VARCHAR(8000) 
		SET @tmp_Targy = (SELECT top 1 value FROM @prs_table WHERE localName='Subject')
	DECLARE @tmp_Szoveg  VARCHAR(MAX) 
		SET @tmp_Szoveg = (SELECT top 1 value FROM @prs_table WHERE localName='Body')
	DECLARE @TemplateID INT
		SET @TemplateID = (SELECT top 1 value FROM @prs_table WHERE localName='EmailTemplateID')
	DECLARE @LetrehozoID INT
		SET @LetrehozoID = (SELECT top 1 value FROM @prs_table WHERE localName='UserID')
	DECLARE @SentToJelentkezoID INT = (SELECT top 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_jelentkezokID_ID' AND InOut='in')
	DECLARE @SentToJelentkezoTablaID INT = IIF(EXISTS (SELECT top 1 value FROM @prs_table WHERE localName='SentToJelentkezoTablaID'),(SELECT top 1 value FROM @prs_table WHERE localName='SentToJelentkezoTablaID'),(SELECT top 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='SentToJelentkezoTablaID_ID'))

	DECLARE @AllasID INT = (SELECT TOP 1 ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_allasajanlatokID_ID' AND InOut='in')
	DECLARE @AllasName VARCHAR(255) = (SELECT targy FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)
	
	DECLARE @SzolgHelyek VARCHAR(255) = (SELECT hely FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)

	DECLARE @Cimzett_neve VARCHAR(200)
	DECLARE @Kuldo_neve VARCHAR(200)
	DECLARE @Kuldo_alairas VARCHAR(MAX)

	IF @SentToJelentkezoTablaID = 1
	 BEGIN
		SET @SentToJelentkezoID = (SELECT ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_jelentkezokID_ID' AND InOut = 'in')
	 END

	IF @SentToJelentkezoTablaID = 2
	 BEGIN
		SET @SentToJelentkezoID = (SELECT ornValue FROM @tmp_Cimzettek_tbl WHERE ornAlias='msk_kex_gdpr_jelentkezokID_ID' AND InOut = 'in')
	 END
	

	SET @Cimzett_neve = (SELECT TOP 1 nev
							FROM dbo.msk_kex_jelentkezok
							WHERE msk_kex_jelentkezokID=@SentToJelentkezoID)
	SET @Kuldo_neve = (SELECT TOP 1 Name
							FROM dbo.People
							WHERE PeopleID=@LetrehozoID)
	SET @Kuldo_alairas = (SELECT TOP 1 Alairas
							FROM dbo.msk_kex_emailalairas
							WHERE PeopleID=@LetrehozoID AND Deleted=0)

	SET @tmp_Targy = REPLACE(@tmp_Targy, '%allas_neve%', ISNULL(@AllasName, ''))

	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%cimzett%', ISNULL(@Cimzett_neve, 'Címzett'))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%kuldo%', ISNULL(@Kuldo_neve, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%kuldo_alairas%', ISNULL(@Kuldo_alairas, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%allas_neve%', ISNULL(@AllasName, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%szolg_helyek%', ISNULL(@SzolgHelyek, ''))

	INSERT INTO dbo.msk_MailSend_Log
	(
	    Modul,
	    Recipients,
	    CopyRecipients,
	    BlindCopyRecipients,
	    Subject,
	    Body,
	    BodyFormat,
	    Importance,
	    FileAttachments,
	    MailItemID,
	    Created,
	    Success,
	    Deleted,
	    EmailTemplateID,
	    CreatedBy,
	    SentToJelentkezoID,
	    SentToJelentkezoTablaID
	)
	VALUES
	(   'KEX',        -- Modul - varchar(50)
	    @tmp_Cimzett,        -- Recipients - varchar(260)
	    @tmp_Masolat,        -- CopyRecipients - varchar(8000)
	    NULL,        -- BlindCopyRecipients - varchar(8000)
	    @tmp_Targy,        -- Subject - varchar(200)
	    @tmp_Szoveg,        -- Body - varchar(max)
	    'HTML',        -- BodyFormat - varchar(20)
	    'Normal',        -- Importance - varchar(100)
	    NULL,        -- FileAttachments - varchar(8000)
	    0,         -- MailItemID - int
	    GETDATE(), -- Created - datetime
	    0,      -- Success - bit
	    0,         -- Deleted - tinyint
	    @TemplateID,         -- EmailTemplateID - int
	    @LetrehozoID,         -- CreatedBy - int
	    @SentToJelentkezoID,         -- SentToJelentkezoID - int
	    @SentToJelentkezoTablaID          -- SentToJelentkezoTablaID - tinyint
	    )
	DECLARE @UjSendMailLogID INT = SCOPE_IDENTITY()

	UPDATE dbo.msk_MailSend_Log SET MailItemID=@UjSendMailLogID
	WHERE MailSendLogID=@UjSendMailLogID

	EXEC [dbo].[msk_SendMail_dll] 	
			@Modul = 'KEX',
			@Recipients = @tmp_Cimzett,
			@CopyRecipients  = @tmp_Masolat,
			@BlindCopyRecipients = NULL,
			@Subject = @tmp_Targy,
			@Body = @tmp_Szoveg,
			@BodyFormat = 'HTML',
			@Importance = 'Normal',
			@FileAttachments = NULL,
			@EmailTemplateID = @TemplateID,
			@CreatedBy = @LetrehozoID,
			@CimzettID = @SentToJelentkezoID,
			@CimzettTablaID = @SentToJelentkezoTablaID,
	        @MailSendLogID = @UjSendMailLogID


	IF @tmp_Masolat IS NOT NULL
		        UPDATE msk_kex_jelentkezok SET EmailCC = @tmp_Masolat
                WHERE msk_kex_jelentkezokID = @SentToJelentkezoID;
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_GDPRValtozas1Evre.sql =====

CREATE PROCEDURE [dbo].[msk_kex_GDPRValtozas1Evre]
AS 
BEGIN
/*GDPR változásban érintettek legyûjtése (csak elsõ alkalommal fut le!)*/
IF OBJECT_ID('temp_gdpr_GDPRValtozas1Evre', 'U') IS NULL 
BEGIN
	CREATE TABLE [dbo].[temp_gdpr_GDPRValtozas1Evre]
	(
		[GDPRID] INT NOT NULL,
		[GDPR_VEGE] DATETIME2 NULL,
		[Modified] DATETIME NULL,
		[Created] DATETIME NOT NULL DEFAULT GETDATE(), 
		CONSTRAINT [PK_temp_gdpr_anonimizaltak] PRIMARY KEY ([GDPRID])
	)

	INSERT INTO dbo.temp_gdpr_GDPRValtozas1Evre	(GDPRID,GDPR_VEGE)
	SELECT g.msk_kex_gdpr_jelentkezokID, g.gdpr_vege
	FROM msk_kex_gdpr_jelentkezok g
	WHERE g.deleted=0 AND g.nev<>'xxx'
END

  
/*Adatok letárolása*/
IF OBJECT_ID('tempdb..#ttGDPRValtozas1Evre') IS NOT NULL
BEGIN
    DROP TABLE #ttGDPRValtozat1Evre
END

SELECT TOP 200 g.*, c.Name AS vallalatName
INTO #ttGDPRValtozas1Evre
FROM dbo.temp_gdpr_GDPRValtozas1Evre tgdpr
	INNER JOIN msk_kex_gdpr_jelentkezok g ON tgdpr.GDPRID=g.msk_kex_gdpr_jelentkezokID
	INNER JOIN dbo.msk_kex_allasajanlatok a ON a.msk_kex_allasajanlatokID=g.idallasajanlat
	INNER JOIN dbo.orn_SZI_Company c ON c.AllasVallalatKod=a.idceg
WHERE g.deleted=0 AND g.nev<>'xxx'
AND tgdpr.Modified IS NULL
ORDER BY g.gdpr_vege ASC

/*Emailek küldése*/
DECLARE @Subject VARCHAR(MAX)
DECLARE @BodyEredeti VARCHAR(MAX)
DECLARE @Body VARCHAR(MAX)

/*1)	Azon jelentkezõket, - akiknek a személyes adatait 12-24 hónap között kezeljük -, a személyes adataik törlésérõl kell értesíteni. #ttGDPRAnonimesErtesites*/
SET @Subject = 'Értesítés személyes adatok törlésérõl / az adatkezelés idõtartamának változásáról'
SET @BodyEredeti = '<p><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">Tisztelt Jelentkezõnk!</span></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">T&aacute;j&eacute;koztatjuk, hogy a %vallalat% &aacute;ltal</span><span style="font-size:11.0pt">&nbsp;a </span><a href="https://karrier.mavcsoport.hu/">https://karrier.mavcsoport.hu/</a><span style="font-size:11.0pt"> oldalon meghirdetett &aacute;ll&aacute;sra, a Jelentkezõi fel&uuml;leten beadott jelentkez&eacute;se alkalm&aacute;val a vonatkoz&oacute; adatkezel&eacute;si t&aacute;j&eacute;koztat&oacute; megismer&eacute;s&eacute;t k&ouml;vetõen</span><span style="font-size:11.0pt"><span style="color:black"> &Ouml;n hozz&aacute;j&aacute;rul&aacute;s&aacute;t adta ahhoz, hogy <em>&uacute;j &aacute;ll&aacute;saj&aacute;nlat megk&uuml;ld&eacute;se &eacute;rdek&eacute;ben</em> szem&eacute;lyes adatait </span></span><strong><span style="font-size:11.0pt">a jelentkez&eacute;s&eacute;tõl sz&aacute;m&iacute;tott 24 h&oacute;napig</span></strong><span style="font-size:11.0pt"><span style="color:black"> kezelj&uuml;k</span></span><em><span style="font-size:11.0pt">.</span></em></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">A belsõ szab&aacute;lyoz&aacute;sunk m&oacute;dos&iacute;t&aacute;s&aacute;ra figyelemmel ez az idõtartam a <strong>jelentkez&eacute;stõl sz&aacute;m&iacute;tott 12 h&oacute;napra v&aacute;ltozott. </strong>A jelentkez&eacute;se sor&aacute;n elfogadott adatkezel&eacute;si t&aacute;j&eacute;koztat&oacute; ennek megfelelõen m&oacute;dosult. </span></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">&Eacute;rtes&iacute;tj&uuml;k, hogy amennyiben a szem&eacute;lyes adatait t&ouml;bb mint 12 h&oacute;napja kezelj&uuml;k, teh&aacute;t t&ouml;bb mint 12 h&oacute;napja adott hozz&aacute;j&aacute;rul&aacute;st azok kezel&eacute;s&eacute;hez, &uacute;gy azokat <strong>a rendszer&uuml;nkbõl a jelen level&uuml;nk kik&uuml;ld&eacute;s&eacute;t k&ouml;vetõ 30 napon bel&uuml;l t&ouml;r&ouml;lj&uuml;k.</strong></span></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><strong><span style="font-size:11.0pt">T&aacute;j&eacute;koztatjuk, hogy amennyiben &Ouml;nnek valamely &aacute;ll&aacute;sp&aacute;ly&aacute;zatra t&ouml;rt&eacute;nõ jelentkez&eacute;se m&eacute;g folyamatban van,</span></strong><span style="font-size:11.0pt"> a fentiekben foglalt v&aacute;ltoz&aacute;s a folyamatban l&eacute;võ <strong>kiv&aacute;laszt&aacute;si elj&aacute;r&aacute;st semmilyen form&aacute;ban nem befoly&aacute;solja. </strong></span></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">Amennyiben a jelentkez&eacute;s&eacute;vel kapcsolatban &eacute;rdeklõdni k&iacute;v&aacute;n, azt a hirdet&eacute;sben megadott el&eacute;rhetõs&eacute;geken teheti meg. A </span><a href="https://karrier.mavcsoport.hu/">https://karrier.mavcsoport.hu/</a><span style="font-size:11.0pt"> oldalon meghirdetett &aacute;ll&aacute;sra a Jelentkezõi fel&uuml;leten beadott jelentkez&eacute;ssel kapcsolatos adatkezel&eacute;si t&aacute;j&eacute;koztat&oacute;(k) tartalmazz&aacute;k a kapcsolattart&aacute;si adatokat, amely az al&aacute;bbi oldalon &eacute;rhetõ el:</span></span></span></p>  <p style="text-align:justify"><a href="https://karrier.mavcsoport.hu/node/197"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">https://karrier.mavcsoport.hu/node/197</span></span></span></a></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">Tisztelettel,</span></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><strong><span style="font-size:11.0pt">M&Aacute;V-csoport tagv&aacute;llalatok</span></strong></span></span></p>  <p style="text-align:justify"><span style="font-size:12pt"><span style="font-family:&quot;Times New Roman&quot;,serif"><span style="font-size:11.0pt">Az egy automatikus e-mail, k&eacute;rj&uuml;k ne v&aacute;laszoljon r&aacute;!</span></span></span></p>'

	DECLARE @MyCursor CURSOR
	DECLARE @CimzettID INT
	DECLARE @CimzettEmail VARCHAR(8000)
	DECLARE @MailSendLogID INT
	DECLARE @logValue VARCHAR(MAX)
	DECLARE @Vallalat VARCHAR(100)

	SET @MyCursor = CURSOR FOR SELECT msk_kex_gdpr_jelentkezokID, email, vallalatName FROM #ttGDPRValtozas1Evre

BEGIN TRAN t01

	OPEN @MyCursor 
	FETCH NEXT FROM @MyCursor INTO @CimzettID, @CimzettEmail, @Vallalat
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @Body = REPLACE(@BodyEredeti, '%vallalat%', @Vallalat)

		INSERT INTO dbo.msk_MailSend_Log (Modul,Recipients,CopyRecipients,BlindCopyRecipients,Subject,Body,BodyFormat,Importance,FileAttachments,MailItemID,
											Created,Success,Deleted,EmailTemplateID,CreatedBy,SentToJelentkezoID,SentToJelentkezoTablaID)
		VALUES	('KEX',@CimzettEmail,NULL,NULL,@Subject,@Body,'HTML','Normal',NULL,NULL,DEFAULT,0,0,0,1,@CimzettID,2)

		SET @MailSendLogID = SCOPE_IDENTITY()

		EXEC [dbo].[msk_SendMail_dll]
				@Modul = 'KEX',
				@Recipients = @CimzettEmail,
				@CopyRecipients  = NULL,
				@BlindCopyRecipients = NULL,
				@Subject = @Subject,
				@Body = @Body,
				@BodyFormat = 'HTML',
				@Importance = 'Normal',
				@FileAttachments = NULL,
				@EmailTemplateID = 0,
				@CreatedBy = 1,
				@CimzettID = @CimzettID,
				@CimzettTablaID = 2,
				@MailSendLogID = @MailSendLogID

		SET @logValue = CONCAT('msk_kex_gdpr_jelentkezokID:',@CimzettID,' - Email:',@CimzettEmail)

		EXEC dbo.msk_log_insert @Name = 'GDPRValtozas1Evre', -- varchar(max)
		                        @Value = @logValue -- varchar(max)
		

		FETCH NEXT FROM @MyCursor INTO @CimzettID, @CimzettEmail, @Vallalat
	END  
	CLOSE @MyCursor 
	DEALLOCATE @MyCursor 

/*GDPR adatkezelési idõ megváltoztatása*/
UPDATE msk_kex_gdpr_jelentkezok set gdpr_vege = dateadd(year,-1,gdpr_vege) 
WHERE msk_kex_gdpr_jelentkezokID IN (SELECT msk_kex_gdpr_jelentkezokID FROM #ttGDPRValtozas1Evre) -- 1 évvel csökkenteni a GDPR végét mindenkinél, akinek kiment az email

UPDATE dbo.temp_gdpr_GDPRValtozas1Evre SET Modified = GETDATE() WHERE GDPRID IN (SELECT msk_kex_gdpr_jelentkezokID FROM #ttGDPRValtozas1Evre)

/*Anonimizálás*/
EXEC dbo.msk_kex_gdpr_anonimizalas

COMMIT TRAN t01

DECLARE @logName VARCHAR(1000) = CONCAT('GDPRValtozas1EvreSzumma-',FORMAT(GETDATE(),'yyyy-MM-dd HH:mm'))
SET @logValue = CONCAT('Anonimizálva:',(SELECT COUNT(*) FROM #ttGDPRValtozas1Evre),'db')
EXEC dbo.msk_log_insert @Name = @logName, -- varchar(max)
		                        @Value = @logValue -- varchar(max)

SELECT 'Done'

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_gdpr_anonimizalas.sql =====

CREATE PROCEDURE [dbo].[msk_kex_gdpr_anonimizalas]

AS BEGIN
	SET NOCOUNT ON
	
	DROP TABLE IF EXISTS #gdpr_anonimizalando_Dok
	CREATE TABLE #gdpr_anonimizalando_Dok (docID INT)

	;WITH Mycte (DocID) AS
		(	
			(	
			SELECT cvlinkid AS dok 
			FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL AND CAST(gdpr_vege AS DATETIME) < GETDATE()
			UNION
			SELECT JelentkezesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL AND CAST(gdpr_vege AS DATETIME) < GETDATE()
			UNION
			SELECT AdatkezelesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL AND CAST(gdpr_vege AS DATETIME) < GETDATE()
			UNION
			SELECT MotivaciosDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL AND CAST(gdpr_vege AS DATETIME) < GETDATE()
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL AND CAST(gdpr_vege AS DATETIME) < GETDATE()
			)
			EXCEPT
			(
			SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL
			UNION
			SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL
			UNION
			SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL
			UNION
			SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_map_ajanlas WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
			)
		)
	UPDATE dbo.Document SET Deleted=9 
	OUTPUT [Inserted].[DocumentID]
	INTO #gdpr_anonimizalando_Dok
	WHERE EXISTS (SELECT * FROM Mycte WHERE DocumentID=DocID)
	
	/*LOG*/
	INSERT INTO [dbo].[msk_log]
	(
		[name],
		[value],
		[created]
	)
	SELECT
	'GDPR anonimizálás',
	[AD].[docID],
	GETDATE()
	FROM #gdpr_anonimizalando_Dok [AD]



	--GDPR jelentkezõ anonimizálása
	update Msk_kex_hash set Deleted=1 where Msk_kex_hashID in (  select HASHID from msk_kex_gdpr_jelentkezok where Deleted=0 AND CAST(gdpr_vege AS DATETIME) < GETDATE() )    
	UPDATE dbo.msk_kex_jelentkezok SET HASHID=NULL where nev='xxx' and HASHID in ( select HASHID from msk_kex_gdpr_jelentkezok where Deleted=0 AND CAST(gdpr_vege AS DATETIME) < GETDATE() )  
	UPDATE dbo.msk_kex_gdpr_jelentkezok SET nev='xxx', email='xxx', telefonszam='xxx', EmailCC='xxx', 
						cvlinkid = NULL, AdatkezelesiDokID = NULL, JelentkezesiDokID = NULL, MunkavallaloiDokID = NULL, MotivaciosDokID = NULL,
						cvlink='xxx', cvtartalom='xxx', ajanlo_nev='xxx', MAPCompany = 'xxx', MAPEmail='xxx', map_hatarido = NULL, 
						idmap_dokumentacio=NULL, MAPPeopleID=NULL, map_beerkezes = NULL,MAPAjanloszelvenyForrasa = NULL, MAPErvenyes = NULL, JelentkezokID= NULL, Deleted=1,HASHID=NULL 
	WHERE Deleted=0 AND CAST(gdpr_vege AS DATETIME) < GETDATE()

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_jelentkezok_hozzarendelese_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_jelentkezok_hozzarendelese] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	
	DECLARE @tmp_filtersjelentkezo TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filtersjelentkezo execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filtersjelentkezo where ornAlias<>'msk_kex_gdpr_jelentkezokID_ID' or ornType<>'Param' or inOut<>'In' 


	DECLARE @tmp_filtersallasajanlat TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filtersallasajanlat execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filtersallasajanlat where ornAlias<>'msk_kex_allasajanlatokID_ID' or ornType<>'Out' or inOut<>'Out'

	DECLARE @MyFieldallasajanlat INT;

    set @MyFieldallasajanlat= (select ornValue from @tmp_filtersallasajanlat)
	
	DECLARE @MyCursorjelentkezo CURSOR;
	DECLARE @MyFieldjelentkezo INT;
	BEGIN
		    SET @MyCursorjelentkezo = CURSOR FOR select ornValue from @tmp_filtersjelentkezo 
		    OPEN @MyCursorjelentkezo FETCH NEXT FROM @MyCursorjelentkezo INTO @MyFieldjelentkezo
		    WHILE @@FETCH_STATUS = 0
			BEGIN
    INSERT INTO [dbo].[msk_kex_jelentkezok]
           ([idallasajanlat]
           ,[iddrupal]
           ,[targy]
           ,[nev]
           ,[email]
           ,[telefonszam]
           ,[cvlink]
           ,[cvtartalom]
           ,[gdpr]
           ,[ajanlo_nev]
           ,[datum]
           ,[honnanertesult]
           ,[Deleted]
           ,[cvlinkid]
		   ,[JelentkezesiDokID]
		   ,[AdatkezelesiDokID]
	       ,[MotivaciosDokID]
	       ,[MunkavallaloiDokID]
	       ,[HashID]
	       ,[EmailCC],
		   MAPCompany,
		   idmap_dokumentacio,
		   map_beerkezes,
		   map_hatarido,
		   gdpr_vege,
		   MAPEmail,
		   MAPPeopleID,
		   MAPAjanloszelvenyForrasa,
		   MAPErvenyes,
		   hp_torzsszam,
		   hp_nev)
    (SELECT @MyFieldallasajanlat
      ,-1
      ,[targy]
      ,[nev]
      ,[email]
      ,[telefonszam]
      ,[cvlink]
      ,[cvtartalom]
      ,[gdpr]
      ,IIF(ajanlo_nev='xxx',NULL,ajanlo_nev)
      ,GETDATE()
      ,[honnanertesult]
      ,[Deleted]
      ,[cvlinkid]
	  ,[JelentkezesiDokID]
      ,[AdatkezelesiDokID]
	  ,[MotivaciosDokID]
	  ,[MunkavallaloiDokID]
	  ,[HashID]
	  ,[EmailCC]
	  ,IIF(MAPCompany='xxx',NULL,MAPCompany)
	  ,idmap_dokumentacio
	  ,map_beerkezes
	  ,DATEADD(day, 10, GETDATE())
	  ,gdpr_vege
	  ,IIF(MAPEmail='xxx',NULL,MAPEmail)
	  ,MAPPeopleID
	  ,MAPAjanloszelvenyForrasa
	  ,IIF((SELECT [dbo].[msk_kex_isMAPErvenyes] (MAPPeopleID, @MyFieldallasajanlat))=1,1,0)
	  ,(SELECT TOP 1 p.PERNR
		FROM dbo.msk_tob_keresesikerelem kk
		INNER JOIN dbo.msk_tob_allashirdetesek ah ON ah.Idkeresesikerelem=kk.Msk_tob_keresesikerelemID
		INNER JOIN dbo.People p ON p.PeopleID=kk.Idtoborzo1
		WHERE ah.Msk_tob_allashirdetesekID=@MyFieldallasajanlat)
	  ,(SELECT TOP 1 p.Name
		FROM dbo.msk_tob_keresesikerelem kk
		INNER JOIN dbo.msk_tob_allashirdetesek ah ON ah.Idkeresesikerelem=kk.Msk_tob_keresesikerelemID
		INNER JOIN dbo.People p ON p.PeopleID=kk.Idtoborzo1
		WHERE ah.Msk_tob_allashirdetesekID=@MyFieldallasajanlat)
     FROM [dbo].[msk_kex_gdpr_jelentkezok]
     WHERE [msk_kex_gdpr_jelentkezokID]= @MyFieldjelentkezo ) 
	  
				FETCH NEXT FROM @MyCursorjelentkezo INTO @MyFieldjelentkezo 



			END; 

			CLOSE @MyCursorjelentkezo ;
			DEALLOCATE @MyCursorjelentkezo;
	END
	
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_jelentkezok_ker_allasajanlatok.sql =====

CREATE PROCEDURE [dbo].[msk_kex_jelentkezok_ker_allasajanlatok] (
	@UserID INT,	
    @FieldList varchar(max) = '*',
    @WhereString varchar(8000) = '1=1',
    @OrderByString varchar(4000) = '',
    @pageNumber INT = 0,
    @rowsPerPage INT = 0
)
AS
BEGIN
-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2023.03.27
-- Description:	KEX Jeéentkezõk keresése Állásajánlatok kérpenyõ
-- =============================================

	SET NOCOUNT ON;
	
	DECLARE @GDPRJelentkezokID INT
	DECLARE @HashID INT
	EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'g.[msk_kex_gdpr_jelentkezokID]', 0, @GDPRJelentkezokID OUTPUT, @WhereString OUTPUT
	SET @HashID = (SELECT HashID FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@GDPRJelentkezokID)
	DECLARE @LatestActiveJelentkezo INT = (SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC)
	DECLARE @LatestAnonimazedGDPRJelentkezo INT = (SELECT TOP 1 msk_kex_gdpr_jelentkezokID FROM dbo.msk_kex_gdpr_jelentkezok 
				WHERE Deleted<>0 AND HashID=@HashID ORDER BY msk_kex_gdpr_jelentkezokID DESC)
	DECLARE @LatestAnonimazedJelentkezo INT = ISNULL((SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE idallasajanlat=(SELECT idallasajanlat FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@LatestAnonimazedGDPRJelentkezo) AND HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC),0)

	declare @sel nvarchar(4000);
	set @sel = 'select '+@FieldList+'     
    FROM msk_kex_allasajanlatok as a
		INNER JOIN People as p ON a.idtoborzo1 = p.PeopleID
		INNER JOIN dbo.msk_kex_jelentkezok j ON j.idallasajanlat=a.msk_kex_allasajanlatokID
		LEFT JOIN dbo.msk_kex_gdpr_jelentkezok g ON g.HashID=j.HashID
    WHERE 
		j.msk_kex_jelentkezokID BETWEEN ' + CAST(@LatestAnonimazedJelentkezo + 1 AS VARCHAR) + ' AND ' + CAST(@LatestActiveJelentkezo AS VARCHAR) + '
	--(SELECT COUNT(DISTINCT g.msk_kex_gdpr_jelentkezokID) FROM msk_kex_allasajanlatok as a
	--			LEFT JOIN People as p ON a.idtoborzo1 = p.PeopleID
	--			LEFT JOIN dbo.msk_kex_jelentkezok j ON j.idallasajanlat=a.msk_kex_allasajanlatokID
	--			LEFT JOIN dbo.msk_kex_gdpr_jelentkezok g ON g.HashID=j.HashID
	--		    WHERE ' + @WhereString + ')=1 
		AND
		' + @WhereString + ' 
		and dateadd(year,CAST(ISNULL((SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code=''GDPR_megorzesi_ido'' AND Deleted=0),1) AS INT) ,j.datum)>getdate()' 
	PRINT @sel
	EXEC sp_executesql @sel
END
/*TESZT
EXECUTE msk_kex_jelentkezok_ker_allasajanlatok '518',
                                               @OrderByString = N'a.[msk_kex_allasajanlatokID] Asc',
                                               @WhereString = N'1=1 AND (g.[msk_kex_gdpr_jelentkezokID]=N''133242'')  AND (a.[idceg]=N''410706'') ',
                                               @FieldList = N'a.[msk_kex_allasajanlatokID],a.[uzletag],a.[targy],a.[leiras],a.[hely],a.[idkategoria],a.[idceg],a.[reszleg],a.[elvarasok],a.[elonytjelent],a.[juttatasok],a.[datum_aktivalas],a.[datum_lejarat],a.[szerzodes_fajta],a.[foglalkoztatasi_fok],a.[poziciok_szama],a.[munkavegzes_helye],a.[feladatok],a.[tovabbi_info],a.[toborzo_info],a.[toborzo_torzsszam],a.[vallalat],a.[igazgatosag],a.[munkakor_csoport],a.[kepzes_fajta],a.[kepzes_szakirany],a.[szak],a.[idegen_nyelv],a.[informatika],a.[szakmai_tapasztalat],a.[jogositvany],a.[link],a.[toborzo_feluliras_flag],a.[idszin],a.[idtoborzo1],a.[idtoborzo2],a.[idvezeto],a.[datum_tanfolyam],a.[idtanfolyamhely],a.[idtanfolyamtipus],a.[datum_lezaras],a.[aktiv],a.[datum_tanfolyam_szoveges],a.[min_tapasztalat],a.[min_vegzettseg],a.[vezetoi_engedely],a.[alt_ceg_nev],a.[alt_email],a.[alt_telefon],a.[ceg_elrejtese],a.[jelentkezes_gomb],a.[idfogado],a.[toborzo_email],a.[toborzo_felvado],a.[map_job],a.[cv],a.[kvalifikacio],a.[engedely_iktatoszama],a.[engedely_datuma],a.[pozicio_szama],a.[Deleted],a.[idmunkaltato]',
                                               @pageNumber = 1,
                                               @rowsPerPage = 100;
*/


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_jemail.sql =====

-- =============================================
-- Author:		Najdanonovszki Krisztián
-- Create date: 2023-03-29
-- Description:	KEX - Jelentkezõ e-mail
-- =============================================
CREATE PROCEDURE [dbo].[msk_kex_jemail]
--	@JelentkezoID INT,
	@FieldList VARCHAR(max) = '*',  
	@WhereString VARCHAR(max) = '1=1',  
	@OrderByString VARCHAR(max) = '',  
	@PageNumber INT,  
	@RowsPerPage INT
AS
BEGIN
	SET NOCOUNT ON
	

	DECLARE @HashID INT
	EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'g.[HashID]', 0, @HashID OUTPUT, @WhereString OUTPUT
	DECLARE @LatestActiveJelentkezo INT = (SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC)
	DECLARE @LatestAnonimazedGDPRJelentkezo INT = (SELECT TOP 1 msk_kex_gdpr_jelentkezokID FROM dbo.msk_kex_gdpr_jelentkezok 
				WHERE Deleted<>0 AND HashID=@HashID ORDER BY msk_kex_gdpr_jelentkezokID DESC)
	DECLARE @LatestAnonimazedJelentkezo INT = ISNULL((SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE idallasajanlat=(SELECT idallasajanlat FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@LatestAnonimazedGDPRJelentkezo) AND HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC),0)

	DECLARE 
		@Select VARCHAR(max)

SET @select = '	SELECT ' + @FieldList + '
	  FROM msk_MailSend_Log m
	  LEFT JOIN msk_kex_gdpr_jelentkezok g ON g.msk_kex_gdpr_jelentkezokID=m.SentToJelentkezoID
	  LEFT JOIN msk_kex_jelentkezok j ON j.msk_kex_jelentkezokID=m.SentToJelentkezoID
	  WHERE m.Deleted=0
	  AND m.SentToJelentkezoTablaID=1
	  AND m.Modul = ''KEX''
	  AND j.msk_kex_jelentkezokID BETWEEN ' + CAST(@LatestAnonimazedJelentkezo + 1 AS VARCHAR) + ' AND ' + CAST(@LatestActiveJelentkezo AS VARCHAR) + '
	  and dateadd(year,CAST(ISNULL((SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code=''GDPR_megorzesi_ido'' AND Deleted=0),1) AS INT) ,j.datum)>getdate() and '+@WhereString 

	EXECUTE(@Select)
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_jinterju.sql =====

-- =============================================
-- Author:		Szecskás János
-- Create date: 2020-05-14
-- Description:	KEX - Jelentkezõ interjúi
-- =============================================
CREATE PROCEDURE [dbo].[msk_kex_jinterju]
--	@JelentkezoID INT,
	@FieldList VARCHAR(max) = '*',  
	@WhereString VARCHAR(max) = '1=1',  
	@OrderByString VARCHAR(max) = '',  
	@PageNumber INT,  
	@RowsPerPage INT
AS
BEGIN
	SET NOCOUNT ON
	

	DECLARE @GDPRJelentkezokID INT
	DECLARE @HashID INT
	EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'g.[msk_kex_gdpr_jelentkezokID]', 0, @GDPRJelentkezokID OUTPUT, @WhereString OUTPUT
	SET @HashID = (SELECT HashID FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@GDPRJelentkezokID)
	DECLARE @LatestActiveJelentkezo INT = (SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC)
	DECLARE @LatestAnonimazedGDPRJelentkezo INT = (SELECT TOP 1 msk_kex_gdpr_jelentkezokID FROM dbo.msk_kex_gdpr_jelentkezok 
				WHERE Deleted<>0 AND HashID=@HashID ORDER BY msk_kex_gdpr_jelentkezokID DESC)
	DECLARE @LatestAnonimazedJelentkezo INT = ISNULL((SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE idallasajanlat=(SELECT idallasajanlat FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@LatestAnonimazedGDPRJelentkezo) AND HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC),0)

	DECLARE 
		@Select VARCHAR(max)

SET @select = '	
SELECT i.msk_kex_interjuID
      ,i.idjelentkezo
	  ,gdpr.msk_kex_gdpr_jelentkezokID
	  ,a.msk_kex_allasajanlatokID
	  ,a.targy
      ,i.datum
      ,l1.LookupValue AS eredmeny
      ,l2.LookupValue AS dolgozik
      ,l3.LookupValue AS megjelent
      ,i.megjegyzes
  FROM msk_kex_interju AS i 
  LEFT JOIN msk_kex_jelentkezok  AS j ON i.idjelentkezo = j.msk_kex_jelentkezokID
  LEFT JOIN dbo.msk_kex_gdpr_jelentkezok gdpr ON gdpr.HashID=j.HashID
  LEFT JOIN msk_kex_allasajanlatok AS a ON j.idallasajanlat = a.msk_kex_allasajanlatokID
  LEFT JOIN msk_kex_LookupList AS l1 ON i.ideredmeny = l1.LookupListID
  LEFT JOIN msk_kex_LookupList AS l2 ON i.iddolgozik = l2.LookupListID
  LEFT JOIN msk_kex_LookupList AS l3 ON i.idmegjelent = l3.LookupListID
  WHERE j.msk_kex_jelentkezokID BETWEEN ' + CAST(@LatestAnonimazedJelentkezo + 1 AS VARCHAR) + ' AND ' + CAST(@LatestActiveJelentkezo AS VARCHAR) + '
  AND dateadd(year,CAST(ISNULL((SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code=''GDPR_megorzesi_ido'' AND Deleted=0),1) AS INT) ,j.datum)>getdate() and '+@WhereString 
--  WHERE i.idjelentkezo = @JelentkezoID

--	PRINT left(@Select,8000)
	EXECUTE(@Select)
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_jteszt.sql =====

-- =============================================
-- Author:		Szecskás János
-- Create date: 2020-05-14
-- Description:	KEX - Jelentkezõ interjúi
-- =============================================
CREATE PROCEDURE [dbo].[msk_kex_jteszt]
--	@JelentkezoID INT,
	@FieldList VARCHAR(max) = '*',  
	@WhereString VARCHAR(max) = '1=1',  
	@OrderByString VARCHAR(max) = '',  
	@PageNumber INT,  
	@RowsPerPage INT
AS
BEGIN
	SET NOCOUNT ON
	

	DECLARE @GDPRJelentkezokID INT
	DECLARE @HashID INT
	EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'g.[msk_kex_gdpr_jelentkezokID]', 0, @GDPRJelentkezokID OUTPUT, @WhereString OUTPUT
	SET @HashID = (SELECT HashID FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@GDPRJelentkezokID)
	DECLARE @LatestActiveJelentkezo INT = (SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC)
	DECLARE @LatestAnonimazedGDPRJelentkezo INT = (SELECT TOP 1 msk_kex_gdpr_jelentkezokID FROM dbo.msk_kex_gdpr_jelentkezok 
				WHERE Deleted<>0 AND HashID=@HashID ORDER BY msk_kex_gdpr_jelentkezokID DESC)
	DECLARE @LatestAnonimazedJelentkezo INT = ISNULL((SELECT TOP 1 msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok 
				WHERE idallasajanlat=(SELECT idallasajanlat FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID=@LatestAnonimazedGDPRJelentkezo) AND HashID=@HashID ORDER BY msk_kex_jelentkezokID DESC),0)

	DECLARE 
		@Select VARCHAR(max)

SET @select = '	SELECT [msk_kex_tesztID]
      ,[idjelentkezo]
	  ,gdpr.msk_kex_gdpr_jelentkezokID
	  ,a.msk_kex_allasajanlatokID
	  ,a.targy
      ,tt.nev AS teszttipus
	  ,t.datum
      ,l1.LookupValue AS megirta
      ,l2.LookupValue AS eredmeny
      ,t.[megjegyzes]

  FROM msk_kex_teszt AS t 
  LEFT JOIN msk_kex_jelentkezok  AS j ON t.idjelentkezo = j.msk_kex_jelentkezokID
  LEFT JOIN dbo.msk_kex_gdpr_jelentkezok gdpr ON gdpr.HashID=j.HashID
  LEFT JOIN msk_kex_allasajanlatok AS a ON j.idallasajanlat = a.msk_kex_allasajanlatokID
  LEFT JOIN msk_kex_teszttipusok AS tt ON t.idteszttipus = tt.msk_kex_teszttipusokID
  LEFT JOIN msk_kex_LookupList AS l1 ON t.idmegirta = l1.LookupListID
  LEFT JOIN msk_kex_LookupList AS l2 ON t.ideredmeny = l2.LookupListID
  WHERE 		j.msk_kex_jelentkezokID BETWEEN ' + CAST(@LatestAnonimazedJelentkezo + 1 AS VARCHAR) + ' AND ' + CAST(@LatestActiveJelentkezo AS VARCHAR) + '
	AND dateadd(year,CAST(ISNULL((SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code=''GDPR_megorzesi_ido'' AND Deleted=0),1) AS INT) ,j.datum)>getdate() and '+@WhereString 

	EXECUTE(@Select)

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_LandingzoneAdvertList_migralas_naponta.sql =====


CREATE PROCEDURE [dbo].[msk_kex_LandingzoneAdvertList_migralas_naponta]	
AS 
BEGIN

-- Csak akkor futtatjunk, ha még nem futott aznap.
	DECLARE @MarFutott INT -- Figyeli, hogy futott-e már ma ez a modul.
	DECLARE @LegutolsoFedolgozottDatum DATETIME
	SET @LegutolsoFedolgozottDatum = DATEADD(DAY, -2, getdate())
	SET @MarFutott = 0

	SET @MarFutott = (SELECT COUNT(*) 
	FROM msk_kex_advertlistchangelog
	WHERE CAST(Created as date) = CAST(DATEADD(DAY, -1, getdate()) AS date))   -- 'tegnapi' dátummal futtatjunk 

    IF @MarFutott = 0

		SET @LegutolsoFedolgozottDatum = CAST((SELECT top (1) Created 
		FROM msk_kex_advertlistchangelog
		ORDER BY [AdvertListID] desc) AS date) 

-- Ideiglenes tábla létrehozása (#tmp_msk_kex_advertlistchangelog)
-- Az aktuális napra      
-- Kimásolja a orn_kex_LandingZone_AdvertList táblából az aktuális napi rekordokat és átmásolja = > #tmp_msk_kex_advertlistchangelog ideiglenes táblába.

	BEGIN 
	    IF OBJECT_ID('tempdb..#tmp_msk_kex_advertlistchangelog') IS NOT NULL
			DROP TABLE #tmp_msk_kex_advertlistchangelog

		SELECT AdvertListID as 'AdvertListID'   
			  ,WebAdvertsID as 'WebAdvertsID'
			  ,AdvertID as 'AdvertID'
			  ,Company as 'Company'
			  ,Title as 'Title'
			  ,Description as 'Description'
			  ,Locations as 'Locations'
			  ,Categories as 'Categories'
			  ,CompanyID as 'CompanyID'
			  ,Department as 'Department'
			  ,Requirements as 'Requirements'
			  ,Qualities as 'Qualities'
			  ,Benefits as 'Benefits'
			  ,Min_Experience as 'Min_Experience'
			  ,Min_Education as 'Min_Education'
			  ,Driver_Licence as 'Driver_Licence'
			  ,Link as 'Link'
			  ,Activation_Date as 'Activation_Date'
			  ,Expiraton_Date as 'Expiraton_Date'
			  ,Contract as 'Contract' 
			  ,Schedule as 'Schedule'
			  ,Company_Name as 'Company_Name'
			  ,Email as 'Email'
			  ,Phone as 'Phone'
			  ,Vacancy_NR as 'Vacancy_NR' 
			  ,Work_Location as 'Work_Location'
			  ,Hide_Company as 'Hide_Company'
			  ,Schow_Apply_Button as 'Schow_Apply_Button'
			  ,Custom_Template_ID as 'Custom_Template_ID'
			  ,Tasks as 'Tasks'
			  ,Additional_Info as 'Additional_Info' 
			  ,Recruiter_Info as 'Recruiter_Info'
			  ,Recruiter_ID as 'Recruiter_ID'
			  ,Recruiter_Email as 'Recruiter_Email'
			  ,Recruiter_Felvado as 'Recruiter_Felvado'
			  ,Map_Job as 'Map_Job'
			  ,CV as 'CV'
			  ,Subsidiary as 'Subsidiary'
			  ,Industry as 'Industry'
			  ,Hierarchy_Level as 'Hierarchy_Level'
			  ,Education_Type as 'Education_Type'
			  ,Education_Field as 'Education_Field'
			  ,Field_Of_Study as 'Field_Of_Study'
			  ,Reference_Number as 'Reference_Number'
			  ,Approval_Date as 'Approval_Date'
			  ,Number_Of_Positions as 'Number_Of_Positions'
			  ,Created as 'Created'
			  ,Deleted as 'Deleted'

		INTO #tmp_msk_kex_advertlistchangelog
		FROM orn_kex_LandingZone_AdvertList
		WHERE CAST(Created as date) <= CAST(DATEADD(DAY, -1, getdate()) AS date)	-- 'tegnapi' dátummal futtatjunk 
		  AND CAST(Created as date) > CAST(@LegutolsoFedolgozottDatum AS date)		-- figyeli azt is hogy legyen késõbbi mint a legutolsó nap,
																					-- amit feldolgoztak, így ha kimaradt valamelyik nap akkor azt is feldolgozza 
	--	WHERE CAST(Created as date) = CAST('2018.11.16' AS date) --teszteléshez kellett
		ORDER BY AdvertListID

		-- Végigmegy az #tmp_msk_kex_advertlistchangelog ideiglenes táblán és azt összehasonlítja msk_kex_advertlistchangelog táblával:
		-- - ha ha az adott AdvertID-val NEM létezik rekord a msk_kex_advertlistchangelog táblában, akkor azt a rekordot beírtja msk_kex_advertlistchangelog táblába.
		-- - ha az adott AdvertID-val létezik rekord a msk_kex_advertlistchangelog táblában, akkor abból veszi a legutolsót, és tovább vizsgálja:
		-- --- ha a két rekord nem tér el egymástól, akkor NEM írja be.  
		-- --- ha a két rekord el tér egymástól, akkor azt a rekordot beírtja msk_kex_advertlistchangelog táblába.

		DECLARE @Msk_Kex_AdvertlistchangelogID INT
		DECLARE @AdvertListID INT
		DECLARE @WebAdvertsID INT
		DECLARE @AdvertID varchar(8000)
		DECLARE @Company varchar(8000)
		DECLARE @Title varchar(8000)
		DECLARE @Description varchar(8000)
		DECLARE @Locations varchar(8000)
		DECLARE @Categories varchar(8000)
		DECLARE @CompanyID varchar(8000)
		DECLARE @Department VARCHAR(8000)
		DECLARE @Requirements VARCHAR(8000)
		DECLARE @Qualities VARCHAR(8000)
		DECLARE @Benefits VARCHAR(8000)
		DECLARE @Min_Experience VARCHAR(8000)
		DECLARE @Min_Education VARCHAR(8000)
		DECLARE @Driver_Licence VARCHAR(8000)
		DECLARE @Link varchar(8000)
		DECLARE @Activation_Date VARCHAR(8000)
		DECLARE @Expiraton_Date VARCHAR(8000)
		DECLARE @Contract VARCHAR(8000)
		DECLARE @Schedule VARCHAR(8000)
		DECLARE @Company_Name VARCHAR(8000)
		DECLARE @Email VARCHAR(8000)
		DECLARE @Phone VARCHAR(8000)
		DECLARE @Vacancy_NR VARCHAR(8000)
		DECLARE @Work_Location VARCHAR(8000)
		DECLARE @Hide_Company VARCHAR(8000)
		DECLARE @Schow_Apply_Button VARCHAR(8000)
		DECLARE @Custom_Template_ID VARCHAR(8000)
		DECLARE @Tasks VARCHAR(8000)
		DECLARE @Additional_Info VARCHAR(8000)
		DECLARE @Recruiter_Info VARCHAR(8000)
		DECLARE @Recruiter_ID VARCHAR(8000) 
		DECLARE @Recruiter_email VARCHAR(8000) 
		DECLARE @Recruiter_Felvado VARCHAR(8000) 
		DECLARE @Map_Job VARCHAR(8000) 
		DECLARE @CV VARCHAR(8000) 
		DECLARE @Subsidiary VARCHAR(8000) 
		DECLARE @Industry VARCHAR(8000) 
		DECLARE @Hierarchy_Level VARCHAR(8000) 
		DECLARE @Education_Type VARCHAR(8000) 
		DECLARE @Education_Field VARCHAR(8000) 
		DECLARE @Field_Of_Study VARCHAR(8000) 
		DECLARE @Reference_Number VARCHAR(8000) 
		DECLARE @Approval_Date VARCHAR(8000) 
		DECLARE @Number_Of_Positions VARCHAR(8000) 
		DECLARE @Created DATETIME 
		DECLARE @Deleted TINYINT 

		DECLARE @Msk_Kex_AdvertlistchangelogID2 INT 
		DECLARE @AdvertListID2 INT 
		DECLARE @WebAdvertsID2 INT 
		DECLARE @AdvertID2 varchar(8000) 
		DECLARE @Company2 varchar(8000) 
		DECLARE @Title2 varchar(8000) 
		DECLARE @Description2 varchar(8000) 
		DECLARE @Locations2 varchar(8000) 
		DECLARE @Categories2 varchar(8000) 
		DECLARE @CompanyID2 varchar(8000) 
		DECLARE @Department2 VARCHAR(8000) 
		DECLARE @Requirements2 VARCHAR(8000) 
		DECLARE @Qualities2 VARCHAR(8000) 
		DECLARE @Benefits2 VARCHAR(8000) 
		DECLARE @Min_Experience2 VARCHAR(8000) 
		DECLARE @Min_Education2 VARCHAR(8000) 
		DECLARE @Driver_Licence2 VARCHAR(8000) 
		DECLARE @Link2 VARCHAR(8000) 
		DECLARE @Activation_Date2 VARCHAR(8000) 
		DECLARE @Expiraton_Date2 VARCHAR(8000) 
		DECLARE @Contract2 VARCHAR(8000) 
		DECLARE @Schedule2 VARCHAR(8000) 
		DECLARE @Company_Name2 VARCHAR(8000) 
		DECLARE @Email2 VARCHAR(8000) 
		DECLARE @Phone2 VARCHAR(8000) 
		DECLARE @Vacancy_NR2 VARCHAR(8000) 
		DECLARE @Work_Location2 VARCHAR(8000) 
		DECLARE @Hide_Company2 VARCHAR(8000) 
		DECLARE @Schow_Apply_Button2 VARCHAR(8000) 
		DECLARE @Custom_Template_ID2 VARCHAR(8000) 
		DECLARE @Tasks2 VARCHAR(8000) 
		DECLARE @Additional_Info2 VARCHAR(8000) 
		DECLARE @Recruiter_Info2 VARCHAR(8000) 
		DECLARE @Recruiter_id2 VARCHAR(8000) 
		DECLARE @Recruiter_Email2 VARCHAR(8000) 
		DECLARE @Recruiter_Felvado2 VARCHAR(8000) 
		DECLARE @Map_Job2 VARCHAR(8000) 
		DECLARE @CV2 VARCHAR(8000) 
		DECLARE @Subsidiary2 VARCHAR(8000) 
		DECLARE @Industry2 VARCHAR(8000) 
		DECLARE @Hierarchy_Level2 VARCHAR(8000) 
		DECLARE @Education_Type2 VARCHAR(8000) 
		DECLARE @Education_Field2 VARCHAR(8000) 
		DECLARE @Field_Of_Study2 VARCHAR(8000) 
		DECLARE @Reference_Number2 VARCHAR(8000) 
		DECLARE @Approval_Date2 VARCHAR(8000) 
		DECLARE @Number_Of_Positions2 VARCHAR(8000) 
		DECLARE @Created2 DATETIME 
		DECLARE @Deleted2 TINYINT 

		DECLARE @Vansor TINYINT			-- Figyeli, ha az adott AdvertID-val létezik-e rekord a msk_kex_advertlistchangelog táblában (0:nincs, 1:van) 
		DECLARE @Vanelteres TINYINT 	-- Ha az adott AdvertID-val létezik rekord a msk_kex_advertlistchangelog táblában, akkor abból veszi a legutolsót, és ez a 'flag' figyeli, 
										-- hogy a két rekord eltér-e egymástól (0:nem tér el, 1: eltér)


		DECLARE @MyCursor CURSOR 

		BEGIN
			SET @MyCursor = CURSOR FOR select	AdvertListID 
												,WebAdvertsID 
												,AdvertID 
												,Company 
												,Title
												,Description
												,Locations 
												,Categories
												,CompanyID
												,Department
												,Requirements
												,Qualities
												,Benefits
												,Min_Experience
												,Min_Education
												,Driver_Licence
												,Link
												,Activation_Date
												,Expiraton_Date
												,Contract
												,Schedule
												,Company_Name
												,Email
												,Phone
												,Vacancy_NR
												,Work_Location
												,Hide_Company
												,Schow_Apply_Button
												,Custom_Template_ID
												,Tasks
												,Additional_Info
												,Recruiter_Info
												,Recruiter_ID
												,Recruiter_Email
												,Recruiter_Felvado
												,Map_Job
												,CV
												,Subsidiary
												,Industry
												,Hierarchy_Level
												,Education_Type
												,Education_Field
												,Field_Of_Study
												,Reference_Number
												,Approval_Date
												,Number_Of_Positions
												,Created
												,Deleted

			FROM [#tmp_msk_kex_advertlistchangelog] 
			ORDER BY [AdvertListID]

			OPEN @MyCursor 
			FETCH NEXT FROM @MyCursor INTO   @AdvertListID 
											,@WebAdvertsID 
											,@AdvertID 
											,@Company 
											,@Title
											,@Description
											,@Locations 
											,@Categories
											,@CompanyID
											,@Department
											,@Requirements
											,@Qualities
											,@Benefits
											,@Min_Experience
											,@Min_Education
											,@Driver_Licence
											,@Link
											,@Activation_Date
											,@Expiraton_Date
											,@Contract
											,@Schedule
											,@Company_Name
											,@Email
											,@Phone
											,@Vacancy_NR
											,@Work_Location
											,@Hide_Company
											,@Schow_Apply_Button
											,@Custom_Template_ID
											,@Tasks
											,@Additional_Info
											,@Recruiter_Info
											,@Recruiter_ID
											,@Recruiter_Email
											,@Recruiter_Felvado
											,@Map_Job
											,@CV
											,@Subsidiary
											,@Industry
											,@Hierarchy_Level
											,@Education_Type
											,@Education_Field
											,@Field_Of_Study
											,@Reference_Number
											,@Approval_Date
											,@Number_Of_Positions
											,@Created
											,@Deleted

			WHILE @@FETCH_STATUS = 0
			BEGIN
				SET @Vansor = 0
				SET @AdvertListID2 = 0
				SELECT TOP (1)	 @AdvertListID2 =  AdvertListID 
								,@WebAdvertsID2 =  WebAdvertsID 
								,@AdvertID2     =  AdvertID
								,@Company2      =  Company
								,@Title2        =  Title
								,@Description2  =  Description 
								,@Locations2    =  Locations
								,@Categories2   =  Categories
								,@CompanyID2    =  CompanyID 
								,@Department2   =  Department
								,@Requirements2 =  Requirements
								,@Qualities2    =  Qualities 
								,@Benefits2     =  Benefits
								,@Min_Experience2 = Min_Experience
								,@Min_Education2  = Min_Education
								,@Driver_Licence2 = Driver_Licence
								,@Link2			= Link
								,@Activation_Date2 = Activation_Date
								,@Expiraton_Date2  = Expiraton_Date
								,@Contract2        = Contract
								,@Schedule2        = Schedule
								,@Company_Name2    = Company_Name 
								,@Email2           = Email
								,@Phone2           = Phone
								,@Vacancy_NR2      = Vacancy_NR
								,@Work_Location2   = Work_Location
								,@Hide_Company2    = Hide_Company
								,@Schow_Apply_Button2  = Schow_Apply_Button
								,@Custom_Template_ID2  = Custom_Template_ID
								,@Tasks2               = Tasks
								,@Additional_Info2     = Additional_Info
								,@Recruiter_Info2      = Recruiter_Info
								,@Recruiter_ID2        = Recruiter_ID
								,@Recruiter_Email2     = Recruiter_Email
								,@Recruiter_Felvado2   = Recruiter_Felvado
								,@Map_Job2             = Map_Job
								,@CV2                  = CV
								,@Subsidiary2          = Subsidiary
								,@Industry2            = Industry
								,@Hierarchy_Level2     = Hierarchy_Level
								,@Education_Type2      = Education_Type
								,@Education_Field2     = Education_Field
								,@Field_Of_Study2      = Field_Of_Study
								,@Reference_Number2    = Reference_Number
								,@Approval_Date2       = Approval_Date
								,@Number_Of_Positions2 = Number_Of_Positions
								,@Created2			 = Created
								,@Deleted2			 = Deleted	
			 
				FROM [msk_kex_advertlistchangelog] 
				WHERE @AdvertID = [AdvertID]
				ORDER BY [AdvertListID] desc

				IF @AdvertListID2 <> 0
				BEGIN 
					SET @Vansor = 1 
				END

				SET @Vanelteres = 1 
				IF (ISNULL(@AdvertID,'') = ISNULL(@AdvertID2,'')  
				AND	ISNULL(@Company,'') = ISNULL(@Company2,'')  
				AND ISNULL(@Title,'') = ISNULL(@Title2,'')
				AND ISNULL(@Description,'') = ISNULL(@Description2,'')
				AND ISNULL(@Locations,'') = ISNULL(@Locations2,'')
				AND ISNULL(@Categories,'') = ISNULL(@Categories2,'')
				AND ISNULL(@CompanyID,'') = ISNULL(@CompanyID2,'')
				AND ISNULL(@Department,'') = ISNULL(@Department2,'')
				AND ISNULL(@Requirements,'') = ISNULL(@Requirements2,'')
				AND ISNULL(@Qualities,'') = ISNULL(@Qualities2,'')
				AND ISNULL(@Benefits,'') = ISNULL(@Benefits2,'')
				AND ISNULL(@Min_Experience,'') = ISNULL(@Min_Experience2,'')
				AND ISNULL(@Min_Education,'') = ISNULL(@Min_Education2,'')
				AND ISNULL(@Driver_Licence,'') = ISNULL(@Driver_licence2,'')
				AND ISNULL(@Link,'') = ISNULL(@Link2,'')
				AND ISNULL(@Activation_Date,'') = ISNULL(@Activation_Date2,'')
				AND ISNULL(@Expiraton_Date,'') = ISNULL(@Expiraton_Date2,'')
				AND ISNULL(@Contract,'') = ISNULL(@Contract2,'')
				AND ISNULL(@Schedule,'') = ISNULL(@Schedule2,'')
				AND ISNULL(@Company_Name,'') = ISNULL(@Company_Name2,'')
				AND ISNULL(@Email,'') = ISNULL(@Email2,'')
				AND ISNULL(@Phone,'') = ISNULL(@Phone2,'')
				AND ISNULL(@Vacancy_NR,'') = ISNULL(@Vacancy_NR2,'')
				AND ISNULL(@Work_Location,'') = ISNULL(@Work_Location2,'')
				AND ISNULL(@Hide_Company,'') = ISNULL(@Hide_Company2,'')
				AND ISNULL(@Schow_Apply_Button,'') = ISNULL(@Schow_Apply_Button2,'')
				AND ISNULL(@Custom_Template_ID,'') = ISNULL(@Custom_Template_ID2,'')
				AND ISNULL(@Tasks,'') = ISNULL(@Tasks2,'')
				AND ISNULL(@Additional_Info,'') = ISNULL(@Additional_Info2,'')
				AND ISNULL(@Recruiter_Info,'') = ISNULL(@Recruiter_Info2,'')
				AND ISNULL(@Recruiter_ID,'') = ISNULL(@Recruiter_ID2,'')
				AND ISNULL(@Recruiter_Email,'') = ISNULL(@Recruiter_Email2,'')
				AND ISNULL(@Recruiter_Felvado,'') = ISNULL(@Recruiter_Felvado2,'')
				AND ISNULL(@Map_Job,'') = ISNULL(@Map_Job2,'')
				AND ISNULL(@CV,'') = ISNULL(@CV2,'')
				AND ISNULL(@Subsidiary,'') = ISNULL(@Subsidiary2,'')
				AND ISNULL(@Industry,'') = ISNULL(@Industry2,'')
				AND ISNULL(@Hierarchy_Level,'') = ISNULL(@Hierarchy_Level2,'')
				AND ISNULL(@Education_Type,'') = ISNULL(@Education_Type2,'')
				AND ISNULL(@Education_Field,'') = ISNULL(@Education_Field2,'')
				AND ISNULL(@Field_Of_Study,'') = ISNULL(@Field_Of_Study2,'')
				AND ISNULL(@Reference_Number,'') = ISNULL(@Reference_Number2,'')
				AND ISNULL(@Approval_Date,'') = ISNULL(@Approval_Date2,'')
				AND ISNULL(@Number_Of_Positions,'') = ISNULL(@Number_Of_Positions2,'')
				AND ISNULL(@Deleted,'') = ISNULL(@Deleted2,''))

				BEGIN
					SET @Vanelteres = 0
				END 

				IF (@Vansor = 0 or @Vanelteres = 1)
					INSERT INTO [dbo].[msk_kex_advertlistchangelog] 
								(AdvertListID
								,WebAdvertsID
								,AdvertID
								,Company 
								,Title
								,Description
								,Locations
								,Categories
								,CompanyID
								,Department
								,Requirements
								,Qualities
								,Benefits
								,Min_Experience
								,Min_Education
								,Driver_Licence
								,Link
								,Activation_Date
								,Expiraton_Date
								,Contract
								,Schedule
								,Company_Name
								,Email
								,Phone
								,Vacancy_NR
								,Work_Location
								,Hide_Company
								,Schow_Apply_Button
								,Custom_Template_ID
								,Tasks
								,Additional_Info
								,Recruiter_Info
								,Recruiter_ID
								,Recruiter_Email
								,Recruiter_Felvado
								,Map_Job
								,CV
								,Subsidiary
								,Industry
								,Hierarchy_level
								,Education_Type
								,Education_Field
								,Field_Of_Study
								,Reference_Number
								,Approval_Date
								,Number_Of_Positions
								,Created
								,Deleted)
						VALUES  (@AdvertListID
								,@WebAdvertsID
								,@AdvertID
								,@Company 
								,@Title
								,@Description
								,@Locations 
								,@Categories
								,@CompanyID
								,@Department
								,@Requirements
								,@Qualities
								,@Benefits
								,@Min_Experience
								,@Min_Education
								,@Driver_Licence
								,@Link
								,@Activation_Date
								,@Expiraton_Date
								,@Contract
								,@Schedule
								,@Company_Name
								,@Email
								,@Phone
								,@Vacancy_NR
								,@Work_Location
								,@Hide_Company
								,@Schow_Apply_Button
								,@Custom_Template_ID
								,@Tasks
								,@Additional_Info
								,@Recruiter_Info
								,@Recruiter_ID
								,@Recruiter_Email
								,@Recruiter_Felvado
								,@Map_Job
								,@CV
								,@Subsidiary
								,@Industry
								,@Hierarchy_level
								,@Education_Type
								,@Education_Field
								,@Field_Of_Study
								,@Reference_Number
								,@Approval_Date
								,@Number_Of_Positions
								,@Created
								,@Deleted)

              	  
					FETCH NEXT FROM @MyCursor INTO @AdvertListID 
												,@WebAdvertsID 
												,@AdvertID 
												,@Company 
												,@Title
												,@Description
												,@Locations 
												,@Categories
												,@CompanyID
												,@Department
												,@Requirements
												,@Qualities
												,@Benefits
												,@Min_Experience
												,@Min_Education
												,@Driver_Licence
												,@Link
												,@Activation_Date
												,@Expiraton_Date
												,@Contract
												,@Schedule
												,@Company_Name
												,@Email
												,@Phone
												,@Vacancy_NR
												,@Work_Location
												,@Hide_Company
												,@Schow_Apply_Button
												,@Custom_Template_ID
												,@Tasks
												,@Additional_Info
												,@Recruiter_Info
												,@Recruiter_ID
												,@Recruiter_Email
												,@Recruiter_Felvado
												,@Map_Job
												,@CV
												,@Subsidiary
												,@Industry
												,@Hierarchy_Level
												,@Education_Type
												,@Education_Field
												,@Field_Of_Study
												,@Reference_Number
												,@Approval_Date
												,@Number_Of_Positions
												,@Created
												,@Deleted

				END  
				CLOSE @MyCursor 
				DEALLOCATE @MyCursor 
			END
		END
	END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_manualis_anonimizalas.sql =====


CREATE PROCEDURE [dbo].[msk_kex_manualis_anonimizalas] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	
	DROP TABLE IF EXISTS #gdpr_gomb_anonimizalando_Dok
	CREATE TABLE #gdpr_gomb_anonimizalando_Dok (docID INT)
	
	DECLARE @tmp_filters TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filters execute osp_getPrsDataFromXml_Filters @prsID

	DECLARE @anonimindokID INT = (SELECT ornValue FROM @tmp_filters WHERE ornAlias = 'Idanonindok_ID' AND inOut = 'out' )

	DECLARE @ids TABLE
	(
		id INT
	)

	INSERT INTO @ids SELECT ornValue FROM @tmp_filters WHERE ornAlias = 'msk_kex_gdpr_jelentkezokID_ID' AND inOut = 'out'

	DECLARE @max_id INT = (SELECT MAX(id) FROM @ids)
	DELETE FROM @ids WHERE id = @max_id

	--SELECT @max_id
	--SELECT @anonimindokID
	--SELECT * FROM @tmp_filters
	--SELECT * FROM @ids

	;WITH Mycte (DocID) AS
		(	
			(	
			SELECT cvlinkid AS dok FROM dbo.msk_kex_gdpr_jelentkezok WHERE EXISTS (SELECT * FROM @ids WHERE id=msk_kex_gdpr_jelentkezokID)
			UNION
			SELECT JelentkezesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE EXISTS (SELECT * FROM @ids WHERE id=msk_kex_gdpr_jelentkezokID)
			UNION
			SELECT AdatkezelesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE EXISTS (SELECT * FROM @ids WHERE id=msk_kex_gdpr_jelentkezokID)
			UNION
			SELECT MotivaciosDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE EXISTS (SELECT * FROM @ids WHERE id=msk_kex_gdpr_jelentkezokID)
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE EXISTS (SELECT * FROM @ids WHERE id=msk_kex_gdpr_jelentkezokID)
			)
			EXCEPT
			(
			SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL
			UNION
			SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL
			UNION
			SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL
			UNION
			SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
			UNION
			SELECT MunkavallaloiDokID FROM dbo.msk_map_ajanlas WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
			)
		)
	UPDATE dbo.Document SET Deleted=9 
	OUTPUT [Inserted].[DocumentID]
	INTO #gdpr_gomb_anonimizalando_Dok
	WHERE EXISTS (SELECT * FROM Mycte WHERE DocumentID=DocID)

	/*LOG*/
	INSERT INTO [dbo].[msk_log]
	(
		[name],
		[value],
		[created]
	)
	SELECT
	'GDPR gombnyomásos anonimizálás',
	[AD].[docID],
	GETDATE()
	FROM #gdpr_gomb_anonimizalando_Dok [AD]

	update Msk_kex_hash set Deleted=1 where Msk_kex_hashID in (  select HASHID from msk_kex_gdpr_jelentkezok where msk_kex_gdpr_jelentkezokID in (SELECT * FROM @ids ))    
	UPDATE dbo.msk_kex_jelentkezok SET HASHID=NULL where nev='xxx' and HASHID in (  select HASHID from msk_kex_gdpr_jelentkezok where msk_kex_gdpr_jelentkezokID in (SELECT * FROM @ids ))     
	UPDATE dbo.msk_kex_gdpr_jelentkezok SET Idanonindok=@anonimindokID, nev='xxx', email='xxx', telefonszam='xxx', EmailCC='xxx', 
						cvlinkid = NULL, AdatkezelesiDokID = NULL, JelentkezesiDokID = NULL, MunkavallaloiDokID = NULL, MotivaciosDokID = NULL,
						cvlink='xxx', cvtartalom='xxx', ajanlo_nev='xxx', MAPCompany = 'xxx', MAPEmail='xxx', map_hatarido = NULL, 
						idmap_dokumentacio=NULL, MAPPeopleID=NULL, map_beerkezes = NULL,MAPAjanloszelvenyForrasa = NULL, MAPErvenyes = NULL, JelentkezokID= NULL, Deleted=1,HASHID=NULL 
	WHERE EXISTS (SELECT * FROM @ids WHERE id=msk_kex_gdpr_jelentkezokID)



	DELETE FROM dbo.msk_kex_gdpr_jelentkezok WHERE msk_kex_gdpr_jelentkezokID = @max_id

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_map_6_honap.sql =====

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2020-05-14
-- Description:	KEX - MAP adatok anonimizálása 6 hónap elteltével
-- =============================================
CREATE PROCEDURE [dbo].[msk_kex_map_6_honap]
AS
BEGIN

	SET NOCOUNT ON

	DROP TABLE IF EXISTS #anonimizalando_6honap
	DROP TABLE IF EXISTS #anonimizalandoDokumentumok_6honap
	SELECT * 
	INTO #anonimizalando_6honap
	FROM [dbo].[msk_kex_gdpr_jelentkezok] [MKGJ]
	WHERE ISNULL(IIF([MKGJ].map_beerkezes='1900-01-01',NULL, [MKGJ].[map_beerkezes]),'2900-01-01') <= DATEADD(MONTH, -6, GETDATE())
	AND MunkavallaloiDokID IS NOT NULL

	UPDATE[MKGJ]
		SET [MKGJ].ajanlo_nev = 'xxx',
			[MKGJ].MAPCompany = 'xxx',
			[MKGJ].MAPEmail = 'xxx',
			[MKGJ].map_hatarido = NULL,
			[MKGJ].idmap_dokumentacio = NULL,
			[MKGJ].MAPPeopleID = NULL,
			[MKGJ].map_beerkezes = NULL,
			[MKGJ].MAPAjanloszelvenyForrasa = NULL,
			[MKGJ].MAPErvenyes = 0,
			[MKGJ].JelentkezokID = NULL,
			[MKGJ].MunkavallaloiDokID = NULL
	FROM [dbo].[msk_kex_gdpr_jelentkezok] [MKGJ]
	INNER JOIN [#anonimizalando_6honap] [A] ON [A].[msk_kex_gdpr_jelentkezokID]=[MKGJ].[msk_kex_gdpr_jelentkezokID]


	/*Map 6 hónap miatt anonimizált Document rekordok Deleted=9-re állíátsa*/

	SELECT [A].[MunkavallaloiDokID] 
	INTO #anonimizalandoDokumentumok_6honap
	FROM [#anonimizalando_6honap] [A]
	EXCEPT
	(
	SELECT [MKJ].[MunkavallaloiDokID] FROM [dbo].[msk_kex_jelentkezok] [MKJ]
	UNION
	SELECT [MMA].[MunkavallaloiDokID] FROM [dbo].[msk_map_ajanlas] [MMA]
	)

	/*LOG*/
	INSERT INTO [dbo].[msk_log]
	(
		[name],
		[value],
		[created]
	)
	SELECT
	'MAP_6_hónap anonimizálás',
	[AD].[MunkavallaloiDokID],
	GETDATE()
	FROM [#anonimizalandoDokumentumok_6honap] [AD]

	UPDATE [D]
	SET [D].[Deleted]=9
	FROM [dbo].[Document] [D]
	INNER JOIN #anonimizalandoDokumentumok_6honap [A] ON [A].[MunkavallaloiDokID]=[D].[DocumentID]
	WHERE [D].[Deleted]=0

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_mjgy_feltoltes.sql =====


CREATE PROCEDURE [dbo].[msk_kex_mjgy_feltoltes]	
AS
BEGIN
    SET NOCOUNT ON

    

    DROP TABLE IF EXISTS [#ttPSTLZ]
	
    SELECT DISTINCT [P2].[PSTLZ]
    INTO [#ttPSTLZ]
    FROM [dbo].[People] [P2]
    WHERE [P2].[Deleted] = 0 AND [P2].[IsGroup] = 0

    MERGE [dbo].[msk_mjgy] [tgt]
    USING (
              SELECT [P].[PeopleID] AS [PeopleID_mjgy]
              FROM [#ttPSTLZ] [TP]
                  INNER JOIN [dbo].[People] [P] ( NOLOCK ) ON [TP].[PSTLZ] = [P].[PERNR]
                  INNER JOIN [dbo].[mft_AktivPeople]( NULL ) [MA] ON [MA].[PeopleID] = [P].[PeopleID]
              WHERE [P].[Deleted] = 0 AND [P].[IsGroup] = 0 AND [MA].[Aktiv] = 1
          ) [src]
    ON ( [tgt].[PeopleID_mjgy] = [src].[PeopleID_mjgy] )
    --WHEN MATCHED  THEN UPDATE SET [tgt].[PeopleID_mjgy] = [src].[PeopleID_mjgy]
    WHEN NOT MATCHED BY TARGET THEN INSERT ( [PeopleID_mjgy] )
                                    VALUES ( [src].[PeopleID_mjgy] )
    WHEN NOT MATCHED BY SOURCE THEN DELETE;
END
GO


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_PostDeployment.sql =====

CREATE PROCEDURE [dbo].[msk_kex_PostDeployment]

AS BEGIN
	SET NOCOUNT ON
	
print 'KEX POSTD Started'
IF NOT EXISTS (SELECT * FROM dbo.People WHERE TechnicalName LIKE 'Group_KEX%')
INSERT INTO dbo.People (CompanyID,Name,IsGroup,CreatedbyID,Active,TechnicalName)
VALUES
( 0, 'KEX _ Toborzási folyamatgazda', 1, 1, 1, 'Group_KEXTOBF'),
( 0, 'KEX _ Toborzó', 1, 1, 1, 'Group_KEXTOB')
ELSE SELECT 'A KEX szerepkörök már léteznek'


/* MSK_KEX_LOOKUPLIST*/
delete from [dbo].[msk_kex_LookupList]
SET IDENTITY_INSERT [dbo].[msk_kex_LookupList] ON 
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (1, 1, N'Igen', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (2, 1, N'Nem', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (3, 1, N'Talán', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (4, 2, N'Igen', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (5, 2, N'Nem', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (6, 3, N'Felvéve', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (7, 3, N'Elutasítva', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (8, 3, N'Visszalépett', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (9, 4, N'Vezetõ', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (10, 4, N'Mjgy', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (11, 5, N'', 0, 0, NULL, NULL)
INSERT [dbo].[msk_kex_LookupList] ([LookupListID], [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName]) VALUES (12, 5, N'*', 0, 0, NULL, NULL)
SET IDENTITY_INSERT [dbo].[msk_kex_LookupList] OFF

TRUNCATE TABLE [dbo].[msk_kex_szin]
SET IDENTITY_INSERT [dbo].[msk_kex_szin] ON 
--INSERT INTO [dbo].[msk_kex_szin] ([msk_kex_szinid],[nev],[szin],[deleted],[order]) VALUES ('1','piros','#FF0000','0','0'),('2','Ajánlatot elfogadta(kék)','#0000FF','0','6'),('3','CV alapján megfelel(narancs)','#FFA500','0','2'),('4','Interjú alapján megfelelt(barna)','#A0522D','0','3'),('5','Új jelentkezõ(fehér)','#dfdfdf','0','1'),('6','Felvéve(zöld)','#008000','0','7'),('7','Teszten megfelelt(bordó)','#8B0000','0','4'),('8','Nem felelt meg/Elutasítva/Visszalép(szürke)','#808080','0','8'),('10','Orvosin megfelelt(lila)','#808080','0','5')
INSERT INTO [dbo].[msk_kex_szin] ([msk_kex_szinid],[nev],[szin],[deleted],[order],[ID]) 
VALUES 
( 1, 'piros', 'piros', 0, 0 ,65),
( 2, 'Ajánlatot elfogadta', 'kék', 0, 12,66 ),
( 3, 'CV alapján megfelelt', 'narancs', 0, 2,67 ),
( 4, 'Interjú alapján megfelelt', 'barna', 0, 9,68 ),
( 5, 'Új jelentkezõ', 'fehér', 0, 1,69 ),
( 6, 'Felvéve', 'zöld', 0, 13,70 ),
( 7, 'Teszten megfelelt', 'bordó', 0, 10,71 ),
( 8, 'Nem felelt meg', 'szürke', 0, 14,72 ),
( 9, '-', '-', 1, 14,73 ),
( 10, 'Orvosin megfelelt', 'lila', 0, 11,74 ),
( 11, 'Elutasítva', 'szürke', 0, 15,75 ),
( 12, 'Visszalépett', 'szürke', 0, 16,76 ),
( 13, 'Toborzó igen', 'narancs', 0, 3,77 ),
( 14, 'Toborzó talán', 'narancs', 0, 4,78 ),
( 15, 'Toborzó nem', 'narancs', 0, 5,79 ),
( 16, 'Vezetõ igen', 'narancs', 0, 6,80 ),
( 17, 'Vezetõ talán', 'narancs', 0, 7,81 ),
( 18, 'Vezetõ nem', 'narancs', 0, 8,82 )
SET IDENTITY_INSERT [dbo].[msk_kex_szin] OFF

--/* KEX2 indításakor a jelentkezõ státuszait (felvéve, elutasítva, visszalépett) migrálja az új msk_kex_felvstatusz táblába */
----DELETE FROM dbo.msk_kex_felvstatusz --Csak elsõ alkalommal, ha kell, éles índítás után már nem szabad!!!
---- Ha a migráció eredménye is üres , akkor másodszor is lefut
--IF (select count(*) from [dbo].[msk_kex_felvstatusz]) <1
--BEGIN
--	print 'felvstatusz migráció'
--	INSERT INTO dbo.msk_kex_felvstatusz ()
--	  SELECT msk_kex_jelentkezokID, 
--				idfelveve, --idfelvstatusz
--				ISNULL((SELECT TOP 1 ChangedTime FROM dbo.FSYS_Log
--					WHERE BoType = 'MSKKEXJelentkezok'
--					AND Field = 'idfelveve' AND BoID = msk_kex_jelentkezokID
--					ORDER BY LogID DESC),'1901-01-01'), --státusz dátuma				
--				NULL, --belépés dátuma
--				idelutasitasindok, 
--				idvisszalepesindok, 
--				0 --deleted
--	  FROM dbo.msk_kex_jelentkezok
--	  WHERE idfelveve = 6 OR idfelveve = 7 OR idfelveve = 8
--END
--ELSE
--BEGIN
--	print 'Felvstatusz migráció nem kellett már nem üres'
--END

--/* KEX2 indításakor kitölti a HashID-val a jelentkezõk és gdpr jelentkezõk táblákat */
--IF (select count(*) from dbo.msk_kex_hash) <1
--BEGIN
--	UPDATE dbo.msk_kex_jelentkezok SET Updated=1 --ezzel nem fog lefutni az UPDATE trigger a Jelentkezõkön


--	DECLARE @MyCursor CURSOR
--	DECLARE @Myemail VARCHAR(255)
--	DECLARE @jelentkezoID INT
--	DECLARE @J_hashID INT
--	DECLARE @HashID INT
--	DECLARE @gdpr TINYINT
--	DECLARE @idceg INT
--		BEGIN
--				SET @MyCursor = CURSOR FOR select msk_kex_jelentkezokID, email, gdpr, HashID from dbo.msk_kex_jelentkezok WHERE Deleted=0 ORDER BY msk_kex_jelentkezokID ASC

--				OPEN @MyCursor 
--				FETCH NEXT FROM @MyCursor 
--				INTO  @jelentkezoID, @Myemail, @gdpr, @J_hashID

--				WHILE @@FETCH_STATUS = 0
--				BEGIN

--					SET @idceg = (SELECT TOP 1 a.idceg FROM msk_kex_jelentkezok j LEFT JOIN dbo.msk_kex_allasajanlatok a ON a.msk_kex_allasajanlatokID=j.idallasajanlat WHERE msk_kex_jelentkezokID=@jelentkezoID) --aktuális ajánlathoz tartozó idceg

--					IF ISNULL(@J_hashID,'')=''
--					BEGIN
--						IF @gdpr = 1
--							BEGIN
--								IF dbo.msk_kex_get_hash(@Myemail,@idceg) IN (SELECT Hash FROM dbo.msk_kex_hash WHERE Deleted=0)
--									BEGIN
--										SET @HashID = (SELECT TOP 1 Msk_kex_hashID FROM dbo.msk_kex_hash WHERE Hash = dbo.msk_kex_get_hash(@Myemail,@idceg) AND Deleted=0)
--									END
--								ELSE
--									BEGIN
--										INSERT INTO msk_kex_hash (Hash, Deleted) VALUES (dbo.msk_kex_get_hash(@Myemail,@idceg), 0)
--										SET @HashID = SCOPE_IDENTITY()
--									END
--							END
--						ELSE
--								IF dbo.msk_kex_get_hash(@Myemail,@idceg) IN (SELECT Hash FROM dbo.msk_kex_hash WHERE Deleted=1)
--									BEGIN
--										SET @HashID = (SELECT TOP 1 Msk_kex_hashID FROM dbo.msk_kex_hash WHERE Hash = dbo.msk_kex_get_hash(@Myemail,@idceg) AND Deleted=1)
--									END
--								ELSE
--									BEGIN
--										INSERT INTO msk_kex_hash (Hash, Deleted) VALUES (dbo.msk_kex_get_hash(@Myemail,@idceg), 1)
--										SET @HashID = SCOPE_IDENTITY()
--									END
--						UPDATE dbo.msk_kex_jelentkezok SET HashID=@HashID WHERE msk_kex_jelentkezokID=@jelentkezoID
--						UPDATE dbo.msk_kex_gdpr_jelentkezok SET HashID=@HashID WHERE email=@Myemail
--					END
					
--					FETCH NEXT FROM @MyCursor
--					INTO @jelentkezoID, @Myemail, @gdpr, @J_hashID
--				END; 

--				CLOSE @MyCursor;
--				DEALLOCATE @MyCursor;
--			END;

--END
--ELSE
--BEGIN
--	print 'A hash elõállítás nem kellett már nem üres'
--END

IF NOT EXISTS (SELECT * FROM [dbo].[msk_kex_lezarasindokok])
BEGIN
	SET IDENTITY_INSERT [dbo].[msk_kex_lezarasindokok] ON 
	INSERT INTO [dbo].[msk_kex_lezarasindokok] ([Msk_kex_lezarasindokokID],[Indokok],[Deleted]) VALUES ('1','Nem volt megfelelõ jelölt','0'),('2','A pozíció visszavonásra került','0'),('3','A pozíció újra meghirdetésre került','0'),('4','A pozíció betöltésre került','0')
	SET IDENTITY_INSERT [dbo].[msk_kex_lezarasindokok] OFF
END
ELSE
	SELECT 'A lezárás indokok migráció nem kellett már nem üres'

IF NOT EXISTS (SELECT * FROM [dbo].[msk_kex_mananonindokok])
BEGIN
	SET IDENTITY_INSERT [dbo].[msk_kex_mananonindokok] ON 
	INSERT INTO [dbo].[msk_kex_mananonindokok] ([Msk_kex_mananonindokokID],[Indokok],[Deleted]) VALUES ('1','A jelentkezõ kérésére az adatai anonimizálásra kerültek','0')
	SET IDENTITY_INSERT [dbo].[msk_kex_mananonindokok] OFF
END
ELSE
	SELECT 'A manuális anonim indokok migráció nem kellett már nem üres'

/* Vezetõk tábla feltöltése */

IF (select count(*) from dbo.msk_kex_allasajanlat_vezetok) <1
BEGIN
	DECLARE @idvezeto INT;
	DECLARE @idmunkaltato INT;
	DECLARE @msk_kex_allasajanlatokID INT;
	DECLARE @Deleted TINYINT;
    DECLARE @van_mjgy TINYINT;
	DECLARE @Allasajanlatok_cursor CURSOR;
	 
    BEGIN 
		SET @Allasajanlatok_cursor = CURSOR FOR
		SELECT [idvezeto]
		      ,[idmunkaltato]
			  ,[msk_kex_allasajanlatokID]
			  ,[Deleted]
		FROM [dbo].[msk_kex_allasajanlatok]
		WHERE [idmunkaltato] IS NOT NULL;

		OPEN @Allasajanlatok_cursor
		FETCH NEXT FROM @Allasajanlatok_cursor INTO @idvezeto
		                                           ,@idmunkaltato
	                                               ,@msk_kex_allasajanlatokID     
				           					       ,@Deleted
  
        WHILE @@FETCH_STATUS = 0
        BEGIN
		 SET @van_mjgy = (SELECT COUNT (*) FROM [dbo].[msk_mjgy] WHERE [PeopleID_mjgy] = @idvezeto) 

          INSERT INTO [dbo].[msk_kex_allasajanlat_vezetok]
           ([Idvezeto]
           ,[Idallasajanlat]
           ,[Mjgy]
           ,[Deleted]
		   ,[Statuszolovezeto])
           VALUES
           (@idmunkaltato
           ,@msk_kex_allasajanlatokID
           ,10 
           ,@Deleted
		   ,0)

       IF @idvezeto IS NOT NULL 
	   BEGIN 
           INSERT INTO [dbo].[msk_kex_allasajanlat_vezetok]
           ([Idvezeto]
           ,[Idallasajanlat]
           ,[Mjgy]
           ,[Deleted]
		   ,[Statuszolovezeto])
          VALUES
           (@idvezeto
           ,@msk_kex_allasajanlatokID
           ,CASE WHEN @van_mjgy = 0 then 9 else 10 end
           ,@Deleted
		   ,1)
        END


        FETCH NEXT FROM @Allasajanlatok_cursor INTO @idvezeto
		                                           ,@idmunkaltato
	                                               ,@msk_kex_allasajanlatokID     
		    		           					   ,@Deleted
     
        END;
		CLOSE @Allasajanlatok_cursor; 
		DEALLOCATE @Allasajanlatok_cursor;

	END
END

/* Email aláírás generálás */

DECLARE @toborzok_adatai TABLE(
PeopleID INT,
Nev VARCHAR(1000),
Munkakor VARCHAR(40),
Szervezet VARCHAR(40),
Cim VARCHAR(60),
Mobil VARCHAR(100),
Email VARCHAR(100),
AlairasID INT
)

INSERT INTO @toborzok_adatai SELECT p.PeopleID, p.Name, UPPER(LEFT(p.STLTX,1))+LOWER(SUBSTRING(p.STLTX,2,LEN(p.STLTX))), UPPER(LEFT(p.ORGTX,1))+LOWER(SUBSTRING(p.ORGTX,2,LEN(p.ORGTX))), p.MHELY, p.Mobile, p.Email, e.msk_kex_emailalairasID
				FROM dbo.People p
				LEFT JOIN dbo.PeopleGroupsPeople pgp ON p.PeopleID=pgp.PeopleID
				LEFT JOIN dbo.People pp ON pgp.GroupID=pp.PeopleID
				LEFT JOIN dbo.msk_kex_emailalairas e ON e.PeopleID=p.PeopleID
WHERE p.Deleted=0 AND pp.IsGroup=1 AND pgp.Deleted=0 AND pp.TechnicalName='Group_KEXTOB'

	DECLARE @MyCursor2 CURSOR;
	DECLARE @PeopleID INT;
	DECLARE @Nev VARCHAR(100)
	DECLARE @Munkakor VARCHAR(40)
	DECLARE @Szervezet VARCHAR(40)
	DECLARE @Cim VARCHAR(60)
	DECLARE @Mobil VARCHAR(100)
	DECLARE @Email VARCHAR(100)
	DECLARE @AlairasID INT
	DECLARE @Alairas VARCHAR(1000)
	DECLARE @CegID VARCHAR(10)
	DECLARE @CegNev VARCHAR(100)
	DECLARE @LogoLink VARCHAR(200)
	DECLARE @BaseURL VARCHAR(100)

		BEGIN
			SET @MyCursor2 = CURSOR FOR
			select PeopleID, Nev, Munkakor, Szervezet, Cim, Mobil, Email from @toborzok_adatai WHERE AlairasID IS NULL

				OPEN @MyCursor2 
				FETCH NEXT FROM @MyCursor2 
				INTO @PeopleID, @Nev, @Munkakor, @Szervezet, @Cim, @Mobil, @Email

				WHILE @@FETCH_STATUS = 0
				BEGIN
					
					SET @BaseURL = (SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code='BaseURL' AND Deleted=0)
					SET @CegID = (SELECT BUKRS FROM dbo.People WHERE PeopleID=@PeopleID)
					SET @CegNev = (SELECT TOP 1 Name FROM dbo.orn_SZI_Company WHERE VallalatKod=@CegID AND Deleted=0)
					SET @LogoLink = (SELECT CASE WHEN @CegID='1000' THEN '%base_url%ui/gfx/msk_mavlogo.png'
												 WHEN @CegID='2000' THEN '%base_url%ui/gfx/msk_startlogo.png'
												 WHEN @CegID='3000' THEN '%base_url%ui/gfx/msk_szklogo.png'
												 WHEN @CegID='4000' THEN '%base_url%ui/gfx/msk_fkglogo.png'
												 WHEN @CegID='5000' THEN '%base_url%ui/gfx/msk_hevlogo.png' END)
					SET @LogoLink = REPLACE(@LogoLink, '%base_url%', ISNULL(@BaseURL, ''))

				
					SET @Alairas = '<p><strong>@Nev</strong><br />@Munkakor</p><p><img alt="" src="@LogoLink" /></p><p>@CegNev<br />@Szervezet</p><p>@Cim<br />Mobil: @Mobil<br />Email: <a href="@Email">@Email</a><br />Honlap: <a href="http://www.mavcsoport.hu/">www.mavcsoport.hu</a></p>'
					SET @Alairas = REPLACE(@Alairas, '@Nev', ISNULL(@Nev, ''))
					SET @Alairas = REPLACE(@Alairas, '@Munkakor', ISNULL(@Munkakor, ''))
					SET @Alairas = REPLACE(@Alairas, '@Szervezet', ISNULL(@Szervezet, ''))
					SET @Alairas = REPLACE(@Alairas, '@Cim', ISNULL(@Cim, ''))
					SET @Alairas = REPLACE(@Alairas, '@Mobil', ISNULL(@Mobil, ''))
					SET @Alairas = REPLACE(@Alairas, '@Email', ISNULL(@Email, ''))
					SET @Alairas = REPLACE(@Alairas, '@LogoLink', ISNULL(@LogoLink, ''))
					SET @Alairas = REPLACE(@Alairas, '@CegNev', ISNULL(@CegNev, ''))

					INSERT INTO dbo.msk_kex_emailalairas
					(
					    PeopleID,
					    Alairas,
					    Deleted
					)
					VALUES
					(   @PeopleID,  -- PeopleID - int
					    @Alairas, -- Alairas - varchar(1000)
					    0   -- Deleted - tinyint
					    )
					
				  FETCH NEXT FROM @MyCursor2
				  INTO @PeopleID, @Nev, @Munkakor, @Szervezet, @Cim, @Mobil, @Email
				END; 

				CLOSE @MyCursor2;
				DEALLOCATE @MyCursor2;
		END;



/* advertlistchangelog tábla elsõ betöltése */

IF (select count(*) from dbo.msk_kex_advertlistchangelog) <1
BEGIN
	-- Végigmegy az orn_kex_LandingZone_AdvertList adatbázis táblán és azt összehasonlítja msk_kex_advertlistchangelog táblával:
	-- - ha ha az adott AdvertID-val NEM létezik rekord a msk_kex_advertlistchangelog táblában, akkor azt a rekordot beírtja msk_kex_advertlistchangelog táblába.
	-- - ha az adott AdvertID-val létezik rekord a msk_kex_advertlistchangelog táblában, akkor abból veszi a legutolsót, és tovább vizsgálja:
	-- --- ha a két rekord nem tér el egymástól, akkor NEM írja be.  
	-- --- ha a két rekord el tér egymástól, akkor azt a rekordot beírtja msk_kex_advertlistchangelog táblába.

	DECLARE @Msk_Kex_AdvertlistchangelogID INT 
	DECLARE @AdvertListID INT 
	DECLARE @WebAdvertsID INT 
	DECLARE @AdvertID varchar(8000) 
	DECLARE @Company varchar(8000) 
	DECLARE @Title varchar(8000) 
	DECLARE @Description varchar(8000) 
	DECLARE @Locations varchar(8000) 
	DECLARE @Categories varchar(8000) 
	DECLARE @CompanyID varchar(8000) 
	DECLARE @Department VARCHAR(8000) 
	DECLARE @Requirements VARCHAR(8000) 
	DECLARE @Qualities VARCHAR(8000) 
	DECLARE @Benefits VARCHAR(8000) 
	DECLARE @Min_Experience VARCHAR(8000) 
	DECLARE @Min_Education VARCHAR(8000) 
	DECLARE @Driver_Licence VARCHAR(8000) 
	DECLARE @Link varchar(8000) 
	DECLARE @Activation_Date VARCHAR(8000) 
	DECLARE @Expiraton_Date VARCHAR(8000) 
	DECLARE @Contract VARCHAR(8000) 
	DECLARE @Schedule VARCHAR(8000) 
	DECLARE @Company_Name VARCHAR(8000) 
	--DECLARE @Email VARCHAR(8000) 
	DECLARE @Phone VARCHAR(8000) 
	DECLARE @Vacancy_NR VARCHAR(8000) 
	DECLARE @Work_Location VARCHAR(8000) 
	DECLARE @Hide_Company VARCHAR(8000) 
	DECLARE @Schow_Apply_Button VARCHAR(8000) 
	DECLARE @Custom_Template_ID VARCHAR(8000) 
	DECLARE @Tasks VARCHAR(8000) 
	DECLARE @Additional_Info VARCHAR(8000) 
	DECLARE @Recruiter_Info VARCHAR(8000) 
	DECLARE @Recruiter_ID VARCHAR(8000) 
	DECLARE @Recruiter_email VARCHAR(8000) 
	DECLARE @Recruiter_Felvado VARCHAR(8000) 
	DECLARE @Map_Job VARCHAR(8000) 
	DECLARE @CV VARCHAR(8000) 
	DECLARE @Subsidiary VARCHAR(8000) 
	DECLARE @Industry VARCHAR(8000) 
	DECLARE @Hierarchy_Level VARCHAR(8000) 
	DECLARE @Education_Type VARCHAR(8000) 
	DECLARE @Education_Field VARCHAR(8000) 
	DECLARE @Field_Of_Study VARCHAR(8000) 
	DECLARE @Reference_Number VARCHAR(8000) 
	DECLARE @Approval_Date VARCHAR(8000) 
	DECLARE @Number_Of_Positions VARCHAR(8000) 
	DECLARE @Created DATETIME 
	--DECLARE @Deleted TINYINT 

	DECLARE @Msk_Kex_AdvertlistchangelogID2 INT 
	DECLARE @AdvertListID2 INT 
	DECLARE @WebAdvertsID2 INT 
	DECLARE @AdvertID2 varchar(8000) 
	DECLARE @Company2 varchar(8000) 
	DECLARE @Title2 varchar(8000) 
	DECLARE @Description2 varchar(8000) 
	DECLARE @Locations2 varchar(8000) 
	DECLARE @Categories2 varchar(8000) 
	DECLARE @CompanyID2 varchar(8000) 
	DECLARE @Department2 VARCHAR(8000) 
	DECLARE @Requirements2 VARCHAR(8000) 
	DECLARE @Qualities2 VARCHAR(8000) 
	DECLARE @Benefits2 VARCHAR(8000) 
	DECLARE @Min_Experience2 VARCHAR(8000) 
	DECLARE @Min_Education2 VARCHAR(8000) 
	DECLARE @Driver_Licence2 VARCHAR(8000) 
	DECLARE @Link2 VARCHAR(8000) 
	DECLARE @Activation_Date2 VARCHAR(8000) 
	DECLARE @Expiraton_Date2 VARCHAR(8000) 
	DECLARE @Contract2 VARCHAR(8000) 
	DECLARE @Schedule2 VARCHAR(8000) 
	DECLARE @Company_Name2 VARCHAR(8000) 
	DECLARE @Email2 VARCHAR(8000) 
	DECLARE @Phone2 VARCHAR(8000) 
	DECLARE @Vacancy_NR2 VARCHAR(8000) 
	DECLARE @Work_Location2 VARCHAR(8000) 
	DECLARE @Hide_Company2 VARCHAR(8000) 
	DECLARE @Schow_Apply_Button2 VARCHAR(8000) 
	DECLARE @Custom_Template_ID2 VARCHAR(8000) 
	DECLARE @Tasks2 VARCHAR(8000) 
	DECLARE @Additional_Info2 VARCHAR(8000) 
	DECLARE @Recruiter_Info2 VARCHAR(8000) 
	DECLARE @Recruiter_id2 VARCHAR(8000) 
	DECLARE @Recruiter_Email2 VARCHAR(8000) 
	DECLARE @Recruiter_Felvado2 VARCHAR(8000) 
	DECLARE @Map_Job2 VARCHAR(8000) 
	DECLARE @CV2 VARCHAR(8000) 
	DECLARE @Subsidiary2 VARCHAR(8000) 
	DECLARE @Industry2 VARCHAR(8000) 
	DECLARE @Hierarchy_Level2 VARCHAR(8000) 
	DECLARE @Education_Type2 VARCHAR(8000) 
	DECLARE @Education_Field2 VARCHAR(8000) 
	DECLARE @Field_Of_Study2 VARCHAR(8000) 
	DECLARE @Reference_Number2 VARCHAR(8000) 
	DECLARE @Approval_Date2 VARCHAR(8000) 
	DECLARE @Number_Of_Positions2 VARCHAR(8000) 
	DECLARE @Created2 DATETIME 
	DECLARE @Deleted2 TINYINT 

	DECLARE @Vansor TINYINT  -- Figyeli, ha az adott AdvertID-val létezik-e rekord a msk_kex_advertlistchangelog táblában (0:nincs, 1:van) 
	DECLARE @Vanelteres TINYINT 	-- Ha az adott AdvertID-val létezik rekord a msk_kex_advertlistchangelog táblában, akkor abból veszi a legutolsót, és ez a 'flag' figyeli, 
										-- hogy a két rekord eltér-e egymástól (0:nem tér el, 1: eltér)


	DECLARE @MyCursor CURSOR 

	BEGIN
		SET @MyCursor = CURSOR FOR select	AdvertListID 
											,WebAdvertsID 
											,AdvertID 
											,Company 
											,Title
											,Description
											,Locations 
											,Categories
											,CompanyID
											,Department
											,Requirements
											,Qualities
											,Benefits
											,Min_Experience
											,Min_Education
											,Driver_Licence
											,Link
											,Activation_Date
											,Expiraton_Date
											,Contract
											,Schedule
											,Company_Name
											,Email
											,Phone
											,Vacancy_NR
											,Work_Location
											,Hide_Company
											,Schow_Apply_Button
											,Custom_Template_ID
											,Tasks
											,Additional_Info
											,Recruiter_Info
											,Recruiter_ID
											,Recruiter_Email
											,Recruiter_Felvado
											,Map_Job
											,CV
											,Subsidiary
											,Industry
											,Hierarchy_Level
											,Education_Type
											,Education_Field
											,Field_Of_Study
											,Reference_Number
											,Approval_Date
											,Number_Of_Positions
											,Created
											,Deleted

		FROM [orn_kex_LandingZone_AdvertList] 
		WHERE CAST(Created as date) <= CAST(DATEADD(DAY, -1, getdate()) AS date)   -- 'tegnapig' mindent 
	--	WHERE CAST(Created as date) <= CAST('2018.11.16' AS date) --teszteléshez kellett

		ORDER BY [AdvertListID]

		OPEN @MyCursor 
		FETCH NEXT FROM @MyCursor INTO   @AdvertListID 
										,@WebAdvertsID 
										,@AdvertID 
										,@Company 
										,@Title
										,@Description
										,@Locations 
										,@Categories
										,@CompanyID
										,@Department
										,@Requirements
										,@Qualities
										,@Benefits
										,@Min_Experience
										,@Min_Education
										,@Driver_Licence
										,@Link
										,@Activation_Date
										,@Expiraton_Date
										,@Contract
										,@Schedule
										,@Company_Name
										,@Email
										,@Phone
										,@Vacancy_NR
										,@Work_Location
										,@Hide_Company
										,@Schow_Apply_Button
										,@Custom_Template_ID
										,@Tasks
										,@Additional_Info
										,@Recruiter_Info
										,@Recruiter_ID
										,@Recruiter_Email
										,@Recruiter_Felvado
										,@Map_Job
										,@CV
										,@Subsidiary
										,@Industry
										,@Hierarchy_Level
										,@Education_Type
										,@Education_Field
										,@Field_Of_Study
										,@Reference_Number
										,@Approval_Date
										,@Number_Of_Positions
										,@Created
										,@Deleted

		WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @Vansor = 0
			SET @AdvertListID2 = 0
			SELECT TOP (1)	 @AdvertListID2 =  AdvertListID 
							,@WebAdvertsID2 =  WebAdvertsID 
							,@AdvertID2     =  AdvertID
							,@Company2      =  Company
							,@Title2        =  Title
							,@Description2  =  Description 
							,@Locations2    =  Locations
							,@Categories2   =  Categories
							,@CompanyID2    =  CompanyID 
							,@Department2   =  Department
							,@Requirements2 =  Requirements
							,@Qualities2    =  Qualities 
							,@Benefits2     =  Benefits
							,@Min_Experience2 = Min_Experience
							,@Min_Education2  = Min_Education
							,@Driver_Licence2 = Driver_Licence
							,@Link2			= Link
							,@Activation_Date2 = Activation_Date
							,@Expiraton_Date2  = Expiraton_Date
							,@Contract2        = Contract
							,@Schedule2        = Schedule
							,@Company_Name2    = Company_Name 
							,@Email2           = Email
							,@Phone2           = Phone
							,@Vacancy_NR2      = Vacancy_NR
							,@Work_Location2   = Work_Location
							,@Hide_Company2    = Hide_Company
							,@Schow_Apply_Button2  = Schow_Apply_Button
							,@Custom_Template_ID2  = Custom_Template_ID
							,@Tasks2               = Tasks
							,@Additional_Info2     = Additional_Info
							,@Recruiter_Info2      = Recruiter_Info
							,@Recruiter_ID2        = Recruiter_ID
							,@Recruiter_Email2     = Recruiter_Email
							,@Recruiter_Felvado2   = Recruiter_Felvado
							,@Map_Job2             = Map_Job
							,@CV2                  = CV
							,@Subsidiary2          = Subsidiary
							,@Industry2            = Industry
							,@Hierarchy_Level2     = Hierarchy_Level
							,@Education_Type2      = Education_Type
							,@Education_Field2     = Education_Field
							,@Field_Of_Study2      = Field_Of_Study
							,@Reference_Number2    = Reference_Number
							,@Approval_Date2       = Approval_Date
							,@Number_Of_Positions2 = Number_Of_Positions
							,@Created2			 = Created
							,@Deleted2			 = Deleted	
			 
			FROM [msk_kex_advertlistchangelog] 
			WHERE @AdvertID = [AdvertID]
			ORDER BY [AdvertListID] desc

			IF @AdvertListID2 <> 0
			BEGIN 
				SET @Vansor = 1 
			END

			SET @Vanelteres = 1 
			IF (ISNULL(@AdvertID,'') = ISNULL(@AdvertID2,'')  
			AND	ISNULL(@Company,'') = ISNULL(@Company2,'')  
			AND ISNULL(@Title,'') = ISNULL(@Title2,'')
			AND ISNULL(@Description,'') = ISNULL(@Description2,'')
			AND ISNULL(@Locations,'') = ISNULL(@Locations2,'')
			AND ISNULL(@Categories,'') = ISNULL(@Categories2,'')
			AND ISNULL(@CompanyID,'') = ISNULL(@CompanyID2,'')
			AND ISNULL(@Department,'') = ISNULL(@Department2,'')
			AND ISNULL(@Requirements,'') = ISNULL(@Requirements2,'')
			AND ISNULL(@Qualities,'') = ISNULL(@Qualities2,'')
			AND ISNULL(@Benefits,'') = ISNULL(@Benefits2,'')
			AND ISNULL(@Min_Experience,'') = ISNULL(@Min_Experience2,'')
			AND ISNULL(@Min_Education,'') = ISNULL(@Min_Education2,'')
			AND ISNULL(@Driver_Licence,'') = ISNULL(@Driver_licence2,'')
			AND ISNULL(@Link,'') = ISNULL(@Link2,'')
			AND ISNULL(@Activation_Date,'') = ISNULL(@Activation_Date2,'')
			AND ISNULL(@Expiraton_Date,'') = ISNULL(@Expiraton_Date2,'')
			AND ISNULL(@Contract,'') = ISNULL(@Contract2,'')
			AND ISNULL(@Schedule,'') = ISNULL(@Schedule2,'')
			AND ISNULL(@Company_Name,'') = ISNULL(@Company_Name2,'')
			AND ISNULL(@Email,'') = ISNULL(@Email2,'')
			AND ISNULL(@Phone,'') = ISNULL(@Phone2,'')
			AND ISNULL(@Vacancy_NR,'') = ISNULL(@Vacancy_NR2,'')
			AND ISNULL(@Work_Location,'') = ISNULL(@Work_Location2,'')
			AND ISNULL(@Hide_Company,'') = ISNULL(@Hide_Company2,'')
			AND ISNULL(@Schow_Apply_Button,'') = ISNULL(@Schow_Apply_Button2,'')
			AND ISNULL(@Custom_Template_ID,'') = ISNULL(@Custom_Template_ID2,'')
			AND ISNULL(@Tasks,'') = ISNULL(@Tasks2,'')
			AND ISNULL(@Additional_Info,'') = ISNULL(@Additional_Info2,'')
			AND ISNULL(@Recruiter_Info,'') = ISNULL(@Recruiter_Info2,'')
			AND ISNULL(@Recruiter_ID,'') = ISNULL(@Recruiter_ID2,'')
			AND ISNULL(@Recruiter_Email,'') = ISNULL(@Recruiter_Email2,'')
			AND ISNULL(@Recruiter_Felvado,'') = ISNULL(@Recruiter_Felvado2,'')
			AND ISNULL(@Map_Job,'') = ISNULL(@Map_Job2,'')
			AND ISNULL(@CV,'') = ISNULL(@CV2,'')
			AND ISNULL(@Subsidiary,'') = ISNULL(@Subsidiary2,'')
			AND ISNULL(@Industry,'') = ISNULL(@Industry2,'')
			AND ISNULL(@Hierarchy_Level,'') = ISNULL(@Hierarchy_Level2,'')
			AND ISNULL(@Education_Type,'') = ISNULL(@Education_Type2,'')
			AND ISNULL(@Education_Field,'') = ISNULL(@Education_Field2,'')
			AND ISNULL(@Field_Of_Study,'') = ISNULL(@Field_Of_Study2,'')
			AND ISNULL(@Reference_Number,'') = ISNULL(@Reference_Number2,'')
			AND ISNULL(@Approval_Date,'') = ISNULL(@Approval_Date2,'')
			AND ISNULL(@Number_Of_Positions,'') = ISNULL(@Number_Of_Positions2,'')
			AND ISNULL(@Deleted,'') = ISNULL(@Deleted2,''))

			BEGIN
				SET @Vanelteres = 0
			END 

			IF (@Vansor = 0 or @Vanelteres = 1)
				INSERT INTO [dbo].[msk_kex_advertlistchangelog] 
							(AdvertListID
							,WebAdvertsID
							,AdvertID
							,Company 
							,Title
							,Description
							,Locations
							,Categories
							,CompanyID
							,Department
							,Requirements
							,Qualities
							,Benefits
							,Min_Experience
							,Min_Education
							,Driver_Licence
							,Link
							,Activation_Date
							,Expiraton_Date
							,Contract
							,Schedule
							,Company_Name
							,Email
							,Phone
							,Vacancy_NR
							,Work_Location
							,Hide_Company
							,Schow_Apply_Button
							,Custom_Template_ID
							,Tasks
							,Additional_Info
							,Recruiter_Info
							,Recruiter_ID
							,Recruiter_Email
							,Recruiter_Felvado
							,Map_Job
							,CV
							,Subsidiary
							,Industry
							,Hierarchy_level
							,Education_Type
							,Education_Field
							,Field_Of_Study
							,Reference_Number
							,Approval_Date
							,Number_Of_Positions
							,Created
							,Deleted)
					VALUES  (@AdvertListID
							,@WebAdvertsID
							,@AdvertID
							,@Company 
							,@Title
							,@Description
							,@Locations 
							,@Categories
							,@CompanyID
							,@Department
							,@Requirements
							,@Qualities
							,@Benefits
							,@Min_Experience
							,@Min_Education
							,@Driver_Licence
							,@Link
							,@Activation_Date
							,@Expiraton_Date
							,@Contract
							,@Schedule
							,@Company_Name
							,@Email
							,@Phone
							,@Vacancy_NR
							,@Work_Location
							,@Hide_Company
							,@Schow_Apply_Button
							,@Custom_Template_ID
							,@Tasks
							,@Additional_Info
							,@Recruiter_Info
							,@Recruiter_ID
							,@Recruiter_Email
							,@Recruiter_Felvado
							,@Map_Job
							,@CV
							,@Subsidiary
							,@Industry
							,@Hierarchy_level
							,@Education_Type
							,@Education_Field
							,@Field_Of_Study
							,@Reference_Number
							,@Approval_Date
							,@Number_Of_Positions
							,@Created
							,@Deleted)

              	  
				FETCH NEXT FROM @MyCursor INTO @AdvertListID 
											,@WebAdvertsID 
											,@AdvertID 
											,@Company 
											,@Title
											,@Description
											,@Locations 
											,@Categories
											,@CompanyID
											,@Department
											,@Requirements
											,@Qualities
											,@Benefits
											,@Min_Experience
											,@Min_Education
											,@Driver_Licence
											,@Link
											,@Activation_Date
											,@Expiraton_Date
											,@Contract
											,@Schedule
											,@Company_Name
											,@Email
											,@Phone
											,@Vacancy_NR
											,@Work_Location
											,@Hide_Company
											,@Schow_Apply_Button
											,@Custom_Template_ID
											,@Tasks
											,@Additional_Info
											,@Recruiter_Info
											,@Recruiter_ID
											,@Recruiter_Email
											,@Recruiter_Felvado
											,@Map_Job
											,@CV
											,@Subsidiary
											,@Industry
											,@Hierarchy_Level
											,@Education_Type
											,@Education_Field
											,@Field_Of_Study
											,@Reference_Number
											,@Approval_Date
											,@Number_Of_Positions
											,@Created
											,@Deleted

		END  
		CLOSE @MyCursor 
		DEALLOCATE @MyCursor 
	END

/* KEX email sablonok alapfeltötlés */

IF (select count(*) from dbo.orn_szi_EmailTemplateSample WHERE technical_name='kex_mav') <1
  BEGIN
	INSERT INTO dbo.orn_szi_EmailTemplateSample ( [TemplateName],[EmailSubject],[EmailBody],[Active],[technical_name],[Created],[CreatedByID],Deleted)	VALUES
	( 'Általános elutasító levél CV alapján', 'Általános elutasító levél CV alapján', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val v&aacute;llalatunkat &eacute;s jelentkezett a karrierport&aacute;lon meghirdetett&nbsp;%allas_neve% poz&iacute;ci&oacute;nkra!</p>

	<p>A rendelkez&eacute;s&uuml;nkre bocs&aacute;tott adatok alapj&aacute;n megvizsg&aacute;ltuk foglalkoztat&aacute;s&aacute;nak lehetõs&eacute;g&eacute;t, ez&uacute;ttal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk.</p>

	<p>Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a> oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>M&Aacute;V Zrt.</p>
	', 1, 'kex_mav', N'2019-07-24T07:04:59', 518, 0 ), 
	( 'Elutasító levél kiválasztásban részt vett jelentkezõknek', 'Elutasító levél kiválasztásban részt vett jelentkezõknek', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nettel vett&uuml;k jelentkez&eacute;s&eacute;t v&aacute;llalatunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra, &eacute;s ez&uacute;ton is szeretn&eacute;nk megk&ouml;sz&ouml;nni t&uuml;relm&eacute;t az elh&uacute;z&oacute;d&oacute; kiv&aacute;laszt&aacute;si folyamat miatt.</p>

	<p>A rendelkez&eacute;s&uuml;nkre bocs&aacute;tott adatok alapj&aacute;n megvizsg&aacute;ltuk foglalkoztat&aacute;s&aacute;nak lehetõs&eacute;g&eacute;t.</p>

	<p>Jelenleg v&eacute;gzetts&eacute;g&eacute;nek &eacute;s szakmai tapasztalat&aacute;nak megfelelõ munkak&ouml;rt nem tudunk aj&aacute;nlani &Ouml;nnek. Aktu&aacute;lis &aacute;ll&aacute;saj&aacute;nlatainkat nyomon k&ouml;vetheti a karrier oldalunkon: <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a></p>

	<p>Amennyiben k&eacute;pzetts&eacute;g&eacute;nek, gyakorlat&aacute;nak, elk&eacute;pzel&eacute;seinek megfelelõ aj&aacute;nlatot tal&aacute;l, sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t ezen a fel&uuml;leten.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>M&Aacute;V Zrt.</p>
	', 1, 'kex_mav', N'2019-07-24T07:07:26', 518, 0 ), 
	( 'Interjú meghívó hosszabb', 'Interjú meghívó hosszabb', '<p>Tisztelt %cimzett%!</p>

	<p>Telefonos megbesz&eacute;l&eacute;s&uuml;nkre hivatkozva k&uuml;ld&ouml;m a %allas_neve% interj&uacute;val kapcsolatos r&eacute;szleteket.</p>

	<p>Az interj&uacute; idõpontja: &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	Helysz&iacute;n: &lt;helysz&iacute;n&gt;</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t. K&eacute;rem, ezt hozza mag&aacute;val &eacute;s engem keressen a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t.</p>

	<p>Az interj&uacute;n &lt;interj&uacute;ztat&oacute; neve&gt;, &lt;interj&uacute;ztat&oacute; poz&iacute;ci&oacute;ja&gt; &eacute;s &lt;toborz&oacute; neve&gt;, &lt;toborz&oacute; poz&iacute;ci&oacute;ja&gt; fog tal&aacute;lkozni.</p>

	<p>Interj&uacute; t&iacute;pusa: kompetencia alap&uacute; &eacute;s szakmai interj&uacute;<br />
	Az interj&uacute; fõbb t&eacute;mak&ouml;rei:</p>

	<ul>
		<li>Tanulm&aacute;nyok</li>
		<li>Eddigi poz&iacute;ci&oacute;k &eacute;s felelõss&eacute;gi k&ouml;r&ouml;k</li>
		<li>Eddig el&eacute;rt teljes&iacute;tm&eacute;nyek</li>
		<li>Motiv&aacute;ci&oacute;k, preferenci&aacute;k, kompetenci&aacute;k</li>
	</ul>

	<p>Csatolva k&uuml;ld&ouml;m a poz&iacute;ci&oacute; le&iacute;r&aacute;s&aacute;t &ndash; k&eacute;rem, ezt olvassa &aacute;t &eacute;s ez alapj&aacute;n k&eacute;sz&uuml;lj&ouml;n f&ouml;l.</p>

	<p>&Eacute;rdemes lehet megn&eacute;zni besz&eacute;lget&eacute;s&uuml;nk elõtt weboldalunkat. A c&eacute;grõl &eacute;s c&eacute;gcsoportr&oacute;l bõvebb inform&aacute;ci&oacute;t tal&aacute;lhat a k&ouml;vetkezõ linkeken:</p>

	<ul>
		<li><a href="https://www.mavcsoport.hu/mav-csoport/bemutatkozas" target="_blank">https://www.mavcsoport.hu/mav-csoport/bemutatkozas</a></li>
		<li><a href="https://www.mavcsoport.hu/mav/bemutatkozas" target="_blank">https://www.mavcsoport.hu/mav/bemutatkozas</a></li>
		<li><a href="https://www.mavcsoport.hu/mav/szervezeti-felepites" target="_blank">https://www.mavcsoport.hu/mav/szervezeti-felepites</a></li>
	</ul>

	<p>Ha b&aacute;rmilyen k&eacute;rd&eacute;s mer&uuml;l fel &Ouml;nben az interj&uacute; elõtt, k&eacute;rem keressen b&aacute;tran a lenti el&eacute;rhetõs&eacute;geken.</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>

	<p>&nbsp;</p>
	', 1, 'kex_mav', N'2019-07-24T07:08:17', 518, 0 ), 
	( 'Interjú meghívó rövidebb', 'Interjú meghívó rövidebb', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t t&aacute;rsas&aacute;gunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra.<br />
	&Ouml;n&eacute;letrajza alapj&aacute;n szeretn&eacute;nk megh&iacute;vni &Ouml;nt egy interj&uacute;ra.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t, valamint szem&eacute;lyes iratait.</p>

	<p>Az interj&uacute; idõpontja: &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	Az interj&uacute; helysz&iacute;ne: &lt;helysz&iacute;n&gt;</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_mav', N'2019-07-24T07:12:51', 518, 0 ), 
	( 'Értesítés keresés elhúzódásáról', 'Értesítés keresés elhúzódásáról', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t t&aacute;rsas&aacute;gunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra.</p>

	<p>Ez&uacute;ton t&aacute;j&eacute;koztatjuk, hogy a kiv&aacute;laszt&aacute;si folyamat elh&uacute;z&oacute;dik, ami&eacute;rt sz&iacute;ves eln&eacute;z&eacute;s&eacute;t k&eacute;rj&uuml;k.<br />
	P&aacute;ly&aacute;zat&aacute;t v&aacute;llalatunk r&eacute;sz&eacute;rõl tov&aacute;bbra is aktu&aacute;lisnak tekintj&uuml;k &eacute;s amint lehets&eacute;ges visszajelz&uuml;nk.</p>

	<p>T&uuml;relm&eacute;t &eacute;s meg&eacute;rt&eacute;s&eacute;t k&ouml;sz&ouml;nj&uuml;k!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:36:19', 518, 0 ), 
	( 'Orvosi meghívó (203)', 'Orvosi meghívó (203)', '<p>Tisztelt %cimzett%!</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;sek&eacute;nt szeretn&eacute;nk, ha r&eacute;szt venne egy elõzetes alkalmass&aacute;gi orvosi vizsg&aacute;laton.</p>

	<p>Idõpontja: &lt;pontos d&aacute;tum &eacute;s &oacute;ra&gt;<br />
	Helysz&iacute;ne: &lt;pontos helysz&iacute;n&gt;<br />
	Orvos: &lt;orvos neve&gt;</p>

	<p>Fontos tudnival&oacute;k:</p>

	<ul>
		<li>k&eacute;rj&uuml;k a vizsg&aacute;latra &eacute;hgyomorra, kipihenten jelenjen meg (a cukros &uuml;d&iacute;tõital, k&aacute;v&eacute;, energiaital fogyaszt&aacute;s&aacute;t is ker&uuml;lje a labor v&eacute;rvizsg&aacute;lat elõtt)</li>
		<li>amennyiben valamilyen kezelt betegs&eacute;ge van, az orvosi leleteit felt&eacute;tlen&uuml;l vigye mag&aacute;val</li>
		<li>mivel t&ouml;bb vizsg&aacute;laton vesz r&eacute;szt, k&eacute;rj&uuml;k hozzon mag&aacute;val enni- &eacute;s innival&oacute;t, melyet a v&eacute;rv&eacute;tel ut&aacute;n elfogyaszthat</li>
	</ul>

	<p>A vizsg&aacute;latokat szab&aacute;lyoz&oacute; korm&aacute;nyrendeletet az al&aacute;bbi internetes oldalon tekintheti meg: <a href="http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476" target="_blank">http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476</a></p>

	<p>K&eacute;rem, a vizsg&aacute;latok v&eacute;g&eacute;n az eredm&eacute;nyrõl (azaz, hogy alkalmas vagy nem alkalmas) &eacute;rtes&iacute;tsen, &eacute;s a hat&aacute;rozat munk&aacute;ltat&oacute;i p&eacute;ld&aacute;ny&aacute;t juttassa el hozz&aacute;m - c&iacute;mem: &lt;pontos c&iacute;m, el&eacute;rhetõs&eacute;g&gt;</p>

	<p>Amennyiben m&eacute;gsem tud r&eacute;szt venni a vizsg&aacute;laton a megadott idõpontban, k&eacute;rem min&eacute;l hamarabb, lehetõleg a vizsg&aacute;latot megelõzõen legal&aacute;bb h&aacute;rom nappal jelezze fel&eacute;m.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_mav', N'2019-07-24T07:13:42', 518, 0 ), 
	( 'Tesztre meghívó', 'Tesztre meghívó', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t a meghirdetett %allas_neve% poz&iacute;ci&oacute;ra.</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;se a teszt&iacute;r&aacute;s/kompetencia felm&eacute;r&eacute;s, melyre ez&uacute;ton szeretn&eacute;nk megh&iacute;vni.</p>

	<p>A teszt&iacute;r&aacute;s/kompetencia felm&eacute;r&eacute;s idõpontja: &lt;Teszt kezdõ d&aacute;tuma, &oacute;ra, perc&gt;.<br />
	Helysz&iacute;n: &lt;helysz&iacute;n&gt;</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t.<br />
	K&eacute;rem, ezt hozza mag&aacute;val &eacute;s &lt;toborz&oacute; neve&gt;-t keresse a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy r&eacute;szv&eacute;teli sz&aacute;nd&eacute;k&aacute;t erre a lev&eacute;lre k&uuml;ld&ouml;tt v&aacute;lasz&aacute;val jelezze.</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_mav', N'2019-07-24T07:14:55', 518, 0 ), 
	( 'Általános elutasító CV alapján', 'Általános elutasító CV alapján', '<p>Tisztelt&nbsp;%cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve% poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a> oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:17:42', 518, 0 ), 
	( 'Egyszerûsített jelentkezési felületes', 'Egyszerûsített jelentkezési felületes', '<p>Kedves %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k &eacute;rdeklõd&eacute;s&eacute;t &eacute;s jelentkez&eacute;s&eacute;t %allas_neve% poz&iacute;ci&oacute;nkra.</p>

	<p>A kiv&aacute;laszt&aacute;si-folyamat k&ouml;vetkezõ l&eacute;p&eacute;seivel kapcsolatban az &Ouml;n &aacute;ltal megadott el&eacute;rhetõs&eacute;gek egyik&eacute;n hamarosan keresni fogjuk.</p>

	<p>A M&Aacute;V-csoport tov&aacute;bbi &aacute;ll&aacute;saj&aacute;nlatait nyomon k&ouml;vetheti a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a>&nbsp;oldalon. Amennyiben m&aacute;s, a k&eacute;pzetts&eacute;g&eacute;nek, gyakorlat&aacute;nak, elk&eacute;pzel&eacute;seinek megfelelõ aj&aacute;nlatot tal&aacute;l, sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t ezen a fel&uuml;leten.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>A M&Aacute;V-H&Eacute;V Zrt. toborz&aacute;s-kiv&aacute;laszt&aacute;si csapata</p>
	', 1, 'kex_hev', N'2019-07-24T07:18:39', 518, 0 ), 
	( 'Értesítés keresés elhúzódásáról', 'Értesítés keresés elhúzódásáról', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t t&aacute;rsas&aacute;gunk %allas_neve%&nbsp;poz&iacute;ci&oacute;j&aacute;ra.<br />
	Ez&uacute;ton t&aacute;j&eacute;koztatjuk, hogy a kiv&aacute;laszt&aacute;si folyamat elh&uacute;z&oacute;dik, ami&eacute;rt sz&iacute;ves eln&eacute;z&eacute;s&eacute;t k&eacute;rj&uuml;k.<br />
	P&aacute;ly&aacute;zat&aacute;t v&aacute;llalatunk r&eacute;sz&eacute;rõl tov&aacute;bbra is aktu&aacute;lisnak tekintj&uuml;k &eacute;s amint lehets&eacute;ges visszajelz&uuml;nk.</p>

	<p>T&uuml;relm&eacute;t &eacute;s meg&eacute;rt&eacute;s&eacute;t k&ouml;sz&ouml;nj&uuml;k!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:20:03', 518, 0 ), 
	( 'Interjúra behívó rövidebb', 'Interjúra behívó rövidebb', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t t&aacute;rsas&aacute;gunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra.<br />
	&Ouml;n&eacute;letrajza alapj&aacute;n szeretn&eacute;nk megh&iacute;vni &Ouml;nt egy interj&uacute;ra.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t, valamint szem&eacute;lyes iratait.</p>

	<p>Az interj&uacute; idõpontja: &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	Az interj&uacute; helysz&iacute;ne: &lt;helysz&iacute;n&gt;</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:39:47', 518, 0 ), 
	( 'Meghívó kompetencia felmérésre', 'Meghívó kompetencia felmérésre', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t a meghirdetett %kuldo_alairas% poz&iacute;ci&oacute;ra.</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;se a teszt&iacute;r&aacute;s/kompetencia felm&eacute;r&eacute;s, melyre ez&uacute;ton szeretn&eacute;nk megh&iacute;vni.</p>

	<p>A teszt&iacute;r&aacute;s/kompetencia felm&eacute;r&eacute;s idõpontja: &lt;Teszt kezdõ d&aacute;tuma, &oacute;ra, perc&gt;.<br />
	Helysz&iacute;n: &lt;helysz&iacute;n&gt;</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t. K&eacute;rem ezt hozza mag&aacute;val &eacute;s engem k&eacute;rjen a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy r&eacute;szv&eacute;teli sz&aacute;nd&eacute;k&aacute;t erre a lev&eacute;lre k&uuml;ld&ouml;tt v&aacute;lasz&aacute;val jelezze.</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:40:29', 518, 0 ), 
	( 'Interjú meghívó - hosszabb verzió', 'Interjú meghívó - hosszabb verzió', '<p>Tisztelt %cimzett%!</p>

	<p>Telefonos megbesz&eacute;l&eacute;s&uuml;nkre hivatkozva k&uuml;ld&ouml;m a %allas_neve% interj&uacute;val kapcsolatos r&eacute;szleteket.</p>

	<p>Az interj&uacute; idõpontja: 2018.08.16. (cs&uuml;t&ouml;rt&ouml;k), 9:30<br />
	Helysz&iacute;n: 1087 Budapest, K&ouml;nyves K&aacute;lm&aacute;n krt. 11/C.</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t. K&eacute;rem ezt hozza mag&aacute;val &eacute;s engem keressen a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t.</p>

	<p>Az interj&uacute;n &lt;interj&uacute;ztat&oacute; neve&gt;, &lt;interj&uacute;ztat&oacute; poz&iacute;ci&oacute;ja&gt; &eacute;s &lt;toborz&oacute; neve&gt;, &lt;toborz&oacute; poz&iacute;ci&oacute;ja&gt; fog tal&aacute;lkozni.</p>

	<p>Interj&uacute; t&iacute;pusa: kompetencia alap&uacute; &eacute;s szakmai interj&uacute;</p>

	<p>Az interj&uacute; fõbb t&eacute;mak&ouml;rei:</p>

	<ul>
		<li>Tanulm&aacute;nyok</li>
		<li>Eddigi poz&iacute;ci&oacute;k &eacute;s felelõss&eacute;gi k&ouml;r&ouml;k</li>
		<li>Eddig el&eacute;rt teljes&iacute;tm&eacute;nyek</li>
		<li>Motiv&aacute;ci&oacute;k, preferenci&aacute;k, kompetenci&aacute;k</li>
	</ul>

	<p>Csatolva k&uuml;ld&ouml;m a poz&iacute;ci&oacute; le&iacute;r&aacute;s&aacute;t &ndash; k&eacute;rem ezt olvassa &aacute;t &eacute;s ez alapj&aacute;n k&eacute;sz&uuml;lj&ouml;n f&ouml;l.</p>

	<p>&Eacute;rdemes lehet megn&eacute;zni besz&eacute;lget&eacute;s&uuml;nk elõtt weboldalunkat. A c&eacute;grõl &eacute;s c&eacute;gcsoportr&oacute;l bõvebb inform&aacute;ci&oacute;t tal&aacute;lhat a k&ouml;vetkezõ linkeken:</p>

	<ul>
		<li><a href="https://www.mavcsoport.hu/mav-csoport/bemutatkozas" target="_blank">https://www.mavcsoport.hu/mav-csoport/bemutatkozas</a></li>
		<li><a href="https://www.mavcsoport.hu/mav-start/bemutatkozas/bemutatkozas-mav-start-zrt" target="_blank">https://www.mavcsoport.hu/mav-start/bemutatkozas/bemutatkozas-mav-start-zrt</a></li>
		<li><a href="https://www.mavcsoport.hu/mav-start/bemutatkozas/szervezeti-struktura" target="_blank">https://www.mavcsoport.hu/mav-start/bemutatkozas/szervezeti-struktura</a></li>
	</ul>

	<p>Ha b&aacute;rmilyen k&eacute;rd&eacute;s mer&uuml;l fel &Ouml;nben az interj&uacute; elõtt, k&eacute;rem keressen b&aacute;tran a lenti el&eacute;rhetõs&eacute;geken.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>&#39;%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:20:51', 518, 0 ), 
	( 'Interjú meghívó - rövidebb verzió', 'Interjú meghívó - rövidebb verzió', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t t&aacute;rsas&aacute;gunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra.<br />
	&Ouml;n&eacute;letrajza alapj&aacute;n szeretn&eacute;nk megh&iacute;vni &Ouml;nt egy interj&uacute;ra.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t, valamint szem&eacute;lyes iratait.</p>

	<p>Az interj&uacute; idõpontja: &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	Az interj&uacute; helysz&iacute;ne: &lt;helysz&iacute;n&gt;</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:22:54', 518, 0 ), 
	( 'Írásbeli ajánlat', 'Írásbeli ajánlat', '<p>Foglalkoztat&aacute;si aj&aacute;nlat&nbsp;%cimzett% r&eacute;sz&eacute;re</p>

	<p>A M&Aacute;V-H&Eacute;V Zrt. az al&aacute;bbi foglalkoztat&aacute;si aj&aacute;nlatot teszi az &Ouml;n r&eacute;sz&eacute;re:</p>

	<table border="1" cellpadding="1" cellspacing="1" style="width:500px">
		<tbody>
			<tr>
				<td>Foglalkoztat&aacute;s jellege:</td>
				<td>hat&aacute;rozatlan/hat&aacute;rozott idejû munkaviszony 3/6 h&oacute;nap pr&oacute;baidõ kik&ouml;t&eacute;s&eacute;vel</td>
			</tr>
			<tr>
				<td>Munkak&ouml;r:</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td>Munkav&eacute;gz&eacute;s helye:</td>
				<td>a v&aacute;llalat sz&eacute;khelye &eacute;s telephelyei</td>
			</tr>
			<tr>
				<td>Alapb&eacute;r:</td>
				<td>Ft</td>
			</tr>
			<tr>
				<td>Munkarend:</td>
				<td>&nbsp;</td>
			</tr>
			<tr>
				<td>Egy&eacute;b juttat&aacute;s:</td>
				<td>Hat&aacute;lyos belsõ szab&aacute;lyoz&oacute;k alapj&aacute;n</td>
			</tr>
		</tbody>
	</table>

	<p>Jelen foglalkoztat&aacute;si aj&aacute;nlat &hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..-ig &eacute;rv&eacute;nyes</p>

	<p>Budapest, 201&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:24:10', 518, 0 ), 
	( 'Kiválasztási folyamatban már résztvevõ - elutasítás', 'Kiválasztási folyamatban már résztvevõ - elutasítás', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k r&eacute;szv&eacute;tel&eacute;t a t&aacute;rsas&aacute;gunk &aacute;ltal meghirdetett %allas_neve%&nbsp;poz&iacute;ci&oacute;hoz k&ouml;tõdõ toborz&aacute;s-kiv&aacute;laszt&aacute;si folyamatban.</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a> oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:27:00', 518, 0 ), 
	( 'SAP elutasító', 'SAP elutasító', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k r&eacute;szv&eacute;tel&eacute;t a t&aacute;rsas&aacute;gunk &aacute;ltal meghirdetett %allas_neve% poz&iacute;ci&oacute;hoz k&ouml;tõdõ toborz&aacute;s-kiv&aacute;laszt&aacute;si folyamatban.</p>

	<p>T&aacute;j&eacute;koztatjuk, hogy k&ouml;r&uuml;ltekintõ d&ouml;nt&eacute;si folyamat eredm&eacute;nyek&eacute;nt nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk.</p>

	<p>Aktu&aacute;lis &aacute;ll&aacute;saj&aacute;nlatainkat nyomon k&ouml;vetheti a www.mavcsoport.hu/karrier oldalon. Amennyiben k&eacute;pzetts&eacute;g&eacute;nek, szakmai gyakorlat&aacute;nak, elk&eacute;pzel&eacute;seinek megfelelõ aj&aacute;nlatot tal&aacute;l, sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t a karrierport&aacute;lunkon.</p>

	<p>Sok sikert k&iacute;v&aacute;nunk tov&aacute;bbi szakmai p&aacute;lyafut&aacute;s&aacute;hoz!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:30:47', 518, 0 ), 
	( 'Interjúra behívó hosszabb', 'Interjúra behívó hosszabb', '<p>Tisztelt %cimzett%!</p>

	<p>Telefonos megbesz&eacute;l&eacute;s&uuml;nkre hivatkozva k&uuml;ld&ouml;m a %allas_neve% interj&uacute;val kapcsolatos r&eacute;szleteket.</p>

	<p><strong>Az interj&uacute; idõpontja:</strong> &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	<strong>Helysz&iacute;n:</strong> &lt;helysz&iacute;n&gt;</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t. K&eacute;rem ezt hozza mag&aacute;val &eacute;s engem keressen a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a <strong>v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;ny</strong>ok eredeti p&eacute;ld&aacute;ny&aacute;t.</p>

	<p>Az interj&uacute;n <strong>&lt;hozz&aacute;rendelt vezetõ neve&gt;</strong>, <strong>&lt;hozz&aacute;rendelt vezetõ poz&iacute;ci&oacute;ja&gt;</strong> &eacute;s <strong>&lt;toborz&oacute; neve&gt;</strong>, &lt;toborz&oacute; poz&iacute;ci&oacute;ja&gt; fog tal&aacute;lkozni.</p>

	<p><strong>Interj&uacute; t&iacute;pusa: </strong>kompetencia alap&uacute; &eacute;s szakmai interj&uacute;</p>

	<p><strong>Az interj&uacute; fõbb t&eacute;mak&ouml;rei:</strong></p>

	<ul>
		<li>Tanulm&aacute;nyok</li>
		<li>Eddigi poz&iacute;ci&oacute;k &eacute;s felelõss&eacute;gi k&ouml;r&ouml;k</li>
		<li>Eddig el&eacute;rt teljes&iacute;tm&eacute;nyek</li>
		<li>Motiv&aacute;ci&oacute;k, preferenci&aacute;k, kompetenci&aacute;k</li>
	</ul>

	<p>Csatolva k&uuml;ld&ouml;m a poz&iacute;ci&oacute; le&iacute;r&aacute;s&aacute;t &ndash; k&eacute;rem ezt olvassa &aacute;t &eacute;s ez alapj&aacute;n k&eacute;sz&uuml;lj&ouml;n f&ouml;l.</p>

	<p>&Eacute;rdemes lehet megn&eacute;zni besz&eacute;lget&eacute;s&uuml;nk elõtt weboldalunkat. A c&eacute;grõl &eacute;s c&eacute;gcsoportr&oacute;l bõvebb inform&aacute;ci&oacute;t tal&aacute;lhat a k&ouml;vetkezõ linkeken:</p>

	<ul>
		<li>https://www.mavcsoport.hu/mav-csoport/bemutatkozas</li>
		<li>https://www.mavcsoport.hu/mav-start/bemutatkozas/bemutatkozas-mav-start-zrt</li>
		<li><a href="https://www.mavcsoport.hu/mav-start/bemutatkozas/szervezeti-struktura" target="_blank">https://www.mavcsoport.hu/mav-start/bemutatkozas/szervezeti-struktura</a></li>
	</ul>

	<p>Ha b&aacute;rmilyen k&eacute;rd&eacute;s mer&uuml;l fel &Ouml;nben az interj&uacute; elõtt, k&eacute;rem keressen b&aacute;tran a lenti el&eacute;rhetõs&eacute;geken.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:37:16', 518, 0 ), 
	( 'Nem megfelelõ platformon, formában', 'Nem megfelelõ platformon, formában', '<p>Tisztelt Jelentkezõ!</p>

	<p>A M&Aacute;V-H&Eacute;V Zrt. k&ouml;sz&ouml;nettel vette &eacute;rdeklõd&eacute;s&eacute;t, jelentkez&eacute;s&eacute;t.</p>

	<p>K&eacute;rj&uuml;k, hogy jelentkez&eacute;s&eacute;t a kiv&aacute;lasztott poz&iacute;ci&oacute;ra a M&Aacute;V-csoport karrieroldal&aacute;n (<a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a>) tegye meg, tekintettel arra, hogy ez az e-mail c&iacute;m nem fogad jelentkez&eacute;seket, illetve nem tov&aacute;bb&iacute;tja a be&eacute;rkezett leveleket.</p>

	<p>Az erre az e-mail c&iacute;mre be&eacute;rkezett levelek azonnal t&ouml;rl&eacute;sre ker&uuml;lnek, &iacute;gy adatkezel&eacute;sre sem ker&uuml;l sor.</p>

	<p>A M&Aacute;V-csoport karrieroldal&aacute;n a szûrõ funkci&oacute; haszn&aacute;lat&aacute;val k&ouml;nnyen kereshet az &Ouml;nt &eacute;rdeklõ &aacute;ll&aacute;slehetõs&eacute;gek k&ouml;z&ouml;tt, tov&aacute;bb&aacute; t&aacute;j&eacute;koz&oacute;dhat a c&eacute;g&uuml;nkn&eacute;l aktu&aacute;lisan nyitott poz&iacute;ci&oacute;kr&oacute;l, melyekrõl r&eacute;szletes le&iacute;r&aacute;st is olvashat.</p>

	<p>A meghirdetett &aacute;ll&aacute;sok sz&aacute;ma &eacute;s &ouml;sszet&eacute;tele hetente v&aacute;ltozik, ez&eacute;rt javasoljuk, port&aacute;lunk gyakori megl&aacute;togat&aacute;s&aacute;t.</p>

	<p>Egy&uuml;ttmûk&ouml;d&eacute;s&eacute;t &ndash; elõre is &ndash; k&ouml;sz&ouml;nj&uuml;k.</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>A M&Aacute;V-H&Eacute;V Zrt. toborz&aacute;s-kiv&aacute;laszt&aacute;si csapata</p>
	', 1, 'kex_hev', N'2019-07-24T07:28:09', 518, 0 ), 
	( 'Orvosi alkalmassági vizsgálat', 'Orvosi alkalmassági vizsgálat', '<p>Kedves %cimzett%!</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;sek&eacute;nt szeretn&eacute;nk, ha r&eacute;szt venne egy elõzetes alkalmass&aacute;gi orvosi vizsg&aacute;laton.</p>

	<p>Idõpontja: &lt;pontos d&aacute;tum &eacute;s &oacute;ra&gt;<br />
	Helysz&iacute;ne: &lt;pontos helysz&iacute;n&gt;<br />
	Orvos: &lt;orvos neve&gt;</p>

	<p>Fontos tudnival&oacute;k:</p>

	<ul>
		<li>k&eacute;rj&uuml;k a vizsg&aacute;latra &eacute;hgyomorra, kipihenten jelenjen meg (a cukros &uuml;d&iacute;tõital, k&aacute;v&eacute;, energiaital fogyaszt&aacute;s&aacute;t is ker&uuml;lje a labor v&eacute;rvizsg&aacute;lat elõtt)</li>
		<li>amennyiben valamilyen kezelt betegs&eacute;ge van, az orvosi leleteit felt&eacute;tlen&uuml;l vigye mag&aacute;val</li>
		<li>mivel t&ouml;bb vizsg&aacute;laton vesz r&eacute;szt, k&eacute;rj&uuml;k hozzon mag&aacute;val enni- &eacute;s innival&oacute;t, melyet a v&eacute;rv&eacute;tel ut&aacute;n elfogyaszthat</li>
	</ul>

	<p>A vizsg&aacute;latokat szab&aacute;lyoz&oacute; korm&aacute;nyrendeletet az al&aacute;bbi internetes oldalon tekintheti meg: <a href="http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476" target="_blank">http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476</a></p>

	<p>K&eacute;rem, a vizsg&aacute;latok v&eacute;g&eacute;n az eredm&eacute;nyrõl (azaz, hogy alkalmas vagy nem alkalmas) &eacute;rtes&iacute;tsen, &eacute;s a hat&aacute;rozat munk&aacute;ltat&oacute;i p&eacute;ld&aacute;ny&aacute;t juttassa el hozz&aacute;m - c&iacute;mem: &lt;pontos c&iacute;m, el&eacute;rhetõs&eacute;g&gt;</p>

	<p>Amennyiben m&eacute;gsem tud r&eacute;szt venni a vizsg&aacute;laton a megadott idõpontban, k&eacute;rem min&eacute;l hamarabb, lehetõleg a vizsg&aacute;latot megelõzõen legal&aacute;bb h&aacute;rom nappal jelezze fel&eacute;m.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', N'2019-07-24T07:29:24', 518, 0 ), 
	( 'Általános elutasító CV alapján', 'Általános elutasító CV alapján', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve% poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a> oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:34:24', 518, 0 ), 
	( 'Elutasító kiválasztási folyamatban már résztvevõnek', 'Elutasító kiválasztási folyamatban már résztvevõnek', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k r&eacute;szv&eacute;tel&eacute;t a t&aacute;rsas&aacute;gunk &aacute;ltal meghirdetett %kuldo_alairas% poz&iacute;ci&oacute;hoz k&ouml;tõdõ toborz&aacute;s-kiv&aacute;laszt&aacute;si folyamatban.</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a> oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:35:19', 518, 0 ), 
	( 'Orvosi meghívó (203)', 'Orvosi meghívó (203)', '<p>Kedves %cimzett%!</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;sek&eacute;nt szeretn&eacute;nk, ha r&eacute;szt venne egy elõzetes alkalmass&aacute;gi orvosi vizsg&aacute;laton.</p>

	<p>Idõpontja: &lt;d&aacute;tum &eacute;s &oacute;ra&gt;<br />
	Helysz&iacute;ne: &lt;helysz&iacute;n&gt;</p>

	<p>Orvos: &hellip;</p>

	<p>Fontos tudnival&oacute;k:</p>

	<ul>
		<li>k&eacute;rj&uuml;k a vizsg&aacute;latra &eacute;hgyomorra, kipihenten jelenjen meg (a cukros &uuml;d&iacute;tõital, k&aacute;v&eacute;, energiaital fogyaszt&aacute;s&aacute;t is ker&uuml;lje a labor v&eacute;rvizsg&aacute;lat elõtt)</li>
		<li>amennyiben valamilyen kezelt betegs&eacute;ge van, az orvosi leleteit felt&eacute;tlen&uuml;l vigye mag&aacute;val</li>
		<li>mivel t&ouml;bb vizsg&aacute;laton vesz r&eacute;szt, k&eacute;rj&uuml;k hozzon mag&aacute;val enni- &eacute;s innival&oacute;t, melyet a v&eacute;rv&eacute;tel ut&aacute;n elfogyaszthat</li>
	</ul>

	<p>A vizsg&aacute;latokat szab&aacute;lyoz&oacute; korm&aacute;nyrendeletet az al&aacute;bbi internetes oldalon tekintheti meg: <a href="http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476" target="_blank">http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476</a></p>

	<p>K&eacute;rem, a vizsg&aacute;latok v&eacute;g&eacute;n az eredm&eacute;nyrõl (azaz, hogy alkalmas vagy nem alkalmas) &eacute;rtes&iacute;tsen, &eacute;s a hat&aacute;rozat munk&aacute;ltat&oacute;i p&eacute;ld&aacute;ny&aacute;t juttassa el hozz&aacute;m - c&iacute;mem: &hellip;</p>

	<p>Amennyiben m&eacute;gsem tud r&eacute;szt venni a vizsg&aacute;laton a megadott idõpontban, k&eacute;rem min&eacute;l hamarabb, lehetõleg a vizsg&aacute;latot megelõzõen legal&aacute;bb h&aacute;rom nappal jelezze fel&eacute;m.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', N'2019-07-24T07:41:15', 518, 0 ), 
	( 'Általános elutasító levél CV alapján', 'Általános elutasító levél CV alapján', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val v&aacute;llalatunkat &eacute;s jelentkezett a karrierport&aacute;lon meghirdetett&nbsp;%allas_neve% poz&iacute;ci&oacute;nkra!</p>

	<p>A rendelkez&eacute;s&uuml;nkre bocs&aacute;tott adatok alapj&aacute;n megvizsg&aacute;ltuk foglalkoztat&aacute;s&aacute;nak lehetõs&eacute;g&eacute;t, ez&uacute;ttal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk.</p>

	<p>Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a> oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>M&Aacute;V Zrt.</p>
	', 1, 'kex_szk', N'2019-07-24T07:04:59', 518, 0 ), 
	( 'Elutasító levél kiválasztásban részt vett jelentkezõknek', 'Elutasító levél kiválasztásban részt vett jelentkezõknek', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nettel vett&uuml;k jelentkez&eacute;s&eacute;t v&aacute;llalatunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra, &eacute;s ez&uacute;ton is szeretn&eacute;nk megk&ouml;sz&ouml;nni t&uuml;relm&eacute;t az elh&uacute;z&oacute;d&oacute; kiv&aacute;laszt&aacute;si folyamat miatt.</p>

	<p>A rendelkez&eacute;s&uuml;nkre bocs&aacute;tott adatok alapj&aacute;n megvizsg&aacute;ltuk foglalkoztat&aacute;s&aacute;nak lehetõs&eacute;g&eacute;t.</p>

	<p>Jelenleg v&eacute;gzetts&eacute;g&eacute;nek &eacute;s szakmai tapasztalat&aacute;nak megfelelõ munkak&ouml;rt nem tudunk aj&aacute;nlani &Ouml;nnek. Aktu&aacute;lis &aacute;ll&aacute;saj&aacute;nlatainkat nyomon k&ouml;vetheti a karrier oldalunkon: <a href="http://www.mavcsoport.hu/karrier" target="_blank">www.mavcsoport.hu/karrier</a></p>

	<p>Amennyiben k&eacute;pzetts&eacute;g&eacute;nek, gyakorlat&aacute;nak, elk&eacute;pzel&eacute;seinek megfelelõ aj&aacute;nlatot tal&aacute;l, sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t ezen a fel&uuml;leten.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>M&Aacute;V Zrt.</p>
	', 1, 'kex_szk', N'2019-07-24T07:07:26', 518, 0 ), 
	( 'Interjú meghívó hosszabb', 'Interjú meghívó hosszabb', '<p>Tisztelt %cimzett%!</p>

	<p>Telefonos megbesz&eacute;l&eacute;s&uuml;nkre hivatkozva k&uuml;ld&ouml;m a %allas_neve% interj&uacute;val kapcsolatos r&eacute;szleteket.</p>

	<p>Az interj&uacute; idõpontja: &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	Helysz&iacute;n: &lt;helysz&iacute;n&gt;</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t. K&eacute;rem, ezt hozza mag&aacute;val &eacute;s engem keressen a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t.</p>

	<p>Az interj&uacute;n &lt;interj&uacute;ztat&oacute; neve&gt;, &lt;interj&uacute;ztat&oacute; poz&iacute;ci&oacute;ja&gt; &eacute;s &lt;toborz&oacute; neve&gt;, &lt;toborz&oacute; poz&iacute;ci&oacute;ja&gt; fog tal&aacute;lkozni.</p>

	<p>Interj&uacute; t&iacute;pusa: kompetencia alap&uacute; &eacute;s szakmai interj&uacute;<br />
	Az interj&uacute; fõbb t&eacute;mak&ouml;rei:</p>

	<ul>
		<li>Tanulm&aacute;nyok</li>
		<li>Eddigi poz&iacute;ci&oacute;k &eacute;s felelõss&eacute;gi k&ouml;r&ouml;k</li>
		<li>Eddig el&eacute;rt teljes&iacute;tm&eacute;nyek</li>
		<li>Motiv&aacute;ci&oacute;k, preferenci&aacute;k, kompetenci&aacute;k</li>
	</ul>

	<p>Csatolva k&uuml;ld&ouml;m a poz&iacute;ci&oacute; le&iacute;r&aacute;s&aacute;t &ndash; k&eacute;rem, ezt olvassa &aacute;t &eacute;s ez alapj&aacute;n k&eacute;sz&uuml;lj&ouml;n f&ouml;l.</p>

	<p>&Eacute;rdemes lehet megn&eacute;zni besz&eacute;lget&eacute;s&uuml;nk elõtt weboldalunkat. A c&eacute;grõl &eacute;s c&eacute;gcsoportr&oacute;l bõvebb inform&aacute;ci&oacute;t tal&aacute;lhat a k&ouml;vetkezõ linkeken:</p>

	<ul>
		<li><a href="https://www.mavcsoport.hu/mav-csoport/bemutatkozas" target="_blank">https://www.mavcsoport.hu/mav-csoport/bemutatkozas</a></li>
		<li><a href="https://www.mavcsoport.hu/mav/bemutatkozas" target="_blank">https://www.mavcsoport.hu/mav/bemutatkozas</a></li>
		<li><a href="https://www.mavcsoport.hu/mav/szervezeti-felepites" target="_blank">https://www.mavcsoport.hu/mav/szervezeti-felepites</a></li>
	</ul>

	<p>Ha b&aacute;rmilyen k&eacute;rd&eacute;s mer&uuml;l fel &Ouml;nben az interj&uacute; elõtt, k&eacute;rem keressen b&aacute;tran a lenti el&eacute;rhetõs&eacute;geken.</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>

	<p>&nbsp;</p>
	', 1, 'kex_szk', N'2019-07-24T07:08:17', 518, 0 ), 
	( 'Interjú meghívó rövidebb', 'Interjú meghívó rövidebb', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t t&aacute;rsas&aacute;gunk %allas_neve% poz&iacute;ci&oacute;j&aacute;ra.<br />
	&Ouml;n&eacute;letrajza alapj&aacute;n szeretn&eacute;nk megh&iacute;vni &Ouml;nt egy interj&uacute;ra.</p>

	<p>K&eacute;rj&uuml;k, hogy hozza mag&aacute;val a v&eacute;gzetts&eacute;geit igazol&oacute; okm&aacute;nyok eredeti p&eacute;ld&aacute;ny&aacute;t, valamint szem&eacute;lyes iratait.</p>

	<p>Az interj&uacute; idõpontja: &lt;Kezdõ d&aacute;tum, &oacute;ra, perc&gt;<br />
	Az interj&uacute; helysz&iacute;ne: &lt;helysz&iacute;n&gt;</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_szk', N'2019-07-24T07:12:51', 518, 0 ), 
	( 'Orvosi meghívó (203)', 'Orvosi meghívó (203)', '<p>Tisztelt %cimzett%!</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;sek&eacute;nt szeretn&eacute;nk, ha r&eacute;szt venne egy elõzetes alkalmass&aacute;gi orvosi vizsg&aacute;laton.</p>

	<p>Idõpontja: &lt;pontos d&aacute;tum &eacute;s &oacute;ra&gt;<br />
	Helysz&iacute;ne: &lt;pontos helysz&iacute;n&gt;<br />
	Orvos: &lt;orvos neve&gt;</p>

	<p>Fontos tudnival&oacute;k:</p>

	<ul>
		<li>k&eacute;rj&uuml;k a vizsg&aacute;latra &eacute;hgyomorra, kipihenten jelenjen meg (a cukros &uuml;d&iacute;tõital, k&aacute;v&eacute;, energiaital fogyaszt&aacute;s&aacute;t is ker&uuml;lje a labor v&eacute;rvizsg&aacute;lat elõtt)</li>
		<li>amennyiben valamilyen kezelt betegs&eacute;ge van, az orvosi leleteit felt&eacute;tlen&uuml;l vigye mag&aacute;val</li>
		<li>mivel t&ouml;bb vizsg&aacute;laton vesz r&eacute;szt, k&eacute;rj&uuml;k hozzon mag&aacute;val enni- &eacute;s innival&oacute;t, melyet a v&eacute;rv&eacute;tel ut&aacute;n elfogyaszthat</li>
	</ul>

	<p>A vizsg&aacute;latokat szab&aacute;lyoz&oacute; korm&aacute;nyrendeletet az al&aacute;bbi internetes oldalon tekintheti meg: <a href="http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476" target="_blank">http://njt.hu/cgi_bin/njt_doc.cgi?docid=126434.324476</a></p>

	<p>K&eacute;rem, a vizsg&aacute;latok v&eacute;g&eacute;n az eredm&eacute;nyrõl (azaz, hogy alkalmas vagy nem alkalmas) &eacute;rtes&iacute;tsen, &eacute;s a hat&aacute;rozat munk&aacute;ltat&oacute;i p&eacute;ld&aacute;ny&aacute;t juttassa el hozz&aacute;m - c&iacute;mem: &lt;pontos c&iacute;m, el&eacute;rhetõs&eacute;g&gt;</p>

	<p>Amennyiben m&eacute;gsem tud r&eacute;szt venni a vizsg&aacute;laton a megadott idõpontban, k&eacute;rem min&eacute;l hamarabb, lehetõleg a vizsg&aacute;latot megelõzõen legal&aacute;bb h&aacute;rom nappal jelezze fel&eacute;m.</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_szk', N'2019-07-24T07:13:42', 518, 0 ), 
	( 'Tesztre meghívó', 'Tesztre meghívó', '<p>Tisztelt %cimzett%!</p>

	<p>K&ouml;sz&ouml;nj&uuml;k jelentkez&eacute;s&eacute;t a meghirdetett %allas_neve% poz&iacute;ci&oacute;ra.</p>

	<p>A kiv&aacute;laszt&aacute;si folyamat k&ouml;vetkezõ l&eacute;p&eacute;se a teszt&iacute;r&aacute;s/kompetencia felm&eacute;r&eacute;s, melyre ez&uacute;ton szeretn&eacute;nk megh&iacute;vni.</p>

	<p>A teszt&iacute;r&aacute;s/kompetencia felm&eacute;r&eacute;s idõpontja: &lt;Teszt kezdõ d&aacute;tuma, &oacute;ra, perc&gt;.<br />
	Helysz&iacute;n: &lt;helysz&iacute;n&gt;</p>

	<p>A port&aacute;n azonos&iacute;t&aacute;si c&eacute;llal elk&eacute;rhetik szem&eacute;lyi- vagy egy&eacute;b f&eacute;nyk&eacute;pes igazolv&aacute;ny&aacute;t.<br />
	K&eacute;rem, ezt hozza mag&aacute;val &eacute;s &lt;toborz&oacute; neve&gt;-t keresse a recepci&oacute;n.</p>

	<p>K&eacute;rj&uuml;k, hogy r&eacute;szv&eacute;teli sz&aacute;nd&eacute;k&aacute;t erre a lev&eacute;lre k&uuml;ld&ouml;tt v&aacute;lasz&aacute;val jelezze.</p>

	<p>Megjelen&eacute;s&eacute;re sz&aacute;m&iacute;tunk!</p>

	<p>&Uuml;dv&ouml;zlettel:</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_szk', N'2019-07-24T07:14:55', 518, 0 )
  END
END

/*	KEX Vezetõnek/MJGY-nek menõ email-sablonok*/
IF NOT EXISTS(SELECT * FROM dbo.orn_szi_EmailTemplateSample WHERE technical_name LIKE 'kex%mjgy')
	BEGIN
		INSERT INTO [dbo].[orn_szi_EmailTemplateSample] ( [TemplateName],[EmailSubject],[EmailBody],[Active],[technical_name],[Created],[CreatedByID],Deleted)
		VALUES
		('KEX - Vezetõi email MÁV', 'Vezetõi email', '<p>Kedves %cimzett%!</p>

		<p>%kuldo% %statuszolo% %vezeto_tipus%k&eacute;nt jel&ouml;lte %allas_neve% &aacute;ll&aacute;saj&aacute;nlathoz a H&Ouml;P-KEX rendszerben, melyet ezen a <a href="%link%">linken&nbsp;</a>&eacute;rhet el.</p>

		<p>&Uuml;dv:</p>

		<p>Hum&aacute;n &Ouml;nkiszolg&aacute;l&oacute; Port&aacute;l<br />
		KEX modul</p>
		', 1, 'kex_mav_mjgy', N'2019-07-24T16:00:29.307', 1, 0 ), 
		('KEX - Vezetõi email START', 'Vezetõi email', '<p>Kedves %cimzett%!</p>

		<p>%kuldo% %statuszolo% %vezeto_tipus%k&eacute;nt jel&ouml;lte %allas_neve% &aacute;ll&aacute;saj&aacute;nlathoz a H&Ouml;P-KEX rendszerben, melyet ezen a <a href="%link%">linken&nbsp;</a>&eacute;rhet el.</p>

		<p>&Uuml;dv:</p>

		<p>Hum&aacute;n &Ouml;nkiszolg&aacute;l&oacute; Port&aacute;l<br />
		KEX modul</p>
		', 1, 'kex_szesza_mjgy', N'2019-07-24T11:11:11', 1, 0 ), 
		('KEX - Vezetõi email SZK', 'Vezetõi email', '<p>Kedves %cimzett%!</p>

		<p>%kuldo% %statuszolo% %vezeto_tipus%k&eacute;nt jel&ouml;lte %allas_neve% &aacute;ll&aacute;saj&aacute;nlathoz a H&Ouml;P-KEX rendszerben, melyet ezen a <a href="%link%">linken&nbsp;</a>&eacute;rhet el.</p>

		<p>&Uuml;dv:</p>

		<p>Hum&aacute;n &Ouml;nkiszolg&aacute;l&oacute; Port&aacute;l<br />
		KEX modul</p>
		', 1, 'kex_szk_mjgy', N'2019-09-12T10:03:13.073', 1, 0 ), 
		('KEX - Vezetõi email FKG', 'Vezetõi email', '<p>Kedves %cimzett%!</p>

		<p>%kuldo% %statuszolo% %vezeto_tipus%k&eacute;nt jel&ouml;lte %allas_neve% &aacute;ll&aacute;saj&aacute;nlathoz a H&Ouml;P-KEX rendszerben, melyet ezen a <a href="%link%">linken&nbsp;</a>&eacute;rhet el.</p>

		<p>&Uuml;dv:</p>

		<p>Hum&aacute;n &Ouml;nkiszolg&aacute;l&oacute; Port&aacute;l<br />
		KEX modul</p>
		', 1, 'kex_fkg_mjgy', N'2019-09-12T10:03:45.213', 1, 0 ), 
		('KEX - Vezetõi email HÉV', 'Vezetõi email', '<p>Kedves %cimzett%!</p>

		<p>%kuldo% %statuszolo% %vezeto_tipus%k&eacute;nt jel&ouml;lte %allas_neve% &aacute;ll&aacute;saj&aacute;nlathoz a H&Ouml;P-KEX rendszerben, melyet ezen a <a href="%link%">linken&nbsp;</a>&eacute;rhet el.</p>

		<p>&Uuml;dv:</p>

		<p>Hum&aacute;n &Ouml;nkiszolg&aacute;l&oacute; Port&aacute;l<br />
		KEX modul</p>
		', 1, 'kex_hev_mjgy', N'2019-09-12T10:03:52.227', 1, 0 )
	END
ELSE
	SELECT 'Vezetõk/MJGY emailsablonok feltöltésre nem volt szükség'

IF NOT EXISTS (SELECT * FROM dbo.orn_szi_EmailTemplateSample WHERE TemplateName LIKE 'KEX - Elutasító lakcím miatt%')
	INSERT INTO dbo.orn_szi_EmailTemplateSample ([TemplateName], [EmailSubject], [EmailBody], [Active], [technical_name], [Created], [CreatedByID], [Deleted], [CompanyID], [ModulID])
	VALUES
	('KEX - Elutasító lakcím miatt (MÁV)', 'Köszönjük jelentkezését - %allas_neve%', '<p><strong>Tisztelt %cimzett%!</strong></p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve%&nbsp;(%szolg_helyek%)&nbsp;poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a&nbsp;<a href="https://karrier.mavcsoport.hu/">karrier.mavcsoport.hu</a>&nbsp;oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_mav', GETDATE(), 1, 0, 2, 10 ),
	('KEX - Elutasító lakcím miatt (SZK)', 'Köszönjük jelentkezését - %allas_neve%', '<p><strong>Tisztelt %cimzett%!</strong></p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve%&nbsp;(%szolg_helyek%)&nbsp;poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a&nbsp;<a href="https://karrier.mavcsoport.hu/">karrier.mavcsoport.hu</a>&nbsp;oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_szk', GETDATE(), 1, 0, 1, 10 ),
	('KEX - Elutasító lakcím miatt (START)', 'Köszönjük jelentkezését - %allas_neve%', '<p><strong>Tisztelt %cimzett%!</strong></p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve%&nbsp;(%szolg_helyek%)&nbsp;poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a&nbsp;<a href="https://karrier.mavcsoport.hu/">karrier.mavcsoport.hu</a>&nbsp;oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_start', GETDATE(), 1, 0, 3, 10 ),
	('KEX - Elutasító lakcím miatt (HÉV)', 'Köszönjük jelentkezését - %allas_neve%', '<p><strong>Tisztelt %cimzett%!</strong></p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve%&nbsp;(%szolg_helyek%)&nbsp;poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a&nbsp;<a href="https://karrier.mavcsoport.hu/">karrier.mavcsoport.hu</a>&nbsp;oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_hev', GETDATE(), 1, 0, 7, 10 ),
	('KEX - Elutasító lakcím miatt (VAGON)', 'Köszönjük jelentkezését - %allas_neve%', '<p><strong>Tisztelt %cimzett%!</strong></p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve%&nbsp;(%szolg_helyek%)&nbsp;poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a&nbsp;<a href="https://karrier.mavcsoport.hu/">karrier.mavcsoport.hu</a>&nbsp;oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_vagon', GETDATE(), 1, 0, 10, 10 ),
	('KEX - Elutasító lakcím miatt (VOLÁNBUSZ)', 'Köszönjük jelentkezését - %allas_neve%', '<p><strong>Tisztelt %cimzett%!</strong></p>

	<p>K&ouml;sz&ouml;nj&uuml;k, hogy megtisztelte bizalm&aacute;val T&aacute;rsas&aacute;gunkat &eacute;s jelentkezett %allas_neve%&nbsp;(%szolg_helyek%)&nbsp;poz&iacute;ci&oacute;nkra!</p>

	<p>Ez alkalommal sajnos nem &Ouml;nre esett a v&aacute;laszt&aacute;sunk. Tov&aacute;bbra is sz&iacute;vesen fogadjuk jelentkez&eacute;s&eacute;t nyitott poz&iacute;ci&oacute;inkra, melyeket megtekinthet a&nbsp;<a href="https://karrier.mavcsoport.hu/">karrier.mavcsoport.hu</a>&nbsp;oldalon.</p>

	<p>Tov&aacute;bbi &aacute;ll&aacute;skeres&eacute;s&eacute;hez sok sikert k&iacute;v&aacute;nunk!</p>

	<p>&Uuml;dv&ouml;zlettel,</p>

	<p>%kuldo_alairas%</p>
	', 1, 'kex_volan', GETDATE(), 1, 0, 11, 10 )

/* LandingZone_AdvertList betöltõ éjszakai job beállítás */
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name = 'LandingZone_AdvertList betöltõ')
INSERT INTO dbo.ServerTool_Job (name,dll_name,class_name,SQL,Mon,Tue,Wed,Thu,Fri,Sat,Sun,minsec_from,minsec_to,period,last_run,running,status_message,Activated, Deleted)
VALUES ('LandingZone_AdvertList betöltõ', NULL, NULL, 'Kivezetésre került', 1, 1, 1, 1, 1, 1, 1, '0:30', '1:00', 60, NULL, 0, NULL, 1, 0 )
ELSE
UPDATE dbo.ServerTool_Job SET [SQL]='Kivezetésre került' WHERE name = 'LandingZone_AdvertList betöltõ'

/* GDPR vége dátum klitöltése a KEX1-ben rögzített jelentkezõkhöz */
/*
IF EXISTS(SELECT * FROM dbo.msk_kex_jelentkezok WHERE gdpr=1 AND gdpr_vege IS NULL)
BEGIN

	DECLARE @gdprVegeCursor CURSOR
	DECLARE @idjel INT
	DECLARE @jelentkezes_datuma DATE
		BEGIN
				SET @gdprVegeCursor = CURSOR FOR SELECT msk_kex_jelentkezokID, datum FROM dbo.msk_kex_jelentkezok WHERE gdpr=1

				OPEN @gdprVegeCursor 
				FETCH NEXT FROM @gdprVegeCursor 
				INTO  @idjel, @jelentkezes_datuma

				WHILE @@FETCH_STATUS = 0
				BEGIN

					UPDATE dbo.msk_kex_jelentkezok SET gdpr_vege=DATEADD(YEAR,2,@jelentkezes_datuma) WHERE msk_kex_jelentkezokID=@idjel
					
					FETCH NEXT FROM @gdprVegeCursor
					INTO @idjel, @jelentkezes_datuma
				END; 

				CLOSE @gdprVegeCursor;
				DEALLOCATE @gdprVegeCursor;
			END;

END
ELSE
BEGIN
	print 'A gdpr vége dátum kitöltésére a jelentkezõk táblában nem volt szükség'
END
*/

--/* GDPR vége dátum klitöltése a KEX1-ben rögzített gdpr-os jelentkezõkhöz */
--IF EXISTS(SELECT * FROM dbo.msk_kex_gdpr_jelentkezok WHERE gdpr=1 AND gdpr_vege IS NULL)
--BEGIN

--	DECLARE @gdprVegegCursor CURSOR
--	DECLARE @idgdpr INT
--	DECLARE @gdprjelentkezes_datuma DATE
--		BEGIN
--				SET @gdprVegegCursor = CURSOR FOR SELECT msk_kex_gdpr_jelentkezokID, datum FROM dbo.msk_kex_gdpr_jelentkezok WHERE gdpr=1

--				OPEN @gdprVegegCursor 
--				FETCH NEXT FROM @gdprVegegCursor 
--				INTO  @idgdpr, @gdprjelentkezes_datuma

--				WHILE @@FETCH_STATUS = 0
--				BEGIN

--					UPDATE dbo.msk_kex_gdpr_jelentkezok SET gdpr_vege=DATEADD(YEAR,2,@gdprjelentkezes_datuma) WHERE msk_kex_gdpr_jelentkezokID=@idgdpr
					
--					FETCH NEXT FROM @gdprVegegCursor
--					INTO @idgdpr, @gdprjelentkezes_datuma
--				END; 

--				CLOSE @gdprVegegCursor;
--				DEALLOCATE @gdprVegegCursor;
--			END;

--END
--ELSE
--BEGIN
--	print 'A gdpr vége dátum kitöltésére a GDPR jelentkezõk táblában nem volt szükség'
--END

/*MAP jelentkezõ adatainak törlése 6 hónap múlva*/
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name = 'MAP6honap')
INSERT INTO dbo.ServerTool_Job (name, dll_name, class_name, SQL, Mon, Tue, Wed, Thu, Fri, Sat, Sun, minsec_from, minsec_to, period, last_run, running, status_message, Activated, Deleted)
VALUES( 'MAP6honap', NULL, NULL, 'EXEC [dbo].[msk_kex_map_6_honap]', 1, 1, 1, 1, 1, 1, 1, '5:30', '9:00', 600, NULL, NULL, NULL, 1, 0 )
ELSE 
UPDATE dbo.ServerTool_Job 
SET SQL = 'EXEC [dbo].[msk_kex_map_6_honap]' 
WHERE name = 'MAP6honap'

--/*KEX MAP-os adatok feltöltése*/
--UPDATE dbo.msk_kex_gdpr_jelentkezok
--SET 
--	MAPCompany = (SELECT TOP 1 MAPCompany FROM dbo.msk_kex_jelentkezok WHERE dbo.msk_kex_jelentkezok.HashID = dbo.msk_kex_gdpr_jelentkezok.HashID ORDER BY datum DESC),
--	map_beerkezes = (SELECT TOP 1 map_beerkezes FROM dbo.msk_kex_jelentkezok WHERE dbo.msk_kex_jelentkezok.HashID = dbo.msk_kex_gdpr_jelentkezok.HashID ORDER BY datum DESC),
--	idmap_dokumentacio = (SELECT TOP 1 idmap_dokumentacio FROM dbo.msk_kex_jelentkezok WHERE dbo.msk_kex_jelentkezok.HashID = dbo.msk_kex_gdpr_jelentkezok.HashID ORDER BY datum DESC)

/*MÁV SZK logó csere*/
IF EXISTS(SELECT * FROM dbo.msk_kex_emailalairas WHERE Alairas LIKE '%iVBORw0KGgoAAAANSUhEUgAAAKo%')
BEGIN
	UPDATE dbo.msk_kex_emailalairas
	SET Alairas = STUFF(Alairas,PATINDEX('%data:%',Alairas),26890,'xszklogox')
	FROM
		dbo.msk_kex_emailalairas LEFT JOIN dbo.People ON People.PeopleID = msk_kex_emailalairas.PeopleID
	WHERE dbo.People.BUKRS=3000 and dbo.People.Deleted=0

	UPDATE dbo.msk_kex_emailalairas
	SET Alairas = STUFF(Alairas,PATINDEX('%xszklogox%',Alairas),9,'data:image/jpeg;base64,/9j/4AAQSkZJRgABAgEAlgCWAAD/7QAsUGhvdG9zaG9wIDMuMAA4QklNA+0AAAAAABAAlgAAAAEAAQCWAAAAAQAB/+FHbWh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8APD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDMgNzkuMTYxMjEwLCAyMDE3LzA4LzExLTEwOjI4OjM2ICAgICAgICAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICAgICAgICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgICAgICAgICAgeG1sbnM6eG1wR0ltZz0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL2cvaW1nLyIKICAgICAgICAgICAgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iCiAgICAgICAgICAgIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIgogICAgICAgICAgICB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIgogICAgICAgICAgICB4bWxuczppbGx1c3RyYXRvcj0iaHR0cDovL25zLmFkb2JlLmNvbS9pbGx1c3RyYXRvci8xLjAvIgogICAgICAgICAgICB4bWxuczpwZGY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGRmLzEuMy8iPgogICAgICAgICA8ZGM6Zm9ybWF0PmltYWdlL2pwZWc8L2RjOmZvcm1hdD4KICAgICAgICAgPGRjOnRpdGxlPgogICAgICAgICAgICA8cmRmOkFsdD4KICAgICAgICAgICAgICAgPHJkZjpsaSB4bWw6bGFuZz0ieC1kZWZhdWx0Ij5NYXZfU3prX2xvZ29fMl9raWNzaTwvcmRmOmxpPgogICAgICAgICAgICA8L3JkZjpBbHQ+CiAgICAgICAgIDwvZGM6dGl0bGU+CiAgICAgICAgIDx4bXA6TWV0YWRhdGFEYXRlPjIwMjAtMDMtMDRUMTM6NTI6NTArMDE6MDA8L3htcDpNZXRhZGF0YURhdGU+CiAgICAgICAgIDx4bXA6TW9kaWZ5RGF0ZT4yMDIwLTAzLTA0VDEyOjUyOjU0WjwveG1wOk1vZGlmeURhdGU+CiAgICAgICAgIDx4bXA6Q3JlYXRlRGF0ZT4yMDIwLTAzLTA0VDEzOjUyOjUwKzAxOjAwPC94bXA6Q3JlYXRlRGF0ZT4KICAgICAgICAgPHhtcDpDcmVhdG9yVG9vbD5BZG9iZSBJbGx1c3RyYXRvciBDQyAyMi4wIChXaW5kb3dzKTwveG1wOkNyZWF0b3JUb29sPgogICAgICAgICA8eG1wOlRodW1ibmFpbHM+CiAgICAgICAgICAgIDxyZGY6QWx0PgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHhtcEdJbWc6d2lkdGg+MjU2PC94bXBHSW1nOndpZHRoPgogICAgICAgICAgICAgICAgICA8eG1wR0ltZzpoZWlnaHQ+NTY8L3htcEdJbWc6aGVpZ2h0PgogICAgICAgICAgICAgICAgICA8eG1wR0ltZzpmb3JtYXQ+SlBFRzwveG1wR0ltZzpmb3JtYXQ+CiAgICAgICAgICAgICAgICAgIDx4bXBHSW1nOmltYWdlPi85ai80QUFRU2taSlJnQUJBZ0VBbGdDV0FBRC83UUFzVUdodmRHOXphRzl3SURNdU1BQTRRa2xOQSswQUFBQUFBQkFBbGdBQUFBRUEmI3hBO0FRQ1dBQUFBQVFBQi8rNEFEa0ZrYjJKbEFHVEFBQUFBQWYvYkFJUUFCZ1FFQkFVRUJnVUZCZ2tHQlFZSkN3Z0dCZ2dMREFvS0N3b0smI3hBO0RCQU1EQXdNREF3UURBNFBFQThPREJNVEZCUVRFeHdiR3hzY0h4OGZIeDhmSHg4Zkh3RUhCd2NOREEwWUVCQVlHaFVSRlJvZkh4OGYmI3hBO0h4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zkh4OGZIeDhmSHg4Zi84QUFFUWdBT0FFQUF3RVImI3hBO0FBSVJBUU1SQWYvRUFhSUFBQUFIQVFFQkFRRUFBQUFBQUFBQUFBUUZBd0lHQVFBSENBa0tDd0VBQWdJREFRRUJBUUVBQUFBQUFBQUEmI3hBO0FRQUNBd1FGQmdjSUNRb0xFQUFDQVFNREFnUUNCZ2NEQkFJR0FuTUJBZ01SQkFBRklSSXhRVkVHRTJFaWNZ
																	RVVNcEdoQnhXeFFpUEImI3hBO1V0SGhNeFppOENSeWd2RWxRelJUa3FLeVkzUENOVVFuazZPek5oZFVaSFREMHVJSUpvTUpDaGdaaEpSRlJxUzBWdE5WS0JyeTQvUEUmI3hBOzFPVDBaWFdGbGFXMXhkWGw5V1oyaHBhbXRzYlc1dlkzUjFkbmQ0ZVhwN2ZIMStmM09FaFlhSGlJbUtpNHlOam8rQ2s1U1ZscGVZbVomI3hBO3FibkoyZW41S2pwS1dtcDZpcHFxdXNyYTZ2b1JBQUlDQVFJREJRVUVCUVlFQ0FNRGJRRUFBaEVEQkNFU01VRUZVUk5oSWdaeGdaRXkmI3hBO29iSHdGTUhSNFNOQ0ZWSmljdkV6SkRSRGdoYVNVeVdpWTdMQ0IzUFNOZUpFZ3hkVWt3Z0pDaGdaSmpaRkdpZGtkRlUzOHFPend5Z3AmI3hBOzArUHpoSlNrdE1UVTVQUmxkWVdWcGJYRjFlWDFSbFptZG9hV3ByYkcxdWIyUjFkbmQ0ZVhwN2ZIMStmM09FaFlhSGlJbUtpNHlOam8mI3hBOytEbEpXV2w1aVptcHVjblo2ZmtxT2twYWFucUttcXE2eXRycSt2L2FBQXdEQVFBQ0VRTVJBRDhBOVU0cTdGWFlxbFhtSHpWNWQ4dVcmI3hBO2YxelhOUWhzSUQ5a3l0OFRrZGtRVmR6N0tEazRZNVNOQVd4bE1SRmxoa3Y1MTJzNVA2Rjh0NnRxVWY3RnkwS1dzTGp4UnBtREVVL3kmI3hBO2NxeTVzR00xUExDSjdycy9ZemhqeVMrbUVqOEsrK21rL091R0NoMWJ5eHJGakgrM1BIRkhjeEo0bGpFL0tudnh4eDU5UGtOUXl3SjcmI3hBO3JyNzFsanlSK3FFdnYrNW1IbHJ6ajVZOHpXeHVORDFHSzlSUDd4RkpXVlA5ZUp3c2lmN0pjdW5pbERtR0VaaVhKT2NyWk94VjJLclomI3hBO3BvWVltbG1kWTRrQlo1SElWVkE2a2s3REVCVXYvd0FTK1hQK3JyWi85SkVYL05XVDhPWGNVV0V5QkJGUjB5Q1VQZWFscDFrRU43ZFEmI3hBOzJ3a3J3OWFSWStWT3RPUkZhVndpSlBKYlU3WFd0SHU1UkRhMzl2Y1RFRWlPS1ZIYWc2bWlrbkNZa2N3aTBaa1V2Q2YrY2hianpacnQmI3hBO3hiK1dkR2hUOUdXL0dlL2thNXRvakxPUlZFS3ZJcmNZMU5keHVUN0E1c3RFSXg5UjV1SHFoT1d3NU16L0FDZC9LM1QvQUNYb2kzTXAmI3hBO2p1ZGR2MFZyeThTaktxSDRoREMzOGc3bjlvNytGTWZWYWc1RDVCdHdZUkFlYk5KZk1HZ3d5dkZMcVZySExHU3J4dlBHckt3MklJTFYmI3hBO0J6SDRKZHpkYU5pbGpsalNXSnhKRklBeU9wQlZsSXFDQ05pQ01pbFF2TlUweXlLaTl1NGJZdlVvSnBFajVVNjA1RVZ3aUpQSmJiczkmI3hBO1EwKzlWbXM3bUs1VkRSMmhkWkFDZXg0azRtSkhOVVJnVkQzMm82ZllRZXZmWE1WcEFEUXl6dXNhVi8xbUlHRVJKNUtTbDlqNXo4bjYmI3hBO2hPSUxEWGRQdTUySUN4UVhjRWprbnBSVWNuSm5GTWN3V0luRThpbTBzc2NVYnl5dUk0b3dXZDJJQ3FvRlNTVHNBQmxiSkwvOFMrWFAmI3hBOytyclovd0RTUkYvelZrL0RsM0ZGaDMrSmZMbi9BRmRiUC9wSWkvNXF4OE9YY1ZzSzlwck9rWGt2cFdsOWIzRXRPWHB4U283VUhlaWsmI3hBO25BWWtjd3RxU2VZdkw4anJISHFkbzd1UXFJczhaSkoyQUFEWThFdTViQ09ra2ppamFTUmdrYUFzN3NRRlZRS2trbm9Ca1VvQWVaZkwmI3hBO2hOQnF0blgvQUppSXYrYXNuNGN1NG9zSmprRXV4VmlQNWgrZXg1WnM3YTJzWUJmZVlkVVl3NlZZVm9Dd0ZXbWxJNlJSOVcvMnlKZW0mI3hBO01UT1o0WVIzSi9IVW8zSkVZaTVIazgvMDd5d2tkMit1ZVlybjlMNi9JT2Mrb1hGUFRpQTM0UUlmZ2lSZllmZDB6aSswdTNjMnBQaDQmI3hBOzdoaTZSSE0rL3Y4QWR5OS9OM3VsN1BoaTlVdlZQdjd2ZDNMUjU2MHk0dUh0OUd0TDdYcFlqU1g5RjJ6M0NLZmVUNFkvK0d4d2V6T3EmI3hBO25IaWx3NHgvU05mWUxLTW5hdUdKb1hMK3FQMDhtbjg5YWZhU3BIclduNmpvWHFIakhKcWRvOEViSDJrSE5QcHJrczNzeHFvaTQ4T1QmI3hBOytxZC90cEVPMXNKTkc0KzhmcDVLbXFlV2JIVXBZdFowaTVPbTYxSCs4czlac3lBeHIvUHgrR1ZHNkVOMnlucy90blBvNWNFcmxqNncmI3hBO2wwOTM4MHM5VG9jZWNjUTJsMGtQeHV6ajh1dlBzK3UvV2RHMXFKYlR6UnBhcWIyRlA3dWVJN0xjd1Y2bzNjZnNuYk8zak9HU0F5NHomI3hBO2NKZlo1SHpkQ1JLTWpDUXFRL0ZobXVCTHNWWXIrYXYvQUpMZnpKLzJ6NS8rSUhMdE4vZVI5N1htK2crNThRNTBUcEgyeCtVWG1YL0UmI3hBO1g1ZWFQZnUzSzVqaCtxM1hjK3JibjBpVzkzQ2gvcHpudFRqNGNoRHVzTStLQUx3TC9uSmJ6TCtrL1BpYVZHMWJmUllGaUk3ZXRNQkwmI3hBO0lmOEFnU2
																	kvUm16MEdPb1gzdURySjNLdTVDLzg0M2YrVFB0ditZVzUvd0NJWWRmL0FIYU5IOWZ3ZlYrbzM5dHAybjNPb1hUY0xhMGkmI3hBO2VlZC9CSTFMTWZ1R2FXTWJOQjJaTlBnL3pEclZ6cm11MytzWFIvZjM4OGs3anc1c1NGSHNvMkdkSkNIREVBZEhTVGx4U0pmVm4vT1AmI3hBO2ZtbzY1K1hsdGJUUHl2TkdZMk10VHVZMUFhQS9MMHlFSCtybWwxdVBoeWU5Mm1tbnhROXp4Yi9uSTN5eitpUHpDa3ZvazQyMnN4TGQmI3hBO3JUb0pWL2R5ajVrcUhQOEFyWnNORGs0c2Rkemg2eUZUdnZlMy93RE9QK3YvQUtYL0FDejA5SGJsUHBqU1dFcEpyL2RIbEdQb2lkQm0mI3hBO3Uxc09ISWZQZHpkTks0QjRoL3prZnIvNlQvTWVXelJ1VU9rMjhWcUtHbzVzUFdrUHpySnhQeXpZNkdGWTc3M0Mxa3JuWGM5dS9JRHkmI3hBO3oraFB5M3NaWkU0M1dyTTJvVFZGRHhsb0lkL0QwbFZ2cHpYNjNKeFpENWJPYnBvY01CNXM4MWZVVTB6U2IzVVpFTWlXVUV0dzZEWXMmI3hBO0lrTGtENThjeG94c2dOeE5QaXE5MVR6VitZM25HM2p1N2oxOVIxT2RZTFdOMkt3UXE3VUNvdS9DTkJ1YUN2ZmM1dnhHT0tHM0lPbk0mI3hBO3BaSk1oL01MOGpQTWZrdlJWMW1lOHQ3NnpFaXhUbURtcnhsOWxZaGh1cE8xYTljcndhdU9RMVZObVhUR0F1MmRma3Q1dDEvemg1UDgmI3hBO3krUmIyNDllOC9SazZhVmQzRE1lS1R4dEJ3bGNCbTRvN3J4MkpwVWRnTXh0Vmlqam5HWTc5Mi9UNURPSmllNWovd0QwS3orWVAvVncmI3hBOzBuL2tkYy85aytXL3lqRHVQNCtMVitTbjNoZ25uNzh2OVM4azZqQnAycDMxbGRYczBmcXREWnZLNWpRbWkrcDZrY1ZPVzlBSy9xekomI3hBO3c1aGtGZ0ZveTRqRFl2VmYrY1lQSk9vL1hycnpoUFdLeDlKN0t6VWplWm1aVEk0L3lVNDhmYzE4TXd1ME1vcmc2dVhvOForcDQxNU8mI3hBOy93Q1V2MFAvQUxhRnIveWVYTS9MOUo5emg0dnFIdmU0Zjg1SS9tZDZhSHlWcFV2eHZ4ZldwVVBSVFJrdDYrLzJuK2dkem11ME9uL2omI3hBO1B3YzNWNXE5SVNiL0FKeDYvS245SzNpZWJ0YWdycGxvL3dEdU1nY2JUem9mNzBnOVVpUFR4Yi9WTmJOYnFlRWNJNXNOSmd2MUZNZE4mI3hBOzhtMkQrWVBNbWs2ak5lbTYwdlVIRVhHN3VFLzBTY0NXMk5GZW4yRG5MZHZkcTZqVFNnY1pqd1RqL05CM0hQOEFRN3ZzN1NZc29rSlgmI3hBO3hSUGVlUjVKdC95cjNRUDkrMzMvQUVtM1AvTmVhRC9SUnJPK1ArbERzZjVLd2R4LzB4L1dpOUk4b2FKcFY2MTliSks5MjBmcGV0UE4mI3hBO0pPeXBYa1ZVeU0xS253ekQxM2JXbzFNQkRJUnczZXdBYnNHaHhZcGNVUnY3eVVUcnVnNmZybGw5U3Y4QTFHdGllVHh4eVBFR3AwRGMmI3hBO0NPUTlqbU5vdGRrMDArUEhYRjVnR3ZjMjU5UEhMSGhseTk5SlBCK1d2bG0zaUVVSDF1R0pmc3h4M2x3cWl1K3dEMHpiSDJwMWg2eC8mI3hBOzBvY01kazRCeUIvMHgvVzNKNVMxT3dpZHZMK3NYVUpJL2VhYmZ5TmU2Zk9PNlRRemM5bTZjaHVNeTlMN1ZaT0tzMFJLUGZIYVEvUTEmI3hBO1p1eUkxKzdKQjg5d2ttaGFwRnBFOFYxYXdtdzBpNHZCcDJ1YUl6RnhwdXBPQ1k1SUdZay9WcmlocFhZSHZtNTdhN09ocThQaXczeUMmI3hBO1BGR1g4K1BjZk1PQm9OVExEazRKYlJKb2orYWZMeUxMTmE4cWFOckZ6RGRYaVNMY3dLMGNjOEVza0w4R0lKVXRHVkpGUjN6ak5CMnYmI3hBO24wb01jWjJsMEl0M3VvMGVQTVFaRGNlZElIL2xYdWdmNzl2ditrMjUvd0NhOHp2OUZHczc0LzZVT1A4QXlWZzdqL3BqK3RJL05IazYmI3hBO3d0MDAyeDAyNHZZOVIxYS90N0czYzNsdzNBU1BXUitMT1JSVVU1dSt3ZTJOVHFjeEV6SGdqRWsra2ZCd08wZEZpeFl4dzN4RWdjejgmI3hBO2ZzZXhmbWpHa2Y1WitZbzBIRkUwNlpWSGdBbEJtOTAvOTRQZTYvTjlCOXo1QzhuNkErdXo2blpSSnp1VTA2NHViY1VxM08yNHpVVUQmI3hBO3V5b3lmVG04eXo0YVBtNnJGRGlzZVQxei9uR1R6bEJZV2ZtSFNMNlhoYTJzSjFlUC9KU0plRnlmK0JFZVlPdnhXUVI3bkswYzlpSG0mI3hBO09uV3Q3NXYxenpKcnQwdk1RMmwvcXQyVHVBekt3akErVWtpMDlobVpJaUFqRWVRY2FJNHpLWGtTeVQvbkc3L3laOXQvekMzUC9FTXAmI3hBOzEvOEFkdG1qK3Y0UFgvOEFuSkx6VCtpZklnMHVKK04xcmtvZ29EUStoRlNTWWovaEVQOEFyWmc2REh4VHZ1Y3ZWenFGZDd5RDhzL3kmI3hBOzUveEQrWDNuUFZtaTVYRU1DeGFZOUtuMWJlbDFLcSs3
																	S3FKL3NzenRSbjRja1IrTzV4TUdMaWhJb24vbkd2elYraWZQTGFUTS9HMDEmI3hBO3lJd2dFMEgxaUdza0pQekhOQjd0ZzErUGloZmNuUnpxVmQ3MUgvbkpqeTEray9Jc1dyUkx5dU5GbkVqSHY2RTlJNUIvd2ZwbjVETVAmI3hBO1FaS25YZTVPcmhjTDdtRS84NHZlYUlMRzU4d2FWZHlCTGMyNDFGU3gyVVc5Vm1JSHVycWY5am1SMmhqdWlQYzA2S2ZNUExyT0M5ODgmI3hBO2ZtQWtacUxqWHRRTFNFZnNMUEtXYy9KRUpQeUdaaEl4dzl3Y1lEeEorOHZ1QzJ0NExhM2l0b0VFY0VLTEhGR09pb2dvb0h5QXpuaWImI3hBO2R5MWRXc0YzYXpXdHdna2d1RWFLWkQwWkhCVmdmbURpRFJ0WHlKNTkvSnZ6bDVMMVJyN1RvcDd6U1laUFdzdFV0UVRKRnhZRkRLRSsmI3hBO0tOME5QaTZlQjdEZVlkVkRJS1BOMVdYVHlnYkhKT2ZLdi9PVFBuTFRmVGcxeUNIV3JWYUJwU1BRdWFkUHRvT0IrbEtueHl2Sm9JSDYmI3hBO2RtVU5aSWM5MzBUNUw4NzZENXgwWmRVMGVVdEdEd25na0hHV0dTbGVFaTFPL2dSc2UyYXZMaWxqTkYyR1BJSml3cCtmdk9tbmVUdkwmI3hBO04xclY0UXpJUFR0TGV0RE5Pd1BDTWZkVStBQk9PSEVja3FDNU1nZ0xMNVA4cTZCNWcvTS96OHd1WldlVzhrTjFxdDVUYUtBRWNpbzcmI3hBO2JVU05ma09tYnJKT09HRzN3ZFhDSnl6M2ZaR2xhWFlhVnB0dHB1bndyQlpXa2F4UVJMMFZWRkI4ejRrOWMwVXBHUnN1MkFvVUh3VHAmI3hBOzk5UFlYOXRmUVU5ZTBsU2VMa0tqbkd3WmFqd3FNNlNRc1U2T0pvMmk3RzZ0TDd6SEJkZVlacFpMUzV1bGsxV2RONW1SM3JNd3IrMVEmI3hBO2s0Q0NJMUg0SmlRWlhKOTE2VEJwc0dsMmtPbUxHdW1wREd0bXNQOEFkK2lGSERoVHR4Nlp6a2lTZCtidXdCV3pFdk5mNVorV3RYMXAmI3hBOzlidWRUdjhBU2J5NGpqaG1heXV4YXJLSXE4QzN3bmt3RFU2NFR3emlJeWhHWUg4Nk4waWlEWUpqN2pTVWY4cWw4cWY5VGJyZi9jVi8mI3hBOzV0eUg1ZkQvQUtqaS93QklHWEZQK2ZQL0FFeGQvd0FxbDhxZjlUYnJmL2NWL3dDYmNmeStIL1VjWCtrQzhVLzU4LzhBVEYzL0FDcVgmI3hBO3lwLzFOdXQvOXhYL0FKdHgvTDRmOVJ4ZjZRTHhUL256L3dCTVhmOEFLcGZLbi9VMjYzLzNGZjhBbTNIOHZoLzFIRi9wQXZGUCtmUC8mI3hBO0FFeFl6NWRZV2ZtalhOQ3N0WWsxL1NMRVF5VzkvTklzMGtja3ZMbkE4eTdTRmVQMGRNNXYybjBlTEhISGtqRVk1U3NFQVZZSFduWjkmI3hBO2s1cHlNb2ttUUZibjdyU2J6ZmJ3L3BIemJEVVJ4WFBscGIyZWc2M05uZlJpM2ZiOXJjcURtMzlsY2twYVlBL3c1Q0I3akd5NFhiRVEmI3hBO01wSTZ3djVIWmsrdFhFN2VUcjY1TWpXOXgrajVaZldSaXJSdjZKYmtHV2xDcHpqTkxqaU5iR05jVWZGQXJuWTRxZDdua2ZCa2JvOEomI3hBOytHeXI1WC9MYlFOUzh0YVRxTjc1cDFxSzh2YkszdUxtSWFvVkN5eXhLN3FGSXFLTXgyT2VoNU5OaEVpQmh4Yy81Z2VhaFBJWWdtYy8mI3hBOzlNV1NlWGZ5czhyMkd1V21zdzZ2cU9yWFduRjJ0MHZMd1hVU05LalJsdVBIWThTYWI0eEVZQWlFSVE0dWZERVIrNVNDU0NaU2xYZVMmI3hBO1V6L05YL3lXL21UL0FMWjgvd0R4QTVQVGYza2ZleHpmUWZjK2F2OEFuSGovQU1tcnBnN0dLNkJIL1J1K2JiWGYzUmRkcFByU1B6M3AmI3hBO1Y3NU44ODY3cE5vN1c4UEtXS01Mc0dzN3BlU29mRWVtNEI5OHR3eUdTQUovQllaUVlUSUQwRHlINVorcGZrSDV2MTZWS1RhdWhTRmkmI3hBO1A5MFd6aFFRZmVWbkIrV1l1YkplZU1lNXlNTUt4U1Bla2Y4QXpqZC81TSsyL3dDWVc1LzRobG12L3UydlIvWDhGdjhBemtQNXAvVGYmI3hBOzVoVDJjVDhyVFJVRmxHQWRqS1BpblB6NXR3UCtyaDBXUGh4MzNvMWM3blhjZ3RGOHFmbmxaYWRISG8wR3RXZW56RDFraXRacFlZMjkmI3hBO1FBOHVDT29xd3Ayd3p5WVNkK0cxaml5Z2JYODJKUzIrdmVWZk1NUXVvSkxEVjlObGluV0tRY1hSMTR5eG42ZGpsOXhuSGJjRnBvd2wmI3hBO3Z6RDdXaWZUZk9ua2tOL3g0YTlZVUkyWW90eEhRai9XUXQ5NHpuOThjL01GM0cwbytSZkZLVDZ2NWExZS90VkpndklsdXROdkUzK3omI3hBO0lyUVRLZnZPZEJRbUFmaTZlekFrZkI2ci93QTR2ZVdUZSthNzNYNVVyRHBNSHB3Ti93QVgzTlYyK1VRZXZ6R1lmYUdTb2lQZTVPaWgmI3hBO1pNbjA5bW5ka2t2blc2MXUwOHA2cmQ2RUEyclcxdTgxb3BYbnlhUDRpb1Q5b2xRUUI0NVppQU1nSm
																	NtTXlRRFhONEg1RC81eU84d3kmI3hBO2VacldMemJkUXBva29aSjVZb0FwallyOERIaFZ1UExyVE5sbTBNZUgwODNCeGFzbVhxNUt2NS82cCtWV3FhTGIzbWhUMmMvbUpyaFMmI3hBO1piRUx5YUVxM1AxeW9BTzlLVitLdnRYSFJSeXhOU3ZoVHFwUUkyNXFQL09MRTl4RHJtdnU3K25waVdTU1hVakVMR3JySldNc1RzUGcmI3hBOzlUOGNQYUkySGZhTkZ6TER2emwvTW1YenI1bVkyek1ORDA4dEZwc1oyNTcvQUJ6c1BHU20zZ3RPOWN2MHVEdzQ3OHkwNmpOeG5ia0gmI3hBO3FmNVFlYlB5ajhrK1dFZ2wxNkZ0WnZ1TTJxVENLYy9IVDRZbElqK3pIVWo1MVBmTUxVNDh1U1hMWWNuS3dTeHdqVjd2VHZMbjVtZVImI3hBO3ZNbW9IVHRFMVZMeTlFYlNtRlk1VlBCU0FUVjBVZnRETVNlQ2NCWkRrUnl4a2FCZkZXaTZlTlMxbXcwNHY2UXZMaUszTWdGU29sY0omI3hBO3lwdFdsYzZDY3FCTHBvUnNnUFRmenovS1MwOG10cCtwYUtraDBhZEZ0cmd1UzdKY292Mm1iL2k1Unk4S2c5TmhtSHBOU2NsZzgzSzEmI3hBO09BUm9qa3o3L25Hdjh4ZjBocGorVU5SbHJlYWVwazB4bU83MjFmaWpyNHhFN2Y1SjhGekcxK0NqeGpxMzZUTFk0VDBaVCtmbWl3MzMmI3hBO2tZYWpKQUxqOUNYY0Y4OEpGZWNJZjA1aytSU1NwK1dZMm5Kc3hCb3lCRjl4NkZ2eWdVQ1JZQkJZckgrWDNrU1NOWkk5SXQyUndHUmcmI3hBO0RRZ2lvUFhQUDVkdmE2SklPU1ZqM2ZxZWtIWjJuUDhBQkZkL3lybnlSLzFaN2Y3ai9YSS82SU5iL3FrdnMvVXY4bTZmK1pGMy9LdWYmI3hBO0pIL1ZudC91UDljZjlFR3Qvd0JVbDluNmwvazNUL3pJdS81Vno1SS82czl2OXgvcmovb2cxdjhBcWt2cy9VdjhtNmYrWkZWdWI3eWwmI3hBOzVRMDdoU0N3aDZ4MnNJSHF5c2VuRkI4VHNlbGNqandhdnRESmZxbWU4OGg4ZVFaVHlZZE5IcEVkekU3aTIxRFU3cWZUTHlJdzY1NWwmI3hBO2tnbDFTejZ0cHVpV2ppU09HWWo3TTF5L0ZpdmhTb0ZjN21Vc2ZadWsyTjhBTmYwcG45QSs1NThDV3F6Ymo2dWZsRWZyZWkzVnBiWFYmI3hBO3JMYTNFWWt0NWtNY3NSNk1qQ2hVMDdVenpURmxsQ1luRTFJRzdlcWxBU0JCNUZJZitWYytTUDhBcXoyLzNIK3ViVC9SQnJmOVVsOW4mI3hBOzZuRC9BSk4wL3dETWluLzVCYUxZMjJpYXhyVm5Bc0Z0ckdvUy9VbFFVWDZwYWt3eFUvMmZxSE8vbVppRUl6TnpFUnhlODgzbllpUEYmI3hBO0l4RlJNalh1NU05ODBhR3V2ZVhkUjBWcGpicnFGdTl1Wnd2TXB6Rk9YR29yVDU1SEhQaGtEM0psR3dRODUvTC9BUDV4L3RmSi9tbTImI3hBOzErUFdudkd0bGxVVzdXNGpCOVdNeC9hRWpkT1ZlbVpXYlduSkhocG94YVlRTjJqZnpPL0kvVHZQT3RRYXVkU2ZUYm1LQVc4b1NFU2kmI3hBO1FLeFpXTlhTaEhJajdzanA5V2NZcXJUbTA0bWJaSGQvbC9ZeWZsMGZKTnZPYmUxK3FKWmk2Q0JtcXRDMGhTb0ZYWUZqdjN5b1pqNG4mI3hBO0g1dG5oamg0ZkppWDVlZmtKYitUUE1pYTVEclQza2tjVWtTd3ZiaU5mM2kwcVNKRzZaZm4xbmlSNGFhc1dtRURZS1JmOUN0MlUycGYmI3hBO1hiN3pITmRHU2IxcnBUYktwbDVOeWNGdlZOT1crOU1zL2xBMVFERDhtTHNsN1BwdXNhVHFKdUUwNjZpdWZxVXB0N2tSTUdFY3FmYWomI3hBO2FuUWp3elhPWTg3L0FESy9JblR2TzJ2cHJYNlRmVFovUVNDWkVoRW9rS0ZpcmtsMG9lTGNmb3pNd2F3NDQxVnVQbDA0bWJ0bG41ZWUmI3hBO1RwZkovbG1MUVcxQnRSaXQ1Skh0NVdqRVJSSkR6S1VEUFdqbGpXdmZLYytYamx4VlRaamh3aW1DZWR2K2NjOU04emVaNzdYWTlYZlQmI3hBO3pmTXNrbHN0dUpGRGhRck1HTWkvYkk1SGJxY3lNV3VNSWlOWFRUazBvbEs3WlQ1SThyK1h2eXk4dVI2WGNha2pmWHJ3MHVwd0lqTmMmI3hBO1RBS2thclZ0K01kQUs1ajU4eHlTdHV4WWhBVUdiNVMyS043ZldWamF5WGQ3Y1IydHJFQVpiaVoxampVRTBISjJJQTNPS3ZKZk5mNUEmI3hBO2VRL05kN2QzK2gzNDB5OVdab3IxYlQwN2kzV2RkM1Y0UXltT1FjaFZRNCtXWnVMWFNpS083alpOTEdSdmtXT1duL09KeWlhdDU1bEwmI3hBO1FCdGxodE9Mc3Y4QXJOS3dVL1FjdlBhWGRGcEdoSFV2V05FL0xYeTdvUGxDKzh0YU9qVzhXb1FTdzNONDlKSm5lV014K281K0dwQU8mI3hBO3lpZzhNd1o1NVNrSkhvNWNNUWpHZzh0LzZGT3NmK3BrbC82UkYvNnE1bS95a2Y1cmpma2gzdS82Rk9zZitwa2wvd0NrUmY4QXFyai8mI3hBO0FD
																	a2Y1cS9raDNzci9MYjhpcmJ5UjVpYldvOVllK1kyNzIvb05BSWgrOEtubHlEdjA0K0dVWjlZY2thcW0zRnB4QTNhUWFSL3ppOVomI3hBO2FicTFscUk4d3lTbXp1SXJnUm0xVmVYcE9INDE5VTByVExaZG9FZ2ltdU9qQUlOdlcvTm5sblR2TS9sNjkwVFVCL285NUdWRGdWYU4mI3hBO3h1a2kxN293QkdZT1BJWVNCRGxUaUpDaThvOHYvd0RPTlRhRHJWbnJHbithSlk3eXlsV1dKdnFnb2FkVmFrMjZzdFZZZHdjelo2L2kmI3hBO0JCanpjYUdrRVRZTDJYVWRQczlSc0xuVDcySVRXZDNFOEZ4RVNRR2prVXF5MUJCRlFlMllFWkVHdzVSRmltRmo4aS95dUFBR2p5QUQmI3hBO1lBWHQ5LzFYeTc4elB5K1EvVTErREh6K1pZNTV1L0xXUHlpSWZNbmttem1lSzFESnJPamlXYWRyaTJKQjlTSDFua2IxSXFWb0R1UHgmI3hBO3h0WnBvNnpFY1U2RXVjWmR4L1VXN0RsbGdseHhzanFPOGZyUWtzWGx6em5vS2tQOVlzcHZpU1NOaWtzVDA4UnVqclhjSDZjNFNNOVQmI3hBOzJkbjVjTXgzOGlQMGg2RWpGcWNmZkVzUWcvSys3MHlSMVMwc3RmdG1KS3RlM09vV2x3bzdDdHRNSWlCL3E1MWVEMnN3VEg3eU1vUzgmI3hBO2hHUSszZDAwK3hza1Q2WmNROHlRZnNUTFMvS2V1Mmt2TFM5TTBYeTJ4TytvMjZ6NmhmcjRtS1c4TExHVFg3UTN3NmoycjA0SHBFNW4mI3hBO3pxTWZzL1V1THNmSmUvREg3VDlxZldXbmFENVQweTV1NVppb1ltYlVOU3VuNXp6U0g5cVJ6dXpFbllENkJuS2FuVmFudEhNQlZubEcmI3hBO0k1RDhkU1hjWXNPTFRRSjVEcVQxVmZLSGtWUFBjc25tVHpWYVRSNkd5ZWxvR2xOTExBN1JraG11NWZSWkdySlFCQlhwOUJQYjZEUlImI3hBOzBXTGdqUnlIZVIvUVBJT2gxR2M2aWZFYkVlZy9TV1VmOHFNL0svOEE2dEVuL1NiZmY5Vjh6UHpNL0w1RDlUUjRROC9tV1g2TG8ybWEmI3hBO0xwZHZwV2x3QzJzTFJlRnZBQ3pjVnFUOXB5ekhjOVNjcW5JeU5ubXpqRUFVR3RlbHVvdEQxQ1cwbml0YnRMYVpyZTVuS2lLT1FSbmcmI3hBOzhoYjRlS3RRbXZiSXBlSitTSmRibDFaTkg4eStZOWMwdTZ2ckNhYTQ5ZTVTYTF1WTEvZUM1MDYrUitNUEJSeVBGV0hHdnhZcFFWdmYmI3hBO2VhckR5MTVwODk2VnJlcnphSGFLTFB5N0hxVjFMY21jdk1rRXQ0eVBST0s4bU1mdzlldjJkMUN2NWgxUHpQNVRtbTB1Mjh5Mytyd2EmI3hBO3Y1Y24xQnJpNG5aNUlMaU5XWlo3ZVFjWGpSdU5GQVBmNVlwWlI1bzh4YTliL2xONU5OcnFNbHJlNjYyazJON3E1Wm1talM1dCtjczMmI3hBO3FHcmNpVjNicnVlK0tFcDA3ejIvbE9MenZhdnFtclh4MG1CSmJDSFhVSnVZNTNQb3BTVm1Ka2psa2RXWDRCOE8vamlsaTJoK2NkUnMmI3hBOy93QW0vTm1qMitxc05XMGVXenViYlVMT1loekZlM0VKa0NTb1F4S09YVnpYOXFtS0hvSDUrVytvMldpdytZTk8xclU5UHVWbXQ3STImI3hBOzFuZHlRVzVSM2NzN1JwU3NueFU1VjZBWXF4Zjgxdk1XcStVTHZTL0x1aCtZYnd6NmFyNnplM0dvWGpTVFQvR3F4V3JQOFBOU0ZZK2smI3hBO2RpRDB4U212bVcyazFQek41TnZOTTh5YTNiNmI1eGVhYTRnZzFDUkVpUVFMS2lRcXZ3eDBMVUkzeFZLdGJnMW5VNS9OOSsrdjN0cE4mI3hBOytYcVJSYUZHMGdZc1lvU0dtdUNWSmtrdWZUKzEzSjMyeFZrLzVrK2NOYXQveXg4cStZNFpKb0wyN3VkTXVidUcwZDRta0VzRFN5UWYmI3hBO0NhOFhPM0U0b1lZMnZhM3JmbE9LOXZkYWwrdStiTmZpMGZVN2QyWTIybFFjMlBveHdTVmpTUWhWYm5TdE85ZVJ4U25FS1FhTHFYblAmI3hBO3k1cW5tTFZZdEQwTTIycmpWYmE0RU4rWnA0ZUx3VFhDS0RLMHBkYUE5U294VkticUR6bnBQa1BTTlgxTFd0ZDVlWXRlc2xTeWh2SjUmI3hBO2I2TFRtanVPTU1UVkJhYVpXQm9CUWtKdFVZb1JKMTM4d3JQU0cwK1MrMWJUZEoxalhyTFROTDFQV1U0YWpEYlRLNXVHWm1BWUdvVGkmI3hBO3g4RzZZcFFIbmpYL0FEYjVlVHpONVdzdk1Hb1hjZW5YT215Mk9wU3p0OWJqK3NvVEpESk9uQm1EVkJwN1lxbjNsZlg5YTg4K2VXMFAmI3hBO1U5UjFMUjdpeTBFdzZ4YldOeTlzVTFHMTFCVmVWT05VckpHVnFRUHNualhGQ2Rma0hiNmplNkxONWcxSFd0VDFDNWFhNHNoYlhsM0omI3hBO1BiaEVkQ3JyRzlhU2ZEVGxYb1RpcVcyV2g2anFQNW5EU2RCOHphN05wT2dzcy9tRzV1ZFFsbGlhWXR5anM0MVhpUDJTSHJYYW82amQmI3hBO1ZoL2tuWHZOR3A2em9OaEJyV3ZOZjZwZFhVT2
																	90ZDNMZlVXc1VMQ1JyTnBHNWV0RW05VjZNQmlsbnZrenkzZXQrWlhtWFQ1L011dTMmI3hBO0ZuNWJrMHlTeWhtMUNXUkpmck1CbWtXNFUvQzY4bHBTZzJ4UTljeFYyS3V4VmdQbVQ4cE5Qdk5RbDFueTVleWVYZGFtUEs0a2dVU1cmI3hBO3R3ZkdlMlloQzMrVXRQSGM0Y3NjZWFIQm1pSngrMGU0ODBRTW9TNG9IaFAySDNoajBtaGZtOVlIMDVOSjAzV2xHd210THMycEk4V1cmI3hBO2RUUStOTTBtWDJhMDB0NFpKUTk0NHZ1cHo0ZHFaUjlVWXk5eHI5YlNhUDhBbTlldDZjV2g2ZnBXMzkvZVh2MWhSN2hiZEs0TVhzenAmI3hBO28vWGtsTDNSNGZ2dFpkcTVUeWhFZTgzK2dKNW9YNVFXdjEySFZQTjErM21IVUlUenQ3WjBFVmhDM2lsdUtoMkg4emsvS3VidkJqeFkmI3hBO0k4T0dQQU9wNXlQdkxnNUpUeUc4aDR2dUh3ZWlZcTdGWFlxcDNWdGIzZHROYTNNYXpXODZORk5FNHFybzQ0c3JBOVFRYVlxd3kzL0omI3hBO2o4dmJlTzZTSFQ1RkYxQzlxeE56Y09ZNEpDQzBjWE4yNEEwN2ZMcGlxL1NQeWY4QUkrbGx4QmJ6eVFTUXZidmF6M00wc0ppa0hGbDkmI3hBO04ySzlPbmhpcTdUdnlnOGdhZGFhaGJXbW5GRjFPRTJ0ekkwMHNrZ2diL2RTTzdNeUxzT24wNHFwV2Y1TmVRcmEwdUxKclNhNXM3bUomI3hBO1laTGE0dVo1RUNJeXV2QUYvZ1pTZ29Wb2UyS3RRZmt0K1hrTUlpR251OVo0cm1XU1NlYVI1R2dyNmF1ek1TVUhMN1BROSttS296WHYmI3hBO3l1OG1hNWRYRnplMmJMSmQyeVdkeUlKR2hWNFk1bG5VTXFFQ29rUlRYcnRpcUdUOG9QSmE2YmM2YThkMU5hWFVzRThxelhVOGg1MngmI3hBO1l4bFN6RXIvQUhoclRyaXFjcDVKOHREV05VMWVTMFdlKzFoSTQ3MTVpWkFVaVRncW9yVkNEajE0NHFoZFAvTHJ5dllSYUpIYnd5OFAmI3hBO0xyelNhVnlsZHZUTnhYMUsxUHhEZmF2VEZWSHpCK1Zma1R6QnEzNlcxWFRCTmVzRldkMWxsaVdVSjlnU3JHNnEvR2c2anNPMktwdnImI3hBO25sZlJ0YXRMTzB2b1NiZXd1SXJ1MWpqWXhoWllLK245bW13cjA2WXFsVjcrVi9rcTl1TldsdXRQOVZkYktQcU1QTjFqZVdQZFpWVlMmI3hBO09FbTUrTmFIYytKeFZCditUWDVmdm9iNktMQjFzNWJoTHVkMW1sOWFXYU5XUkRKS1dMc0ZFalVXdEIxcGlxclkvbFA1UHMvUjlOTHEmI3hBO1QwTHkyMUdMMXJxYVhqY1dmUDBXSE5qc1BWYW83OThWWkI1Zzh1Nkw1aDB1VFM5WnRWdkxHVWd0RTFRUXk5R1ZsSVpXSGlweFZqeWYmI3hBO2xGNURqMFNYUm83Qmx0SjU0N3E0ZjFaRE5MTEZYZ3p5bGk1QzFOQldtK0twemJlVDlBdHZOTno1b2d0L1QxbTh0L3F0ek9HYmk4WUsmI3hBO0hkSzhlWDd0UlgyeFZmNVk4cmFONVowMDZicEVUUldobGVjcTdzNTV5R3JHckVuRldOMlA1TGVSckc5Vzh0WTd1S1paaGMvRGVUaFcmI3hBO2xEQnFzdktqYmpldUtwaEIrV1BsQ0N6MHUxaHRwRVRScnRyL0FFK1FTeUNTT1oyNXY4ZGFsV1BWVHRpcUl2OEF5QjVadjVOYmt1WUomI3hBO0diekQ5Vi9TbkdhUk9mMUlBUWNTaktVcFRmajE3NHEvLzlrPTwveG1wR0ltZzppbWFnZT4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgIDwvcmRmOkFsdD4KICAgICAgICAgPC94bXA6VGh1bWJuYWlscz4KICAgICAgICAgPHhtcE1NOkluc3RhbmNlSUQ+eG1wLmlpZDoxMDc4MTIwYS00NDQ3LWU4NDMtYmQ4Ny0wOTA0ZmU5M2M0NWI8L3htcE1NOkluc3RhbmNlSUQ+CiAgICAgICAgIDx4bXBNTTpEb2N1bWVudElEPnhtcC5kaWQ6MTA3ODEyMGEtNDQ0Ny1lODQzLWJkODctMDkwNGZlOTNjNDViPC94bXBNTTpEb2N1bWVudElEPgogICAgICAgICA8eG1wTU06T3JpZ2luYWxEb2N1bWVudElEPnV1aWQ6NUQyMDg5MjQ5M0JGREIxMTkxNEE4NTkwRDMxNTA4Qzg8L3htcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOlJlbmRpdGlvbkNsYXNzPnByb29mOnBkZjwveG1wTU06UmVuZGl0aW9uQ2xhc3M+CiAgICAgICAgIDx4bXBNTTpEZXJpdmVkRnJvbSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgIDxzdFJlZjppbnN0YW5jZUlEPnV1aWQ6YTYzZjU2NDEtZjE1Yi00ZjdhLThhMzgtYzk1MTVmYmY1MjI0PC9zdFJlZjppbnN0YW5jZUlEPgogICAgICAgICAgICA8c3RSZWY6ZG9jdW1lbnRJRD54bXAuZGlkOmU5ZjJlOTM0LTMwZjktYzI0MC1hZTI2LWUzZjdiNjAxYmE3Zjwvc3RSZWY6
																	ZG9jdW1lbnRJRD4KICAgICAgICAgICAgPHN0UmVmOm9yaWdpbmFsRG9jdW1lbnRJRD51dWlkOjVEMjA4OTI0OTNCRkRCMTE5MTRBODU5MEQzMTUwOEM4PC9zdFJlZjpvcmlnaW5hbERvY3VtZW50SUQ+CiAgICAgICAgICAgIDxzdFJlZjpyZW5kaXRpb25DbGFzcz5wcm9vZjpwZGY8L3N0UmVmOnJlbmRpdGlvbkNsYXNzPgogICAgICAgICA8L3htcE1NOkRlcml2ZWRGcm9tPgogICAgICAgICA8eG1wTU06SGlzdG9yeT4KICAgICAgICAgICAgPHJkZjpTZXE+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPnNhdmVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6NjRhODMzZGQtNThkMy1jMzQyLTlhODMtZGM5YTM2ODE4NDhlPC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDIwLTAyLTI0VDE1OjA5OjAyKzAxOjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBJbGx1c3RyYXRvciBDQyAyMi4wIChXaW5kb3dzKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPnNhdmVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6MTA3ODEyMGEtNDQ0Ny1lODQzLWJkODctMDkwNGZlOTNjNDViPC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDIwLTAzLTA0VDEzOjUyOjUwKzAxOjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBJbGx1c3RyYXRvciBDQyAyMi4wIChXaW5kb3dzKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgIDwvcmRmOlNlcT4KICAgICAgICAgPC94bXBNTTpIaXN0b3J5PgogICAgICAgICA8aWxsdXN0cmF0b3I6U3RhcnR1cFByb2ZpbGU+UHJpbnQ8L2lsbHVzdHJhdG9yOlN0YXJ0dXBQcm9maWxlPgogICAgICAgICA8cGRmOlByb2R1Y2VyPkFkb2JlIFBERiBsaWJyYXJ5IDE1LjAwPC9wZGY6UHJvZHVjZXI+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC
																	AgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCAAtALgDAREAAhEBAxEB/8QAqgAAAgMAAwADAAAAAAAAAAAAAAkHCAoEBQYBAgsBAQACAwEBAQAAAAAAAAAAAAAGBwEEBQgDAhAAAQQDAAIBAwIFAAsAAAAABQMEBgcBAggACRESExQVFiEiIxcKMTIltdV2JzdXlxgRAAIBAwMDAgIJAAUJCQAAAAECAxEEBQASBiExByITQQhRYXGBMkIjFBVykiQXCbHRUoKiM0M0VLLSc4OTo7PjFv/aAAwDAQACEQMRAD8A38eNNHjTR400eNNHjTR400eNNHjTR400eNNHjTVBe+/ZBzv65ITCZje2k2PO7EkbqOQ6DVkLjx2dGv0xlh6cOtxcllMOGax6P/kNEnjjZ7jbRd+2T003yp/CWcT4bmOY3MttivaRYUDO8hZUWpoq1VXO5upAp2VjUU1HeRcnxvGYI58h7jNK21UQAuaCpNGZRQdKmvcj6dWrpezFLkq2FWjvXljVVpNwqB9rArbEhAFigWD3bfcenKgUfkUqHhSLxlhNx+Js93ct9FddHGiK+qiOnByVkMdfS2Imhn9ptpkiLNGxHfazKpYA9K0oaVBIoT17G6N7aR3Zilh9xa7JAA4B7bgGYAkdaVqPjQ1GpP8ANHW3o8aaPGmjxpo8aaPGmjxpo8aaPGmjxpo8aaiZ/fdFinz0WUuiphpMa7csCI5/Y0PZvmD5mtu3dsnrRwYTcNXbVwntoonvrrvpvrnXbGM4zjzfTFZSRQ6W1wyMKgiNyCD2INOoOtNshYIxR54QwNCC6ggj4HrqvPSfe9GULWDyXxuURW67CMFhkMqynq4m8YLSyybGkeyyUejbZRk+fpAROuG6zwqWc6fiixTRy53xvlPVJTMtkuNs
																	7nM8kf8AjeN2FvJcXd3OjrFb28Q3SSHpVmpRUjQF5JGWNAWYawt4LueLH4cC8zFzKsUEETKXllf8K96Ko6s7tRI0VnchVJ0hro6xmBVITLfY9fZyYyGevcN4ZyzVxeeC6eYuVVU8tItCqYgTnEpuF8NXX1buJBKP1HXdRXXP0sU99UvPEUfn35i/mC5Ld8Y+ULC/xfDLEgTZWeO2/dMtSPeu768DW1kJF/Ujs7Rf3IVWIeeh232/jvxb4xxUGa83ZBLzO3FdlqrTewGPQx29nD+rdBNwV551dKkMVhDU1BLQdwaGwocd8tzyghzJqi7c3BFIMWhSUMaOldNWhORWTQEpKnqzY7vNE9fyDC4xumtnXC22vxn47F94+/xJ+JQ/zON5fByG5j9X7EXsd40gH4lW1ytpFBO20n0RF5WAIjBYqDpW/JflQzDNYT4aLGRSekzi0a1C17E3NmxeFaget2jQGm4jTQ6E7LszlYpDRt622T6H47nz6PBIt0DKHI03ZdFkJSs0YxV3Z85DIth1o0lIXrtFLEqd6frAZd0nu/cPWe+XLac+BvmMsPNuSuPHvMMZHxvzhZCWtoqyQ22Q/bgmeOC3nJmtMhCFZpLJmdZEjkeLYytCvA8ieMLrx/apybCXcmU8fzFayMVkmtPdI9t2ljAWe0YsFE1PciJT3DIjGRXKf/RXPv8A51pv/wBnQn/jfno3+Hy3/S3P/pP/AN3VYfyWO/6iD+uv+fXNdWfDZVCJ2YraexKWOY5GzDpV7EZGDkuoh/gQ/dDtnmRbt+i2V3Ua7bp6q4xjf7efjGcYz5+VsbmC6ijvYpI1dwKOrLUVANKgfT8Nfo3UE0Ej2siOVU9VYNQ0NK0rrCj66vd13GS7a5yjXSHRRuwKXnNjC68mseOR6AiBuqVgJOIeEPOSYGIiyTNKLSQ0zJb7ara6bJtdtVP5NtvPUnMPGXF04zeTYazWHJRQmRGVpCf0/WygM5B3KCvb49OuvP8AxnnmfbO20WUuWksZJQjAqgHr9INQoI2sQ3f4aeL/AJDPsXufjCD8+V1zZY6tc2vZsnk0wkR8UPAGDDCvIYMRDoC1WMjFmR7ZjK5JJ9VdFsIYW23Cb6ab66/d12rDxDw7G8kuru8zUPvWECKiqSwBkc1rVSCSirSlaesEjtqe+SeTX2Dt7a2xcvtXkrszEAEhFFKUYEUZm70r6ft1I/8Aj29b9Fdgcz3VN+kbOKWlKozeisVBGCouOClh8f1gEOL4GpoxoMEaKJYIkl1fqUT3U+VM4+r4xjGNPy5x/D8ezVtbYaBYIHtdzAFjVvccV9RY9gBra8b5nJ5rFT3GUlM0yXG0EhRQbFNPSB8SdZ8fcb7LbDM+yeYZqhtVBqJ8pnI3AIiQl1IUtZxFCW16ZRKzUi1lk4gcnlADRGynLljrgeQa6afgpKJ/bX2zt5bnjrhdnHwuP9+bhbi/VpHCTTRDZIKICiOqt+mA3qU/iINRquObcpuX5Q/7MQtDZsqKWiikO5DVjudGYeuo6EdgRQ60bez/AKevk96r4f3Nw7aZqtHzdjU9xmVAjKOSJ2RqyfskQkgjL5rIQBZrqRiR+VMHLxTVFBZrgU613xrj69cU5wfCYqLncnF+TwLOpMsI3FlAljO5WBVgaOqsB1IO5fq1ZnK8rkJOIpn8BM0TARyGgVqxuKFTUEVUsCegI2nXI9UvsVOXP6s5f07f0r3mlgc3I3enckicJiRpA9rXw55Zwd0oPFMhw9ms4gB0cyT+0jrosu322xj6s7a4xzzh8WN51HhMTH7VpemH2V6kL7hERFSST+orHqegOs8Q5LJfcSfK5F99za+77jdATsBcdAAB6Co7dSNUV/x+eue+e4Lnvqf9EX1JJxS9WQ8YLaxRaNwUEFdWXYRpR2E2buQkWGk12kZjEYJ/W30XzhPd612Uz/q43lPlrj/FOMY20tMPaJFkp5CS+52YRxrRvxMRVmZetPg1Pq4HjnM8iz19cXOTuGksYUAC7UA3uenZQfSqt0r8RXTP/dF37N/XvyO1saqWYV1bNi2GHrCDOpEMWLho4o/CyCRnJW6G4VbNSDgUIju6TRBdTKWXrpHdRJdFNVLaD+NuJ2vLuQGzvywx8MJlcKaFqMqqoPUipapI60BAIJB1K+c8in43hhc2YU3ksojTcKhagsWp8aBegPxIqCARrOWIs7/IW25ognsKhXRpi3a/nRVFy0r2vxkVsuVtmDo2tH9XxunY9VzuJMwqpVrs2XbsFN3g3bOfvotd8bZ1uKSx8RfzcvEbmzW3u4loZJC0aEhd1FmaUOWoagt0b4FtVkl35I/io+SQXTTW0h6IgV2pWlTGI9tK9CB1X4gabLMJf7lu9ecOWLk5OkAvjawWwWxo301XNmB3kF3JTsQfDj44fioafVjNzmkYLCWTh+312U0/H1ffj7KOdkcreQG3t/HHFMzf47Po2RtC0bW0kZD0QqSysY5UXcCQp+nbWi1pqYzzc35DjLS9w7CxuQrrOjjZVwQFKh42O0gEj6K0qaV0lDtXr/3ecJWZC6ctnuMFLbOm4hM4yhdSD4LNDYli+I6Co/g61c0uDy1fSp9qtqOao/kOVtW++22mmu6GVrL41x7xlymylyOPxbR2MTbS8pdFJAq20+81QopuJoBXuaGkEzua55x+6jsby/V7uRahYwjEAmgr+kOrGu0CpNPsrab2b9pe0rhXnr11xyV9IHI30JYda3PKb+IDY7XL5cidWnYE5Do+W1XiDsOkWryIytEI52HaJtlnLRTfG62udVduFwnjXBeU5fMTQWSPiIZ4VgBaQUXYyuw9YNJHUuN3UAgdO2uvyr
																	O8t4/jcZFNdMuSlilaYhUNTvBUH0kVRWCnb0JB799TD7U/b10ureNJcO+vOWkf71a5hjO1ZfEA8akhuR2nLhLNAZUgVM8HLA2SQH9Rw8POtNMZQfKatt1G34D3RTncE8e4UYu65Py+Nf4z1mJHLKqxITWVtpDHdSiD4qNwDb1I3eXczyhv4MBxtz++9IkZQrFpGApGKggUrVz8D0qNrV0tclV1ddXUJA4t0ZcJS8rtwOwUsaeEGQIay3khPGjh4BjbKPhALTSMRzOcNGiiiH5LrCey6uddlft6UtyC8xl9lZZ8Pbra4ytI4wWJ2joGYszHc3cgGg7DtU2jh7a/tMdHDk5zcX9Ku5AA3HuFAAG1ew6VPc96ash5xtdTR401m7ufhe0Yh0906fi3r7D9OVrb9qJ3NCp8zLcosSwspOYfGVLOixlvcliQuT/CVnjypNtvo2UR2TKZ/q7bYzjWp/N/i7yN5TvsPmuAeQ7zibWeKFndWgucvHDK0M8zwXEaWKNGHaCVYZSxqRDHQDrWYePuZcb4XbX2N5Hxr+YWa+NxDMkOPZkWSOMSRMbmWNzSZXkU0P8AvCK9BTqo5zv0BDzDWQxL1IG4sfY4cYYnI5NuBAhhnh22VZusNSYy+2r1vhy0cKJKfRvj6099tc/Ouc4z54znyheb+T4uTCcl8vLkcLNt9y3uZ+QzwPsZXTfFLC8bbXVXXcp2sqsKEA6syx84cDxlyt7jeF3dveJXbJFFiY3WoKmjJdBhUEg0PUEg9DrlSqhejZ2S0NTf1OSSZGEmiTBMtKp9wVISSbFBRZZFlo+L388daNEVnKm+qeN/o12U2zjHztn5+HHfk48y8Qx5xPEvLMOLxZkMhhtJeQW0RkYAM5jhgRN7BVBalSFAJ6DX0yPnbhOYnF1luG3t1dBQoeaPFSMFBJC7numNASSBWgJP06hQvQNcmJmnUli8oyTi3oBrEitl1hK4w1quPzZmDHEBMbJTat7doKTyuOrO46ckDBAkIcv/AKs4dIYdM1W62vzHubS/NZ8pEmP8lTc2PL+CXN9HZ3EM93f3VrJMySzi0urPIqsie9DBM0V1bjem1wssbUDdDCf3Oea0uOLNgTh+RRW7zRMILaG5SMNGhuLe4tGkX0SPGHjdqElRJG6HUXcUrqNSll87y4THyUY3j5g8ShiQZpiDAJpHrZsmlbiCRyNOsuhoyubFKQYfNBoVFLQcIUkz1g2S0aoIp69z59cdib7FcJ+aHgMk+NzuahhDzRSNFcsstlBf46dpYtjfu7aJ57OaeokkWG3JPoqef8uVxkrS45B4m5EEusfi5mVFdQY6e9NBcRrGxYC3lMcdxFGSwT3pF/CABK9ZVQQuyJ62DUHqeRnlfupJOouJljdTh2NoFiFczqR1zKNkQsztmOyVmkzlkUfN9cuWaOVcJYU0+pLfTfbuWnyy/MlPYWt7P5nuoWurO3uVQ33I2IS5hjnjqyIykmORSaHpWhoajWrceXvGEN5cWkXCHlFvczQF1tsSFZ4JXhcgPOrU3o1KqKjrTTQ/X7y5J+eOeeppXYVQiaOsC+J9YU3cVmLWr91+yq/jEFHV9WkddOquMH4Oq5VDxtcyvhk8X11dml8b7YU+vGPanHrK9wPGuO8PyGWuM5fYmwiinvppLiV7m6klee5l33f9oKe7KY4vcAKxRxqAFUaoHJz2+Ty+X5BbWS46C/uGdLcCJfaijiSGJSsBaIMVj3vsZhvdjUk6wVUFQu9q8X9uWeBHKbzbmuVcs2cgXaqKYINICZK3FX82HMk0tfu67bGJQCLqrY31+w3B77fx+fnHufLZX9hyTGWMp/s17HdRUPYyAQyIT9yugHxLjXlDHY795g7+7jH69q9vJX47CZEYD72Rq/ALq/8AOrclvtfvPoXqCVjnO8T5P9YcieE2pZmkqP0nrGkHUUKN2v2vlBus6vmyj8gEKZ+FlGYrTfbGmdMp6RK1x9vwLF2mDgI/cX+cUAg9fbMwYV+yCOONx2qxH1mR3F7NzDIXOVmB9mzxTE1HTeItp/8Aed3X40UaY56NOjxfI/qM9gPRRLdp96srSPlY41fb6aNS06I1ZXgGvgS+ym2v9I7Nyo9pt8fVtjVbOddds4xrmHeUMM/IPIOIw6VpPAoYjuEEsjSN/qoGP3ak3AcmmG4bkcm9KxTErX4uY0CD72IH36z+0PfPM4bmzu+IdAhrblvRPSQeE6VJPI1HoiaBRg/E5qrZhghMzh6eR0+01nkuZD25BRkOIbpsklVNdVFNsJ+WzlcVmpM1irjEtbx4eyZ/djZnVmV09sBFVGU+2hYruZasQOg66rnH5DFR4vIQ5JZnyd0q+26qpClW3ksS6kb2ABop6VPU9NagP8em2I11169OiuA7Pd7vUoC2l0Q0aqb43dZpfoQXIsfA3Vwn8KOo/Mdju/3Nd9vxfy2mPhP+nnakPLthNx/l9nyyxFDKUevw963K9/qZNn20bv11a/je8izPG7njt2aiMMv/AJUwbt9jb/sqvbprN9C+lZ9xZzr7J/XzK0XrOW2rNYLX62EdVMtozIKkscuItrVHfX6dPszONsU2G+6n167oIafbxj6s7eXJc4W05LmMLy6Ag28ETyf0lljBi/qMd32k11WMGUuMFjMpxuaommkRP6JjciT+sop9g6a2l+gzmTfm/wBcdVPzA38CaX+9JX7J8KoY0dYYTRFiyr5vlbb+vs12rYKJd4S2xrqi4er/ABr87bbb+bPK+b/meZTpG1ba0AgX6KpUyff7hcV+IA1eXjvFfxfGIWcUnuSZm+xqBP8AYCn6iTr2fuInvr6Yc8hKf9hhiVAK/t06
																	/VgB6GRiTnJNGp1CWSCyUnjpKPAZCgCPCWUi20S/NbqtnjZw4QUSWR2WTzreO7Tlz5dsjxBY3u7dB7iuyqrI5/CwZl3KSvXaQQQCCDQ6+/Nbjji41bLkjOttMx2FVYsrqPxKVBoQG+IoQSCCKjWYi2uS+v8A1XUXD+9uBu7i015KnD2FyUKk0yZiBFwxsRFvvFXU7paQ/uGtZnppupowe7uU9H6Lj4zsPb4wrhvd2P5Bx7neUk4pyzFLFn4g6mtHFY67gky7ZE/0lp6SPznpWqrzD5riOPTkPHcgZMNIVYd1NH/DviNUb6DXqD+UdaaIqm9ysJW9UI/2C3WHGApuz0kdeL14GWWaMp/eoN8QEg47DMOlXr9ATLsNUSjjO35G4Yfl3tvlfVnsopUGQ8cXI56eI4xme2O2T3G6mOBgCzPSgqlSo7b229t1BZVnzeA8QHJL5Qs43JsHZ5QSAq9zRujHvtFe+2pU/wCkHjuxu5ul597aOxklZPnE9IlKeZlGu6YuU2iz31bLS4aLe5caowOm2KSAyOop53RSJoaYTU13EZ1Unvk7kVnxfCxcA476P0gJiD1WI9dhI/4kxq0h7lT1H6nSH8Cwlzn8pJzHN+v9QmMHs0g/MAfyRiioO24dD6Ovmf8ALB/7g8Vf8m3d/vutfPv4E/5PJ/8AiQ/9mTXy8wf8zYf0Jf8AKmllcSS+zvUl7HqOsTsytthbS0ISNMycxL0GkkkQCvr4ap/9VwhjZV+4YS2LlE1NDf0bbEvxUio7fGFV9vJtya3svIHDbqz45NuaCUhQlVVpID/umHSqMPwflqY37DUVwM13w3k9vc5yKgljBYt6mCS/8QHrRlP4vzU3r3Ov0dWD9iVYsigt60JDCTRs/HEWDlF4xfsXiOjho9ZO2+6jd00dN1Nd01NNttN9Nsba5zjOM+eOHR43KOCrqSCCKEEdwR8CPiNem1ZXUOhBQioI6gg9iDrl+fnWdHjTSTvb3rIoae5Ptp1dN/VVTGJlYNR2+lS1y3HV7XL2Ywh1MqxmMjb1PIg7h22Anq6eisrqp741yf0xvt8ap4xp8quvIcXjXOjxHbWN15KhW2ns47i2tbj3US5jiuoVF2DGGMEzSr1BLQgA9TX6Yi24vNy/Hf8A7aS4j4rL78UzR3E9usbmIyQyuYHRiA8Ri70/VBI6AhckWn9EzSShIfG+8Oy38kkjtQeBFLdwdfjFixBJk7I7MGKpWwmLZd7syYrKaI43+4phPP04zn+HniPlflj/ABBOEcduuWco4zi7Xj1jGHnm/hcPIsSF1Te6xCRwgZl3Nt2oDuYhQSL+xPBflszmShxGJydxNk7hiscYy2QDOwUuVXdOKttVjQdSAaa7S0pLT1JmwsctXuLtGEGpG31cx9iZ7f6913NJ7Ocs/pFqtrEcN3zjV1jGmySe+yumd9Pq1x9en1cTxz59+eXy5irjN+N8Lg8tjLWb2pnhxGGrE+0PSRHCOoKkFWKhW67SdrU3uTeM/l74bcxWnKb28sbicVjEuUyK+4K0Ow+/RiD0IBJFRUdRXxCV5UNAk5PZlZlLt6WtX9uLR3M+s6ZXTYLKNRtJw2JZGzPoK+SLiBVBWg8rls7I/kF2Wm2+ye+qDlfKGme3lfCnzq/MxlsdxnzQlpx/x5a3SzOFTG26CQBkaSGwsC1zeXrRPJHAXjMSAsDLCrOW51vzzwH4is7nJcKaTIcimiKikl1cuy1BCPd3RaK3gDBWce4taAqkjhRrp+T2LCuY5YPT9tSYYGhSkZTDDLEMMyEYZzxE9ZE6t2yrjwIMJoF2MWsC07UUFQ5F41ZlHMTBiFV2iLl3sljU+dbkVn5C5JxT5U/CNrJk77A/pPb25WUpPBaRWltYLICEaWxsraSS+cMYo5p5EaQGCTb9vAuKvONYrN+XPIEyWcWVf3d8tY1ETSyzyXBD+pEnmn2QK3q9mKIgfqAa8LNLApOJVbNY9y51B1g2sMxpLN6kq6s+ner4xHHVtWWfJEWGRkPByoVHWaBexZTuRf66JJJrbrLqqZ+rffbNw+Isr89t3zjj2B8hYHF2PjuC4tYr24lxmGLR461VBIgkBaQObaL2YiASrFKCgpqHc5xny8w8fy2X47fzT8okiuJYIo8jkKPeTFmU+2soXa0773AAFNxNNa8IfXj4BSsWqg1KzkpJhauCV4WnEjJkZJJZE+GxNrG30rPGDTpcseOF3CO7x05drbuXThTbdXfO+223nqC4u1lyT38aKiNOZAigKqgsWCqFAVVHYBQAB0ApqoYbcpZLaOzMwiCFiSxNF2liWJJJ7kkkk9zXWd7iLhn1zcPVt17EJR7KeerVgXT8MxzzPV5DYNLwVnESLURNmpMJqR/umfa7S79PlK62Ga2UHLbLXCn05+M51sPlPlC85JdWF5HbJbT4+f3VIkL7mqhAPpWg9HXvUHUK4/wK2wdveWzztPFeQ+2wKBaCjAkepqn1fdTXs+UPXHw/zDyz2Ty+E7yqSYybrKkf3jL7MXkFYDDMM5//ALdliEcsNGJoWQR0eVsNCSYifwdUeNhjpi61VythFPVXOM95OvM7nsdmpLZY4sc+9YhISGbcGYltopUKo/CaUr8dZxHArXE4e9xaTs8l6m1pCgBVdpAAXca0LMe4rX6tRo/9L1E1lyex9fpj2PxuD63/ANChb1C4PAIACmNsLC4W0iACDxKIE7XaOpUJ1KIok8KMdnKizxJDXGmPt/O/Uk8uNLyWPksmOjNxFaGBF900G595cH2+5B20p2J69daCeOFjwT4JL1xDJciVm9sVNF2hab+1fV37gfRpiXF1F8E8x1oryDj+1M3P83
																	TCF1JOLVtaF18GVnl23o4cT6PwoWWkTkkqamxHEsZtmwhu4cKI5ctWCGVVk1EkoNyHmOXz+YmypllgEpFI0kbagVQoAptHYVJoKkk/HUswvGsbh8ZFjhHHKYwauyLuYkliTWvxPQVNBQapLwbw1xFwr2tcN3097LKNMN0I/dQ6xuc9pVUKC8BrVqb/AHMVHSYkytZ0UjzSmyMfZ7PiDwU31bosFdF9W2qu/wBEj5T5Lm5Xx+LC39oguIjGwmEhJLou1m27PzgtUbuhNammuHx/gsXHczJlLS5YwyB1MWwAbWO4Lu3flIWh29afCuog7b9THr0627iltmP/AGNU9Ulh3CTrsyX58FSWoSMrMlTENi6zN+AZPLPEyPLm0QGzUw221GL5c5JYdo/eSW0+enxrzBkOO4KLCftEnMCsFkaQg0LFlBXaaha0HUekAdNaOd8a2eay8mV/cNEJSpZAgIqAASDuFN1Knp3JOtBdHdQ8z2HUUlntXzqICqQp6WH6hczB8XBx6BilK3dMouvuNLuyWg9vE03GUm452vsgk9Qwms3wo2WbrK1DJK80jTSktIzEknuSTUk/WTqyURIkEcYAjUAADsAOgH3DVN/Yw59cXV1eheXul7QCEXkqtlSCwUlV55genld33HjsNhT4AydhG0lagLACp2q12JAyjRVTATd67cNPx2Sy6Hd4zyfKcUyYyeKZfc2lWVhVHUkEqwBBpUAggggjoe+uRncDj+RWJsMgDsruVlNGRh03KaEdiQQQQQeo1nycelLhPJR3E5H7yKdd1dXhR0QLVg4k1OtikJ1wUbR4ls7Iv+jX0dixTJ8mmyVdKx1L4dOdEN08qb4xtbv9+rKrSxYmBcgy0MnvdD9FQIgxH1e59+q2/ulViI5MjKbJTUJ7fb7D7hUH69n3aZd1Z6k+KOiKt4h5Uq7t2L0dBKziUzIUtXzaSwWxT1+uLAJsChe0xrJafxXaaG35Ic9UUfi2ThtnL1ZNvq3Q11RxGMB5WyGIyd9mL21iushfMhLbvb2KgIVEornYAQAK/lBJY9dd/MePLLJWFpjLW4kt7K0VgF279zOQS7epRurXrT4kCg6aXqQ9IPF0DjsVJlfdlAYZEpUITOQggQklUx2OyQC6IF2CReKu3N/sxhgQ5KhH6Orhpsoju4aONMbZ3SUxrJX85s7bnxNuWPxMtT/8WuEviZUG1clMFHwEf/2asZ0X6s+H7C5b4brexfbDUESi1Oxy/Eq2t2UyWotmV7DbGt1xNTxWPvjtzMRxBpBSbrUQruwekU8baa4U2R3+EscfGeXpcZl8hlYsfERftCdglKhPZiEfQiPru/EegoenXvrp3/jeK/xtnj5Lxx+0WUbvbBL+5Jv6gv029u5r9Wrl+ynnH1u+wSqK/jk17w50qaX81nkojtbjG0qaMOgqb0dsGOVvNB5GfhUR6xYmCSdItXD1Jy0dsVMJ6ZxuvrtGuG8/vuH31xcQxLPa3PVoixUBgSVYEA0IBIPTqD17Cnd5Pw6z5NaQwyyGK4g/DIFBO2lCpFR0JAPfoR9Z0yX12VuIqLkSqK5ivTYTryAxBmWj1c3ZHsx5wKJwoGYehxsWal4rKpiDNowJ2wcBklkXmcoIstGm+mqjbbOY/wAlzMGfzM2XgtltffO5kVtw3/mYHatN59RFPxEn467OCxk2HxkeNlnNx7Qorldp2/lUip/COgNewA+Grt+cHXX0eNNHjTUGdG88Vt1JU0gp+0WT9QEYVHlBJ0C+2Dy+Dy8C7TJxWeQc+loo4AS+LF0NHDRzrjfTb42RXTWbKrIqbdndtZyM2yOW3kjeOWKVRJFNDIpSWGaNqrJFIhKujChB+BoR8LiAXCABnjmR1eORCVkjkQhkkjYdVdGAZSPiPoqNIdujnPo2ugjmt+pea3PbNTMt9FQN20XAx03kJX8TdNIeRsDnTRT98wudpJY2W3eQ/B5hlT+ZDLTOcJa+NeRfKNn+L8rbyB8p/Km4xlJWO/G3d1NbCJW3ForfIKJY7q2J2qLfIIhVamSaamrwxXmnHZXDjjPmXELlbNQP7XDAk6SFKUkms6B4ZvjvthIpYVRYqhdVzG11QhIqFUh/EvYl0SiPPEVA0Zk/OfUJsZEZBhNRJBNV10gzB1ZDirXKWyerpZ62TRzp/KtjGvzjTm4F/iL8xt5uP8r5bjMLgpSY3nGTxNv7sVRVlbCRy3zxOOpQorMOjoKka+kPKvlgw0q5PC4a4vsnF60j/j75ysgqRt/frHbpID0Vt6gHs3x0z7nrhS4rasOG3d2mKAQmJ1ycYzCo+T46eaTRFGZjtdFQdg9AzFkliOSqSxV/jLoMADffDjHmqTpV4+XT0wnePhDwJwL5esZO3HJ3zHkC+hMN1lpYvZEcLH122OgLM8EUgoJ5pHM84FKRRn2xAefeQ+R+TbqNMnGLDi1vIJIrJX9xpJF/BLeSABXZD6ooUBijf1FpXVGV0fltaiGvophTKamEttNFc6bYS3UT2VT0Uzrn6NlEtVEdlNNdvjOdcb65zj+Hzj/T401msY+qHtmMVnZ9VxtbixWCWzMq5Hy6Fj5FbEK1xRsON2Gcl1WwSzn1O2dcFeQ2y8SliwzHFzEhaRll+raiXyWpTZJH80OmvWz71HdDzlG0A7Qhy3BQMz06FtKNOYvmcfvCMWnf3FJbl/NCaSP+3zBNPmqAHi/32ZJFtqRdhWaCP6G2301T0zTTUkWTwN3Hbdmxa2DTzkaJnXcGouo5qIyblFvD41CKCtElZok1BHNkc7JMjLyfPJEvqQDLDQmRZMSOJtTKqmuzdJQ6ag8Z6ne8YfMlbZF3FzlYM1sq7qa6
																	ruyHyYrZ8Iiil70p0c5uiPDoxLR0Cn5Y3EnMVlhqPYILhw7lqyaCktWCmiGdtMUOmrP3f6++mb8HX+g+Ic41M+6sI8phrZcRUnNpxpFq8qPabFrhFxXd7XEAdS13PCzgKy1bPNxCBQU4I6u1m22qOi+aaa4UB9Ydy6VwCq60p7VRZOKcGdh8MhLPBNTxCXuBFrTSsGfOlgPI8UjYtFoVr+noF+AUb6GV92j1BFJm5coLKLIKaa+QHrc6Ad83dpwOUSOh4daXT8EoqtowJqFSZiKrh4yiImxiQ6ZOyZGJomUZfMEvvOXWjYKokz/GaIYWc66ZV1UNNNVyLem3o3SFFKkBzDmYrDH1YWpzCyns4GS8hZA6lZnd4+747dzgYGhYoGV6bSfviA43ph41HlFGLAnkjqvuu30xQ6ak5962OvbJsSzZHaZPniMvrH6Kqayk7vq+xZOTtiFU7S8xaKwKp4NAZzzAvW4hwNirwkVeO3rookalq+V3yaiKmu7XNNNdwt6ey9e2UCDUSfrVtz6/lnJEzkZizcSM10BX5Ll635VbZVrVRUaG/bS+LeKydfL9ZdcWmNWdOMotlks6Jaqaar9U3pAu2qqyuWANbJqqQMrO9ej3nmPADx6ZEwNb9HyYoKLzo/FiL2vXBZpUkkkLJ2c1cYTwSaky7zREamjvjzFNNMU7Q5M6DuiPcv1zV0U5qlNO1cYGSu7a5teZzau0bNLQpEOQryIMjEMpiz9s1sjNmX60cYqt2uxhVi0bqfCGzjXfJ01TWHeoi9QbjrctIZbTEqJ9G8ydzVDD2hM7LFR1QznpC45XYsFIgVUKvY7P4wWGGR2ZK6eoPDQYmL/2Uo6Zud0NFNNPIqABMopFlIvLBUEEs46+biYUnAnZVw2eRFqAB41IyFsSBg0hkmdyXYnlZBpq4bZbYQV+9lVVVNPOmpU8aaPGmjxpo8aaPGmjxpo8aaPGmjxpo8aaPGmjxpo8aaPGmjxpo8aaPGmjxpo8aaPGmjxpo8aaPGmjxpr/2Q==')
	FROM
		dbo.msk_kex_emailalairas LEFT JOIN dbo.People ON People.PeopleID = msk_kex_emailalairas.PeopleID
	WHERE dbo.People.BUKRS=3000 and dbo.People.Deleted=0
END
ELSE SELECT 'Csak új SZK logók vannak az aláírásokban'

/*Az Állásra-jelentkezés interfész gdpr duplikálása miatti takarítás. Deleted=3-ra állítja a duplikáltakat, csak 1 marad aktív minden hashID-hoz (KEX2-ben már jól mûködik)*/
;WITH duplikaltak(HashID, darabszam, maxGDPRID) 
AS
(
	SELECT HashID, COUNT(HashID), MAX(msk_kex_gdpr_jelentkezokID)  FROM dbo.msk_kex_gdpr_jelentkezok GROUP BY HashID
)
UPDATE dbo.msk_kex_gdpr_jelentkezok 
		SET Deleted = 3 
		WHERE HashID IN (SELECT duplikaltak.HashID FROM duplikaltak WHERE duplikaltak.darabszam>0) 
			AND msk_kex_gdpr_jelentkezokID NOT IN (SELECT DISTINCT duplikaltak.maxGDPRID FROM duplikaltak WHERE duplikaltak.darabszam>0)

/* Email generálás éjszakai job beállítás */
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name = 'Email aláírás generálás')
	INSERT INTO dbo.ServerTool_Job (name,dll_name,class_name,SQL,Mon,Tue,Wed,Thu,Fri,Sat,Sun,minsec_from,minsec_to,period,last_run,running,status_message, Activated, Deleted)
	VALUES ('Email aláírás generálás', NULL, NULL, 'dbo.msk_kex_email_alairas_generalas', 1, 1, 1, 1, 1, 1, 1, '5:00', '5:30', 60, NULL, 0, NULL, 1, 0 )

/*Anonimizálás ServerTool*/
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name='Anonimizalas')
	INSERT INTO dbo.ServerTool_Job (name,dll_name,class_name,SQL,Mon,Tue,Wed,Thu,Fri,Sat,Sun,minsec_from,minsec_to,period,last_run,running,status_message,Activated,Deleted)
	VALUES('Anonimizalas','C:\EffectorServerToolService\Anonimizalas.dll','Anonimizalas.Anonimizalas','',1,1,1,1,1,1,1,'8:30','11:30',600,NULL,0,NULL,1,0)
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name='Törlendõ mappa teljes útvonala')
	INSERT INTO dbo.ServerTool_Job (name,dll_name,class_name,SQL,Mon,Tue,Wed,Thu,Fri,Sat,Sun,minsec_from,minsec_to,period,last_run,running,status_message,Activated,Deleted)
	VALUES('Törlendõ mappa teljes útvonala','C:\EffectorServerToolService\Anonimizalas.dll','Anonimizalas.Anonimizalas','',1,1,1,1,1,1,1,'6:30','10:30',600,NULL,0,NULL,1,0)
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name='GDPR anonimizalas')
	INSERT INTO dbo.ServerTool_Job (name,dll_name,class_name,SQL,Mon,Tue,Wed,Thu,Fri,Sat,Sun,minsec_from,minsec_to,period,last_run,running,status_message,Activated,Deleted)
	VALUES('GDPR anonimizalas',NULL,NULL,'EXEC dbo.msk_kex_gdpr_anonimizalas',1,1,1,1,1,1,1,'08:00','11:00',600,NULL,0,NULL,1,0)
IF NOT EXISTS (SELECT * FROM dbo.ServerTool_Job WHERE name='Tomeges_anonimizalas')
	INSERT INTO dbo.ServerTool_Job (name,dll_name,class_name,SQL,Mon,Tue,Wed,Thu,Fri,Sat,Sun,minsec_from,minsec_to,period,last_run,running,status_message,Activated,Deleted)
	VALUES('Tomeges_anonimizalas','C:\EffectorServerToolService\Anonimizalas.dll','Anonimizalas.Anonimizalas','',0,0,0,0,0,0,0,'8:30','11:30',600,NULL,0,NULL,1,1)

/*Lezárt állásokhoz tartozó nyitott jelentkezések lezárása*/
UPDATE dbo.msk_kex_jelentkezok SET Deleted=1 WHERE msk_kex_jelentkezokID IN (
SELECT j.msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok j INNER JOIN dbo.msk_kex_allasajanlatok a ON a.msk_kex_allasajanlatokID=j.idallasajanlat
WHERE j.Deleted=0 AND a.Deleted=1)
/*Állásokhoz nem tartozó nyitott jelentkezések lezárása*/
UPDATE dbo.msk_kex_jelentkezok SET Deleted=1 WHERE msk_kex_jelentkezokID IN (
SELECT j.msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok j LEFT JOIN dbo.msk_kex_allasajanlatok a ON a.msk_kex_allasajanlatokID=j.idallasajanlat
WHERE j.Deleted=0 AND a.msk_kex_allasajanlatokID IS NULL)

/*TOB-os álláshirdetést "Lezárt" státusba, aminek a KEX-es állása le lett zárva*/
UPDATE dbo.msk_tob_allashirdetesek SET StatuszID = 24
WHERE Msk_tob_allashirdetesekID IN (SELECT msk_kex_allasajanlatokID FROM dbo.msk_kex_allasajanlatok WHERE Deleted=1)

/*KEX jelentkezõ hibás státusz állítások törlése*/
UPDATE dbo.msk_kex_felvstatusz SET Deleted=1 WHERE ISNULL(idfelvstatusz,0) = 0 AND Deleted = 0

/*Az anonimizálás dll hány nap után törölje a mappában lévõ fájlokat*/
IF NOT EXISTS (SELECT * FROM dbo.FSYS_ApplicationSetup WHERE Code='Mappa_megorzesi_ido' AND Deleted=0)
	INSERT INTO dbo.FSYS_ApplicationSetup (Code,Name,CodeValue,Department,GroupName,Deleted)
	VALUES ('Mappa_megorzesi_ido','Az anonimizálás dll hány nap után törölje a mappában lévõ fájlokat','30',0,NULL,0)

/* B-1100504 miatt */
IF NOT EXISTS (SELECT * FROM dbo.FSYS_ApplicationSetup WHERE Code='GDPR_megorzesi_ido' AND Deleted=0)
	INSERT INTO dbo.FSYS_ApplicationSetup (Code,Name,CodeValue,Department,GroupName,Deleted)
	VALUES ('GDPR_megorzesi_ido','A GDPR jelentkezõk években mért megõrzési ideje','2',0,NULL,0)

/*B-1052624 hiba javítása, NULL-ozza MAPErvenyes mezõt ahol nincs ajánló és Deleted=1-re állítja a map-ban az ajánlást*/
UPDATE dbo.msk_kex_jelentkezok SET MAPErvenyes = NULL
WHERE ajanlo_nev IS NULL AND MAPErvenyes = 1
UPDATE dbo.msk_map_ajanlas SET Deleted=1
WHERE AjanloPERNR IS NULL
print 'KEX POSTD Ended'

/*IsMAPErvenyes javítás miatt le kell futnia*/
UPDATE dbo.msk_kex_gdpr_jelentkezok SET MAPErvenyes=0
WHERE MAPPeopleID = 0 AND MAPErvenyes=1

/*Lezárt álláshoz tartozó jelentkezõ anonimizálása (TIBCO-ból újraküldött)*/
	DECLARE @allasID INT
	DECLARE @CurI CURSOR
	SET @CurI = CURSOR FOR SELECT DISTINCT a.msk_kex_allasajanlatokID FROM dbo.msk_kex_jelentkezok j INNER JOIN dbo.msk_kex_allasajanlatok a ON a.msk_kex_allasajanlatokID=j.idallasajanlat
							WHERE a.Deleted=1 AND j.nev <>'xxx'
	OPEN @CurI FETCH NEXT FROM @CurI INTO @allasID
	WHILE @@FETCH_STATUS = 0
	BEGIN
		PRINT 'Aninimizálás' + CAST(@allasID AS VARCHAR(100))
			/*Annonimizálás*/
			--Document tábla Deleted=9-re állítása
			;WITH Mycte (DokID)
			AS
			(
				(
				SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND cvlinkid IS NOT NULL
				UNION
				SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND JelentkezesiDokID IS NOT NULL
				UNION
				SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND AdatkezelesiDokID IS NOT NULL
				UNION
				SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND MotivaciosDokID IS NOT NULL
				UNION
				SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat = @allasID AND MunkavallaloiDokID IS NOT NULL
				)
				EXCEPT
				(
				SELECT cvlinkid FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL
				UNION
				SELECT JelentkezesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL
				UNION
				SELECT AdatkezelesiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL
				UNION
				SELECT MotivaciosDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL
				UNION
				SELECT MunkavallaloiDokID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
				UNION
				SELECT cvlinkid FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND cvlinkid IS NOT NULL AND idallasajanlat <> @allasID
				UNION
				SELECT JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND JelentkezesiDokID IS NOT NULL AND idallasajanlat <> @allasID
				UNION
				SELECT AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND AdatkezelesiDokID IS NOT NULL AND idallasajanlat <> @allasID
				UNION
				SELECT MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MotivaciosDokID IS NOT NULL AND idallasajanlat <> @allasID
				UNION
				SELECT MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL AND idallasajanlat <> @allasID
				UNION
				SELECT MunkavallaloiDokID FROM dbo.msk_map_ajanlas WHERE Deleted=0 AND MunkavallaloiDokID IS NOT NULL
				)

			)
			UPDATE dbo.Document SET Deleted=9 WHERE EXISTS (SELECT * FROM Mycte WHERE DocumentID=Mycte.DokID)
					
			--Jelentkezõk anonimizálása
			UPDATE msk_kex_jelentkezok SET nev='xxx', email='xxx', telefonszam='xxx', EmailCC='xxx', 
					cvlinkid = NULL, AdatkezelesiDokID = NULL, JelentkezesiDokID = NULL, MunkavallaloiDokID = NULL, MotivaciosDokID = NULL,
					cvlink='xxx', cvtartalom='xxx', ajanlo_nev='xxx', Deleted=1
					WHERE idallasajanlat = @allasID
			UPDATE dbo.msk_kex_jelentkezok SET HASHID=iif((select top 1 hashid from dbo.msk_kex_gdpr_jelentkezok g where g.hashid=hashid ) is null,NULL,HASHID) WHERE idallasajanlat = @allasID
					
			--Emailek anonimizálása
			UPDATE dbo.msk_MailSend_Log SET Recipients='xxx', CopyRecipients='xxx', BlindCopyRecipients='xxx' 
			WHERE SentToJelentkezoID IN (SELECT msk_kex_jelentkezokID FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat=@allasID) AND SentToJelentkezoTablaID=1

			SELECT * FROM dbo.msk_kex_jelentkezok WHERE idallasajanlat=@allasID
		
		FETCH NEXT FROM @CurI INTO @allasID
	END;

/*81285: KEX - Orvosi státusz és Felvételi státusz kiegészítés, Jelentkezõ státusz szûrõ és riport módosítás (AK-10511)*/
IF NOT EXISTS (SELECT * FROM dbo.msk_kex_teszt_jelentkezok)
INSERT INTO dbo.msk_kex_teszt_jelentkezok (JelentkezokID)
VALUES (273706),(273709),(273713),(273718)

/*Change Request 81285: KEX - Orvosi státusz és Felvételi státusz kiegészítés, Jelentkezõ státusz szûrõ és riport módosítás (AK-10511)*/
BEGIN TRAN t01
UPDATE dbo.msk_kex_jelentkezok SET Deleted=0
WHERE Deleted=0 AND idszin=3
COMMIT TRAN t01

/*Bug 87372: MAP-KEX üzemi problémák*/
IF EXISTS (SELECT 1 FROM dbo.msk_kex_jelentkezok WHERE iddrupal=-1 AND (hp_nev IS NULL OR hp_torzsszam IS NULL))
BEGIN
	UPDATE j
	SET j.hp_torzsszam = p.PERNR,
		j.hp_nev = p.Name
	FROM dbo.msk_kex_jelentkezok j
	INNER JOIN dbo.msk_tob_allashirdetesek ah ON ah.Msk_tob_allashirdetesekID=j.idallasajanlat
	INNER JOIN dbo.msk_tob_keresesikerelem kk ON kk.Msk_tob_keresesikerelemID=ah.Idkeresesikerelem
	INNER JOIN dbo.People p ON p.PeopleID=kk.Idtoborzo1
	WHERE j.iddrupal=-1 AND (j.hp_nev IS NULL OR j.hp_torzsszam IS NULL)
END

/*MÁVCsoport átalakulás miatt a logók módosítása*/
EXEC [dbo].[msk_kex_email_alairas_generalas]

/*MÁVCsoport átalakulás miatt a START átnevezése*/
UPDATE [dbo].[msk_kex_allasajanlatok]
SET [uzletag] = 'MÁV Személyszállítási Zrt.'
WHERE [uzletag]='MÁV-START Vasúti Személyszállító Zrt.'
AND [Deleted]=0

/*Bug 98972: KEX GDPR érvényesség vége dátum*/
DECLARE @gdpr_megorzesi_ido INT = (SELECT TOP 1 [FAS].[CodeValue] FROM [dbo].[FSYS_ApplicationSetup] [FAS] WHERE [FAS].[Code]='GDPR_megorzesi_ido' AND [FAS].[Deleted]=0 ORDER BY 1 DESC)
IF EXISTS (SELECT TOP (1) 1 FROM [dbo].[msk_kex_gdpr_jelentkezok] [MKGJ] WHERE CAST(DATEADD(YEAR,@gdpr_megorzesi_ido,[MKGJ].[datum]) AS DATE) < CAST([MKGJ].[gdpr_vege] AS DATE) AND [MKGJ].[Deleted]=0)
	UPDATE [dbo].[msk_kex_gdpr_jelentkezok] SET [gdpr_vege] = CAST(DATEADD(YEAR,1,[datum]) AS DATE)	
	WHERE CAST(DATEADD(YEAR,@gdpr_megorzesi_ido,[datum]) AS DATE) < CAST([gdpr_vege] AS DATE) AND [Deleted]=0

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_ajanlattetelriport.sql =====

CREATE PROCEDURE [dbo].[msk_kex_sel_ajanlattetelriport] 


  @UserID INT
, @FieldList VARCHAR(MAX) = '*'
, @WhereString VARCHAR(MAX) = '1=1'
, @OrderByString VARCHAR(MAX) = ''
, @PageNumber INT = 1
, @RowsPerPage INT = 100

AS
BEGIN
    SET NOCOUNT ON
	SET DATEFIRST 1

    DECLARE @sql NVARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

	DECLARE @sSearch VARCHAR(20) = NULL
    DECLARE @ParamName NVARCHAR(255) = NULL
    DECLARE @Cut BIT = 1
    DECLARE @return_value2 NVARCHAR(MAX) = NULL
	DECLARE @iidceg INTEGER = NULL
	DECLARE @sAjanlattetelDatumaTol VARCHAR(50) = NULL -- stringet ad vissza
	DECLARE @dAjanlattetelDatumaTol DATETIME = NULL -- típusegyezõség miatt
    DECLARE @sAjanlattetelDatumaIg VARCHAR(50) = NULL
	DECLARE @dAjanlattetelDatumaIg DATETIME = NULL
	DECLARE @bAjanlattetelDatuma BIT = NULL
	DECLARE @iFelveteliStatusz INTEGER = NULL
	DECLARE @iPozicioStatusz INTEGER = NULL
	DECLARE @sPozicioNeve VARCHAR(30) = NULL 


	DROP TABLE IF EXISTS [#ttmsk_kex_ajanlat_ajan]
	DROP TABLE IF EXISTS [#ttmsk_tob_pozicio_ajan] 
	DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz_ajan]
	DROP TABLE IF EXISTS [#ttAjanlattetelRiport]
	DROP TABLE IF EXISTS [#ttjelentkezok_ajan]
	DROP TABLE IF EXISTS [#ttmsk_kex_orvosi_ajan]

	
	--select 1/0

	SET @Cut = 1
    SET @ParamName = N'idceg'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iidceg OUTPUT
                                                       , @WhereString OUTPUT
	

	SET @sSearch = 'BETWEEN'
    SET @ParamName = N'AjanlattetelDatuma'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sAjanlattetelDatumaTol OUTPUT
                                                                         , @sAjanlattetelDatumaIg OUTPUT
                                                                         , @WhereString OUTPUT

    IF @sAjanlattetelDatumaTol IS NOT NULL AND @sAjanlattetelDatumaIg IS NOT NULL
    BEGIN
        SET @bAjanlattetelDatuma = 1
    END

	SET @dAjanlattetelDatumaTol = REPLACE( @sAjanlattetelDatumaTol, '''', '' )
    SET @dAjanlattetelDatumaIg = REPLACE( @sAjanlattetelDatumaIg, '''', '' ) 


	SET @Cut = 1
    SET @ParamName = N'FelveteliStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iFelveteliStatusz OUTPUT
                                                       , @WhereString OUTPUT

	SET @Cut = 1
    SET @ParamName = N'PozicioStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iPozicioStatusz OUTPUT
                                                       , @WhereString OUTPUT


	SET @sSearch = 'LIKE'
    SET @ParamName = N'PozicioNeve'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sPozicioNeve OUTPUT
                                                                         , @return_value2 OUTPUT
                                                                         , @WhereString OUTPUT


SELECT 
	aj.msk_kex_ajanlatID as msk_kex_ajanlatID,
	aj.datum as AjanlattetelDatuma,
	AjanlatotElfogadta.LookupValue as AjanlatotElfogadta,
	aj.PozicioIDLast,
	aj.idjelentkezo,
	poz.Iktatoszam as EngedelyIktatoszama,
	poz.Engedelyezesidatum as Engedelyezesidatum,
	poz.PozicioInfo as Megjegyzes,
	poz.PozicioVisszavDatum as PozicioVisszavonasDatuma,
	poz.Idkeresesikerelem,
	poz.StatuszID,
	poz.PozicioID,
	toba.Msk_tob_allashirdetesekID,
	l.LookupValue as PozicioStatusza,
	kexa.targy AS PozicioNeve,
	kexa.munkavegzes_helye AS MunkavegzesHelye,
	kexa.poziciok_szama as BetoltesAlattAlloLetszam,
	kexa.idceg,
	kexa.idtoborzo1,
	kexa.idlezarasindok,
	statuszolovezeto.Name AS MJGY,
	toborzo.Name AS ToborzoNeve,
	statuszolovezeto.PeopleID,
	s.Szakterulet as szakterulet
INTO [#ttmsk_kex_ajanlat_ajan]
FROM [dbo].[msk_kex_ajanlat] aj
LEFT JOIN [dbo].[msk_kex_LookupList] AjanlatotElfogadta ON AjanlatotElfogadta.LookupListID = aj.idelfogadva AND AjanlatotElfogadta.GroupNum = 2 AND AjanlatotElfogadta.Deleted = 0
LEFT JOIN [dbo].[msk_tob_pozicio] poz ON aj.PozicioIDLast = poz.PozicioID AND poz.Deleted = 0
LEFT JOIN [dbo].[msk_tob_allashirdetesek] toba on poz.Idkeresesikerelem = toba.Idkeresesikerelem 
LEFT JOIN [dbo].[msk_kex_allasajanlatok] kexa on kexa.msk_kex_allasajanlatokID = toba.Msk_tob_allashirdetesekID 
LEFT JOIN [dbo].[msk_kex_allasajanlat_vezetok] AS kexav ON kexav.Idallasajanlat = kexa.msk_kex_allasajanlatokID AND kexav.Statuszolovezeto = 1
LEFT JOIN [dbo].[People] AS statuszolovezeto ON statuszolovezeto.PeopleID = kexav.Idvezeto AND statuszolovezeto.Deleted = 0
LEFT JOIN [dbo].[People] AS toborzo ON toborzo.PeopleID = kexa.idtoborzo1 AND toborzo.Deleted = 0
LEFT JOIN [dbo].[msk_tob_LookupList] l on l.LookuplistID = poz.StatuszID and l.deleted=0
LEFT JOIN msk_tob_allashirdetesek h ON h.msk_tob_allashirdetesekID = kexa.msk_kex_allasajanlatokID
LEFT JOIN msk_tob_keresesikerelem k ON k.msk_tob_keresesikerelemID = h.Idkeresesikerelem
LEFT JOIN msk_tob_szakterulet s ON s.Msk_tob_szakteruletID = k.SzakteruletID
WHERE poz.Idkeresesikerelem IS NOT NULL AND aj.Deleted != 2 AND 1=1
AND (
		@iPozicioStatusz IS NULL OR (  @iPozicioStatusz IS NOT NULL AND l.LookupListID = @iPozicioStatusz )
	)
AND
	(
		@iidceg IS NULL OR (  @iidceg IS NOT NULL AND kexa.idceg = @iidceg )
		--( @iidceg IS NULL OR (  @iidceg IS NOT NULL AND mka.Idceg = @iidceg ) )
	)
	
--	Select * from msk_tob_allashirdetesek
--  Select * from [#ttmsk_tob_pozicio] 
select * 
INTO [#ttmsk_kex_felvstatusz_ajan]
from (					
SELECT ROW_NUMBER() OVER (PARTITION BY ttmka.idjelentkezo ORDER BY mkf.Msk_kex_felvstatuszID DESC) AS RowNum,
	ttmka.idjelentkezo,
	felvetelistatusz.LookupValue AS FelveteliStatusz,
	felvetelistatusz.LookupListID AS LookupListID,
	elutasitasindok.nev AS ElutasitasIndoka,
	visszalepesindok.nev AS VisszalepesIndoka,
	mkf.Belepesdatum AS BelepesDatum,
	mkf.Datum as StatuszAllitasDatuma
	--
FROM [#ttmsk_kex_ajanlat_ajan] ttmka
LEFT JOIN dbo.msk_kex_felvstatusz AS mkf ON mkf.idjelentkezo = ttmka.idjelentkezo
LEFT JOIN [dbo].[msk_kex_LookupList] AS felvetelistatusz ON felvetelistatusz.LookupListID = mkf.Idfelvstatusz AND felvetelistatusz.Deleted = 0 AND felvetelistatusz.GroupNum = 3
LEFT JOIN [dbo].[msk_kex_elutasitasindokok] AS elutasitasindok ON mkf.Idelutasitasindok=elutasitasindok.msk_kex_elutasitasindokokID AND elutasitasindok.Deleted = 0
LEFT JOIN [dbo].[msk_kex_visszalepesindokok] AS visszalepesindok ON mkf.Idvisszalepesindok=visszalepesindok.msk_kex_visszalepesindokokID AND visszalepesindok.Deleted = 0						
WHERE (mkf.Deleted != 2)) AS X WHERE x.RowNum = 1

AND (
@iFelveteliStatusz IS NULL OR (  @iFelveteliStatusz IS NOT NULL AND X.LookupListID = @iFelveteliStatusz )
	)
													
SELECT *
INTO [#ttmsk_kex_orvosi_ajan]
FROM (
SELECT ROW_NUMBER() OVER (PARTITION BY ttmka.idjelentkezo ORDER BY orvosi.kiallitasdatuma ASC) AS RowNum,
	ttmka.msk_kex_ajanlatID,
	orvosi.idjelentkezo,
	orvosi.igenylesdatuma as OrvosiIgenylesDatuma,
	orvosi.kiallitasdatuma as OrvosiKiallitasDatuma,
	CASE 
        WHEN orvosi.kiallitasdatuma IS NULL AND orvosi.igenylesdatuma IS NULL THEN NULL -- Mindkét dátum hiányzik
		WHEN orvosi.kiallitasdatuma IS NULL THEN NULL									-- Ha csak a kiallitasdatuma hiányzik
        ELSE OMGMS.ElteltNapokSzama + 1													-- Ha mindkét dátum meg van adva
    END AS OrvosiIdotartama
FROM [#ttmsk_kex_ajanlat_ajan] ttmka
LEFT JOIN [dbo].[msk_kex_orvosi] orvosi on ttmka.idjelentkezo = orvosi.idjelentkezo AND orvosi.Deleted = 0
OUTER APPLY (SELECT [dbo].[ofn_msk_getMunkanapokSzama](orvosi.igenylesdatuma, orvosi.kiallitasdatuma) AS ElteltNapokSzama) OMGMS
WHERE 1=1 ) as B13 WHERE B13.RowNum = 1 



select 
	a.msk_kex_ajanlatID,
	a.idjelentkezo,
	j.msk_kex_jelentkezokID,
	j.datum as JelentkezesDatuma,
	j.nev as JelentkezoNeve	
INTO [#ttjelentkezok_ajan]
from msk_kex_ajanlat a
LEFT JOIN [msk_kex_jelentkezok] j ON j.msk_kex_jelentkezokID = a.idjelentkezo AND j.Deleted = 0
Where a.Deleted = 0



SELECT 
ttmka.msk_kex_ajanlatID as msk_kex_ajanlatID,
ttmka.EngedelyIktatoszama,
ttmka.Engedelyezesidatum,
ttmka.Megjegyzes,
ttmka.PozicioNeve AS PozicioNeve,
ttmka.MunkavegzesHelye AS MunkavegzesHelye,
ttmka.BetoltesAlattAlloLetszam as BetoltesAlattAlloLetszam,
ttmka.MJGY AS MJGY,
ttmka.ToborzoNeve AS ToborzoNeve,
IIF (ttmka.idlezarasindok > 0, 'Lezárt', 'Folyamatban') as HirdetesStatusz,
ttmka.PozicioStatusza as PozicioStatusza,
ttmka.PozicioVisszavonasDatuma as PozicioVisszavonasDatuma,
ttj.JelentkezesDatuma as JelentkezesDatuma,
ttmka.AjanlattetelDatuma AS AjanlattetelDatuma,
--CASE WHEN ttmtp.RowNum = 1 THEN ttmka.AjanlattetelDatuma ELSE NULL END AS AjanlattetelDatuma,
ttmka.AjanlatotElfogadta as AjanlatotElfogadta,
CASE WHEN ttmko.RowNum = 1 THEN ttmko.OrvosiIgenylesDatuma ELSE NULL END AS OrvosiIgenylesDatuma,
CASE WHEN ttmko.RowNum = 1 THEN ttmko.OrvosiKiallitasDatuma ELSE NULL END as OrvosiKiallitasDatuma,
CASE WHEN ttmko.RowNum = 1 THEN ttmko.OrvosiIdotartama ELSE NULL END AS OrvosiIdotartama,
ttmkf.FelveteliStatusz AS FelveteliStatusz,
ttmkf.StatuszAllitasDatuma as StatuszAllitasDatuma,
ttmkf.ElutasitasIndoka as ElutasitasIndoka,
ttmkf.VisszalepesIndoka as VisszalepesIndoka,
ttmkf.BelepesDatum as BelepesDatum,
ttj.JelentkezoNeve as JelentkezoNeve,
ttmka.idceg,
ttmka.idtoborzo1,
ttmka.PeopleID as PeopleID,
ttmka.szakterulet as szakterulet
INTO [#ttAjanlattetelRiport]
FROM [dbo].[#ttmsk_kex_ajanlat_ajan] ttmka
LEFT JOIN [dbo].[#ttmsk_kex_orvosi_ajan] ttmko ON ttmko.msk_kex_ajanlatID = ttmka.msk_kex_ajanlatID AND ttmko.RowNum = 1
--LEFT JOIN [dbo].[#ttmsk_tob_pozicio_ajan] ttmtp on ttmtp.msk_kex_ajanlatID = ttmka.msk_kex_ajanlatID
LEFT JOIN [dbo].[#ttmsk_kex_felvstatusz_ajan] ttmkf ON ttmkf.idjelentkezo = ttmka.idjelentkezo AND ttmkf.RowNum=1
LEFT JOIN [dbo].[#ttjelentkezok_ajan] ttj ON ttj.msk_kex_ajanlatID = ttmka.msk_kex_ajanlatID
WHERE 1=1 
	

	-- A @WhereString megszabadítása a fölösleges szövegektõl [START]
    EXEC [dbo].[msp_wrk_ReturnParamValueCleanFromWhereString] @WhereString, @WhereString OUTPUT
	

    SET @sql = '
		
			SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
				, ' + @FieldList
					   + '
					   INTO [#ttResultList] 
					   FROM [#ttAjanlattetelRiport]
					   WHERE 1=1 AND '  + @WhereString + '
    
		

    SELECT * 
    from [#ttResultList]
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '
	EXEC msk_Print_Text @sql
    EXEC ( @sql )


END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_allasajanlatokalapriport.sql =====


/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-24
-- Description:	KEX - Állásajánlatok alap riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_allasajanlatokalapriport] @UserID INT
                                                                     , @FieldList VARCHAR(MAX) = '*'
                                                                     , @WhereString VARCHAR(MAX) = '1=1'
                                                                     , @OrderByString VARCHAR(MAX) = '[uzletag]'
                                                                     , @PageNumber INT = 1
                                                                     , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatok]

    CREATE TABLE [#ttmsk_kex_allasajanlatok] (
                                                 [msk_kex_allasajanlatokID] INTEGER NOT NULL
                                               , [uzletag] VARCHAR(100) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [reszleg] VARCHAR(255) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [targy] VARCHAR(255) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [munkavegzes_helye] VARCHAR(255) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [datum_lejarat] DATE NULL
                                               , [toborzo_info] VARCHAR(MAX) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [idmunkaltato] INTEGER NULL
                                               , [idvezeto] INTEGER NULL
                                               , [idtoborzo1] INTEGER NULL
                                               , [idtoborzo2] INTEGER NULL
                                               , [idceg] INTEGER NULL
                                               , [datum_lezaras] DATE NULL
                                               , [link] VARCHAR(2000) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [toborzo_torzsszam] VARCHAR(10) COLLATE Hungarian_Technical_CI_AS NULL
                                               , [Idlezarasindok] INTEGER NULL
                                             )
    -- 104448 alapján a reszleg helyett szakterulet 
    SET @sql = '
INSERT INTO [#ttmsk_kex_allasajanlatok] ( [msk_kex_allasajanlatokID], [uzletag], [reszleg], [targy]
                                        , [munkavegzes_helye], [datum_lejarat], [toborzo_info], [idmunkaltato]
                                        , [idvezeto], [idtoborzo1], [idtoborzo2], [idceg], [datum_lezaras], [link]
                                        , [toborzo_torzsszam], [Idlezarasindok])
select * from 
(
SELECT [A].[msk_kex_allasajanlatokID]
     , [A].[uzletag]
     , s.Szakterulet as reszleg
     , [A].[targy]
     , [A].[munkavegzes_helye]
     , [A].[datum_lejarat]
     , [A].[toborzo_info]
     , [A].[idmunkaltato]
     , [A].[idvezeto]
     , [A].[idtoborzo1]
     , [A].[idtoborzo2]
     , [A].[idceg]
     , [A].[datum_lezaras]
     , [A].[link]
     , [A].[toborzo_torzsszam]
     , [A].[Idlezarasindok]
FROM [dbo].[msk_kex_allasajanlatok] [A]
left join msk_tob_allashirdetesek h on h.msk_tob_allashirdetesekID=a.msk_kex_allasajanlatokID
left join msk_tob_keresesikerelem k on msk_tob_keresesikerelemID=h.Idkeresesikerelem
left join msk_tob_szakterulet s on s. Msk_tob_szakteruletID=k.SzakteruletID
) a
WHERE ' + @WhereString

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Állásajánlatok alap riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )

    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
        , ' + @FieldList
               + '
    FROM [#ttmsk_kex_allasajanlatok] [A]
        LEFT OUTER JOIN [dbo].[People] [P] ON [P].[PERNR] = [A].[toborzo_torzsszam] AND [P].[Deleted] = 0
        LEFT OUTER JOIN [dbo].[msk_kex_lezarasindokok] [MKL] ON [A].[Idlezarasindok] = [MKL].[Msk_kex_lezarasindokokID] 
)

    SELECT * 
    from FNetPagedSelect
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Állásajánlatok alap riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '[msk_kex_allasajanlatokID], [uzletag], [reszleg], [targy], [munkavegzes_helye], FORMAT( [datum_lejarat], ''yyyy.MM.dd'' ) AS [datum_lejarat], [toborzo_info], [Name], [Mobile], [idmunkaltato], [idvezeto], [idtoborzo1], [idtoborzo2], [idceg], [link]'
DECLARE @WhereString VARCHAR(MAX) = '1 = 1 AND ( [datum_lejarat] BETWEEN ''2022-01-01'' AND ''2022-12-31 23:59:59.999'' )
                               AND ( [idceg] = N''941824'' ) AND ( [reszleg] LIKE N''%adat%'' )
                               AND ( [munkavegzes_helye] LIKE N''%budap%'' )
                               AND ( [msk_kex_allasajanlatokID] IN (
                                                                       SELECT [Idallasajanlat]
                                                                       FROM [msk_kex_allasajanlat_vezetok]
                                                                       WHERE [Idvezeto] = 36482 AND [Mjgy] = 10
                                                                   )
                                   ) AND ( [idvezeto] = N''1836'' ) AND ( 1 IN ( SELECT 1 )) AND (( [idtoborzo1] = 353 ))'
DECLARE @OrderByString VARCHAR(MAX) = '[uzletag]'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

set @WhereString = '1 = 1 AND ( [datum_lejarat] BETWEEN ''2022-01-01'' AND ''2022-12-31 23:59:59.999'' )
                               AND ( [idceg] = N''941824'' ) --AND ( [reszleg] LIKE N''%adat%'' )
                               --AND ( [munkavegzes_helye] LIKE N''%budap%'' )'
EXECUTE [dbo].[msk_kex_sel_allasajanlatokalapriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/
GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_allasajanlatriport.sql =====

CREATE PROCEDURE [dbo].[msk_kex_sel_allasajanlatriport] 

@UserID INT
, @FieldList VARCHAR(MAX) = '*'
, @WhereString VARCHAR(MAX) = '1=1'
, @OrderByString VARCHAR(MAX) = ''
, @PageNumber INT = 1
, @RowsPerPage INT = 100

AS
BEGIN
    SET NOCOUNT ON
	SET DATEFIRST 1

    DECLARE @sql NVARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

	DECLARE @sSearch VARCHAR(20) = NULL
    DECLARE @ParamName NVARCHAR(255) = NULL
    DECLARE @Cut BIT = 1
    DECLARE @return_value2 NVARCHAR(MAX) = NULL
	DECLARE @iidceg INTEGER = NULL
	DECLARE @sAjanlattetelDatumaTol VARCHAR(50) = NULL -- stringet ad vissza
	DECLARE @dAjanlattetelDatumaTol DATETIME = NULL -- típusegyezõség miatt
    DECLARE @sAjanlattetelDatumaIg VARCHAR(50) = NULL
	DECLARE @dAjanlattetelDatumaIg DATETIME = NULL
	DECLARE @bAjanlattetelDatuma BIT = NULL
	DECLARE @iFelveteliStatusz INTEGER = NULL
	DECLARE @iPozicioStatusz INTEGER = NULL
	DECLARE @sPozicioNeve VARCHAR(30) = NULL 


	DROP TABLE IF EXISTS [#ttmsk_kex_ajanlat]
	DROP TABLE IF EXISTS [#ttmsk_tob_pozicio] 
	DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz]
	DROP TABLE IF EXISTS [#ttAjanlattetelRiport]

	
	--select 1/0

	SET @Cut = 1
    SET @ParamName = N'idceg'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iidceg OUTPUT
                                                       , @WhereString OUTPUT
	

	SET @sSearch = 'BETWEEN'
    SET @ParamName = N'AjanlattetelDatuma'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sAjanlattetelDatumaTol OUTPUT
                                                                         , @sAjanlattetelDatumaIg OUTPUT
                                                                         , @WhereString OUTPUT

    IF @sAjanlattetelDatumaTol IS NOT NULL AND @sAjanlattetelDatumaIg IS NOT NULL
    BEGIN
        SET @bAjanlattetelDatuma = 1
    END

	SET @dAjanlattetelDatumaTol = REPLACE( @sAjanlattetelDatumaTol, '''', '' )
    SET @dAjanlattetelDatumaIg = REPLACE( @sAjanlattetelDatumaIg, '''', '' ) 


	SET @Cut = 1
    SET @ParamName = N'FelveteliStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iFelveteliStatusz OUTPUT
                                                       , @WhereString OUTPUT

	SET @Cut = 1
    SET @ParamName = N'PozicioStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iPozicioStatusz OUTPUT
                                                       , @WhereString OUTPUT


	SET @sSearch = 'LIKE'
    SET @ParamName = N'PozicioNeve'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sPozicioNeve OUTPUT
                                                                         , @return_value2 OUTPUT
                                                                         , @WhereString OUTPUT


Select 
aj.msk_kex_ajanlatID as msk_kex_ajanlatID,
j.datum as JelentkezesDatuma,
aj.datum as AjanlattetelDatuma,
AjanlatotElfogadta.LookupValue as AjanlatotElfogadta,
orvosi.igenylesdatuma as OrvosiIgenylesDatuma,
orvosi.kiallitasdatuma as OrvosiKiallitasDatuma,
[dbo].[msk_getMunkanapokSzama](orvosi.igenylesdatuma, orvosi.kiallitasdatuma) AS OrvosiIdotartama,
j.nev as JelentkezoNeve,
aj.PozicioIDLast,
j.msk_kex_jelentkezokID
INTO [#ttmsk_kex_ajanlat]
FROM [dbo].[msk_kex_ajanlat] aj
LEFT JOIN [dbo].[msk_kex_LookupList] AjanlatotElfogadta ON AjanlatotElfogadta.LookupListID = aj.idelfogadva AND AjanlatotElfogadta.GroupNum = 2 AND AjanlatotElfogadta.Deleted = 0
LEFT JOIN [dbo].[msk_kex_jelentkezok] j on aj.idjelentkezo=j.msk_kex_jelentkezokID and j.deleted=0
LEFT JOIN [dbo].[msk_kex_orvosi] orvosi on orvosi.idjelentkezo = j.msk_kex_jelentkezokID AND orvosi.Deleted = 0
WHERE aj.Deleted = 0 
					   AND (
						@bAjanlattetelDatuma IS NULL
						OR		(
                         @bAjanlattetelDatuma IS NOT NULL AND aj.datum BETWEEN @dAjanlattetelDatumaTol AND @dAjanlattetelDatumaIg
							)
						)

					SELECT ROW_NUMBER() OVER (PARTITION BY poz.PozicioID ORDER BY ttmka.AjanlattetelDatuma) AS RowNum,
						    ttmka.msk_kex_ajanlatID,
						    poz.Iktatoszam as EngedelyIktatoszama,
							poz.Engedelyezesidatum as Engedelyezesidatum,
							poz.PozicioInfo as Megjegyzes,
							poz.PozicioVisszavDatum as PozicioVisszavonasDatuma,
							poz.Idkeresesikerelem,
							poz.StatuszID,
							Msk_tob_allashirdetesekID,
							l.LookupValue as PozicioStatusza
					INTO [#ttmsk_tob_pozicio] 
					FROM [#ttmsk_kex_ajanlat] ttmka
					INNER JOIN [msk_tob_pozicio] poz ON ttmka.PozicioIDLast = poz.PozicioID AND poz.Deleted = 0
					LEFT JOIN [dbo].[msk_tob_allashirdetesek] toba on poz.Idkeresesikerelem = toba.Idkeresesikerelem AND toba.Deleted = 0 
					LEFT JOIN [dbo].[msk_kex_allasajanlatok] kexa on kexa.msk_kex_allasajanlatokID = toba.Msk_tob_allashirdetesekID AND kexa.Deleted = 0
					LEFT JOIN [dbo].[msk_tob_LookupList] l on l.LookuplistID = poz.StatuszID and l.deleted=0
					WHERE 1=1 AND (
									@iidceg IS NULL OR (  @iidceg IS NOT NULL AND kexa.idceg = @iidceg )
										)
							  AND (
									@iPozicioStatusz IS NULL OR (  @iPozicioStatusz IS NOT NULL AND l.LookupListID = @iPozicioStatusz )
										)
					
					
						SELECT ROW_NUMBER() OVER (PARTITION BY ttmka.msk_kex_jelentkezokID ORDER BY mkf.Msk_kex_felvstatuszID DESC) AS RowNum,
							ttmka.msk_kex_jelentkezokID,
							felvetelistatusz.LookupValue AS FelveteliStatusz,
							felvetelistatusz.LookupListID AS LookupListID,
							elutasitasindok.nev AS ElutasitasIndoka,
							visszalepesindok.nev AS VisszalepesIndoka,
							mkf.Belepesdatum AS BelepesDatum,
							mkf.Datum as StatuszAllitasDatuma
							INTO [#ttmsk_kex_felvstatusz]
						FROM [#ttmsk_kex_ajanlat] ttmka
						INNER JOIN dbo.msk_kex_felvstatusz AS mkf ON mkf.idjelentkezo = ttmka.msk_kex_jelentkezokID
						LEFT JOIN [dbo].[msk_kex_LookupList] AS felvetelistatusz ON felvetelistatusz.LookupListID = mkf.Idfelvstatusz AND felvetelistatusz.Deleted = 0 AND felvetelistatusz.GroupNum = 3
						LEFT JOIN [dbo].[msk_kex_elutasitasindokok] AS elutasitasindok ON mkf.Idelutasitasindok=elutasitasindok.msk_kex_elutasitasindokokID AND elutasitasindok.Deleted = 0
						LEFT JOIN [dbo].[msk_kex_visszalepesindokok] AS visszalepesindok ON mkf.Idvisszalepesindok=visszalepesindok.msk_kex_visszalepesindokokID AND visszalepesindok.Deleted = 0						
						WHERE (mkf.Deleted = 0) AND (
												@iFelveteliStatusz IS NULL OR (  @iFelveteliStatusz IS NOT NULL AND felvetelistatusz.LookupListID = @iFelveteliStatusz )
													)
													


SELECT 
ttmka.msk_kex_ajanlatID as msk_kex_ajanlatID,
ttmtp.EngedelyIktatoszama,
ttmtp.Engedelyezesidatum,
ttmtp.Megjegyzes,
kexa.targy AS PozicioNeve,
kexa.munkavegzes_helye AS MunkavegzesHelye,
kexa.poziciok_szama as BetoltesAlattAlloLetszam,
statuszolovezeto.Name AS MJGY,
toborzo.Name AS ToborzoNeve,
IIF (kexa.idlezarasindok > 0, 'Lezárt', 'Folyamatban') as HirdetesStatusz,
ttmtp.PozicioStatusza,
ttmtp.PozicioVisszavonasDatuma,
ttmka.JelentkezesDatuma,
CASE WHEN ttmtp.RowNum = 1 THEN ttmka.AjanlattetelDatuma ELSE NULL END AS AjanlattetelDatuma,
ttmka.AjanlatotElfogadta,
ttmka.OrvosiIgenylesDatuma,
ttmka.OrvosiKiallitasDatuma,
A1.OrvosiNapokHossza+1 AS OrvosiIdotartama,
ttmkf.FelveteliStatusz,
ttmkf.StatuszAllitasDatuma,
ttmkf.ElutasitasIndoka,
ttmkf.VisszalepesIndoka,
ttmkf.BelepesDatum,
ttmka.JelentkezoNeve,
kexa.idceg,
statuszolovezeto.PeopleID as PeopleID
--ttmtp.RowNum,
--ttmkf.RowNum
INTO [#ttAjanlattetelRiport]
FROM #ttmsk_kex_ajanlat ttmka
INNER JOIN #ttmsk_tob_pozicio ttmtp on ttmtp.msk_kex_ajanlatID = ttmka.msk_kex_ajanlatID
INNER JOIN #ttmsk_kex_felvstatusz ttmkf ON ttmkf.msk_kex_jelentkezokID = ttmka.msk_kex_jelentkezokID AND ttmkf.RowNum=1
LEFT JOIN [dbo].[msk_kex_allasajanlatok] kexa on kexa.msk_kex_allasajanlatokID = ttmtp.Msk_tob_allashirdetesekID AND kexa.Deleted = 0
LEFT JOIN [dbo].[msk_kex_allasajanlat_vezetok] AS kexav ON kexav.Idallasajanlat = kexa.msk_kex_allasajanlatokID AND kexav.Deleted = 0 AND kexav.Statuszolovezeto = 1
LEFT JOIN [dbo].[People] AS statuszolovezeto ON statuszolovezeto.PeopleID = kexav.Idvezeto AND statuszolovezeto.Deleted = 0
LEFT JOIN [dbo].[People] AS toborzo ON toborzo.PeopleID = kexa.idtoborzo1 AND toborzo.Deleted = 0
OUTER APPLY (SELECT [dbo].[ofn_msk_getMunkanapokSzama](ttmka.OrvosiIgenylesDatuma, ttmka.OrvosiKiallitasDatuma) AS OrvosiNapokHossza ) as A1
WHERE 1=1 

	-- A @WhereString megszabadítása a fölösleges szövegektõl [START]
    EXEC [dbo].[msp_wrk_ReturnParamValueCleanFromWhereString] @WhereString, @WhereString OUTPUT
	

    SET @sql = '
		
			SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
				, ' + @FieldList
					   + '
					   INTO [#ttResultList] 
					   FROM [#ttAjanlattetelRiport]
					   WHERE 1=1 AND '  + @WhereString + '
    
		

    SELECT * 
    from [#ttResultList]
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '
	EXEC msk_Print_Text @sql
    EXEC ( @sql )

	SELECT * from [#ttmsk_tob_pozicio]
END

/* TESZT
DECLARE @UserID INT
DECLARE @FieldList VARCHAR(MAX) 
DECLARE @WhereString VARCHAR(MAX)
DECLARE @OrderByString VARCHAR(MAX)
DECLARE @PageNumber INT
DECLARE @RowsPerPage INT 

SET @UserID = 208
SET @FieldList = N'msk_kex_ajanlatID,EngedelyIktatoszama,FORMAT(Engedelyezesidatum,''yyyy.MM.dd.'') as Engedelyezesidatum
,Megjegyzes,PozicioNeve,MunkavegzesHelye,BetoltesAlattAlloLetszam,MJGY,ToborzoNeve,HirdetesStatusz,PozicioStatusza
,FORMAT(PozicioVisszavonasDatuma,''yyyy.MM.dd.'') as PozicioVisszavonasDatuma,FORMAT(JelentkezesDatuma,''yyyy.MM.dd.'') as JelentkezesDatuma
,FORMAT(AjanlattetelDatuma,''yyyy.MM.dd.'') as AjanlattetelDatuma,AjanlatotElfogadta,FORMAT(OrvosiIgenylesDatuma,''yyyy.MM.dd.'') as OrvosiIgenylesDatuma
,FORMAT(OrvosiKiallitasDatuma,''yyyy.MM.dd.'') as OrvosiKiallitasDatuma,OrvosiIdotartama,FelveteliStatusz,FORMAT(StatuszAllitasDatuma,''yyyy.MM.dd.'') as StatuszAllitasDatuma
,ElutasitasIndoka,VisszalepesIndoka,FORMAT(BelepesDatum,''yyyy.MM.dd.'') as BelepesDatum,JelentkezoNeve,idceg'
SET @WhereString = N'1=1 AND (idceg=N''410706'')  
AND (AjanlattetelDatuma BETWEEN ''2024-03-24'' AND ''2024-03-26 23:59:59.999'') 
AND (PozicioNeve LIKE N''%teszt%'')  
AND (PozicioStatusza=N''30'') 
AND (FelveteliStatusz=N''6'')  
AND (MJGY LIKE N''%Fötevkör Tamás%'') '
SET @WhereString = N'1=1 AND (FelveteliStatusz=N''6'')  AND (PozicioStatusza=N''31'')  '
SET @OrderByString = 'msk_kex_ajanlatID'
SET @PageNumber = 1
SET @RowsPerPage = 100

EXEC [dbo].[msk_kex_sel_allasajanlatriport]  @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_allasajanlatriport_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_sel_allasajanlatriport] 

@UserID INT
, @FieldList VARCHAR(MAX) = '*'
, @WhereString VARCHAR(MAX) = '1=1'
, @OrderByString VARCHAR(MAX) = ''
, @PageNumber INT = 1
, @RowsPerPage INT = 100

AS
BEGIN
    SET NOCOUNT ON
	SET DATEFIRST 1

    DECLARE @sql NVARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

	DECLARE @sSearch VARCHAR(20) = NULL
    DECLARE @ParamName NVARCHAR(255) = NULL
    DECLARE @Cut BIT = 1
    DECLARE @return_value2 NVARCHAR(MAX) = NULL
	DECLARE @iidceg INTEGER = NULL
	DECLARE @sAjanlattetelDatumaTol VARCHAR(50) = NULL -- stringet ad vissza
	DECLARE @dAjanlattetelDatumaTol DATETIME = NULL -- típusegyezõség miatt
    DECLARE @sAjanlattetelDatumaIg VARCHAR(50) = NULL
	DECLARE @dAjanlattetelDatumaIg DATETIME = NULL
	DECLARE @bAjanlattetelDatuma BIT = NULL
	DECLARE @iFelveteliStatusz INTEGER = NULL
	DECLARE @iPozicioStatusz INTEGER = NULL
	DECLARE @sPozicioNeve VARCHAR(30) = NULL 


	DROP TABLE IF EXISTS [#ttmsk_kex_ajanlat]
	DROP TABLE IF EXISTS [#ttmsk_tob_pozicio] 
	DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz]
	DROP TABLE IF EXISTS [#ttAjanlattetelRiport]

	
	--select 1/0

	SET @Cut = 1
    SET @ParamName = N'idceg'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iidceg OUTPUT
                                                       , @WhereString OUTPUT
	

	SET @sSearch = 'BETWEEN'
    SET @ParamName = N'AjanlattetelDatuma'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sAjanlattetelDatumaTol OUTPUT
                                                                         , @sAjanlattetelDatumaIg OUTPUT
                                                                         , @WhereString OUTPUT

    IF @sAjanlattetelDatumaTol IS NOT NULL AND @sAjanlattetelDatumaIg IS NOT NULL
    BEGIN
        SET @bAjanlattetelDatuma = 1
    END

	SET @dAjanlattetelDatumaTol = REPLACE( @sAjanlattetelDatumaTol, '''', '' )
    SET @dAjanlattetelDatumaIg = REPLACE( @sAjanlattetelDatumaIg, '''', '' ) 


	SET @Cut = 1
    SET @ParamName = N'FelveteliStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iFelveteliStatusz OUTPUT
                                                       , @WhereString OUTPUT

	SET @Cut = 1
    SET @ParamName = N'PozicioStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iPozicioStatusz OUTPUT
                                                       , @WhereString OUTPUT


	SET @sSearch = 'LIKE'
    SET @ParamName = N'PozicioNeve'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sPozicioNeve OUTPUT
                                                                         , @return_value2 OUTPUT
                                                                         , @WhereString OUTPUT


Select 
aj.msk_kex_ajanlatID as msk_kex_ajanlatID,
j.datum as JelentkezesDatuma,
aj.datum as AjanlattetelDatuma,
AjanlatotElfogadta.LookupValue as AjanlatotElfogadta,
orvosi.igenylesdatuma as OrvosiIgenylesDatuma,
orvosi.kiallitasdatuma as OrvosiKiallitasDatuma,
[dbo].[msk_getMunkanapokSzama](orvosi.igenylesdatuma, orvosi.kiallitasdatuma) AS OrvosiIdotartama,
j.nev as JelentkezoNeve,
aj.PozicioIDLast,
j.msk_kex_jelentkezokID
INTO [#ttmsk_kex_ajanlat]
FROM [dbo].[msk_kex_ajanlat] aj
LEFT JOIN [dbo].[msk_kex_LookupList] AjanlatotElfogadta ON AjanlatotElfogadta.LookupListID = aj.idelfogadva AND AjanlatotElfogadta.GroupNum = 2 AND AjanlatotElfogadta.Deleted = 0
LEFT JOIN [dbo].[msk_kex_jelentkezok] j on aj.idjelentkezo=j.msk_kex_jelentkezokID and j.deleted=0
LEFT JOIN [dbo].[msk_kex_orvosi] orvosi on orvosi.idjelentkezo = j.msk_kex_jelentkezokID AND orvosi.Deleted = 0
WHERE aj.Deleted = 0 
					   AND (
						@bAjanlattetelDatuma IS NULL
						OR		(
                         @bAjanlattetelDatuma IS NOT NULL AND aj.datum BETWEEN @dAjanlattetelDatumaTol AND @dAjanlattetelDatumaIg
							)
						)

					SELECT ROW_NUMBER() OVER (PARTITION BY poz.PozicioID ORDER BY ttmka.AjanlattetelDatuma) AS RowNum,
						    ttmka.msk_kex_ajanlatID,
						    poz.Iktatoszam as EngedelyIktatoszama,
							poz.Engedelyezesidatum as Engedelyezesidatum,
							poz.PozicioInfo as Megjegyzes,
							poz.PozicioVisszavDatum as PozicioVisszavonasDatuma,
							poz.Idkeresesikerelem,
							poz.StatuszID,
							Msk_tob_allashirdetesekID,
							l.LookupValue as PozicioStatusza
					INTO [#ttmsk_tob_pozicio] 
					FROM [#ttmsk_kex_ajanlat] ttmka
					INNER JOIN [msk_tob_pozicio] poz ON ttmka.PozicioIDLast = poz.PozicioID AND poz.Deleted = 0
					LEFT JOIN [dbo].[msk_tob_allashirdetesek] toba on poz.Idkeresesikerelem = toba.Idkeresesikerelem AND toba.Deleted = 0 
					LEFT JOIN [dbo].[msk_kex_allasajanlatok] kexa on kexa.msk_kex_allasajanlatokID = toba.Msk_tob_allashirdetesekID AND kexa.Deleted = 0
					LEFT JOIN [dbo].[msk_tob_LookupList] l on l.LookuplistID = poz.StatuszID and l.deleted=0
					WHERE 1=1 AND (
									@iidceg IS NULL OR (  @iidceg IS NOT NULL AND kexa.idceg = @iidceg )
										)
							  AND (
									@iPozicioStatusz IS NULL OR (  @iPozicioStatusz IS NOT NULL AND l.LookupListID = @iPozicioStatusz )
										)
					
					
						SELECT ROW_NUMBER() OVER (PARTITION BY ttmka.msk_kex_jelentkezokID ORDER BY mkf.Msk_kex_felvstatuszID DESC) AS RowNum,
							ttmka.msk_kex_jelentkezokID,
							felvetelistatusz.LookupValue AS FelveteliStatusz,
							felvetelistatusz.LookupListID AS LookupListID,
							elutasitasindok.nev AS ElutasitasIndoka,
							visszalepesindok.nev AS VisszalepesIndoka,
							mkf.Belepesdatum AS BelepesDatum,
							mkf.Datum as StatuszAllitasDatuma
							INTO [#ttmsk_kex_felvstatusz]
						FROM [#ttmsk_kex_ajanlat] ttmka
						INNER JOIN dbo.msk_kex_felvstatusz AS mkf ON mkf.idjelentkezo = ttmka.msk_kex_jelentkezokID
						LEFT JOIN [dbo].[msk_kex_LookupList] AS felvetelistatusz ON felvetelistatusz.LookupListID = mkf.Idfelvstatusz AND felvetelistatusz.Deleted = 0 AND felvetelistatusz.GroupNum = 3
						LEFT JOIN [dbo].[msk_kex_elutasitasindokok] AS elutasitasindok ON mkf.Idelutasitasindok=elutasitasindok.msk_kex_elutasitasindokokID AND elutasitasindok.Deleted = 0
						LEFT JOIN [dbo].[msk_kex_visszalepesindokok] AS visszalepesindok ON mkf.Idvisszalepesindok=visszalepesindok.msk_kex_visszalepesindokokID AND visszalepesindok.Deleted = 0						
						WHERE (mkf.Deleted = 0) AND (
												@iFelveteliStatusz IS NULL OR (  @iFelveteliStatusz IS NOT NULL AND felvetelistatusz.LookupListID = @iFelveteliStatusz )
													)
													


SELECT 
ttmka.msk_kex_ajanlatID as msk_kex_ajanlatID,
ttmtp.EngedelyIktatoszama,
ttmtp.Engedelyezesidatum,
ttmtp.Megjegyzes,
kexa.targy AS PozicioNeve,
kexa.munkavegzes_helye AS MunkavegzesHelye,
kexa.poziciok_szama as BetoltesAlattAlloLetszam,
statuszolovezeto.Name AS MJGY,
toborzo.Name AS ToborzoNeve,
IIF (kexa.idlezarasindok > 0, 'Lezárt', 'Folyamatban') as HirdetesStatusz,
ttmtp.PozicioStatusza,
ttmtp.PozicioVisszavonasDatuma,
ttmka.JelentkezesDatuma,
CASE WHEN ttmtp.RowNum = 1 THEN ttmka.AjanlattetelDatuma ELSE NULL END AS AjanlattetelDatuma,
ttmka.AjanlatotElfogadta,
ttmka.OrvosiIgenylesDatuma,
ttmka.OrvosiKiallitasDatuma,
A1.OrvosiNapokHossza+1 AS OrvosiIdotartama,
CASE WHEN  A4.Osszehasonlitas=1
	THEN (
			A2.EngedelyezesiHossza - A1.OrvosiNapokHossza
			
			) 
	ELSE (
			A2.EngedelyezesiHossza
		 ) 
		
	END AS ToborzasHossza,	
ttmkf.FelveteliStatusz,
ttmkf.StatuszAllitasDatuma,
ttmkf.ElutasitasIndoka,
ttmkf.VisszalepesIndoka,
ttmkf.BelepesDatum,
ttmka.JelentkezoNeve,
kexa.idceg
--ttmtp.RowNum,
--ttmkf.RowNum
INTO [#ttAjanlattetelRiport]
FROM #ttmsk_kex_ajanlat ttmka
INNER JOIN #ttmsk_tob_pozicio ttmtp on ttmtp.msk_kex_ajanlatID = ttmka.msk_kex_ajanlatID
INNER JOIN #ttmsk_kex_felvstatusz ttmkf ON ttmkf.msk_kex_jelentkezokID = ttmka.msk_kex_jelentkezokID AND ttmkf.RowNum=1
LEFT JOIN [dbo].[msk_kex_allasajanlatok] kexa on kexa.msk_kex_allasajanlatokID = ttmtp.Msk_tob_allashirdetesekID AND kexa.Deleted = 0
LEFT JOIN [dbo].[msk_kex_allasajanlat_vezetok] AS kexav ON kexav.Idallasajanlat = kexa.msk_kex_allasajanlatokID AND kexav.Deleted = 0 AND kexav.Statuszolovezeto = 1
LEFT JOIN [dbo].[People] AS statuszolovezeto ON statuszolovezeto.PeopleID = kexav.Idvezeto AND statuszolovezeto.Deleted = 0
LEFT JOIN [dbo].[People] AS toborzo ON toborzo.PeopleID = kexa.idtoborzo1 AND toborzo.Deleted = 0
OUTER APPLY (SELECT [dbo].[msk_getMunkanapokSzama](ttmka.OrvosiIgenylesDatuma, ttmka.OrvosiKiallitasDatuma) AS OrvosiNapokHossza ) as A1
OUTER APPLY (SELECT [dbo].[msk_getMunkanapokSzama](ttmtp.Engedelyezesidatum, ttmka.AjanlattetelDatuma) AS EngedelyezesiHossza ) as A2
OUTER APPLY (SELECT [dbo].[msk_datum_osszehasonlitas](ttmka.OrvosiIgenylesDatuma,ttmka.AjanlattetelDatuma) AS Osszehasonlitas ) as A4
WHERE 1=1 

	-- A @WhereString megszabadítása a fölösleges szövegektõl [START]
    EXEC [dbo].[msp_wrk_ReturnParamValueCleanFromWhereString] @WhereString, @WhereString OUTPUT
	

    SET @sql = '
		
			SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
				, ' + @FieldList
					   + '
					   INTO [#ttResultList] 
					   FROM [#ttAjanlattetelRiport]
					   WHERE 1=1 AND '  + @WhereString + '
    
		

    SELECT * 
    from [#ttResultList]
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '
	EXEC msk_Print_Text @sql
    EXEC ( @sql )

	SELECT * from [#ttmsk_tob_pozicio]
END

/* TESZT
DECLARE @UserID INT
DECLARE @FieldList VARCHAR(MAX) 
DECLARE @WhereString VARCHAR(MAX)
DECLARE @OrderByString VARCHAR(MAX)
DECLARE @PageNumber INT
DECLARE @RowsPerPage INT 

SET @UserID = 208
SET @FieldList = N'msk_kex_ajanlatID,EngedelyIktatoszama,FORMAT(Engedelyezesidatum,''yyyy.MM.dd.'') as Engedelyezesidatum
,Megjegyzes,PozicioNeve,MunkavegzesHelye,BetoltesAlattAlloLetszam,MJGY,ToborzoNeve,HirdetesStatusz,PozicioStatusza
,FORMAT(PozicioVisszavonasDatuma,''yyyy.MM.dd.'') as PozicioVisszavonasDatuma,FORMAT(JelentkezesDatuma,''yyyy.MM.dd.'') as JelentkezesDatuma
,FORMAT(AjanlattetelDatuma,''yyyy.MM.dd.'') as AjanlattetelDatuma,AjanlatotElfogadta,FORMAT(OrvosiIgenylesDatuma,''yyyy.MM.dd.'') as OrvosiIgenylesDatuma
,FORMAT(OrvosiKiallitasDatuma,''yyyy.MM.dd.'') as OrvosiKiallitasDatuma,OrvosiIdotartama,FelveteliStatusz,FORMAT(StatuszAllitasDatuma,''yyyy.MM.dd.'') as StatuszAllitasDatuma
,ElutasitasIndoka,VisszalepesIndoka,FORMAT(BelepesDatum,''yyyy.MM.dd.'') as BelepesDatum,JelentkezoNeve,idceg'
SET @WhereString = N'1=1 AND (idceg=N''410706'')  
AND (AjanlattetelDatuma BETWEEN ''2024-03-24'' AND ''2024-03-26 23:59:59.999'') 
AND (PozicioNeve LIKE N''%teszt%'')  
AND (PozicioStatusza=N''30'') 
AND (FelveteliStatusz=N''6'')  
AND (MJGY LIKE N''%Fötevkör Tamás%'') '
SET @WhereString = N'1=1 AND (FelveteliStatusz=N''6'')  AND (PozicioStatusza=N''31'')  '
SET @OrderByString = 'msk_kex_ajanlatID'
SET @PageNumber = 1
SET @RowsPerPage = 100

EXEC [dbo].[msk_kex_sel_allasajanlatriport]  @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_chart1_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_sel_chart1] (
	@UserID INT,
    @FieldList varchar(max) = '*',
    @WhereString varchar(8000) = '1=1',
    @OrderByString varchar(4000) = '',
    @pageNumber INT = 0,
    @rowsPerPage INT = 0
)
AS
BEGIN
-- =============================================
-- Author:		Horváth Gábor
-- Create date: 2019.07.02
-- Description:	Chart alapadatok elállítása
-- Usage: EXECUTE msk_kex_sel_chart1 45
-- SystemLOGSample: CommandText = execute msk_kex_sel_chart1 '7', @OrderByString='CID Asc', @WhereString='1=1 AND (VallalatKod=''1000'') ', @FieldList='CID,ChartID,Data,W,H,Title,VallalatKod', @pageNumber=1, @rowsPerPage=100
-- include: -
-- =============================================

	SET NOCOUNT ON;
insert into msk_log (name,value,created) values ('kex_dashboardWH',@WhereString,getdate())

	--BEGINFILTERS a mezõnevek a DataDefinitionben megadott nevek pl. VallalatKod ... amit viszont ez az eljárás szolgáltat kimenetként :)
	declare @VallalatKod nvarchar(10);set @VallalatKod = '%';				EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'VallalatKod6789', 0, @VallalatKod OUTPUT, @WhereString OUTPUT
	declare @szervezetiegyseg nvarchar(1000);set @szervezetiegyseg = '%';	EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'szervezetiegyseg6789', 0, @szervezetiegyseg OUTPUT, @WhereString OUTPUT
	declare @hely nvarchar(1000);set @hely = '%';							EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'hely6789', 0, @hely OUTPUT, @WhereString OUTPUT
	declare @mjgy nvarchar(10);set @mjgy= '%';								EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'mjgy6789', 0, @mjgy OUTPUT, @WhereString OUTPUT
	declare @vezeto nvarchar(10);set @vezeto = '%';							EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'vezeto6789', 0, @vezeto OUTPUT, @WhereString OUTPUT
	declare @toborzo nvarchar(100);set @toborzo = '%';						EXEC osp_wrk_ReturnParamValueFromWhereString @WhereString, 'toborzo6789', 0, @toborzo OUTPUT, @WhereString OUTPUT

	--DÁTUMTÓL DÁTUMIG BONYOLULTABB :)
	DECLARE @datumtol VARCHAR(100) = '1900-01-01'
	DECLARE @datumig VARCHAR(100) = '2900-01-01'
	DECLARE @datumtol_date DATETIME2 = '1900-01-01'
	DECLARE @datumig_date DATETIME2 = '2900-01-01'

	--2=2 AND (j.datum BETWEEN '2020-01-01' AND '2020-12-31 23:59:59.999')
	--2=2 AND ([datumtol6789] BETWEEN '2020-01-01' AND '2020-12-31')
	--2=2 AND ([datumtol6789] BETWEEN ''2019-01-01'' AND ''2019-12-31'')
	BEGIN TRY
		SET @datumtol = SUBSTRING(@WhereString, CHARINDEX('2=2',@WhereString) + 33,10)
		SET @datumtol_date = @datumtol
		SET @datumig = CONCAT(SUBSTRING(@WhereString, CHARINDEX('2=2',@WhereString) + 50,10),' 23:59:59.999')
		SET @datumig_date = @datumig
	END TRY
	BEGIN CATCH
		SET @datumtol = '1900-01-01'
		SET @datumtol_date = @datumtol
		SET @datumig = '2900-01-01'
		SET @datumig_date = @datumig
	END CATCH

	--MJGY Szöveg beállítása
	DECLARE @sel_mjgy nvarchar(max) = '';
	if (@mjgy<>'%')
		set @sel_mjgy=' and a.msk_kex_allasajanlatokID in (select idallasajanlat from msk_kex_allasajanlat_vezetok where mjgy=10 and idvezeto = '''+@mjgy+''')';

	--ENDFILTERS
insert into msk_log (name,value,created) values ('kex_dashboardDT',concat(@datumtol,'-',cast(@datumig as varchar)),getdate())

	--Values
	/*Toborzás átlagos hossza (nap): Állásajánlat lezárás dátuma - Aktiválás dátuma (amikor a hirdetés megjelent - datuma_aktivalas)*/
/*190905
	DECLARE @sel_len_toborzas nvarchar(max), @len_toborzas int;
	set @sel_len_toborzas = '
		select @len_toborzas=isnull(avg(nap),0) from (
			select max(datediff(day,datum_aktivalas,datum_lejarat)) nap FROM [dbo].[msk_kex_allasajanlatok] a
			where a.Deleted=0 
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND a.datum_aktivalas>='''+@datumtol+''' and a.datum_aktivalas<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			group by msk_kex_allasajanlatokID
		) t where nap >0
		';	
	set @sel_len_toborzas=replace(@sel_len_toborzas,'{{mjgy}}',@sel_mjgy);
	EXEC sp_executesql @sel_len_toborzas, N'@len_toborzas int OUTPUT', @len_toborzas OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL',@sel_len_toborzas,getdate())
*/
	/*Nyitott állásajánlatok (db): nem lezárt állásajánlatok*/
	DECLARE @sel_cnt_nyitott nvarchar(max), @cnt_nyitott int;
	set @sel_cnt_nyitott = '
		select @cnt_nyitott=count(*)  from (select distinct a.msk_kex_allasajanlatokID 
		    from [dbo].[msk_kex_allasajanlatok] a
			INNER JOIN [dbo].[msk_kex_jelentkezok] j ON j.[idallasajanlat]=a.msk_kex_allasajanlatokID 
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL AND a.Deleted=0 and (a.idlezarasindok is null)
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			)t
		';

	
	set @sel_cnt_nyitott=replace(@sel_cnt_nyitott,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_nyitott, N'@cnt_nyitott int OUTPUT', @cnt_nyitott OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL2',@sel_cnt_nyitott,getdate())




	/*Nyitott pozíciók (db): nem lezárt állásajánlatok*/
	DECLARE @sel_cnt_poz nvarchar(max), @cnt_poz int;
	set @sel_cnt_poz = '
		select @cnt_poz=isnull(sum(poziciok_szama),0) from msk_kex_allasajanlatok where msk_kex_allasajanlatokID in (
			select distinct a.msk_kex_allasajanlatokID 
				from [dbo].[msk_kex_allasajanlatok] a
				INNER JOIN [dbo].[msk_kex_jelentkezok] j on j.[idallasajanlat]=a.msk_kex_allasajanlatokID 
				LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
				WHERE tj.JelentkezokID IS NULL AND a.Deleted=0 and (a.idlezarasindok is null)		
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			)
		';

	
	set @sel_cnt_poz=replace(@sel_cnt_poz,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_poz, N'@cnt_poz int OUTPUT', @cnt_poz OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL3',@sel_cnt_poz,getdate())






	/*Jelentkezõk száma (fõ): összes jelentkezõ száma (egyedi e-mail hash-ek alapján, állásajánlatonként és személyenként, 
	azaz ha egy ember több állásra jelentkezik, akkor külön számoljuk, viszont ha egy állásajánlatra többször is beadja, akkor azt egynek)*/
	DECLARE @sel_cnt_jelentkezok nvarchar(max), @cnt_jelentkezok int=0;
	set @sel_cnt_jelentkezok='
		select @cnt_jelentkezok=count(*) from
			(
			select j.HashID /*j.hashid*/
			from [dbo].[msk_kex_jelentkezok] j 
			LEFT JOIN [dbo].[msk_kex_allasajanlatok] a ON a.msk_kex_allasajanlatokID=j.idallasajanlat
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL AND a.Deleted=0 and --j.Deleted=0 and j.[idallasajanlat]=a.msk_kex_allasajanlatokID 
			--AND 
			IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			group by j.hashid--,a.msk_kex_allasajanlatokID 
			) t
	';
	set @sel_cnt_jelentkezok=replace(@sel_cnt_jelentkezok,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_jelentkezok, N'@cnt_jelentkezok int OUTPUT', @cnt_jelentkezok OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL4',@sel_cnt_jelentkezok,getdate())


	/*Teszten résztvevõk (fõ): jelentkezõk számából azok, akiknek van teszt sora*/
	DECLARE @sel_cnt_teszt nvarchar(max), @cnt_teszt int;
	set @sel_cnt_teszt = '
		select @cnt_teszt=count(*) from (
			select j.msk_kex_jelentkezokID 
			from msk_kex_teszt t
			inner join msk_kex_jelentkezok j on j.msk_kex_jelentkezokID=t.idjelentkezo
			inner join msk_kex_allasajanlatok a on j.idallasajanlat = a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL
			and t.deleted=0 and a.deleted=0 --and j.deleted=0
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			--group by j.msk_kex_jelentkezokID
			) t0							
		';	
	set @sel_cnt_teszt=replace(@sel_cnt_teszt,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_teszt, N'@cnt_teszt int OUTPUT', @cnt_teszt OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL5',@sel_cnt_teszt,getdate())

	/*Interún résztvevõk (fõ): jelentkezõk számából azok, akiknek van teszt sora*/
	DECLARE @sel_cnt_interju nvarchar(max), @cnt_interju int;
	set @sel_cnt_interju = '
		select @cnt_interju=count(*) from (
			select j.msk_kex_jelentkezokID from msk_kex_interju t
			inner join msk_kex_jelentkezok j on j.msk_kex_jelentkezokID=t.idjelentkezo
			inner join msk_kex_allasajanlatok a on j.idallasajanlat = a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL
			and t.deleted=0 and a.deleted=0 --and j.deleted=0
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			--group by j.msk_kex_jelentkezokID
			) t0							
		';	
	set @sel_cnt_interju=replace(@sel_cnt_interju,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_interju, N'@cnt_interju int OUTPUT', @cnt_interju OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL6',@sel_cnt_interju,getdate())

	/*Interún résztvevõk (fõ): jelentkezõk számából azok, akiknek van teszt sora*/
	DECLARE @sel_cnt_orvosi nvarchar(max), @cnt_orvosi int;
	set @sel_cnt_orvosi = '
		select @cnt_orvosi=count(*) from (
			select j.msk_kex_jelentkezokID from msk_kex_orvosi t
			inner join msk_kex_jelentkezok j on j.msk_kex_jelentkezokID=t.idjelentkezo
			inner join msk_kex_allasajanlatok a on j.idallasajanlat = a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL
			and t.deleted=0 and a.deleted=0 --and j.deleted=0
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			--group by j.msk_kex_jelentkezokID
			) t0							
		';	
	set @sel_cnt_orvosi=replace(@sel_cnt_orvosi,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_orvosi, N'@cnt_orvosi int OUTPUT', @cnt_orvosi OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL7',@sel_cnt_orvosi,getdate())
	
	/*Kiválasztottak / ajánlatot tettünk (fõ): jelentkezõk számából azok, akiknek van ajánlat sora*/
	DECLARE @sel_cnt_kivalasztott nvarchar(max), @cnt_kivalasztott int=0;
	set @sel_cnt_kivalasztott = '
		select @cnt_kivalasztott=count(*) from (
			select j.msk_kex_jelentkezokID from msk_kex_ajanlat t
			inner join msk_kex_jelentkezok j on j.msk_kex_jelentkezokID=t.idjelentkezo
			inner join msk_kex_allasajanlatok a on j.idallasajanlat = a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL
			and t.deleted=0 and a.deleted=0 --and j.deleted=0
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			--group by j.msk_kex_jelentkezokID
			) t0							
		';	
	set @sel_cnt_kivalasztott=replace(@sel_cnt_kivalasztott,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_kivalasztott, N'@cnt_kivalasztott int OUTPUT', @cnt_kivalasztott OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL8',@sel_cnt_kivalasztott,getdate())

	/*Ajánlatot elfogadók (fõ): jelentkezõk számából azok, akiknek van ajánlat sora, és az Ajánlatot elfogadta mezõ Igen értékû*/
	DECLARE @sel_cnt_elfogado nvarchar(max), @cnt_elfogado int=0;
	set @sel_cnt_elfogado = '
		select @cnt_elfogado=count(*) from (
			select j.msk_kex_jelentkezokID from msk_kex_ajanlat t
			inner join msk_kex_jelentkezok j on j.msk_kex_jelentkezokID=t.idjelentkezo
			inner join msk_kex_allasajanlatok a on j.idallasajanlat = a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL
			and t.deleted=0 and a.deleted=0 --and j.deleted=0 
			and t.idelfogadva=4
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			--group by j.msk_kex_jelentkezokID
			) t0							
		';	
	set @sel_cnt_elfogado=replace(@sel_cnt_elfogado,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_elfogado, N'@cnt_elfogado int OUTPUT', @cnt_elfogado OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL9',@sel_cnt_elfogado,getdate())

	/*Ténylegesen belépõk (fõ): jelentkezõk számából azok, akiknek a státusza felvett*/
	DECLARE @sel_cnt_belepo nvarchar(max), @cnt_belepo int=0;
			set @sel_cnt_belepo = '
		select @cnt_belepo=count(*) from (
			select j.msk_kex_jelentkezokID from msk_kex_AktualisFelveteliStatusz t
			inner join msk_kex_jelentkezok j on j.msk_kex_jelentkezokID=t.idjelentkezo
			inner join msk_kex_allasajanlatok a on j.idallasajanlat = a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL
			and t.deleted=0 and a.deleted=0 and t.idfelvstatusz=6
			AND IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			group by j.msk_kex_jelentkezokID
			) t0							
		';	
	set @sel_cnt_belepo=replace(@sel_cnt_belepo,'{{mjgy}}',@sel_mjgy);	
	EXEC sp_executesql @sel_cnt_belepo, N'@cnt_belepo int OUTPUT', @cnt_belepo OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL10',@sel_cnt_belepo,getdate())

	
/* Ha egy ember jelentkezik sokra az 1-nek számít 
   Jelentkezõk száma (fõ): */
	DECLARE @sel_cnt_jelentkezok_2 nvarchar(max), @cnt_jelentkezok_2 int;
	set @sel_cnt_jelentkezok_2 = '
		select @cnt_jelentkezok_2=count(*) from
			(
			select j.msk_kex_jelentkezokID
			from [dbo].[msk_kex_jelentkezok] j 
			LEFT JOIN [dbo].[msk_kex_allasajanlatok] a ON j.[idallasajanlat]=a.msk_kex_allasajanlatokID
			LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
            WHERE tj.JelentkezokID IS NULL AND a.Deleted=0 and --j.Deleted=0 and j.[idallasajanlat]=a.msk_kex_allasajanlatokID 
			--AND 
			IsNull(a.idceg,'''') like '''+@VallalatKod+''' 
			AND IsNull(a.reszleg,'''') like '''+@szervezetiegyseg+'''
			AND IsNull(a.munkavegzes_helye,'''') like '''+@hely+'''  
			AND j.datum>='''+@datumtol+''' and j.datum<='''+@datumig+''' 	
			AND IsNull(a.idvezeto,'''') like '''+@vezeto+'''
			AND (IsNull(a.idtoborzo1,'''') like '''+@toborzo+''' OR IsNull(a.idtoborzo2,'''') like '''+@toborzo+''' )
			{{mjgy}}
			--group by h.hash /*j.hashid*/
			) t
		';	
	set @sel_cnt_jelentkezok_2=replace(@sel_cnt_jelentkezok_2,'{{mjgy}}',@sel_mjgy);
	EXEC sp_executesql @sel_cnt_jelentkezok_2, N'@cnt_jelentkezok_2 int OUTPUT', @cnt_jelentkezok_2 OUTPUT	
insert into msk_log (name,value,created) values ('kex_dashboardSQL11',@sel_cnt_jelentkezok_2,getdate())


--insert into msk_log (name,value,created) values ('chart_szakaszok',@sel_szakaszok,getdate())	

	declare @rnd int;
	select @rnd=1;--! ! ! ! ! ! ! !!!!!  Ahány rekord lesz megjelenítve. azért kell, mert az összes rekord mekérkezése után kezd el futni majd a javascript     round(rand()*10000,0)
	DECLARE @Select VARCHAR(max)
	SET @select = 'WITH myCTE AS (
		SELECT ROW_NUMBER() OVER (ORDER BY ' + @OrderByString + ') AS Row, ' + @FieldList + ' 
	    FROM (
			select * from (				  
			      SELECT '+convert(varchar(10),@rnd+1)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_nyitott )+''',''||rgba(250,250,128)'') as Data,    300 as W,250 as H,''Nyitott állásajánlatok<br>(db)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			union SELECT '+convert(varchar(10),@rnd+2)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_poz )+''',''||rgba(220,220,100)'') as Data,    300 as W,250 as H,''Nyitott pozíciók<br>(db)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789			
			union SELECT '+convert(varchar(10),@rnd+3)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_jelentkezok )+''',''||rgba(128,234,255)'') as Data,    300 as W,250 as H,''Jelentkezések száma<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789			
			union SELECT '+convert(varchar(10),@rnd+4)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_jelentkezok_2 )+''',''||rgba(128,234,255)'') as Data,    300 as W,250 as H,''Jelentkezõk száma<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789			
			union SELECT '+convert(varchar(10),@rnd+5)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_teszt   )+''',''||rgba(223,087,104)'') as Data,    300 as W,250 as H,''Teszten résztvevõk<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			union SELECT '+convert(varchar(10),@rnd+6)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_interju )+''',''||rgba(210,147,075)'') as Data,    300 as W,250 as H,''Interjún résztvevõk<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			union SELECT '+convert(varchar(10),@rnd+7)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_orvosi  )+''',''||rgba(194,128,255)'') as Data,    300 as W,250 as H,''Orvosi vizsgálaton résztvevõk<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			union SELECT '+convert(varchar(10),@rnd+8)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_kivalasztott )+''',''||rgba(128,163,255)'') as Data,    300 as W,250 as H,''Kiválasztottak/ajánlatot tettünk<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			union SELECT '+convert(varchar(10),@rnd+9)+ ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_elfogado )    +''',''||rgba(145,250,233)'') as Data,    300 as W,250 as H,''Ajánlatot elfogadók<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			union SELECT '+convert(varchar(10),@rnd+10)+' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@cnt_belepo )      +''',''||rgba(108,244,116)'') as Data,    300 as W,250 as H,''Ténylegesen belépõk<br>(fõ)'' as Title, '''+        @VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
			) k
		) as c 		
        WHERE  1=1 )
		select * from myCTE' 
		/* felsõ selectbõl kiszedve
			SELECT '+convert(varchar(10),@rnd)+   ' as CID,''number'' as ChartID,concat('''+convert(varchar(10),@len_toborzas)+''',''||rgba(250,205,145)'') as Data,    300 as W,250 as H,''Toborzás átlagos hossza<br>(nap)'' as Title, '''+@VallalatKod+''' as VallalatKod6789, '''+@szervezetiegyseg+''' as szervezetiegyseg6789, '''+@vezeto+''' as vezeto6789, '''+@datumtol+''' as datumtol6789, '''+@datumig+''' as datumig6789, '''+@mjgy+''' as mjgy6789, '''+@toborzo+''' as toborzo6789, '''+@hely+''' as hely6789
		*/
	insert into msk_log (name,value,created) values ('chart_sum',@select,getdate())
	--PRINT left(@Select,8000)		
	EXECUTE(@Select)
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_elutasitasivisszalepesiokokpriport.sql =====

/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-24
-- Description:	KEX - Elutasítási és visszalépési okok riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_elutasitasivisszalepesiokokpriport] @UserID INT
                                                                      , @FieldList VARCHAR(MAX) = '*'
                                                                      , @WhereString VARCHAR(MAX) = '1=1'
                                                                      , @OrderByString VARCHAR(MAX) = '[tipus]'
                                                                      , @PageNumber INT = 1
                                                                      , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatok]
    DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz]

    CREATE TABLE [#ttmsk_kex_allasajanlatok] (
                                                 [msk_kex_allasajanlatokID] INTEGER NOT NULL
                                               , [targy] VARCHAR(255) NULL
                                               , [msk_kex_jelentkezokID] INTEGER NOT NULL
                                             )

    SET @sql = '
INSERT INTO [#ttmsk_kex_allasajanlatok] ( [msk_kex_allasajanlatokID], [targy], msk_kex_jelentkezokID)
SELECT a.[msk_kex_allasajanlatokID]
    , [a].[targy] AS [targy]
    , [j].[msk_kex_jelentkezokID]
FROM [dbo].[msk_kex_allasajanlatok] [a]
    inner JOIN [dbo].[msk_kex_jelentkezok] [j] ON [a].[msk_kex_allasajanlatokID] = [j].[idallasajanlat]
    LEFT JOIN [dbo].[msk_kex_allasajanlat_vezetok] [av] ON [av].[Idallasajanlat] = [a].[msk_kex_allasajanlatokID] 
                                                           AND [av].[Statuszolovezeto] = 1
    LEFT JOIN [dbo].[msk_tob_allashirdetesek] [ah] ON [ah].[Msk_tob_allashirdetesekID] = [a].[msk_kex_allasajanlatokID]
    LEFT JOIN [dbo].[msk_tob_keresesikerelem] [k] ON [k].[Msk_tob_keresesikerelemID] = [ah].[Idkeresesikerelem]
    LEFT JOIN [dbo].[msk_tob_teruletiigazgatosagok] [ti] ON [ti].[Msk_tob_teruletiigazgatosagokID] = [k].[TeruletiigazgatosagID]
	LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
    WHERE tj.JelentkezokID IS NULL AND ' + @WhereString

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Elutasítási és visszalépési okok riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )

    SELECT [fs].[Idjelentkezo]
         , [fs].[Idfelvstatusz]
         , [fs].[Idelutasitasindok]
         , [fs].[Idvisszalepesindok]
         , [fs].[Deleted]
    INTO [#ttmsk_kex_felvstatusz]
    FROM [dbo].[msk_kex_AktualisFelveteliStatusz] [fs]
        INNER JOIN (
                       SELECT [MKF].[Idjelentkezo]
                            , MAX( [MKF].[Msk_kex_felvstatuszID] ) [Msk_kex_felvstatuszID]
                       FROM [#ttmsk_kex_allasajanlatok] [a]
                           INNER JOIN [dbo].[msk_kex_AktualisFelveteliStatusz] [MKF] ON [MKF].[Idjelentkezo] = [a].[msk_kex_jelentkezokID]
                       WHERE [MKF].[Idfelvstatusz] IN ( 7, 8 ) AND [MKF].[Deleted] = 0
                       GROUP BY [MKF].[Idjelentkezo]
                   ) [a7] ON [a7].[Msk_kex_felvstatuszID] = [fs].[Msk_kex_felvstatuszID]



    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
         , ' + @FieldList
               + '
    FROM [#ttmsk_kex_allasajanlatok] [a]
        LEFT JOIN [#ttmsk_kex_felvstatusz] [f] ON [f].[Idjelentkezo] = [a].[msk_kex_jelentkezokID]
        LEFT JOIN [dbo].[msk_kex_LookupList] [l] ON [l].[LookupListID] = [f].[Idfelvstatusz]
        LEFT JOIN [dbo].[msk_kex_elutasitasindokok] [e] ON [e].[msk_kex_elutasitasindokokID] = [f].[Idelutasitasindok]
        LEFT JOIN [dbo].[msk_kex_visszalepesindokok] [v] ON [v].[msk_kex_visszalepesindokokID] = [f].[Idvisszalepesindok]
    WHERE [f].[Deleted] = 0 AND 1 = 1
    GROUP BY [l].[LookupValue]
           , [a].[targy]
           , ( CASE
                    WHEN [f].[Idelutasitasindok] IS NOT NULL THEN [e].[nev]
                    WHEN [f].[Idvisszalepesindok] IS NOT NULL THEN [v].[nev]
                    ELSE NULL
               END
             )
)

    SELECT *
    from FNetPagedSelect
    WHERE [Row] between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Elutasítási és visszalépési okok riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '[l].[LookupValue] AS [tipus], [a].[targy] AS [targy]
, ( CASE
        WHEN [f].[Idelutasitasindok] IS NOT NULL THEN [e].[nev]
        WHEN [f].[Idvisszalepesindok] IS NOT NULL THEN [v].[nev]
        ELSE NULL
    END
    ) AS [OK]
, COUNT( * ) AS [fo]'
DECLARE @WhereString VARCHAR(MAX) = '1 = 1
                               AND ( [j].[datum] BETWEEN ''2022-01-01'' AND ''2022-11-30 23:59:59.999'' )
                               AND ( [a].[idceg] = N''941824'' ) AND ( [ti].[Igazgatosagok] LIKE N''%alap%'' )
                               AND ( [a].[targy] LIKE N''%adatb%'' )
                               AND ( [a].[msk_kex_allasajanlatokID] IN (
                                                                           SELECT [Idallasajanlat]
                                                                           FROM [msk_kex_allasajanlat_vezetok]
                                                                           WHERE [Idvezeto] = 45904 AND [Mjgy] = 10
                                                                       )
                                   ) AND ( [av].[Idvezeto] = N''1836'' ) AND ( 1 IN ( SELECT 1 ))
                               AND (( [a].[idtoborzo1] = 353 ))'
DECLARE @OrderByString VARCHAR(MAX) = 'l.LookupValue'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

set @WhereString = '1 = 1 --AND ( [j].[datum] BETWEEN ''2022-01-01'' AND ''2022-11-30 23:59:59.999'' )
                            --   AND ( [a].[idceg] = N''941824'' )
                               '
EXECUTE [dbo].[msk_kex_sel_elutasitasivisszalepesiokokpriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_jelentkezokforrasariport.sql =====

/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-24
-- Description:	KEX - Jelentkezõk forrása riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_jelentkezokforrasariport] @UserID INT
                                                                     , @FieldList VARCHAR(MAX) = '*'
                                                                     , @WhereString VARCHAR(MAX) = '1=1'
                                                                     , @OrderByString VARCHAR(MAX) = '[msk_kex_allasajanlatokID]'
                                                                     , @PageNumber INT = 1
                                                                     , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatok]
    DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz]

    CREATE TABLE [#ttmsk_kex_allasajanlatok] (
                                                 [msk_kex_allasajanlatokID] INTEGER NOT NULL
                                               , [honnanertesult] VARCHAR(255) NULL
                                               , [msk_kex_jelentkezokID] INTEGER NOT NULL
                                             )

    SET @sql = '
INSERT INTO [#ttmsk_kex_allasajanlatok] ( [msk_kex_allasajanlatokID], [honnanertesult], [msk_kex_jelentkezokID] )
    SELECT [a].[msk_kex_allasajanlatokID]
            , [j].[honnanertesult]
            , [j].[msk_kex_jelentkezokID]
    FROM [dbo].[msk_kex_allasajanlatok] [a]
        INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [a].[msk_kex_allasajanlatokID] = [j].[idallasajanlat]
		LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
    WHERE tj.JelentkezokID IS NULL AND ' + @WhereString

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Jelentkezõk riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )

    SELECT [fs].[Idjelentkezo]
         , [fs].[Idfelvstatusz]
         , [fs].[Idelutasitasindok]
         , [fs].[Idvisszalepesindok]
         , [fs].[Deleted]
    INTO [#ttmsk_kex_felvstatusz]
    FROM [dbo].[msk_kex_AktualisFelveteliStatusz] [fs]
        INNER JOIN (
                       SELECT [MKF].[Idjelentkezo]
                            , MAX( [MKF].[Msk_kex_felvstatuszID] ) [Msk_kex_felvstatuszID]
                       FROM [#ttmsk_kex_allasajanlatok] [a]
                           INNER JOIN [dbo].[msk_kex_AktualisFelveteliStatusz] [MKF] ON [MKF].[Idjelentkezo] = [a].[msk_kex_jelentkezokID]
                       WHERE [MKF].[Idfelvstatusz] IN ( 6, 7, 8 ) AND [MKF].[Deleted] = 0
                       GROUP BY [MKF].[Idjelentkezo]
                   ) [a7] ON [a7].[Msk_kex_felvstatuszID] = [fs].[Msk_kex_felvstatuszID]

    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
         , ' + @FieldList
               + '
FROM [#ttmsk_kex_allasajanlatok] [J]
    LEFT JOIN [#ttmsk_kex_felvstatusz] [f] ON [f].[Idjelentkezo] = [J].[msk_kex_jelentkezokID]
GROUP BY ( CASE
                WHEN [f].[Idfelvstatusz] = 6 THEN ''Kiválasztott jelentkezõ''
                ELSE ''Jelentkezõ''
           END
         )
       , [J].[honnanertesult] 
 )

    SELECT *
    from FNetPagedSelect
    WHERE [Row] between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Elutasítási és visszalépési okok riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '(CASE WHEN f.Idfelvstatusz = 6 THEN ''Kiválasztott jelentkezõ'' ELSE ''Jelentkezõ'' END) AS jelentkezotipusa,[honnanertesult],count (*) as fo'
DECLARE @WhereString VARCHAR(MAX) = '1 = 1 AND ( [J].[datum] BETWEEN ''2022-01-01'' AND ''2022-12-01 23:59:59.999'' )
                               AND ( [A].[idceg] = N''941824'' ) AND ( [A].[targy] LIKE N''%raktár%'' )
                               AND ( [A].[msk_kex_allasajanlatokID] IN (
                                                                       SELECT [MKAV].[Idallasajanlat]
                                                                       FROM [dbo].[msk_kex_allasajanlat_vezetok] [MKAV]
                                                                       WHERE [MKAV].[Idvezeto] = 809 AND [MKAV].[Mjgy] = 10
                                                                   )
                                   ) AND ( [A].[idvezeto] = N''809'' ) AND ( 1 IN ( SELECT 1 )) AND (( [A].[idtoborzo1] = 353 ) ) 
         '
DECLARE @OrderByString VARCHAR(MAX) = '(CASE WHEN f.Idfelvstatusz = 6 THEN ''Kiválasztott jelentkezõ'' ELSE ''Jelentkezõ'' END)'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

EXECUTE [dbo].[msk_kex_sel_jelentkezokforrasariport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_jelentkezokriport.sql =====

/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-24
-- Description:	KEX - Jelentkezõk riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_jelentkezokriport] @UserID INT
                                                              , @FieldList VARCHAR(MAX) = '*'
                                                              , @WhereString VARCHAR(MAX) = '1=1'
                                                              , @OrderByString VARCHAR(MAX) = '[msk_kex_allasajanlatokID]'
                                                              , @PageNumber INT = 1
                                                              , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatok]
    DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz]
    DROP TABLE IF EXISTS [#ttJelentkezokRiport]

    CREATE TABLE [#ttmsk_kex_allasajanlatok] (
                                                 [msk_kex_allasajanlatokID] INTEGER NOT NULL
                                               , [targy] VARCHAR(255) NULL
                                               , [idceg] INTEGER NULL
                                               , [idtoborzo1] INTEGER NULL
                                               , [munkavegzes_helye] VARCHAR(255) NULL
                                               , [nev] VARCHAR(255) NULL
                                               , [email] VARCHAR(255) NULL
                                               , [telefonszam] VARCHAR(50) NULL
                                               , [berigeny] INTEGER NULL
                                               , [ajanlo_nev] VARCHAR(255) NULL
                                               , [datum] DATETIME2 NULL
                                               , [honnanertesult] VARCHAR(255) NULL
                                               , [cv_toborzo_megj] VARCHAR(MAX) NULL
                                               , [cv_vezeto_megj] VARCHAR(MAX) NULL
                                               , [msk_kex_jelentkezokID] INTEGER NOT NULL
                                               , [idcv_toborzo] INTEGER NULL
                                               , [idcv_vezeto] INTEGER NULL
											   , [szakterulet] varchar(255) Null
                                             )

    SET @sql = '
INSERT INTO [#ttmsk_kex_allasajanlatok] ( [msk_kex_allasajanlatokID], [targy], [szakterulet], [nev], [email], [telefonszam]
                                        , [berigeny], [ajanlo_nev], [datum], [honnanertesult], [cv_toborzo_megj]
                                        , [cv_vezeto_megj], [idceg], [idtoborzo1], [munkavegzes_helye]
                                        , [msk_kex_jelentkezokID], [idcv_toborzo], [idcv_vezeto] )
            SELECT [a].[msk_kex_allasajanlatokID]
                 , [a].[targy]
                 , [s].[Szakterulet] AS [szakterulet]
                 , [j].[nev]
                 , [j].[email]
                 , [j].[telefonszam]
                 , [j].[berigeny]
                 , [j].[ajanlo_nev]
                 , [j].[datum]
                 , [j].[honnanertesult]
                 , [j].[cv_toborzo_megj]
                 , [j].[cv_vezeto_megj]
                 , [a].[idceg]
                 , [a].[idtoborzo1]
                 , [a].[munkavegzes_helye]
                 , [j].[msk_kex_jelentkezokID]
                 , [j].[idcv_toborzo]
                 , [j].[idcv_vezeto]
            FROM [dbo].[msk_kex_allasajanlatok] [a]
                INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [a].[msk_kex_allasajanlatokID] = [j].[idallasajanlat]
                LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
                LEFT JOIN [dbo].[msk_tob_allashirdetesek] [h] ON [h].[msk_tob_allashirdetesekID] = [a].[msk_kex_allasajanlatokID]
                LEFT JOIN [dbo].[msk_tob_keresesikerelem] [k] ON [k].[msk_tob_keresesikerelemID] = [h].[Idkeresesikerelem]
                LEFT JOIN [dbo].[msk_tob_szakterulet] [s] ON [s].[Msk_tob_szakteruletID] = [k].[SzakteruletID]
            WHERE tj.JelentkezokID IS NULL AND ' + @WhereString


    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Jelentkezõk riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )

    SELECT [fs].[Idjelentkezo]
         , [fs].[Idfelvstatusz]
         , [fs].[Idelutasitasindok]
         , [fs].[Idvisszalepesindok]
         , [fs].[Deleted]
    INTO [#ttmsk_kex_felvstatusz]
    FROM [dbo].[msk_kex_AktualisFelveteliStatusz] [fs]
        INNER JOIN (
                       SELECT [MKF].[Idjelentkezo]
                            , MAX( [MKF].[Msk_kex_felvstatuszID] ) [Msk_kex_felvstatuszID]
                       FROM [#ttmsk_kex_allasajanlatok] [a]
                           INNER JOIN [dbo].[msk_kex_AktualisFelveteliStatusz] [MKF] ON [MKF].[Idjelentkezo] = [a].[msk_kex_jelentkezokID]
                       WHERE [MKF].[Idfelvstatusz] IN ( 6, 7, 8 ) AND [MKF].[Deleted] = 0
                       GROUP BY [MKF].[Idjelentkezo]
                   ) [a7] ON [a7].[Msk_kex_felvstatuszID] = [fs].[Msk_kex_felvstatuszID]

    SELECT [a].[msk_kex_allasajanlatokID]
		 , [a].[Szakterulet] AS [szakterulet]
         , [a].[targy]
         , [a].[nev]
         , [a].[email]
         , [a].[telefonszam]
         , [a].[berigeny]
         , [a].[ajanlo_nev]
         , [a].[datum]
         , [a].[honnanertesult]
         , ISNULL( [toborzoID].[LookupValue], 'Nincs értékelve' ) AS [toborzovelemenye]
         , [a].[cv_toborzo_megj]
         , ISNULL( [vezetoID].[LookupValue], 'Nincs értékelve' ) AS [vezetovelemenye]
         , [a].[cv_vezeto_megj]
         , ISNULL( [felvetelID].[LookupValue], 'Nincs kitöltve' ) AS [felvetelistatusz]
         , [a].[idceg]
         , [a].[idtoborzo1]
         , [p].[Name] AS [toborzo1nev]
         , [a].[munkavegzes_helye]
         , [ei].[nev] AS [elutasitasnev]
         , [vi].[nev] AS [visszalepesnev]
         , [a].[msk_kex_jelentkezokID]
    INTO [#ttJelentkezokRiport]
    FROM [#ttmsk_kex_allasajanlatok] [a]
        LEFT JOIN [#ttmsk_kex_felvstatusz] [f] ON [f].[Idjelentkezo] = [a].[msk_kex_jelentkezokID]
        LEFT JOIN [dbo].[msk_kex_visszalepesindokok] [vi] ON [vi].[msk_kex_visszalepesindokokID] = [f].[Idvisszalepesindok]
        LEFT JOIN [dbo].[msk_kex_elutasitasindokok] [ei] ON [ei].[msk_kex_elutasitasindokokID] = [f].[Idelutasitasindok]
        LEFT JOIN [dbo].[msk_kex_LookupList] [felvetelID] ON [f].[Idfelvstatusz] = [felvetelID].[LookupListID]
        LEFT JOIN [dbo].[People] [p] ON [a].[idtoborzo1] = [p].[PeopleID]
        LEFT JOIN [dbo].[msk_kex_LookupList] [toborzoID] ON [a].[idcv_toborzo] = [toborzoID].[LookupListID]
        LEFT JOIN [dbo].[msk_kex_LookupList] [vezetoID] ON [a].[idcv_vezeto] = [vezetoID].[LookupListID]
		LEFT JOIN [dbo].[msk_tob_allashirdetesek] [h] ON [h].[msk_tob_allashirdetesekID] = [a].[msk_kex_allasajanlatokID]
		LEFT JOIN [dbo].[msk_tob_keresesikerelem] [k] ON [k].[msk_tob_keresesikerelemID] = [h].[Idkeresesikerelem]
		LEFT JOIN [dbo].[msk_tob_szakterulet] [s] ON [s].[Msk_tob_szakteruletID] = [k].[SzakteruletID]

    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
         , ' + @FieldList
               + '
FROM [#ttJelentkezokRiport] 
 )

    SELECT *
    from FNetPagedSelect
    WHERE [Row] between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Elutasítási és visszalépési okok riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '[msk_kex_allasajanlatokID],[targy],[nev],[email],[telefonszam],[berigeny],[ajanlo_nev],format(datum,''yyyy.MM.dd'') as datum,[honnanertesult],[toborzovelemenye],[cv_toborzo_megj],[vezetovelemenye],[cv_vezeto_megj],[felvetelistatusz],[idceg],[idtoborzo1],[toborzo1nev],[munkavegzes_helye],[elutasitasnev],[visszalepesnev]'
DECLARE @WhereString VARCHAR(MAX) = '1=1 AND 
           (j.[datum] BETWEEN ''2022-01-01'' AND ''2022-12-01 23:59:59.999'')
         AND (a.[idceg]=N''941824'')  AND (a.[targy] LIKE N''%raktár%'')  AND (1 IN 
          (select 1) ) AND 
          ((a.idtoborzo1=353) ) 
         '
DECLARE @OrderByString VARCHAR(MAX) = '[msk_kex_allasajanlatokID]'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

EXECUTE [dbo].[msk_kex_sel_jelentkezokriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_kivalasztasifazisokriport.sql =====

/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-28
-- Description:	KEX - Kiválasztási fázisok riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_kivalasztasifazisokriport] @UserID INT
                                                             , @FieldList VARCHAR(MAX) = '*'
                                                             , @WhereString VARCHAR(MAX) = '1=1'
                                                             , @OrderByString VARCHAR(MAX) = '[jelentkezoNeve]'
                                                             , @PageNumber INT = 1
                                                             , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_jelentkezok]
    DROP TABLE IF EXISTS [#ttkivalasztasifazisok]

    CREATE TABLE [#ttmsk_kex_jelentkezok] (
                                              [msk_kex_jelentkezokID] INT NOT NULL
                                            , [jelentkezoNeve] VARCHAR(255) NULL
                                            , [pozicio] VARCHAR(255) NULL
                                            , [toborzo1name] VARCHAR(1000) NULL
                                            , [vallalatFilter] INTEGER NULL
                                            , [allasajanlatFilter] VARCHAR(255) NULL
                                            , [statuszolovezetoFilter] INTEGER NULL
                                            , [mjgyFilter] INTEGER NULL
                                            , [toborzo1Filter] INTEGER NULL
                                            , [toborzo2Filter] INTEGER NULL
                                            , [jel_datum] DATETIME2 NULL
                                          )

    SET @sql = '

INSERT INTO [#ttmsk_kex_jelentkezok] ( [msk_kex_jelentkezokID], [jelentkezoNeve], [pozicio], [toborzo1name]
                                     , [vallalatFilter], [allasajanlatFilter], [statuszolovezetoFilter], [mjgyFilter]
                                     , [toborzo1Filter], [toborzo2Filter], [jel_datum] )
SELECT [A1].[msk_kex_jelentkezokID]
     , [A1].[jelentkezoNeve]
     , [A1].[pozicio]
     , [A1].[toborzo1name]
     , [A1].[vallalatFilter]
     , [A1].[allasajanlatFilter]
     , [A1].[statuszolovezetoFilter]
     , [A1].[mjgyFilter]
     , [A1].[toborzo1Filter]
     , [A1].[toborzo2Filter]
     , [A1].[jel_datum]
FROM (
    SELECT [jel].[msk_kex_jelentkezokID]
         , [jel].[nev] AS [jelentkezoNeve]
         , [allas].[targy] AS [pozicio]
         , [p].[Name] AS [toborzo1name]
         , [allas].[idceg] AS [vallalatFilter]
         , [allas].[targy] AS [allasajanlatFilter]
         , [allas].[idvezeto] AS [statuszolovezetoFilter]
         , [allas].[msk_kex_allasajanlatokID] AS [mjgyFilter]
         , [allas].[idtoborzo1] AS [toborzo1Filter]
         , [allas].[idtoborzo2] AS [toborzo2Filter]
         , [jel].[datum] AS [jel_datum]
    FROM [dbo].[msk_kex_jelentkezok] [jel]
        inner JOIN [dbo].[msk_kex_allasajanlatok] [allas] ON [jel].[idallasajanlat] = [allas].[msk_kex_allasajanlatokID]
        left JOIN [dbo].[People] [p] ON [p].[PeopleID] = [allas].[idtoborzo1]
		LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=jel.msk_kex_jelentkezokID 
	WHERE tj.JelentkezokID IS NULL
    ) A1
    WHERE ' + @WhereString

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Kiválasztási fázisok riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    EXEC [dbo].[msk_Print_Text] @sql

    EXEC ( @sql )

    SELECT [jel].[msk_kex_jelentkezokID]
         , [jel].[jelentkezoNeve]
         , [jel].[pozicio]
         , [jel].[toborzo1name]
         , 'Interjú' AS [fazis]
         , [inte].[datum] AS [datum]
         , [look].[LookupValue] AS [interjunMegjelent]
         , [look2].[LookupValue] AS [interjuEredmenye]
         , [inte].[megjegyzes] AS [interjuMegjegyzes]
         , NULL AS [tesztTipusa]
         , NULL AS [tesztetMegirta]
         , NULL AS [tesztEredmenye]
         , NULL AS [tesztMegjegyzes]
         , NULL AS [orvosiTipusa]
         , NULL AS [orvositMegkezdte]
         , NULL AS [orvosinMegfelelt]
         , NULL AS [igenylesdatuma]
         , NULL AS [kiallitasdatuma]
         , [jel].[vallalatFilter]
         , [jel].[allasajanlatFilter]
         , [jel].[statuszolovezetoFilter]
         , [jel].[mjgyFilter]
         , [jel].[toborzo1Filter]
         , [jel].[toborzo2Filter]
         , [jel].[jel_datum]
    INTO [#ttkivalasztasifazisok]
    FROM [dbo].[msk_kex_interju] [inte]
        INNER JOIN [#ttmsk_kex_jelentkezok] [jel] ON [inte].[idjelentkezo] = [jel].[msk_kex_jelentkezokID]
        LEFT JOIN [dbo].[msk_kex_LookupList] [look] ON [look].[LookupListID] = [inte].[idmegjelent]
        LEFT JOIN [dbo].[msk_kex_LookupList] [look2] ON [look2].[LookupListID] = [inte].[ideredmeny]
    WHERE ( [inte].[Deleted] = 0 )
    UNION
    SELECT [jel].[msk_kex_jelentkezokID]
         , [jel].[jelentkezoNeve]
         , [jel].[pozicio]
         , [jel].[toborzo1name]
         , 'Teszt' AS [fazis]
         , [teszt].[datum] AS [datum]
         , NULL AS [interjunMegjelent]
         , NULL AS [interjuEredmenye]
         , NULL AS [interjuMegjegyzes]
         , [tesztt].[nev] AS [tesztTipusa]
         , [look].[LookupValue] AS [tesztMegirta]
         , [look2].[LookupValue] AS [tesztEredmenye]
         , [teszt].[megjegyzes] AS [tesztMegjegyzes]
         , NULL AS [orvosiTipusa]
         , NULL AS [orvositMegkezdte]
         , NULL AS [orvosinMegfelelt]
         , NULL AS [igenylesdatuma]
         , NULL AS [kiallitasdatuma]
         , [jel].[vallalatFilter]
         , [jel].[allasajanlatFilter]
         , [jel].[statuszolovezetoFilter]
         , [jel].[mjgyFilter]
         , [jel].[toborzo1Filter]
         , [jel].[toborzo2Filter]
         , [jel].[jel_datum]
    FROM [dbo].[msk_kex_teszt] [teszt]
        INNER JOIN [#ttmsk_kex_jelentkezok] [jel] ON [teszt].[idjelentkezo] = [jel].[msk_kex_jelentkezokID]
        LEFT JOIN [dbo].[msk_kex_teszttipusok] [tesztt] ON [tesztt].[msk_kex_teszttipusokID] = [teszt].[idteszttipus]
        LEFT JOIN [dbo].[msk_kex_LookupList] [look] ON [look].[LookupListID] = [teszt].[idmegirta]
        LEFT JOIN [dbo].[msk_kex_LookupList] [look2] ON [look2].[LookupListID] = [teszt].[ideredmeny]
    WHERE ( [teszt].[Deleted] = 0 )
    UNION
    SELECT [jel].[msk_kex_jelentkezokID]
         , [jel].[jelentkezoNeve]
         , [jel].[pozicio]
         , [jel].[toborzo1name]
         , 'Orvosi' AS [fazis]
         , [orv].[datum] AS [datum]
         , NULL AS [interjunMegjelent]
         , NULL AS [interjuEredmenye]
         , NULL AS [interjuMegjegyzes]
         , NULL AS [tesztTipusa]
         , NULL AS [tesztMegirta]
         , NULL AS [tesztEredmenye]
         , NULL AS [tesztMegjegyzes]
         , [orvt].[nev] AS [orvosiTipusa]
         , [look].[LookupValue] AS [orvositMegkezdte]
         , [look2].[LookupValue] AS [orvosinMegfelelt]
         , [igenylesdatuma] AS [igenylesdatuma]
         , [kiallitasdatuma] AS [kiallitasdatuma]
         , [jel].[vallalatFilter]
         , [jel].[allasajanlatFilter]
         , [jel].[statuszolovezetoFilter]
         , [jel].[mjgyFilter]
         , [jel].[toborzo1Filter]
         , [jel].[toborzo2Filter]
         , [jel].[jel_datum]
    FROM [dbo].[msk_kex_orvosi] [orv]
        INNER JOIN [#ttmsk_kex_jelentkezok] [jel] ON [orv].[idjelentkezo] = [jel].[msk_kex_jelentkezokID]
        LEFT JOIN [dbo].[msk_kex_orvositipusok] [orvt] ON [orvt].[msk_kex_orvositipusokID] = [orv].[idorvositipus]
        LEFT JOIN [dbo].[msk_kex_LookupList] [look] ON [look].[LookupListID] = [orv].[idelkezdte]
        LEFT JOIN [dbo].[msk_kex_LookupList] [look2] ON [look2].[LookupListID] = [orv].[ideredmeny]
    WHERE ( [orv].[Deleted] = 0 )

    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
        , ' + @FieldList
               + '
    FROM #ttkivalasztasifazisok
    
)

    SELECT * 
    from FNetPagedSelect
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Kiválasztási fázisok riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '[msk_kex_jelentkezokID],[jelentkezoNeve],[pozicio],[toborzo1name],[fazis],format(datum,''yyyy.MM.dd'') as datum,[interjunMegjelent],[interjuEredmenye],[interjuMegjegyzes],[tesztTipusa],[tesztetMegirta],[tesztEredmenye],[tesztMegjegyzes],[orvosiTipusa],[orvositMegkezdte],[orvosinMegfelelt],[vallalatFilter],[allasajanlatFilter],[mjgyFilter],[statuszoloVezetoFilter],[toborzo1Filter],[toborzo2Filter],[jel_datum]'
DECLARE @WhereString VARCHAR(MAX) = '1 = 1 AND ( [jel_datum] BETWEEN ''2022-01-01'' AND ''2022-12-31 23:59:59.999'' )
                               AND ( [vallalatFilter] = N''941824'' ) AND ( [allasajanlatFilter] LIKE N''%Raktár%'' )
                               AND ( [mjgyFilter] IN (
                                                         SELECT [Idallasajanlat]
                                                         FROM [msk_kex_allasajanlat_vezetok]
                                                         WHERE [Idvezeto] = 809 AND [Mjgy] = 10
                                                     )
                                   ) AND ( [statuszolovezetoFilter] = N''52835'' ) AND ( 1 IN ( SELECT 1 ))
                               AND (( [toborzo1Filter] = 353 ) OR ( [toborzo2Filter] = 353 )) 
                               '
DECLARE @OrderByString VARCHAR(MAX) = '[jelentkezoNeve]'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

EXECUTE [dbo].[msk_kex_sel_kivalasztasifazisokriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_kpiszkriport.sql =====

/*
-- =============================================
-- Autorh:		Tóth László
-- Create date: 2022-11-28
-- Description:	KEX - KPI SZK riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_kpiszkriport] @UserID INT
                                                         , @FieldList VARCHAR(MAX) = '*'
                                                         , @WhereString VARCHAR(MAX) = '1=1'
                                                         , @OrderByString VARCHAR(MAX) = '[engedely_iktatoszama]'
                                                         , @PageNumber INT = 1
                                                         , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatok]
    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatokLezaras]
    DROP TABLE IF EXISTS [#ttFotevkorVezetok]
    DROP TABLE IF EXISTS [#ttKPISZKRiport]

    SELECT [a].[msk_kex_allasajanlatokID]
         , (
               SELECT STUFF(
                      (
                          SELECT ', ' + [p].[Name]
                          FROM [dbo].[msk_kex_allasajanlat_vezetok] [av]
                              LEFT JOIN [dbo].[People] [p] ON [p].[PeopleID] = [av].[Idvezeto]
                          WHERE [av].[Deleted] = 0 AND [av].[Idallasajanlat] = [a].[msk_kex_allasajanlatokID]
                                AND [av].[Mjgy] = 10
                          ORDER BY [p].[Name]
                          FOR XML PATH( '' )
                      ), 1, 1, ''
                           )
           ) AS [Name]
    INTO [#ttFotevkorVezetok]
    FROM [dbo].[msk_kex_allasajanlatok] [a]

    --WHERE [a].[msk_kex_allasajanlatokID] = 60010014
    CREATE TABLE [#ttmsk_kex_allasajanlatok] (
                                                 [msk_kex_allasajanlatokID] INTEGER NOT NULL
                                               , [engedely_iktatoszama] VARCHAR(255) NULL
                                               , [engedely_datuma] DATE NULL
                                               , [targy] VARCHAR(255) NULL
                                               , [poziciok_szama] INTEGER NULL
                                               , [reszleg] VARCHAR(255) NULL
                                               , [idtoborzo1] INTEGER NULL
                                               , [Idlezarasindok] INTEGER NULL
                                               , [datum_lezaras] DATE NULL
                                               , [datum_lejarat] DATE NULL
                                               , [Deleted] TINYINT NULL
                                               , [Name] VARCHAR(1000) NULL
                                               , [ajanlattetel_datum] DATE NULL
                                               , [idceg] INTEGER NULL
                                               , [nev] VARCHAR(255) NULL
                                               , [Idvezeto_neve] VARCHAR(1000) NULL
                                             )

    SET @sql = '
INSERT INTO [#ttmsk_kex_allasajanlatok] ( [msk_kex_allasajanlatokID], [engedely_iktatoszama], [engedely_datuma]
                                        , [targy], [poziciok_szama], [reszleg], [idtoborzo1], [Idlezarasindok]
                                        , [datum_lezaras], [datum_lejarat], [Deleted], [Name], [ajanlattetel_datum]
                                        , [idceg], [nev], [Idvezeto_neve] )
            SELECT [A1].[msk_kex_allasajanlatokID]
                 , [A1].[engedely_iktatoszama]
                 , [A1].[engedely_datuma]
                 , [A1].[targy]
                 , [A1].[poziciok_szama]
                 , [A1].[reszleg]
                 , [A1].[idtoborzo1]
                 , [A1].[Idlezarasindok]
                 , [A1].[datum_lezaras]
                 , [A1].[datum_lejarat]
                 , [A1].[Deleted]
                 , [A1].[Name]
                 , [A1].[ajanlattetel_datum]
                 , [A1].[idceg]
                 , [A1].[nev]
                 , [A1].[Idvezeto_neve]
            FROM (
                     SELECT [a].[msk_kex_allasajanlatokID] AS [msk_kex_allasajanlatokID]
                          , [a].[engedely_iktatoszama] AS [engedely_iktatoszama]
                          , [a].[engedely_datuma] AS [engedely_datuma]
                          , [a].[targy] AS [targy]
                          , [a].[poziciok_szama] AS [poziciok_szama]
                          , [a].[reszleg] AS [reszleg]
                          , [a].[idtoborzo1] AS [idtoborzo1]
                          , [a].[Idlezarasindok]
                          , [a].[datum_lezaras]
                          , [a].[datum_lejarat]
                          , [a].[Deleted]
                          , [p].[Name] AS [Name]
                          , [aj].[datum] AS [ajanlattetel_datum]
                          , [a].[idceg] AS [idceg]
                          , [j].[nev]
                          , [TFV].[Name] AS [Idvezeto_neve]
                     FROM [dbo].[msk_kex_allasajanlatok] [a]
                         INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [j].[idallasajanlat] = [a].[msk_kex_allasajanlatokID]
                         LEFT JOIN [dbo].[msk_kex_ajanlat] [aj] ON [aj].[idjelentkezo] = [j].[msk_kex_jelentkezokID]
                         LEFT JOIN [dbo].[People] [p] ON [p].[PeopleID] = [a].[idtoborzo1]
                         LEFT JOIN [#ttFotevkorVezetok] [TFV] ON [TFV].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
						 LEFT JOIN dbo.msk_kex_teszt_jelentkezok tj ON tj.JelentkezokID=j.msk_kex_jelentkezokID
						 WHERE tj.JelentkezokID IS NULL
						 --WHERE [aj].[datum] IS NOT NULL
                 ) [A1]
            WHERE ' + @WhereString

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - KPI SZK riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )

    SELECT [a].[msk_kex_allasajanlatokID]
         , [a].[datum_lezaras]
    INTO [#ttmsk_kex_allasajanlatokLezaras]
    FROM [#ttmsk_kex_allasajanlatok] [a]
        INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [a].[Idlezarasindok]
    WHERE [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%' OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'

    SELECT DISTINCT [a].[msk_kex_allasajanlatokID]
                  , [a].[engedely_iktatoszama]
                  , [a].[engedely_datuma]
                  , [a].[targy]
                  , [a].[poziciok_szama]
                  , [a].[reszleg]
                  , [a].[idtoborzo1]
                  , [a].[Name]
                  , CASE
                         WHEN [a].[Deleted] = 1 THEN 'Lezárt'
                         WHEN CAST(GETDATE() AS DATE) > CAST([a].[datum_lejarat] AS DATE) THEN 'Kiválasztás'
                         WHEN CAST(GETDATE() AS DATE) <= CAST([a].[datum_lejarat] AS DATE) THEN 'Toborzás'
                         ELSE NULL
                    END AS [statusz]
                  --, (
                  --      SELECT CASE
                  --                  WHEN [Deleted] = 1 THEN 'Lezárt'
                  --                  WHEN CAST(GETDATE() AS DATE) > CAST([datum_lejarat] AS DATE) THEN 'Kiválasztás'
                  --                  WHEN CAST(GETDATE() AS DATE) <= CAST([datum_lejarat] AS DATE) THEN 'Toborzás'
                  --             END
                  --      FROM [dbo].[msk_kex_allasajanlatok]
                  --      WHERE [msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                  --  ) AS [statusz]
                  , [a].[ajanlattetel_datum]
                  --, (
                  --      SELECT CASE
                  --                  WHEN EXISTS (
                  --                                  SELECT *
                  --                                  FROM [dbo].[msk_kex_allasajanlatok] [aa]
                  --                                      INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [aa].[Idlezarasindok]
                  --                                  WHERE [aa].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                  --                                        AND (
                  --                                                [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%'
                  --                                                OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'
                  --                                            )
                  --                              ) THEN
                  --                  (
                  --                      SELECT [aa].[datum_lezaras]
                  --                      FROM [dbo].[msk_kex_allasajanlatok] [aa]
                  --                          INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [aa].[Idlezarasindok]
                  --                      WHERE [aa].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                  --                            AND (
                  --                                    [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%'
                  --                                    OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'
                  --                                )
                  --                  )
                  --                  ELSE NULL
                  --             END
                  --      FROM [dbo].[msk_kex_allasajanlatok]
                  --      WHERE [msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                  --  ) AS [lezaras_datum]
                  , [TKAL].[datum_lezaras] AS [lezaras_datum]
                  , [a].[idceg]
                  , [a].[Idvezeto_neve]
                  , [a].[nev]
    INTO [#ttKPISZKRiport]
    FROM [#ttmsk_kex_allasajanlatok] [a]
        LEFT JOIN [#ttmsk_kex_allasajanlatokLezaras] [TKAL] ON [TKAL].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]

    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
        , ' + @FieldList
               + '
    FROM [#ttKPISZKRiport]
    
)

    SELECT * 
    from [FNetPagedSelect]
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - KPI SZK riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '[msk_kex_allasajanlatokID],[engedely_iktatoszama],format([engedely_datuma],''yyyy.MM.dd'') as [engedely_datuma],[targy],[poziciok_szama],[reszleg],[Name],[statusz],format([ajanlattetel_datum],''yyyy.MM.dd'') as [ajanlattetel_datum],format([lezaras_datum],''yyyy.MM.dd'') as [lezaras_datum],[Idvezeto_neve],[nev]'
DECLARE @WhereString VARCHAR(MAX) = '1 = 1 AND ( [idceg] = N''941824'' )
                  AND ( [ajanlattetel_datum] BETWEEN ''2022-01-01'' AND ''2022-11-29 23:59:59.999'' )
                  AND ( [targy] LIKE N''%adatb%'' ) AND ( [Idvezeto_neve] LIKE N''%Kocziszky Szabolcs%'' )
                  AND ( [idtoborzo1] = N''353'' ) 
                               '
DECLARE @OrderByString VARCHAR(MAX) = '[engedely_iktatoszama]'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

SET @WhereString = '1=1'
EXECUTE [dbo].[msk_kex_sel_kpiszkriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

Régi kód: nézetbõl átvéve

    SELECT DISTINCT [a].[msk_kex_allasajanlatokID] AS [msk_kex_allasajanlatokID]
                  , [a].[engedely_iktatoszama] AS [engedely_iktatoszama]
                  , [a].[engedely_datuma] AS [engedely_datuma]
                  , [a].[targy] AS [targy]
                  , [a].[poziciok_szama] AS [poziciok_szama]
                  , [a].[reszleg] AS [reszleg]
                  , [a].[idtoborzo1] AS [idtoborzo1]
                  , [p].[Name] AS [Name]
                  , (
                        SELECT CASE
                                    WHEN [Deleted] = 1 THEN 'Lezárt'
                                    WHEN CAST(GETDATE() AS DATE) > CAST([datum_lejarat] AS DATE) THEN 'Kiválasztás'
                                    WHEN CAST(GETDATE() AS DATE) <= CAST([datum_lejarat] AS DATE) THEN 'Toborzás'
                               END
                        FROM [dbo].[msk_kex_allasajanlatok]
                        WHERE [msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                    ) AS [statusz]
                  , [aj].[datum] AS [ajanlattetel_datum]
                  , (
                        SELECT CASE
                                    WHEN EXISTS (
                                                    SELECT *
                                                    FROM [dbo].[msk_kex_allasajanlatok] [aa]
                                                        INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [aa].[Idlezarasindok]
                                                    WHERE [aa].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                                                          AND (
                                                                  [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%'
                                                                  OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'
                                                              )
                                                ) THEN
                                    (
                                        SELECT [aa].[datum_lezaras]
                                        FROM [dbo].[msk_kex_allasajanlatok] [aa]
                                            INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [aa].[Idlezarasindok]
                                        WHERE [aa].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                                              AND (
                                                      [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%'
                                                      OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'
                                                  )
                                    )
                                    ELSE NULL
                               END
                        FROM [dbo].[msk_kex_allasajanlatok]
                        WHERE [msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                    ) AS [lezaras_datum]
                  , [a].[idceg] AS [idceg]
                  , [dbo].[msk_kex_get_MJGYNeve]( [a].[msk_kex_allasajanlatokID] ) AS [Idvezeto_neve]
                  , [j].[nev]
    FROM [dbo].[msk_kex_allasajanlatok] [a]
        LEFT JOIN [dbo].[People] [p] ON [p].[PeopleID] = [a].[idtoborzo1]
        LEFT JOIN [dbo].[msk_kex_jelentkezok] [j] ON [j].[idallasajanlat] = [a].[msk_kex_allasajanlatokID]
        LEFT JOIN [dbo].[msk_kex_ajanlat] [aj] ON [aj].[idjelentkezo] = [j].[msk_kex_jelentkezokID]
    --LEFT JOIN dbo.msk_kex_allasajanlat_vezetok v ON a.msk_kex_allasajanlatokID = v.Idallasajanlat
    WHERE [aj].[datum] IS NOT NULL --AND v.Deleted = 0 AND v.Mjgy = 10
    UNION ALL
    SELECT DISTINCT [a].[msk_kex_allasajanlatokID]
                  , [a].[engedely_iktatoszama]
                  , [a].[engedely_datuma]
                  , [a].[targy]
                  , [a].[poziciok_szama]
                  , [a].[reszleg]
                  , [a].[idtoborzo1] AS [idtoborzo1]
                  , [p].[Name]
                  , (
                        SELECT CASE
                                    WHEN [Deleted] = 1 THEN 'Lezárt'
                                    WHEN CAST(GETDATE() AS DATE) > CAST([datum_lejarat] AS DATE) THEN 'Kiválasztás'
                                    WHEN CAST(GETDATE() AS DATE) <= CAST([datum_lejarat] AS DATE) THEN 'Toborzás'
                               END
                        FROM [dbo].[msk_kex_allasajanlatok]
                        WHERE [msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                    ) AS [statusz]
                  , [aj].[datum] AS [ajanlattetel_datum]
                  , (
                        SELECT CASE
                                    WHEN EXISTS (
                                                    SELECT *
                                                    FROM [dbo].[msk_kex_allasajanlatok] [aa]
                                                        INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [aa].[Idlezarasindok]
                                                    WHERE [aa].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                                                          AND (
                                                                  [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%'
                                                                  OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'
                                                              )
                                                ) THEN
                                    (
                                        SELECT [aa].[datum_lezaras]
                                        FROM [dbo].[msk_kex_allasajanlatok] [aa]
                                            INNER JOIN [dbo].[msk_kex_lezarasindokok] [ll] ON [ll].[Msk_kex_lezarasindokokID] = [aa].[Idlezarasindok]
                                        WHERE [aa].[msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                                              AND (
                                                      [ll].[Indokok] LIKE '%em volt megfelelõ jelölt%'
                                                      OR [ll].[Indokok] LIKE '%pozíció visszavonásra került%'
                                                  )
                                    )
                                    ELSE NULL
                               END
                        FROM [dbo].[msk_kex_allasajanlatok]
                        WHERE [msk_kex_allasajanlatokID] = [a].[msk_kex_allasajanlatokID]
                    ) AS [lezaras_datum]
                  , [a].[idceg]
                  , [dbo].[msk_kex_get_MJGYNeve]( [a].[msk_kex_allasajanlatokID] ) AS [Idvezeto_neve]
                  , [j].[nev]
    FROM [dbo].[msk_kex_allasajanlatok] [a]
        LEFT JOIN [dbo].[People] [p] ON [p].[PeopleID] = [a].[idtoborzo1]
        LEFT JOIN [dbo].[msk_kex_jelentkezok] [j] ON [j].[idallasajanlat] = [a].[msk_kex_allasajanlatokID]
        LEFT JOIN [dbo].[msk_kex_ajanlat] [aj] ON [aj].[idjelentkezo] = [j].[msk_kex_jelentkezokID]
    --LEFT JOIN dbo.msk_kex_allasajanlat_vezetok v ON a.msk_kex_allasajanlatokID =v.Idallasajanlat
    WHERE [aj].[datum] IS NULL
          AND [a].[msk_kex_allasajanlatokID] NOT IN (
                                                        SELECT [aa].[msk_kex_allasajanlatokID]
                                                        FROM [dbo].[msk_kex_allasajanlatok] [aa]
                                                            LEFT JOIN [dbo].[People] [p] ON [p].[PeopleID] = [aa].[idtoborzo1]
                                                            LEFT JOIN [dbo].[msk_kex_jelentkezok] [j] ON [j].[idallasajanlat] = [aa].[msk_kex_allasajanlatokID]
                                                            LEFT JOIN [dbo].[msk_kex_ajanlat] [aj] ON [aj].[idjelentkezo] = [j].[msk_kex_jelentkezokID]
                                                        WHERE [aj].[datum] IS NOT NULL
                                                    )


*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_lezarthirdetesekriport.sql =====


/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-24
-- Description:	KEX - Lezárt hírdetések riport
-- =============================================
Módosítás:
    - 2022.12.01 Tóth László
        - Performancia javítás
        - [dbo].[msk_kex_allashirdetesHossz]() fv. még problémát okoz!!!
*/
CREATE PROCEDURE [dbo].[msk_kex_sel_lezarthirdetesekriport] @UserID INT
                                                                   , @FieldList VARCHAR(MAX) = '*'
                                                                   , @WhereString VARCHAR(MAX) = '1=1'
                                                                   , @OrderByString VARCHAR(MAX) = ''
                                                                   , @PageNumber INT = 1
                                                                   , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    DROP TABLE IF EXISTS [#ttmsk_kex_allasajanlatok]
    DROP TABLE IF EXISTS [#ttlezarthirdetesekriport]

    CREATE TABLE [#ttmsk_kex_allasajanlatok] (
                                                 [msk_kex_allasajanlatokID] INTEGER NOT NULL
                                               , [uzletag] VARCHAR(100) NULL
                                               , [reszleg] VARCHAR(255) NULL
                                               , [targy] VARCHAR(255) NULL
                                               , [munkavegzes_helye] VARCHAR(255) NULL
                                               , [datum_lejarat] DATE NULL
                                               , [toborzo_info] VARCHAR(MAX) NULL
                                               , [idmunkaltato] INTEGER NULL
                                               , [idvezeto] INTEGER NULL
                                               , [idtoborzo1] INTEGER NULL
                                               , [idtoborzo2] INTEGER NULL
                                               , [idceg] INTEGER NULL
                                               , [Indokok] VARCHAR(4000) NULL
                                               , [datum_lezaras] DATE NULL
                                               , [link] VARCHAR(2000) NULL
                                             )

    SET @sql = '
INSERT INTO [#ttmsk_kex_allasajanlatok] ( [msk_kex_allasajanlatokID], [uzletag], [reszleg], [targy]
                                        , [munkavegzes_helye], [datum_lejarat], [toborzo_info], [idmunkaltato]
                                        , [idvezeto], [idtoborzo1], [idtoborzo2], [idceg], [Indokok], [datum_lezaras]
                                        , [link] )
            SELECT [A].[msk_kex_allasajanlatokID]
                 , [A].[uzletag]
                 , [A].[reszleg]
                 , [A].[targy]
                 , [A].[munkavegzes_helye]
                 , [A].[datum_lejarat]
                 , [A].[toborzo_info]
                 , [A].[idmunkaltato]
                 , [A].[idvezeto]
                 , [A].[idtoborzo1]
                 , [A].[idtoborzo2]
                 , [A].[idceg]
                 , [MKL].[Indokok]
                 , [A].[datum_lezaras]
                 , [A].[link]
            FROM [dbo].[msk_kex_allasajanlatok] [A]
                LEFT OUTER JOIN [dbo].[msk_kex_lezarasindokok] [MKL] ON [A].[Idlezarasindok] = [MKL].[Msk_kex_lezarasindokokID]
WHERE ' + @WhereString

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Lezárt hírdetések riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )

    -- A riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ' + @FieldList
               + '
FROM [#ttmsk_kex_allasajanlatok] [a]
    CROSS APPLY [dbo].[msk_kex_allashirdetesHossz]( [a].[msk_kex_allasajanlatokID] ) [h]
    LEFT JOIN [dbo].[msk_kex_jelentkezok] [j] ON [j].[idallasajanlat] = [a].[msk_kex_allasajanlatokID]
WHERE [h].[AdvertID] = [a].[msk_kex_allasajanlatokID] AND [a].[datum_lezaras] IS NOT NULL
GROUP BY [a].[msk_kex_allasajanlatokID]
       , [a].[targy]
       , [h].[hossz]
       , [h].[korrigalthossz]
       , [a].[Indokok]
 
 )

 SELECT *
 FROM (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
         , *
    from FNetPagedSelect a
    ) A1
    WHERE [Row] between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and ' + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20))
               + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 2. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Lezárt hírdetések riport (SQL 2. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = 'a.[msk_kex_allasajanlatokID],a.[targy],h.[hossz],h.[korrigalthossz],a.[indokok],count(j.msk_kex_jelentkezokID) as fo'
DECLARE @WhereString VARCHAR(MAX) = ' 1 = 1
      AND ( [a].[datum_lezaras] BETWEEN ''2022-01-01'' AND ''2022-12-01 23:59:59.999'' ) AND ( [a].[idceg] = N''941824'' )
      AND ( [a].[reszleg] LIKE N''%adat%'' ) AND ( [a].[targy] LIKE N''%raktár%'' )
      AND ( [a].[munkavegzes_helye] LIKE N''%budapest%'' )
      AND ( [a].[msk_kex_allasajanlatokID] IN (
                                                  SELECT [MKAV].[Idallasajanlat]
                                                  FROM [dbo].[msk_kex_allasajanlat_vezetok] [MKAV]
                                                  WHERE [MKAV].[Idvezeto] = 809 AND [MKAV].[Mjgy] = 10
                                              )
          ) AND ( [a].[idvezeto] = N''809'' ) AND ( 1 IN ( SELECT 1 )) AND (( [a].[idtoborzo1] = 353 )) 
         '
DECLARE @OrderByString VARCHAR(MAX) = 'a.[msk_kex_allasajanlatokID]'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

EXECUTE [dbo].[msk_kex_sel_lezarthirdetesekriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/
GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_mapriport.sql =====


/*
-- =============================================
-- Author:		Tóth László
-- Create date: 2022-11-24
-- Description:	KEX - MAP riport
-- =============================================
Módosítás:

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_mapriport] @UserID INT
                                            , @FieldList VARCHAR(MAX) = '*'
                                            , @WhereString VARCHAR(MAX) = '1=1'
                                            , @OrderByString VARCHAR(MAX) = '[hp_nev]'
                                            , @PageNumber INT = 1
                                            , @RowsPerPage INT = 100
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

    -- Az map riport elõállítása a @WhereString1 alapján
    SET @sql = '
;WITH [FNetPagedSelect] AS (
    SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
        , ' + @FieldList + '
    FROM dbo.[msk_kex_map_riport] WITH ( NOLOCK )
    WHERE ' + @WhereString + '
)

    SELECT * 
    from FNetPagedSelect
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '

    --A futatott dinamikus SQL 1. részének logolása
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - MAP riport (SQL 1. rész)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    --EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = '[idallasajanlat], FORMAT( [datum], ''yyyy.MM.dd'' ) AS [datum], [hp_nev], [ajanlo_nev], [targy], [nev], [felveve], FORMAT( [ujfelveteldatum], ''yyyy.MM.dd'' ) AS [ujfelveteldatum], [idceg], [reszleg], [munkavegzes_helye], [idvezeto], [idtoborzo1], [idtoborzo2], [toborzo_name1], [toborzo_name2], [map_dokumentacionev], FORMAT( [map_beerkezes], ''yyyy.MM.dd'' ) AS [map_beerkezes]'
DECLARE @WhereString VARCHAR(MAX) = '1=1 AND 
           ([datum] BETWEEN ''2022-01-01'' AND ''2022-11-24 23:59:59.999'')
         AND ([idceg]=N''941824'')  AND ([reszleg] LIKE N''%sdsd%'')  AND ([munkavegzes_helye] LIKE N''%budap%'')  AND ([idallasajanlat] IN 
          (SELECT Idallasajanlat FROM msk_kex_allasajanlat_vezetok WHERE Idvezeto = 1499 AND Mjgy = 10)
        )  AND ([idvezeto]=N''3672'')  AND (1 IN 
          (select 1) ) AND 
          ((idtoborzo1=830) )'
DECLARE @OrderByString VARCHAR(MAX) = '[hp_nev]'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

EXECUTE [dbo].[msk_kex_sel_mapriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

*/
GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_orvosiriport.sql =====

CREATE PROCEDURE [dbo].[msk_kex_sel_orvosiriport] 

@UserID INT
, @FieldList VARCHAR(MAX) = '*'
, @WhereString VARCHAR(MAX) = '1=1'
, @OrderByString VARCHAR(MAX) = ''
, @PageNumber INT = 1
, @RowsPerPage INT = 100

AS
BEGIN
    SET NOCOUNT ON
	SET DATEFIRST 1

    DECLARE @sql VARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

	DECLARE @sSearch VARCHAR(20) = NULL
    DECLARE @ParamName NVARCHAR(255) = NULL
    DECLARE @Cut BIT = 1
    DECLARE @return_value2 NVARCHAR(MAX) = NULL
	DECLARE @iidceg INTEGER = NULL
	DECLARE @sPozicioNeve VARCHAR(100) = NULL
	DECLARE @iFelveteliStatusz INTEGER = NULL
	DECLARE @iOrvosiTipusa INTEGER = NULL

	DECLARE @sOrvosiKiallitasDatumaTol VARCHAR(50) = NULL -- stringet ad vissza
	DECLARE @dOrvosiKiallitasDatumaTol DATETIME = NULL -- típusegyezõség miatt
    DECLARE @sOrvosiKiallitasDatumaIg VARCHAR(50) = NULL
	DECLARE @dOrvosiKiallitasDatumaIg DATETIME = NULL
	DECLARE @bOrvosiKiallitasDatuma BIT = NULL

	DECLARE @sJelentkezesDatumTol VARCHAR(50) = NULL -- stringet ad vissza
	DECLARE @dJelentkezesDatumTol DATETIME = NULL -- típusegyezõség miatt
    DECLARE @sJelentkezesDatumIg VARCHAR(50) = NULL
	DECLARE @dJelentkezesDatumIg DATETIME = NULL
	DECLARE @bJelentkezesDatum BIT = NULL


	DROP TABLE IF EXISTS [#ttmsk_kex_orvosi_orv]
	DROP TABLE IF EXISTS [#ttmsk_kex_ajanlat_orv]
	DROP TABLE IF EXISTS [#ttmsk_kex_felvstatusz_orv]
	DROP TABLE IF EXISTS [#ttOrvosiRiport]


	--select 1/0

	SET @Cut = 1
    SET @ParamName = N'idceg'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iidceg OUTPUT
                                                       , @WhereString OUTPUT

	SET @sSearch = 'LIKE'
    SET @ParamName = N'PozicioNeve'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sPozicioNeve OUTPUT
                                                                         , @return_value2 OUTPUT
                                                                         , @WhereString OUTPUT
							

	SET @Cut = 1
    SET @ParamName = N'FelveteliStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iFelveteliStatusz OUTPUT
                                                       , @WhereString OUTPUT


	SET @Cut = 1
    SET @ParamName = N'OrvosiTipusa'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iOrvosiTipusa OUTPUT
                                                       , @WhereString OUTPUT

	
	SET @sSearch = 'BETWEEN'
    SET @ParamName = N'OrvosiKiallitasDatuma'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sOrvosiKiallitasDatumaTol OUTPUT
                                                                         , @sOrvosiKiallitasDatumaIg OUTPUT
                                                                         , @WhereString OUTPUT

    IF @sOrvosiKiallitasDatumaTol IS NOT NULL AND @sOrvosiKiallitasDatumaIg IS NOT NULL
    BEGIN
        SET @bOrvosiKiallitasDatuma = 1
    END

	SET @dOrvosiKiallitasDatumaTol = REPLACE( @sOrvosiKiallitasDatumaTol, '''', '' )
    SET @dOrvosiKiallitasDatumaIg = REPLACE( @sOrvosiKiallitasDatumaIg, '''', '' ) 


	SET @sSearch = 'BETWEEN'
    SET @ParamName = N'JelentkezesDatum'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sJelentkezesDatumTol OUTPUT
                                                                         , @sJelentkezesDatumIg OUTPUT
                                                                         , @WhereString OUTPUT

    IF @sJelentkezesDatumTol IS NOT NULL AND @sJelentkezesDatumIg IS NOT NULL
    BEGIN
        SET @bJelentkezesDatum = 1
    END

	SET @dJelentkezesDatumTol = REPLACE( @sJelentkezesDatumTol, '''', '' )
    SET @dJelentkezesDatumIg = REPLACE( @sJelentkezesDatumIg, '''', '' ) 

--alap lekérdezés
select 
orvosi.msk_kex_orvosiID AS msk_kex_orvosiID,
jelentkezo.datum AS JelentkezesDatum,
kexa.targy AS PozicioNeve,
kexa.munkavegzes_helye AS MunkavegzesHelye,
orvosi.igenylesdatuma AS OrvosiIgenylesDatuma,
orvosi.datum AS OrvosiVizsgDatuma,
orvositipusa.nev AS OrvosiTipusa,
orvosimegkezdese.LookupValue AS OrvositMegkezdte,
orvosimegfelelt.LookupValue AS OrvosinMegfelelt,
orvosi.kiallitasdatuma AS OrvosiKiallitasDatuma,
CASE 
    WHEN orvosi.kiallitasdatuma IS NULL AND orvosi.igenylesdatuma IS NULL THEN NULL -- Mindkét dátum hiányzik
	WHEN orvosi.kiallitasdatuma IS NULL THEN NULL									-- Ha csak a kiallitasdatuma hiányzik
    ELSE OMGMS_orv.ElteltNapokSzama + 1													-- Ha mindkét dátum meg van adva
END AS OrvosiIdotartama,
jelentkezo.nev AS JelentkezoNeve,
jelentkezo.msk_kex_jelentkezokID,
jelentkezo.idallasajanlat,
kexa.idceg as idceg,
kexa.idtoborzo1 as idtoborzo1,
kexa.msk_kex_allasajanlatokID
INTO [#ttmsk_kex_orvosi_orv]
FROM [dbo].[msk_kex_orvosi] AS orvosi
LEFT JOIN [dbo].[msk_kex_orvositipusok] AS orvositipusa ON orvositipusa.msk_kex_orvositipusokID = orvosi.idorvositipus AND orvositipusa.Deleted = 0
LEFT JOIN [dbo].[msk_kex_LookupList] AS orvosimegkezdese ON orvosi.idelkezdte = orvosimegkezdese.LookupListID AND orvosimegkezdese.GroupNum = 2 AND orvosimegkezdese.Deleted = 0
LEFT JOIN [dbo].[msk_kex_LookupList] AS orvosimegfelelt ON orvosi.ideredmeny = orvosimegfelelt.LookupListID AND orvosimegfelelt.GroupNum = 2 AND orvosimegfelelt.Deleted = 0
LEFT JOIN [dbo].[msk_kex_jelentkezok] AS jelentkezo ON orvosi.idjelentkezo = jelentkezo.msk_kex_jelentkezokID AND orvosi.Deleted = 0
LEFT JOIN [dbo].[msk_kex_allasajanlatok] AS kexa ON kexa.msk_kex_allasajanlatokID = jelentkezo.idallasajanlat AND kexa.Deleted != 2
OUTER APPLY (SELECT [dbo].[ofn_msk_getMunkanapokSzama](orvosi.igenylesdatuma, orvosi.kiallitasdatuma) AS ElteltNapokSzama) OMGMS_orv
where orvosi.Deleted = 0 AND 1=1 
						AND (
                        @iidceg IS NULL OR (  @iidceg IS NOT NULL AND kexa.idceg = @iidceg )
							)
						AND (
                        @iOrvosiTipusa IS NULL OR (  @iOrvosiTipusa IS NOT NULL AND orvositipusa.msk_kex_orvositipusokID = @iOrvosiTipusa )
							)
					   AND (
						@bOrvosiKiallitasDatuma IS NULL
						OR		(
                         @bOrvosiKiallitasDatuma IS NOT NULL AND orvosi.kiallitasdatuma BETWEEN @dOrvosiKiallitasDatumaTol AND @dOrvosiKiallitasDatumaIg
							)
						)
						AND (
						@bJelentkezesDatum IS NULL
						OR		(
                         @bJelentkezesDatum IS NOT NULL AND jelentkezo.datum BETWEEN @dJelentkezesDatumTol AND @dJelentkezesDatumIg
							)
						)
						AND (
						@sPozicioNeve IS NULL OR ( @sPozicioNeve IS NOT NULL AND kexa.targy LIKE @sPozicioNeve )
							)

	
					
					
SELECT 
A2.AjanlatadasDatuma,
A2.EngedelyDatuma,
A2.EngedelyIktatoszama,
A2.idjelentkezo,
A2.msk_kex_jelentkezokID,
A2.PozicioID, 
A2.RowNum
INTO [#ttmsk_kex_ajanlat_orv]
FROM(
SELECT ROW_NUMBER() OVER (PARTITION BY ttor.msk_kex_jelentkezokID ORDER BY ajanlat.datum ASC) AS RowNum,
		ttor.msk_kex_jelentkezokID,
		ajanlat.datum AS AjanlatadasDatuma,
		ajanlat.PozicioID,
		poz.Iktatoszam AS EngedelyIktatoszama,
		poz.Engedelyezesidatum as EngedelyDatuma,
		ajanlat.idjelentkezo
FROM [#ttmsk_kex_orvosi_orv] ttor
LEFT JOIN [dbo].[msk_kex_ajanlat] AS ajanlat ON ajanlat.idjelentkezo = ttor.msk_kex_jelentkezokID AND ajanlat.Deleted = 0
LEFT JOIN [msk_tob_pozicio] poz ON ajanlat.PozicioIDLast = poz.PozicioID AND poz.Deleted = 0
WHERE (ajanlat.Deleted != 2)
) A2
Where A2.RowNum = 1



SELECT 
A1.RowNum,
A1.msk_kex_jelentkezokID,
A1.LookupListID,
A1.FelveteliStatusz,
A1.ElutasitasIndoka,
A1.VisszalepesIndoka,
A1.BelepesDatum
INTO [#ttmsk_kex_felvstatusz_orv]
FROM(
select ROW_NUMBER() OVER (PARTITION BY ttor.msk_kex_jelentkezokID ORDER BY mkf.Msk_kex_felvstatuszID DESC) AS RowNum,
ttor.msk_kex_jelentkezokID,
felvetelistatusz.LookupValue AS FelveteliStatusz,
felvetelistatusz.LookupListID AS LookupListID,
elutasitasindok.nev AS ElutasitasIndoka,
visszalepesindok.nev AS VisszalepesIndoka,
mkf.Belepesdatum AS BelepesDatum
FROM [#ttmsk_kex_orvosi_orv] ttor
LEFT JOIN dbo.msk_kex_felvstatusz AS mkf ON mkf.idjelentkezo = ttor.msk_kex_jelentkezokID
LEFT JOIN [dbo].[msk_kex_LookupList] AS felvetelistatusz ON felvetelistatusz.LookupListID = mkf.Idfelvstatusz AND felvetelistatusz.Deleted = 0 AND felvetelistatusz.GroupNum = 3
LEFT JOIN [dbo].[msk_kex_elutasitasindokok] AS elutasitasindok ON mkf.Idelutasitasindok=elutasitasindok.msk_kex_elutasitasindokokID AND elutasitasindok.Deleted = 0
LEFT JOIN [dbo].[msk_kex_visszalepesindokok] AS visszalepesindok ON mkf.Idvisszalepesindok=visszalepesindok.msk_kex_visszalepesindokokID AND visszalepesindok.Deleted = 0
WHERE (mkf.Deleted != 2) 
) A1 
WHERE A1.RowNum = 1



	
select 
ttmko.msk_kex_orvosiID as msk_kex_orvosiID,
ttmko.JelentkezesDatum as JelentkezesDatum,
ttmka.EngedelyIktatoszama as EngedelyIktatoszama,
ttmka.EngedelyDatuma as EngedelyDatuma,
ttmko.PozicioNeve as PozicioNeve,
ttmko.MunkavegzesHelye as MunkavegzesHelye,
statuszolovezeto.Name AS MJGY,
Statuszolovezeto.PeopleID as PeopleID,
toborzo.Name AS ToborzoNeve,
ttmko.OrvosiIgenylesDatuma as OrvosiIgenylesDatuma,
ttmko.OrvosiVizsgDatuma as OrvosiVizsgDatuma,
ttmko.OrvosiTipusa as OrvosiTipusa,
ttmko.OrvositMegkezdte as OrvositMegkezdte,
ttmko.OrvosinMegfelelt as OrvosinMegfelelt,
ttmko.OrvosiKiallitasDatuma as OrvosiKiallitasDatuma,
ttmko.OrvosiIdotartama as OrvosiIdotartama,
ttmko.JelentkezoNeve as JelentkezoNeve,
ttmka.AjanlatadasDatuma as AjanlatadasDatuma,
ttmkf.FelveteliStatusz as FelveteliStatusz,
ttmkf.ElutasitasIndoka as ElutasitasIndoka,
ttmkf.VisszalepesIndoka as VisszalepesIndoka,
ttmkf.BelepesDatum as BelepesDatum,
ttmko.idceg as idceg,
ttmko.idtoborzo1 as idtoborzo1,
ttmkf.LookupListID,
ttmko.msk_kex_allasajanlatokID as msk_kex_allasajanlatokID,
s.Szakterulet as szakterulet
INTO [#ttOrvosiRiport]
from [#ttmsk_kex_orvosi_orv] ttmko
LEFT JOIN [#ttmsk_kex_ajanlat_orv] ttmka on ttmka.msk_kex_jelentkezokID = ttmko.msk_kex_jelentkezokID
LEFT JOIN [#ttmsk_kex_felvstatusz_orv] ttmkf on ttmkf.msk_kex_jelentkezokID = ttmko.msk_kex_jelentkezokID
LEFT JOIN [dbo].[msk_kex_allasajanlat_vezetok] AS kexav ON kexav.Idallasajanlat = ttmko.msk_kex_allasajanlatokID AND kexav.Deleted = 0 AND kexav.Statuszolovezeto = 1
LEFT JOIN [dbo].[People] AS statuszolovezeto ON statuszolovezeto.PeopleID = kexav.Idvezeto AND statuszolovezeto.Deleted = 0
LEFT JOIN [dbo].[People] AS toborzo ON toborzo.PeopleID = ttmko.idtoborzo1 AND toborzo.Deleted = 0
LEFT JOIN msk_tob_allashirdetesek h ON h.msk_tob_allashirdetesekID = ttmko.msk_kex_allasajanlatokID
LEFT JOIN msk_tob_keresesikerelem k ON k.msk_tob_keresesikerelemID = h.Idkeresesikerelem
LEFT JOIN msk_tob_szakterulet s ON s.Msk_tob_szakteruletID = k.SzakteruletID
WHERE 1=1  AND (
                @iFelveteliStatusz IS NULL OR (  @iFelveteliStatusz IS NOT NULL AND ttmkf.LookupListID = @iFelveteliStatusz )
			  )


	-- A @WhereString megszabadítása a fölösleges szövegektõl [START]
    EXEC [dbo].[msp_wrk_ReturnParamValueCleanFromWhereString] @WhereString, @WhereString OUTPUT
	

    SET @sql = '
		
			SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
			, ' + @FieldList + '
			INTO [#ttResultList] 
			FROM [#ttOrvosiRiport]
			WHERE 1=1 AND '  + @WhereString + '
		


    SELECT * 
    from [#ttResultList]
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '
	
    EXEC ( @sql )
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_osszefoglaloriport.sql =====

/*
-- =============================================
-- Author:		Najdanovszki KrisztiÃ¡n
-- Create date: 2020-05-07
-- Description:	KEX - Ã–sszefoglalÃ³ riport
-- =============================================
Módosítás:
    2022.11.23 Tóth László
        - Tárolt eljárás performancia javítása (+[dbo].[msk_kex_szum_osszefoglaloriport] fv. javítása)
        - Effectorban lapozhatóság javítása

*/
CREATE PROCEDURE [dbo].[msk_kex_sel_osszefoglaloriport] @UserID INT
                                                      , @FieldList VARCHAR(MAX) = '*'
                                                      , @WhereString VARCHAR(MAX) = '1=1'
                                                      , @OrderByString VARCHAR(MAX) = 'aj.uzletag'
                                                      , @PageNumber INT
                                                      , @RowsPerPage INT
AS
BEGIN
    SET NOCOUNT ON

    

    DECLARE @bDebug BIT = 0
    DECLARE @Tol VARCHAR(100) = '1900-01-01'
    DECLARE @Ig VARCHAR(100) = '2900-01-01'
    DECLARE @Tol_date DATETIME2 = '1900-01-01'
    DECLARE @Ig_date DATETIME2 = '2900-01-01'
    DECLARE @tolig VARCHAR(100) = ' ''1900-01-01'' , ''2900-01-01'''
    DECLARE @WhereString1 VARCHAR(100) = '1=1'
    DECLARE @IDVezetoSearchString VARCHAR(255) = ''

                DROP TABLE IF EXISTS [#ttszumosszefoglalo]

                CREATE TABLE [#ttszumosszefoglalo] (
                       [allasID] INT NOT NULL
                     , [jfo] INT NULL
                     , [CVmegfelelt] INT NULL
                     , [ifo] INT NULL
                     , [tfo] INT NULL
                     , [osszesinterju] INT NULL
                     , [ofo] INT NULL
                     , [oefo] INT NULL
                     , [omfo] INT NULL
                     , [offo] INT NULL
                     , [afo] INT NULL
                     , [adatum] DATE NULL
                     , [aefo] INT NULL
                     , [vfo] INT NULL
                     , [efo] INT NULL
                     , [kezdettfo] INT NULL
                   )

                INSERT INTO [#ttszumosszefoglalo] EXEC dbo.msp_kex_szum_osszefoglaloriport @AllasID = NULL,                 -- int
                                         @tol = @Tol_date, -- datetime
                                         @ig = @Ig_date   -- datetime

    -- Az av.[idvezeto] paraméter kiemelése a @WhereString-bõl 
    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , 'av.[idvezeto]'
                                                       , 1
                                                       , @IDVezetoSearchString OUTPUT
                                                       , @WhereString OUTPUT

    -- A @WhereString1 összeállítása
    IF ISNULL( @IDVezetoSearchString, '' ) <> ''
    BEGIN
        SET @WhereString1 = '1 = 1 AND av.[idvezeto]=N''' + @IDVezetoSearchString + ' '''
    END

    -- A @WhereString-bõl a [dbo].[msk_kex_szum_osszefoglaloriport] fv. hívásához a @Tol, @Ig meghatározása,
    -- valamint a @tolig beállítása
    IF CHARINDEX( '2=2', @WhereString ) > 0
    BEGIN
        BEGIN TRY
            SET @Tol = SUBSTRING( @WhereString, CHARINDEX( '2=2', @WhereString ) + 26, 10 )
            SET @Tol_date = @Tol
            SET @Ig = SUBSTRING( @WhereString, CHARINDEX( '2=2', @WhereString ) + 43, 19 )
            SET @Ig_date = @Ig
        END TRY
        BEGIN CATCH
            SET @Tol = '1900-01-01'
            SET @Ig = '2900-01-01'
        END CATCH

        SET @tolig = ' ''' + @Tol + ''' , ''' + @Ig + ''' '
    END

    -- SELECT @WhereString1, @IDVezetoSearchString, @WhereString
    -- Állásajánlatok leválogatásához temp tábla 

    DECLARE @sql VARCHAR(MAX) = ''

                BEGIN TRAN t01
                DROP TABLE IF EXISTS [##ttmsk_kex_allasajanlatok]

    -- Az állásajánlatok leválogatása ##ttmsk_kex_allasajanlatok temp táblába a kapott @WhereString alapján
    SET @sql = 'SELECT [aj].[msk_kex_allasajanlatokID]
                 , [aj].[engedely_iktatoszama] as iktatoszam
                 , IIF (aj.idlezarasindok > 0, ''Lezárt'', ''Folyamatban'') as statusz
                 , [aj].[engedely_datuma]
                 , [aj].[datum_aktivalas] AS hirdetes_indulas
                 , [aj].[munkavegzes_helye] as munkavegzes_helye
                 , [aj].[munkavegzes_helye] as terulet
                 , IIF(aj.idtanfolyamtipus > 0, 1, NULL) as tanfolyamkell
                 , [aj].[idtanfolyamtipus]
                 , [aj].[idtanfolyamhely]
                 , SUBSTRING(aj.datum_tanfolyam_szoveges, 1, 4) as tfev
                 , SUBSTRING(aj.datum_tanfolyam_szoveges, 5, 2) as tfho
                 , [aj].[targy] as pozicio
                 , [aj].[poziciok_szama] as letszam
                 , [aj].[datum_lezaras]
                 , [aj].[uzletag] as uzletag
                 , zz.Szakterulet as szervezet
                 , ZZ.Szakterulet as reszleg
                 , [aj].[idmunkaltato] as idmunkaltato
                 , [aj].[idvezeto] as idvezeto
                 , [aj].[idtoborzo1] as idtoborzo1
                 , [aj].[idtoborzo2] as idtoborzo2
                 , [aj].[idceg] as idceg
                 , tt.nev as tfmegnevezes
                 , th.nev as tanfolyamhely
                 , szum.CVmegfelelt as CVmegfelelt
                 , szum.ifo as ifo
                 , szum.tfo as tfo
                 , szum.osszesinterju as osszesinterju
                 , szum.ofo as ofo
                 , szum.omfo as omfo
                 , szum.offo as offo
                 , szum.afo as afo
                 , szum.adatum AS adatum
                 , szum.aefo as aefo
                 , szum.vfo as vfo
                 , szum.efo as efo
                 , szum.kezdettfo as kezdettfo
                 , mk.Name as munkaltato
                 , tob.Name as toborzo
                 , aj.datum_lezaras AS lezar
                 , szum.jfo as jfo
                 , szum.oefo as  oefo
         INTO ##ttmsk_kex_allasajanlatok
            FROM [dbo].[msk_kex_allasajanlatok] [aj]
               left join ( select s.Szakterulet,h.msk_tob_allashirdetesekID from msk_tob_allashirdetesek h 
               left join msk_tob_keresesikerelem k on msk_tob_keresesikerelemID=h.Idkeresesikerelem
               left join msk_tob_szakterulet s on s. Msk_tob_szakteruletID=k.SzakteruletID
               ) ZZ on ZZ.msk_tob_allashirdetesekID=aj.msk_kex_allasajanlatokID 
               INNER JOIN [#ttszumosszefoglalo] [szum] ON [szum].[allasID] = [aj].[msk_kex_allasajanlatokID]
               LEFT JOIN dbo.[msk_kex_jelentkezok] [j] ON [j].[idallasajanlat] = [aj].[msk_kex_allasajanlatokID]
               LEFT JOIN [msk_kex_tanfolyamtipusok] [tt] ON [aj].[idtanfolyamtipus] = [tt].[msk_kex_tanfolyamtipusokID]
               LEFT JOIN [msk_kex_tanfolyamhelyek] [th] ON [aj].[idtanfolyamhely] = [th].[msk_kex_tanfolyamhelyekID]
               LEFT JOIN [People] [tob] ON [aj].[idtoborzo1] = [tob].[PeopleID]
               --LEFT JOIN [People] [tob1] ON [aj].[idtoborzo2] = [tob1].[PeopleID]
               LEFT JOIN [People] [mk] ON [aj].[idmunkaltato] = [mk].[PeopleID]
            WHERE ' + @WhereString

    EXEC ( @sql );
                

    --A futatott dinamikus SQL 1. rÃ©szÃ©nek logolÃ¡sa
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Ã–sszefoglalÃ³ riport (SQL 1. rÃ©sz)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

                DROP TABLE IF EXISTS [#ttOsszefoglaloRiport]

    -- Az Összefoglaló riport elõállítása a @WhereString1 alapján
    SET @sql = '
SELECT ROW_NUMBER() OVER (ORDER BY ' + @OrderByString
               + ') AS Row
     , AJ.*
    INTO #ttOsszefoglaloRiport
FROM (
    SELECT DISTINCT ' + @FieldList
               + '
    FROM ##ttmsk_kex_allasajanlatok aj
       LEFT JOIN [msk_kex_allasajanlat_vezetok] [av] ON [av].[Idallasajanlat] = [aj].[msk_kex_allasajanlatokID]
                                                         AND [av].[Statuszolovezeto] = 1
        LEFT JOIN [msk_kex_tanfolyamtipusok] [tt] ON [aj].[idtanfolyamtipus] = [tt].[msk_kex_tanfolyamtipusokID]
        LEFT JOIN [msk_kex_tanfolyamhelyek] [th] ON [aj].[idtanfolyamhely] = [th].[msk_kex_tanfolyamhelyekID]
        LEFT JOIN [People] [tob] ON [aj].[idtoborzo1] = [tob].[PeopleID]
        --LEFT JOIN [People] [tob1] ON [aj].[idtoborzo2] = [tob1].[PeopleID]
        LEFT JOIN [People] [mk] ON [aj].[idmunkaltato] = [mk].[PeopleID]
    WHERE ' + @WhereString1 + '
    ) AJ

    SELECT * from #ttOsszefoglaloRiport WHERE Row between '
               + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20));

    --A futatott dinamikus SQL 2. rÃ©szÃ©nek logolÃ¡sa
    IF @bDebug = 1
    BEGIN
        INSERT INTO [dbo].[msk_log] ( [name], [value], [created] )
        VALUES (
                   'KEX - Ã–sszefoglalÃ³ riport (SQL 2. rÃ©sz)' -- name - varchar(100)
                 , @sql -- value - varchar(max)
                 , SYSDATETIME() -- created - datetime2(7)
               )
    END

    EXEC [dbo].[msk_Print_Text] @sql
    EXEC ( @sql )

                COMMIT TRAN t01
END
/* TESZT
DECLARE @UserID INT = 508
DECLARE @FieldList VARCHAR(MAX) = 'aj.msk_kex_allasajanlatokID as msk_kex_allasajanlatokID,aj.engedely_iktatoszama as iktatoszam,IIF (idlezarasindok > 0, ''Lezárt'', ''Folyamatban'') AS statusz,aj.engedely_datuma,FORMAT(aj.datum_aktivalas, ''yyyy.MM.dd'') AS hirdetes_indulas,aj.reszleg as szervezet,aj.munkavegzes_helye as terulet,IIF(aj.idtanfolyamtipus > 0, 1, NULL) as tanfolyamkell,tt.nev as tfmegnevezes,SUBSTRING(datum_tanfolyam_szoveges, 1, 4) as tfev,SUBSTRING(datum_tanfolyam_szoveges, 5, 2) as tfho,th.nev as tanfolyamhely,aj.targy as pozicio,aj.poziciok_szama as letszam,szum.jfo,szum.CVmegfelelt,szum.ifo,szum.tfo,szum.osszesinterju,szum.ofo,szum.oefo,szum.omfo,szum.offo,szum.afo,FORMAT(szum.adatum , ''yyyy.MM.dd '') AS adatum,szum.aefo,szum.vfo,szum.efo,szum.kezdettfo,mk.Name as munkaltato,tob.Name as toborzo,FORMAT(aj.datum_lezaras, ''yyyy.MM.dd'') AS lezar,aj.uzletag as uzletag,aj.reszleg as reszleg,aj.munkavegzes_helye as munkavegzes_helye,aj.idmunkaltato as idmunkaltato,aj.idvezeto as idvezeto,aj.idtoborzo1 as idtoborzo1,aj.idtoborzo2 as idtoborzo2,aj.idceg as idceg'
DECLARE @WhereString VARCHAR(MAX) = '1=1 AND 
           2=2 AND (j.datum BETWEEN ''2022-01-01'' AND ''2022-12-31 23:59:59.999'')
         AND (aj.[idceg]=N''941824'')  AND (aj.[reszleg] LIKE N''%szakterule%'')  AND (aj.[munkavegzes_helye] LIKE N''%Budapest%'')  AND (aj.[msk_kex_allasajanlatokID] IN 
          (SELECT Idallasajanlat FROM msk_kex_allasajanlat_vezetok WHERE Idvezeto = 1426 AND Mjgy = 10)
        )  AND (av.[idvezeto]=N''1288'')  AND (1 IN 
          (select 1) ) AND 
          ((aj.idtoborzo1=353) ) '
DECLARE @OrderByString VARCHAR(MAX) = 'aj.uzletag Asc'
DECLARE @PageNumber INT = 1
DECLARE @RowsPerPage INT = 100

EXECUTE [dbo].[msk_kex_sel_osszefoglaloriport] @UserID, @FieldList, @WhereString, @OrderByString, @PageNumber, @RowsPerPage

------------------------------------------------------------------------------
RÃ©gi kÃ³d:
                --2=2 AND (j.datum BETWEEN '2020-01-01' AND '2020-12-31 23:59:59.999')
                IF CHARINDEX('2=2',@WhereString) > 0
                  BEGIN
                               BEGIN TRY
                                               SET @Tol = SUBSTRING(@WhereString, CHARINDEX('2=2',@WhereString) + 26,10)
                                               SET @Tol_date = @Tol
                                               SET @Ig = SUBSTRING(@WhereString, CHARINDEX('2=2',@WhereString) + 43,19)
                                               SET @Ig_date = @Ig
                               END TRY
                               BEGIN CATCH
                                               SET @Tol = '1900-01-01'
                                               SET @Ig = '2900-01-01'
                               END CATCH
                               SET @tolig = ' ''' + @Tol + ''' , ''' + @Ig + ''' '
                  END

                DECLARE @sql VARCHAR(MAX) =
                'SELECT DISTINCT ' + @FieldList + ' FROM msk_kex_allasajanlatok AS aj
  LEFT JOIN msk_kex_allasajanlat_vezetok av ON av.Idallasajanlat = aj.msk_kex_allasajanlatokID AND av.Statuszolovezeto = 1
  LEFT JOIN msk_kex_tanfolyamtipusok AS tt ON aj.idtanfolyamtipus = tt.msk_kex_tanfolyamtipusokID
  LEFT JOIN msk_kex_tanfolyamhelyek AS th ON aj.idtanfolyamhely = th.msk_kex_tanfolyamhelyekID
  LEFT JOIN People tob ON aj.idtoborzo1 = tob.PeopleID
  LEFT JOIN People tob1 ON aj.idtoborzo2 = tob1.PeopleID
  LEFT JOIN People mk ON aj.idmunkaltato = mk.PeopleID
  LEFT JOIN msk_kex_jelentkezok j ON j.idallasajanlat = aj.msk_kex_allasajanlatokID
  OUTER APPLY msk_kex_szum_osszefoglaloriport (aj.msk_kex_allasajanlatokID, ' + @tolig + ') szum
                WHERE ' + @WhereString
                
                INSERT INTO dbo.msk_log
                (
                    name,
                    value,
                    created
                )
                VALUES
                (   'sql',           -- name - varchar(100)
                    @sql,           -- value - varchar(max)
                    SYSDATETIME() -- created - datetime2(7)
                    )
        
                EXEC (@sql)

*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_sel_pozicioriport.sql =====

CREATE PROCEDURE [dbo].[msk_kex_sel_pozicioriport] 
@UserID INT
, @FieldList VARCHAR(MAX) = '*'
, @WhereString VARCHAR(MAX) = '1=1'
, @OrderByString VARCHAR(MAX) = ''
, @PageNumber INT = 1
, @RowsPerPage INT = 100

AS
BEGIN
    SET NOCOUNT ON
	SET DATEFIRST 1

    DECLARE @sql NVARCHAR(MAX) = ''
    DECLARE @bDebug BIT = 0

	DECLARE @sSearch VARCHAR(20) = NULL
    DECLARE @ParamName NVARCHAR(255) = NULL
    DECLARE @Cut BIT = 1
    DECLARE @return_value2 NVARCHAR(MAX) = NULL
	DECLARE @iidceg INTEGER = NULL
	DECLARE @sAjanlattetelDatumaTol VARCHAR(50) = NULL -- stringet ad vissza
	DECLARE @dAjanlattetelDatumaTol DATETIME = NULL -- típusegyezõség miatt
    DECLARE @sAjanlattetelDatumaIg VARCHAR(50) = NULL
	DECLARE @dAjanlattetelDatumaIg DATETIME = NULL
	DECLARE @bAjanlattetelDatuma BIT = NULL
	DECLARE @iFelveteliStatusz INTEGER = NULL
	DECLARE @iPozicioStatusz INTEGER = NULL
	DECLARE @sPozicioNeve VARCHAR(30) = NULL 

    DROP TABLE IF EXISTS #tt_ajdt,#tt_pozcount,#tt_orvosi,#tt_orvosiminusz,#tt_toborzashossz,#tt_jelentkezo       
	
	 
	
	--SELECT 1/0

	SET @Cut = 1
    SET @ParamName = N'idceg'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iidceg OUTPUT
                                                       , @WhereString OUTPUT
	

	SET @sSearch = 'BETWEEN'
    SET @ParamName = N'AjanlattetelDatuma'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sAjanlattetelDatumaTol OUTPUT
                                                                         , @sAjanlattetelDatumaIg OUTPUT
                                                                         , @WhereString OUTPUT

    IF @sAjanlattetelDatumaTol IS NOT NULL AND @sAjanlattetelDatumaIg IS NOT NULL
    BEGIN
        SET @bAjanlattetelDatuma = 1
    END

	SET @dAjanlattetelDatumaTol = REPLACE( @sAjanlattetelDatumaTol, '''', '' )
    SET @dAjanlattetelDatumaIg = REPLACE( @sAjanlattetelDatumaIg, '''', '' ) 


	SET @Cut = 1
    SET @ParamName = N'FelveteliStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iFelveteliStatusz OUTPUT
                                                       , @WhereString OUTPUT

	SET @Cut = 1
    SET @ParamName = N'PozicioStatusz'

    EXEC [dbo].[osp_wrk_ReturnParamValueFromWhereString] @WhereString
                                                       , @ParamName
                                                       , @Cut
                                                       , @iPozicioStatusz OUTPUT
                                                       , @WhereString OUTPUT


	SET @sSearch = 'LIKE'
    SET @ParamName = N'PozicioNeve'

    EXEC [dbo].[msp_wrk_ReturnParamValueFromWhereStringForUniversalSelect] @WhereString
                                                                         , @sSearch
                                                                         , @ParamName
                                                                         , @Cut
                                                                         , @sPozicioNeve OUTPUT
                                                                         , @return_value2 OUTPUT
                                                                         , @WhereString OUTPUT


--  <img src="$(SolutionDir)/DOC/IMAGES/0050.png" scale="1.5" /> Az eredmény oszloplista:

SELECT 
    a.pozicioid,
    MAX(a.datum) AS UtolsoAjanlatadasDatuma
INTO #tt_ajdt
FROM msk_kex_view_ajanlat a
GROUP BY a.pozicioid;

-- Ajánlatadás számlálása
SELECT 
    lp.PozicioID, 
    COUNT(lp.PozicioID) AS Ajanlatadas
INTO #tt_pozcount
FROM [dbo].[msk_view_indexedLOGPozicioID] lp 
GROUP BY lp.pozicioid;

-- Orvosi vizsgálati napok összegyûjtése
SELECT 
    lp.PozicioID, 
    SUM(1 + dbo.ofn_msk_getMunkanapokSzama(o.igenylesdatuma, o.kiallitasdatuma)) AS napok
INTO #tt_orvosi
FROM dbo.msk_view_indexedLOGPozicioID lp  
LEFT JOIN dbo.msk_kex_ajanlat a ON a.msk_kex_ajanlatID = lp.AjanlatID
LEFT JOIN dbo.msk_kex_orvosi o ON o.idjelentkezo = a.idjelentkezo 
GROUP BY lp.PozicioID;

--kivonando orvosi napok
SELECT t.PozicioID,SUM(CASE WHEN napokminusz = 0 THEN 0 ELSE napokminusz+1 END) AS napokminusz
INTO #tt_orvosiminusz
FROM (SELECT l.PozicioID,
dbo.ofn_msk_getMunkanapokSzama(dbo.Min2dt(a.datum,o.igenylesdatuma),dbo.Min2dt(a.datum,o.kiallitasdatuma)) AS napokminusz
FROM [dbo].[msk_view_indexedLOGPozicioID] l 
LEFT JOIN dbo.msk_kex_ajanlat a ON a.msk_kex_ajanlatID=l.AjanlatID
LEFT JOIN dbo.msk_kex_orvosi o ON o.idjelentkezo = a.idjelentkezo 
) t
GROUP BY t.PozicioID;

--toborzás hossza
SELECT p.PozicioID, 1+[dbo].[ofn_msk_getMunkanapokSzama]( p.Engedelyezesidatum, dbo.max3dt(
	p.PozicioVisszavDatum,utolsoajanlat.ajanlatadasdatuma,GETDATE())
) AS toborzashossz 
,ll.LookupValue AS toborzasstatusz
,CASE WHEN al.StatuszID=24 THEN 'Lezárt' ELSE 'Folyamatban' end AS HirdetesStatusz
INTO #tt_toborzashossz
FROM msk_tob_pozicio p
LEFT JOIN msk_tob_LookupList ll ON ll.LookupListID=p.StatuszID
LEFT JOIN dbo.msk_tob_allashirdetesek al ON al.Idkeresesikerelem=p.Idkeresesikerelem
OUTER APPLY (
	SELECT MAX(a.datum) AS ajanlatadasdatuma FROM msk_kex_view_ajanlat a WHERE a.pozicioid=p.PozicioID
) utolsoajanlat
WHERE p.idkeresesikerelem IS NOT NULL;

--Jelentkezõ neve az aktuális kell azaz nem a view-bõl dolgozunk ami a múltat is mutatja
-- emellett bár nem lehet két pozició kiosztva, de ha lenne: az újabb nevét adjuk vissza:
SELECT PozicioID,jelentkezo,felvetelistatusz,idfelvstatusz
INTO #tt_jelentkezo
FROM (
    SELECT 
        a.PozicioID,
        p.nev AS jelentkezo,
        a.datum,	
		felv.lookupvalue AS felvetelistatusz,
		fe.idfelvstatusz,
        ROW_NUMBER() OVER (PARTITION BY a.PozicioID ORDER BY a.DATUM DESC) AS RowNum
    FROM msk_kex_ajanlat a
    LEFT JOIN msk_kex_jelentkezok p ON p.msk_kex_jelentkezokID = a.idjelentkezo
	LEFT JOIN dbo.msk_kex_felvstatusz fe ON fe.Idjelentkezo=a.idjelentkezo
	LEFT JOIN dbo.msk_kex_LookupList felv ON felv.LookupListID=fe.Idfelvstatusz
    WHERE ISNULL(a.PozicioID, 0) > 0 --AND a.idelfogadva=4 nem kell hogy felvéve legyen a hozzárendelés már elég
) t
WHERE RowNum = 1;


SELECT 
    p.PozicioID AS PozicioID,
    p.Iktatoszam AS EngedelyIktatoszama,
    p.Engedelyezesidatum AS Engedelyezesidatum,
    p.PozicioInfo AS Megjegyzes,
    CASE WHEN p.TorlesindokID IS NOT NULL THEN 'Törölt' ELSE l.LookupValue END AS PozicioStatusza,
    mka.targy AS PozicioNeve,
	s.Szakterulet as szakterulet,
    mka.munkavegzes_helye AS MunkavegzesHelye,
    statuszolovezeto.Name AS MJGY,
    toborzo.Name AS ToborzoNeve,
    mka.idtoborzo1,
    mka.idlezarasindok,
    mka.idceg,
    statuszolovezeto.PeopleID AS PeopleID,
    p.Idkeresesikerelem,
    p.PozicioVisszavDatum AS PozicioVisszavonasDatuma,
    ajdt.UtolsoAjanlatadasDatuma,
	jell.jelentkezo AS JelentkezoNeve,
	jell.FelveteliStatusz,
    pozcount.Ajanlatadas,
    orvosi.napok AS OrvosiIdotartama
	--,orvosiminusz.napokminusz
	--,tob.toborzashossz
	,(tob.toborzashossz-orvosiminusz.napokminusz) AS ToborzasHossza
	,tob.HirdetesStatusz
	
INTO [#ttPoziciokRiport]
FROM [msk_tob_pozicio] p
LEFT JOIN msk_tob_LookupList l ON l.LookuplistID = p.StatuszID AND l.deleted = 0
LEFT JOIN msk_tob_keresesikerelem mtk ON mtk.Msk_tob_keresesikerelemID = p.Idkeresesikerelem
LEFT JOIN msk_tob_allashirdetesek mta ON mta.Idkeresesikerelem = mtk.Msk_tob_keresesikerelemID
LEFT JOIN msk_kex_allasajanlatok mka ON mka.msk_kex_allasajanlatokID = mta.Msk_tob_allashirdetesekID
LEFT JOIN [dbo].[msk_kex_allasajanlat_vezetok] AS kexav ON kexav.Idallasajanlat = mka.msk_kex_allasajanlatokID AND kexav.Statuszolovezeto = 1
LEFT JOIN [dbo].[People] AS statuszolovezeto ON statuszolovezeto.PeopleID = kexav.Idvezeto AND statuszolovezeto.Deleted = 0
LEFT JOIN [dbo].[People] AS toborzo ON toborzo.PeopleID = mka.idtoborzo1 AND toborzo.Deleted = 0
LEFT JOIN #tt_ajdt ajdt ON ajdt.pozicioid = p.PozicioID
LEFT JOIN #tt_pozcount pozcount ON pozcount.PozicioID = p.PozicioID
LEFT JOIN #tt_orvosi orvosi ON orvosi.PozicioID = p.PozicioID
LEFT JOIN #tt_orvosiminusz orvosiminusz ON orvosiminusz.PozicioID = p.PozicioID
LEFT JOIN #tt_toborzashossz tob ON tob.PozicioID=p.PozicioID
LEFT JOIN #tt_jelentkezo jell ON jell.PozicioID=p.PozicioID
LEFT JOIN msk_tob_szakterulet s ON s.Msk_tob_szakteruletID = mtk.SzakteruletID
WHERE p.Idkeresesikerelem IS NOT NULL
AND ( @iPozicioStatusz IS NULL OR (  @iPozicioStatusz IS NOT NULL AND l.LookupListID = @iPozicioStatusz ) ) 
AND ( @iidceg IS NULL OR (  @iidceg IS NOT NULL AND mka.Idceg = @iidceg ) )
AND ( @sPozicioNeve IS NULL OR ( @sPozicioNeve IS NOT NULL AND mka.targy LIKE @sPozicioNeve ) )




/*Végsõ lekérdezés*/	



	-- A @WhereString megszabadítása a fölösleges szövegektõl [START]
    EXEC [dbo].[msp_wrk_ReturnParamValueCleanFromWhereString] @WhereString, @WhereString OUTPUT
	

    SET @sql = '
		
			SELECT ROW_NUMBER() OVER ( ORDER BY ' + @OrderByString + ') AS [Row]
				, ' + @FieldList
					   + '
					   INTO [#ttResultList] 
			FROM [#ttPoziciokRiport]
			WHERE 1=1 AND '  + @WhereString + '
    
		

    SELECT * 
    from [#ttResultList]
    WHERE Row between ' + CAST(( @PageNumber - 1 ) * @RowsPerPage + 1 AS VARCHAR(20)) + ' and '
               + CAST(@PageNumber * @RowsPerPage AS VARCHAR(20)) + '
    ORDER BY [Row]
    '
	EXEC msk_Print_Text @sql
    EXEC ( @sql )
END

/*TESZT
execute  [dbo].[msk_kex_sel_pozicioriport] '124',  
    @OrderByString=N'PozicioID Asc', 
    @WhereString=N'1=1 AND (idceg=N''941824'') ', 
    @FieldList=N'PozicioID,EngedelyIktatoszama,FORMAT(Engedelyezesidatum,''yyyy.MM.dd.'') as Engedelyezesidatum,Megjegyzes,PozicioNeve,MunkavegzesHelye,AjanlatAdas,MJGY,ToborzoNeve,HirdetesStatusz,PozicioStatusza,FORMAT(PozicioVisszavonasDatuma,''yyyy.MM.dd.'') as PozicioVisszavonasDatuma,FORMAT(UtolsoAjanlatadasDatuma,''yyyy.MM.dd.'') as UtolsoAjanlatadasDatuma,FelveteliStatusz,OrvosiIdotartama,ToborzasHossza,JelentkezoNeve,idtoborzo1,idceg', 
    @pageNumber=1, @rowsPerPage=100
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_spcsoportosajanlattetel_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_spcsoportosajanlattetel] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	/*
	    <OneRow>
      <datum>2019-06-16 00:00</datum>
      <msk_kex_ajanlatID>16</msk_kex_ajanlatID>
      <idjelentkezo>5494</idjelentkezo>
      <idelfogadva>null</idelfogadva>
      <idtovabbi_egyeztetes>null</idtovabbi_egyeztetes>
    </OneRow>

	*/

	
	DECLARE @tmp_setup TABLE (		
		datum datetime,
		msk_kex_ajanlatID int,
		idjelentkezo int,
		idelfogadva varchar(30),		
		idtovabbi_egyeztetes varchar(30)
	)

	INSERT INTO @tmp_setup exec osp_getPrsDataFromXml_Rows @prsID
	
	DECLARE @tmp_filters TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filters execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filters where ornAlias<>'msk_kex_jelentkezokID_ID' or inOut='In'
	delete from @tmp_filters where not exists (select msk_kex_jelentkezokID from msk_kex_jelentkezok where msk_kex_jelentkezokID=ornValue and Deleted=0)
	
	DECLARE @MyCursor CURSOR;
	DECLARE @MyField INT;
	BEGIN
		    SET @MyCursor = CURSOR FOR select ornValue from @tmp_filters
		    OPEN @MyCursor FETCH NEXT FROM @MyCursor INTO @MyField
		    WHILE @@FETCH_STATUS = 0
			BEGIN
				insert into msk_log (name,value,created) values ('spcsoportosajanlattetel', @MyField,getdate())
				insert into msk_kex_ajanlat (idjelentkezo,idelfogadva,datum,idtovabbi_egyeztetes,deleted)
				   values (@MyField,
					  (select top(1) case when idelfogadva='null' then null else idelfogadva end from @tmp_setup),
				      (select top(1) datum from @tmp_setup),					  
					  (select top(1) case when idtovabbi_egyeztetes='null' then null else idtovabbi_egyeztetes end from @tmp_setup),					  
						0					  
					  )

				UPDATE msk_kex_jelentkezok SET idszin = 5 WHERE msk_kex_jelentkezokID = @MyField
	  
				FETCH NEXT FROM @MyCursor INTO @MyField 
			END; 

			CLOSE @MyCursor ;
			DEALLOCATE @MyCursor;
	END
	
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_spcsoportosfelvistatusz_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_spcsoportosfelvistatusz] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	
	/*
	FORM ADATAI:

	<OneRow>
      <Datum>2019-06-28 00:00</Datum>
      <Idfelvstatusz>8</Idfelvstatusz>
      <Idelutasitasindok>0</Idelutasitasindok>
      <Idvisszalepesindok>2</Idvisszalepesindok>
      <Belepesdatum>null</Belepesdatum>
      <Msk_kex_felvstatuszID>10</Msk_kex_felvstatuszID>
      <Idjelentkezo>5499</Idjelentkezo>
    </OneRow>
	*/
	
	
	DECLARE @tmp_setup TABLE (		
		Msk_kex_felvstatuszID int,
		--MAPErvenyes VARCHAR(30),		
		Idjelentkezo int,
		Datum datetime,
		Idfelvstatusz varchar(30),		
		Belepesdatum varchar(30),
		PeopleID INT,
		VallalatonBeluli VARCHAR(30),
		Idelutasitasindok varchar(30),
		Idvisszalepesindok varchar(30)	
	)	

	INSERT INTO @tmp_setup exec osp_getPrsDataFromXml_Rows @prsID
	
	DECLARE @tmp_filters TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filters execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filters where ornAlias<>'msk_kex_jelentkezokID_ID' or inOut='In'
	delete from @tmp_filters where not exists (select msk_kex_jelentkezokID from msk_kex_jelentkezok where msk_kex_jelentkezokID=ornValue and Deleted=0)

	insert into msk_log (name,value,created) values ('spcsoportosfelvistatusz_3', 'Start',getdate())
	
	-- Idfelvstatusz:6,7,8 Felvéve, Elutasítva, Visszalépett
	-- Ha nincs érvényes MAP ajánlásos a listában és visszalépett vagy elutasítva akkor:
	declare @felvevestat int = (SELECT top 1 Idfelvstatusz FROM @tmp_setup) --6,7,8
	IF EXISTS (SELECT * FROM @tmp_filters tmp INNER JOIN dbo.msk_kex_jelentkezok j ON j.msk_kex_jelentkezokID=tmp.ornValue AND j.MAPErvenyes=1)
		AND @felvevestat = 6
	begin
		SELECT 'A kiválasztott jelentkezõk között található érvényes MAP ajánlással rendelkezõ, a státusz állítás nem hajtható végre.'
	end 
	else
	BEGIN
		DECLARE @aj INT = (select 
			isnull(sum(iif(isnull([dbo].[msk_kex_felvajanlat](aj.idjelentkezo),0)<>4,1,0)),0) 
			from @tmp_filters tmp LEFT JOIN msk_kex_ajanlat aj on aj.idjelentkezo=tmp.ornValue
		)
		DECLARE @ajmissing INT = (select 
			isnull(sum(iif([dbo].[msk_kex_felvajanlat](aj.idjelentkezo) is null,1,0)),0) 
			from @tmp_filters tmp LEFT JOIN msk_kex_ajanlat aj on aj.idjelentkezo=tmp.ornValue
		)
		if @felvevestat = 6 and @ajmissing>0 begin
				select 'A kiválasztott jelentkezõk között van, akinek nincs ajánlása. A státusz állítás nem hajtható végre.'
		end else begin
			if @felvevestat = 6 and @aj>0 -- felvéve van állítva azonban van a jelentkezõk között akinek nincs elfogadott ajánlata
			begin
				select 'A kiválasztott jelentkezõk között van, akinek az ajánlása nem létezik vagy ajánlata nem elfogadott. A státusz állítás nem hajtható végre.'
			end 
			else 
			begin
			  DECLARE @MyCursor CURSOR;
			  DECLARE @MyField INT;
			  BEGIN
					SET @MyCursor = CURSOR FOR select ornValue from @tmp_filters
					OPEN @MyCursor FETCH NEXT FROM @MyCursor INTO @MyField
					WHILE @@FETCH_STATUS = 0
					BEGIN
						insert into msk_log (name,value,created) values ('spcsoportosfelvistatusz_2', @MyField,getdate())
						insert into msk_kex_felvstatusz(Idjelentkezo,datum,Idfelvstatusz,Idelutasitasindok,Idvisszalepesindok,Belepesdatum,deleted,VallalatonBeluli)
						   values (@MyField,
							  (select top(1) datum from @tmp_setup),
							  (select top(1) case when Idfelvstatusz='null' then null else Idfelvstatusz end from @tmp_setup),				      				  
							  (select top(1) case when Idelutasitasindok='null' then null else Idelutasitasindok end from @tmp_setup),					  
							  (select top(1) case when Idvisszalepesindok='null' then null else Idvisszalepesindok end from @tmp_setup),					  
							  (select top(1) case when Belepesdatum='null' then null else Belepesdatum end from @tmp_setup),	
								0,
							  (select top(1) case when VallalatonBeluli='null' then null else VallalatonBeluli end from @tmp_setup)
							  )

						UPDATE msk_kex_jelentkezok SET idszin = 5 WHERE msk_kex_jelentkezokID = @MyField
					
						if @felvevestat in (7,8) begin
							DECLARE @PozicioID INT = (SELECT TOP 1 PozicioID /*ISNULL(idelfogadva,0)*/ FROM dbo.msk_kex_ajanlat WHERE deleted=0 AND idjelentkezo=@MyField ORDER BY msk_kex_ajanlatID desc )
							update msk_tob_pozicio set StatuszID=32 where PozicioID = @PozicioID
							update dbo.msk_kex_ajanlat set PozicioID=NULL WHERE deleted=0 AND idjelentkezo=@MyField  
						end
						if @felvevestat in (6) begin
							set @PozicioID = (SELECT TOP 1 PozicioID /*ISNULL(idelfogadva,0)*/ FROM dbo.msk_kex_ajanlat WHERE deleted=0 AND idjelentkezo=@MyField ORDER BY msk_kex_ajanlatID desc )
							update msk_tob_pozicio set StatuszID=31 where PozicioID = @PozicioID	
						end
						FETCH NEXT FROM @MyCursor INTO @MyField 
					END; 

					CLOSE @MyCursor ;
					DEALLOCATE @MyCursor;
			  END
			end
		end
	END
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_spcsoportosinterju_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_spcsoportosinterju] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	/*
	  <datum>2019-06-29 00:00</datum>
      <msk_kex_interjuID>591</msk_kex_interjuID>
      <idjelentkezo>5403</idjelentkezo>
      <idbehivva>null</idbehivva>
      <idmegjelent>4</idmegjelent>
      <ideredmeny>1</ideredmeny>
      <iddolgozik>4</iddolgozik>
      <megjegyzes>igeeeeeeeen</megjegyzes>
	  */
	DECLARE @tmp_setup TABLE (
		datum datetime,
		msk_kex_interjuID int,
		idjelentkezo int,
		idbehivva varchar(30),
		idmegjelent varchar(30),
		ideredmeny varchar(30),
		iddolgozik varchar(30),
		megjegyzes VARCHAR(max) 
	)

	INSERT INTO @tmp_setup exec osp_getPrsDataFromXml_Rows @prsID
	
	DECLARE @tmp_filters TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filters execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filters where ornAlias<>'msk_kex_jelentkezokID_ID' or inOut='In'
	delete from @tmp_filters where not exists (select msk_kex_jelentkezokID from msk_kex_jelentkezok where msk_kex_jelentkezokID=ornValue and Deleted=0)
	
	DECLARE @MyCursor CURSOR;
	DECLARE @MyField INT;
	BEGIN
		    SET @MyCursor = CURSOR FOR select ornValue from @tmp_filters
		    OPEN @MyCursor FETCH NEXT FROM @MyCursor INTO @MyField
		    WHILE @@FETCH_STATUS = 0
			BEGIN
				insert into msk_log (name,value,created) values ('spcsoportosinterju', @MyField,getdate())
				insert into msk_kex_interju (idjelentkezo,datum,idbehivva,ideredmeny,iddolgozik,idmegjelent,megjegyzes,deleted)
				   values (@MyField,
				      (select top(1) datum from @tmp_setup),
					  (select top(1) case when idbehivva='null' then NULL else idbehivva end from @tmp_setup),
					  (select top(1) case when ideredmeny='null' then NULL else ideredmeny end from @tmp_setup),
					  (select top(1) case when iddolgozik='null' then NULL else iddolgozik end from @tmp_setup),
					  (select top(1) case when idmegjelent='null' then NULL else idmegjelent end from @tmp_setup),
					  (select top(1) case when megjegyzes='null' then NULL else megjegyzes end from @tmp_setup),
						0					  
					  )

				UPDATE msk_kex_jelentkezok SET idszin = 5 WHERE msk_kex_jelentkezokID = @MyField
	  
				FETCH NEXT FROM @MyCursor INTO @MyField 
			END; 			
			CLOSE @MyCursor ;
			DEALLOCATE @MyCursor;			
	END

	
	
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_spcsoportosorvosi_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_spcsoportosorvosi] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	
	    /*<OneRow>
      <datum>2019-06-28 00:00</datum>
      <msk_kex_orvosiID>202</msk_kex_orvosiID>
      <idjelentkezo>5548</idjelentkezo>
      <idorvositipus>4</idorvositipus>
      <idelkezdte>4</idelkezdte>
      <ideredmeny>4</ideredmeny>
    </OneRow>*/

	DECLARE @tmp_setup TABLE (
		igenylesdatuma varchar(30),
		datum datetime,
		msk_kex_orvosiID int,
		idjelentkezo int,
		idorvositipus varchar(30),
		idelkezdte varchar(30),
		ideredmeny varchar(30),
		kiallitasdatuma varchar(30)
	)

	INSERT INTO @tmp_setup exec osp_getPrsDataFromXml_Rows @prsID

	DECLARE @kivetelek VARCHAR(8000) = ''

	DECLARE @tmp_filters TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filters execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filters where ornAlias<>'msk_kex_jelentkezokID_ID' or inOut='In'
	delete from @tmp_filters where not exists (select msk_kex_jelentkezokID from msk_kex_jelentkezok where msk_kex_jelentkezokID=ornValue and Deleted=0)

	DECLARE @MyCursor CURSOR;
	DECLARE @MyField INT;
	BEGIN
		    SET @MyCursor = CURSOR FOR select ornValue from @tmp_filters
		    OPEN @MyCursor FETCH NEXT FROM @MyCursor INTO @MyField
		    WHILE @@FETCH_STATUS = 0
			BEGIN
				IF (EXISTS (SELECT * FROM [dbo].[msk_kex_orvosi] [MKO] WHERE [MKO].[idjelentkezo]=@MyField
				AND ISNULL([MKO].[idelkezdte],0)<>5 AND ISNULL([MKO].[ideredmeny],0)=0 AND [MKO].[Deleted]=0)
				OR EXISTS (SELECT * FROM [dbo].[msk_kex_orvosi] [MKO] WHERE [MKO].[idjelentkezo]=@MyField
				AND ISNULL([MKO].[idelkezdte],0)=4 AND ISNULL([MKO].[ideredmeny],0)<>5 AND [MKO].[Deleted]=0))
				BEGIN
					IF @kivetelek = ''
						SET @kivetelek = (SELECT TOP 1 [MKJ].[nev] FROM [dbo].[msk_kex_jelentkezok] [MKJ] WHERE [MKJ].[msk_kex_jelentkezokID]=@MyField)
					ELSE
						SET @kivetelek = @kivetelek + ', ' + (SELECT TOP 1 [MKJ].[nev] FROM [dbo].[msk_kex_jelentkezok] [MKJ] WHERE [MKJ].[msk_kex_jelentkezokID]=@MyField)
				END
				ELSE
				BEGIN
					insert into msk_log (name,value,created) values ('spcsoportosorvosi', @MyField,getdate())
					insert into msk_kex_orvosi (idjelentkezo,datum,idorvositipus,idelkezdte,ideredmeny,deleted,igenylesdatuma,kiallitasdatuma)
					   values (@MyField,
						  (select top(1) datum from @tmp_setup),
						  (select top(1) case when idorvositipus='null' then null else idorvositipus end from @tmp_setup),
						  (select top(1) case when idelkezdte='null' then null else idelkezdte end from @tmp_setup),
						  (select top(1) case when ideredmeny='null' then null else ideredmeny end from @tmp_setup),					  
							0,
						  (select top(1) case when igenylesdatuma='null' then null else igenylesdatuma end from @tmp_setup),					  
						  (select top(1) case when kiallitasdatuma='null' then null else kiallitasdatuma end from @tmp_setup)
						  )
					UPDATE msk_kex_jelentkezok SET idszin = 5 WHERE msk_kex_jelentkezokID = @MyField  
				END

				FETCH NEXT FROM @MyCursor INTO @MyField 
				 
			END; 

			CLOSE @MyCursor ;
			DEALLOCATE @MyCursor;
	END

	IF @kivetelek <> ''
		SELECT 'A ' + @kivetelek + ' jelentkezõknek nem került rögzítésre, mert van folyamatban lévõ orvosijuk.'
	
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_spcsoportosteszt_1.sql =====

CREATE PROCEDURE [dbo].[msk_kex_spcsoportosteszt] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	/*
	    <OneRow>
      <msk_kex_tesztID>96</msk_kex_tesztID>
      <idjelentkezo>5491</idjelentkezo>
      <idteszttipus>15</idteszttipus>
      <datum>2019-06-19 00:00</datum>
      <idbehivva>null</idbehivva>
      <idmegirta>5</idmegirta>
      <ideredmeny>5</ideredmeny>
      <megjegyzes>zzzzz</megjegyzes>
    </OneRow>
	*/

	/*
	  <datum>2019-06-29 00:00</datum>
      <msk_kex_interjuID>591</msk_kex_interjuID>
      <idjelentkezo>5403</idjelentkezo>
      <idbehivva>null</idbehivva>
      <idmegjelent>4</idmegjelent>
      <ideredmeny>1</ideredmeny>
      <iddolgozik>4</iddolgozik>
      <megjegyzes>igeeeeeeeen</megjegyzes>
	  */
	DECLARE @tmp_setup TABLE (		
		msk_kex_tesztID int,
		idjelentkezo int,
		idteszttipus varchar(30),
		datum datetime,
		idbehivva varchar(30),
		idmegirta varchar(30),
		ideredmeny varchar(30),		
		megjegyzes VARCHAR(max) 
	)

	INSERT INTO @tmp_setup exec osp_getPrsDataFromXml_Rows @prsID
	
	DECLARE @tmp_filters TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filters execute osp_getPrsDataFromXml_Filters @prsID
	delete from @tmp_filters where ornAlias<>'msk_kex_jelentkezokID_ID' or inOut='In'
	delete from @tmp_filters where not exists (select msk_kex_jelentkezokID from msk_kex_jelentkezok where msk_kex_jelentkezokID=ornValue and Deleted=0)
	
	DECLARE @MyCursor CURSOR;
	DECLARE @MyField INT;
	BEGIN
		    SET @MyCursor = CURSOR FOR select ornValue from @tmp_filters
		    OPEN @MyCursor FETCH NEXT FROM @MyCursor INTO @MyField
		    WHILE @@FETCH_STATUS = 0
			BEGIN
				insert into msk_log (name,value,created) values ('spcsoportosteszt', @MyField,getdate())
				insert into msk_kex_teszt (idjelentkezo,idteszttipus,datum,idbehivva,idmegirta,ideredmeny,megjegyzes,deleted)
				   values (@MyField,
					  (select top(1) case when idteszttipus='null' then null else idteszttipus end from @tmp_setup),
				      (select top(1) datum from @tmp_setup),					  
					  (select top(1) case when idbehivva='null' then null else idbehivva end from @tmp_setup),
					  (select top(1) case when idmegirta='null' then null else idmegirta end from @tmp_setup),
					  (select top(1) case when ideredmeny='null' then null else ideredmeny end from @tmp_setup),
					  (select top(1) case when megjegyzes='null' then NULL else megjegyzes end from @tmp_setup),
						0					  
					  )

				UPDATE msk_kex_jelentkezok SET idszin = 5 WHERE msk_kex_jelentkezokID = @MyField
	  
				FETCH NEXT FROM @MyCursor INTO @MyField 
			END; 

			CLOSE @MyCursor ;
			DEALLOCATE @MyCursor;
	END
	
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_splezarasindokok.sql =====

CREATE PROCEDURE [dbo].[msk_kex_splezarasindokok] (   
	@mmName VARCHAR(100),  
	@screenName VARCHAR(100),  
	@componentName VARCHAR(100),  
	@buttonName VARCHAR(100),  
	@userID INT,  
	@parentBoName VARCHAR(100)   
) AS BEGIN  
	SET NOCOUNT ON  
	  
	insert into msk_log (name,value,created) values ('splezarasindokok_lista',concat(@componentName,',',@buttonName),getdate())
	SELECT [Msk_kex_lezarasindokokID] as [type]
		  ,[Indokok] as [FragmentCaption] 
	  FROM msk_kex_lezarasindokok
	  where deleted=0
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_splezarasindokok_2.sql =====

CREATE PROCEDURE [dbo].[msk_kex_splezarasindokok_2] (   
	@ID INT
) AS BEGIN  
	SET NOCOUNT ON  
	  
	insert into msk_log (name,value,created) values ('splezarasindokok2_lista',@ID,getdate())
	SELECT [Msk_kex_lezarasindokokID] as [type]
		  ,[Indokok] as [FragmentCaption] 
	  FROM msk_kex_lezarasindokok
	  where deleted=0
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_statuszolovezeto_torlese_1.sql =====


CREATE PROCEDURE [dbo].[msk_kex_statuszolovezeto_torlese] @prsID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	
	DECLARE @tmp_filtersvezeto TABLE
	(
		ornAlias Varchar(100),
		ornType Varchar(100),
		ornValue Varchar(100),
		inOut Varchar(100)
	)

	INSERT INTO @tmp_filtersvezeto execute osp_getPrsDataFromXml_Filters @prsID

    DECLARE @MyFieldAllasajanlatVezetoTablaID INT;
	DECLARE @MyFieldAllasajanlatID INT;
	DECLARE @MyFieldStatuszoloVezetoID INT;

	                                                                                                  
    set @MyFieldAllasajanlatVezetoTablaID = (select ornValue from @tmp_filtersvezeto where ornAlias ='msk_kex_allasajanlat_vezetokID_ID' AND inOut='out');
    set @MyFieldStatuszoloVezetoID = (select ornValue from @tmp_filtersvezeto where ornAlias ='Idvezeto_ID' AND inOut='out');
    set @MyFieldAllasajanlatID = (select [Idallasajanlat] from [msk_kex_allasajanlat_vezetok] where [msk_kex_allasajanlat_vezetokID] = @MyFieldStatuszoloVezetoID);
	
	UPDATE [msk_kex_allasajanlatok]
    SET [idvezeto] = NULL
    WHERE [msk_kex_allasajanlatokID]= @MyFieldAllasajanlatID
	 -- AND [idvezeto]=@MyFieldStatuszoloVezetoID

	UPDATE [msk_kex_allasajanlat_vezetok]
    SET [Deleted] = 1
    WHERE [idvezeto]=@MyFieldStatuszoloVezetoID

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_kex_vezeto_mentes_es_email_kuldes.sql =====

CREATE PROCEDURE [dbo].[msk_kex_vezeto_mentes_es_email_kuldes] @ID integer	
AS 
BEGIN
	SET NOCOUNT ON
	

	DECLARE @prs_table TABLE (
		rawDataID int,
		prsID int,
		DataType varchar(16), 
		xID int,
		xParentID int,
		localName varchar(512), 
		prev int,
		value varchar(max)
	)

	INSERT INTO @prs_table exec osp_getPrsDataFromXml_All @ID

	DECLARE	@CimzettID VARCHAR(260) 
		SET @CimzettID = (SELECT top 1 value FROM @prs_table WHERE localName='Idvezeto')
	DECLARE @Cimzett_neve VARCHAR(200)
		SET @Cimzett_neve = (SELECT top 1 Name FROM dbo.People WHERE PeopleID=@CimzettID)
	DECLARE @Cimzett_email VARCHAR(200)
		SET @Cimzett_email = (SELECT top 1 Email FROM dbo.People WHERE PeopleID=@CimzettID)
	DECLARE @LetrehozoID INT
		SET @LetrehozoID = (SELECT top 1 value FROM @prs_table WHERE localName='UserID')
	DECLARE @Letrehozo_neve VARCHAR(200)
		SET @Letrehozo_neve = (SELECT TOP 1 Name FROM dbo.People WHERE PeopleID=@LetrehozoID)
	DECLARE @Letrehozo_vallalat INT
		SET @Letrehozo_vallalat = (SELECT TOP 1 BUKRS FROM dbo.People WHERE PeopleID=@LetrehozoID)
	DECLARE @Letrehozo_vallalatID INT
		SET @Letrehozo_vallalatID = (SELECT TOP 1 CompanyID FROM dbo.orn_SZI_Company WHERE VallalatKod=@Letrehozo_vallalat)
	DECLARE @Letrehozo_vallalatRovidNev VARCHAR(40)
		SET @Letrehozo_vallalatRovidNev = (SELECT TOP 1 RovidNev FROM dbo.msk_Company WHERE BUKRS=@Letrehozo_vallalat)
	DECLARE @TemplateID INT
	SET @TemplateID = (SELECT top 1 EmailTemplateSampleID FROM dbo.orn_szi_EmailTemplateSample WHERE  technical_name=CONCAT('kex_',@Letrehozo_vallalatRovidNev,'_mjgy') AND Deleted=0 AND CompanyID=@Letrehozo_vallalatID)

	DECLARE @tmp_Targy  VARCHAR(150) 
		SET @tmp_Targy = (SELECT top 1 EmailSubject FROM dbo.orn_szi_EmailTemplateSample WHERE EmailTemplateSampleID=@TemplateID)
	DECLARE @tmp_Szoveg  VARCHAR(MAX) 
		SET @tmp_Szoveg = (SELECT top 1 EmailBody FROM dbo.orn_szi_EmailTemplateSample WHERE EmailTemplateSampleID=@TemplateID)

	DECLARE @AllasVezetoID INT = (SELECT top 1 value FROM @prs_table WHERE localName='msk_kex_allasajanlat_vezetokID')
	DECLARE @IsMjgy INT = (SELECT top 1 value FROM @prs_table WHERE localName='Mjgy')
	DECLARE @IsStatuszolo BIT = (SELECT top 1 value FROM @prs_table WHERE localName='Statuszolovezeto')

	DECLARE @SentToJelentkezoTablaID INT = 0

	DECLARE @AllasID INT = (SELECT top 1 value FROM @prs_table WHERE xParentID = (SELECT TOP 1 xParentID FROM @prs_table WHERE value = 'msk_kex_allasajanlatokID_ID') AND localName = 'ornValue')


	DECLARE @AllasName VARCHAR(255) = (SELECT top 1 targy FROM dbo.msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@AllasID)

	DECLARE @Letrehozo_alairas VARCHAR(8000)
	SET @Letrehozo_alairas = (SELECT TOP 1 Alairas
							FROM dbo.msk_kex_emailalairas
							WHERE PeopleID=@LetrehozoID AND Deleted=0)

	DECLARE @base_url VARCHAR(8000) = (SELECT TOP 1 CodeValue FROM dbo.FSYS_ApplicationSetup WHERE Code='BaseURL' AND Deleted=0)
	DECLARE @url VARCHAR(8000) = '%base%MMMSKKEXKarrierExcel/ScreenMSKKEXallasajanlatokesjelentkezok?d1=%7CMMMSKKEXKarrierExcel%7CScreenMSKKEXallasajanlatokEdit%7Cin%7C%7CEditObject%7C%7C325%7C%7C%5B%7B%22a%22:%22msk_kex_allasajanlatokID_ID%22,%22t%22:1,%22v%22:%allas%%7D,%7B%22a%22:%22JumpType%22,%22t%22:2,%22v%22:1%7D%5D'
	SET @url = REPLACE(@url, '%base%', ISNULL(@base_url, ''))
	SET @url = REPLACE(@url, '%allas%', ISNULL(@AllasID, ''))

	SET @tmp_Targy = REPLACE(@tmp_Targy, '%allas_neve%', ISNULL(@AllasName, ''))

	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%cimzett%', ISNULL(@Cimzett_neve, 'Címzett'))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%kuldo%', ISNULL(@Letrehozo_neve, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%kuldo_alairas%', ISNULL(@Letrehozo_alairas, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%allas_neve%', ISNULL(@AllasName, ''))
	SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%link%', ISNULL(@url, ''))
	IF @IsStatuszolo = 'true' SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%statuszolo%', 'státuszoló')
		ELSE SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%statuszolo%', '')
	IF @IsMjgy = 10 SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%vezeto_tipus%', 'munkáltatói jogkör gyakorló')
	IF @IsMjgy = 9 SET @tmp_Szoveg = REPLACE(@tmp_Szoveg, '%vezeto_tipus%', 'vezetõ')

	--exec [dbo].[msk_SendMail]
	--		@Modul = 'KEX',
	--		@Recipients = @Cimzett_email,
	--		@CopyRecipients  = '',
	--		@BlindCopyRecipients = NULL,
	--		@Subject = @tmp_Targy,
	--		@Body = @tmp_Szoveg,
	--		@BodyFormat = 'HTML',
	--		@Importance = 'Normal',
	--		@FileAttachments = NULL,
	--		@EmailTemplateID = @TemplateID,
	--		@CreatedBy = @LetrehozoID,
	--		@CimzettID = @CimzettID,
	--		@CimzettTablaID = @SentToJelentkezoTablaID
	INSERT INTO dbo.msk_MailSend_Log
	(
	    Modul,
	    Recipients,
	    CopyRecipients,
	    BlindCopyRecipients,
	    Subject,
	    Body,
	    BodyFormat,
	    Importance,
	    FileAttachments,
	    MailItemID,
	    Created,
	    Success,
	    Deleted,
	    EmailTemplateID,
	    CreatedBy,
	    SentToJelentkezoID,
	    SentToJelentkezoTablaID
	)
	VALUES
	(   'KEX',        -- Modul - varchar(50)
	    @Cimzett_email,        -- Recipients - varchar(260)
	    '',        -- CopyRecipients - varchar(8000)
	    NULL,        -- BlindCopyRecipients - varchar(8000)
	    @tmp_Targy,        -- Subject - varchar(200)
	    @tmp_Szoveg,        -- Body - varchar(max)
	    'HTML',        -- BodyFormat - varchar(20)
	    'Normal',        -- Importance - varchar(100)
	    NULL,        -- FileAttachments - varchar(8000)
	    0,         -- MailItemID - int
	    GETDATE(), -- Created - datetime
	    NULL,      -- Success - bit
	    0,         -- Deleted - tinyint
	    @TemplateID,         -- EmailTemplateID - int
	    @LetrehozoID,         -- CreatedBy - int
	    @CimzettID,         -- SentToJelentkezoID - int
	    @SentToJelentkezoTablaID          -- SentToJelentkezoTablaID - tinyint
	    )

	DECLARE @MailSendLogID INT = SCOPE_IDENTITY()

	EXEC [dbo].[msk_SendMail_dll] 	
			@Modul = 'KEX',
			@Recipients = @Cimzett_email,
			@CopyRecipients  = '',
			@BlindCopyRecipients = NULL,
			@Subject = @tmp_Targy,
			@Body = @tmp_Szoveg,
			@BodyFormat = 'HTML',
			@Importance = 'Normal',
			@FileAttachments = NULL,
			@EmailTemplateID = @TemplateID,
			@CreatedBy = @LetrehozoID,
			@CimzettID = @CimzettID,
			@CimzettTablaID = @SentToJelentkezoTablaID,
	        @MailSendLogID = @MailSendLogID


	IF NOT EXISTS (SELECT TOP 1 * FROM dbo.msk_kex_allasajanlat_vezetok WHERE Idvezeto=@CimzettID AND idallasajanlat=@AllasID AND Mjgy=@IsMjgy AND Deleted=0)
		INSERT INTO dbo.msk_kex_allasajanlat_vezetok
		(
			Idvezeto,
			idallasajanlat,
			Mjgy,
			Deleted,
			Statuszolovezeto
		)
		VALUES
		(   @CimzettID, -- Idvezeto - int
			@AllasID, -- idallasajanlat - int
			@IsMjgy, -- Mjgy - int
			0, -- Deleted - tinyint
			@IsStatuszolo  -- Statuszolovezeto - tinyint
		)

	ELSE
		UPDATE dbo.msk_kex_allasajanlat_vezetok	SET Statuszolovezeto = @IsStatuszolo WHERE msk_kex_allasajanlat_vezetokID=@AllasVezetoID

	SELECT 'Értesítõ email sikeresen kiküldve ' + @Cimzett_neve + ' részére'

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msk_tob_msk_kex_advertlistchangelog_frissites.sql =====


CREATE PROCEDURE [dbo].[msk_tob_msk_kex_advertlistchangelog_frissites] @AllasID INT	
AS 
BEGIN

		--DECLARE @Msk_Kex_AdvertlistchangelogID INT
		--DECLARE @AdvertListID INT
		--DECLARE @WebAdvertsID INT
		DECLARE @AdvertID varchar(8000) = @AllasID
		DECLARE @Company varchar(8000)
		DECLARE @Title varchar(8000)
		DECLARE @Description varchar(8000)
		DECLARE @Locations varchar(8000)
		DECLARE @Categories varchar(8000)
		DECLARE @CompanyID varchar(8000)
		DECLARE @Department VARCHAR(8000)
		DECLARE @Requirements VARCHAR(8000)
		DECLARE @Qualities VARCHAR(8000)
		DECLARE @Benefits VARCHAR(8000)
		DECLARE @Min_Experience VARCHAR(8000)
		DECLARE @Min_Education VARCHAR(8000)
		DECLARE @Driver_Licence VARCHAR(8000)
		DECLARE @Link varchar(8000)
		DECLARE @Activation_Date VARCHAR(8000)
		DECLARE @Expiraton_Date VARCHAR(8000)
		DECLARE @Contract VARCHAR(8000)
		DECLARE @Schedule VARCHAR(8000)
		DECLARE @Company_Name VARCHAR(8000)
		DECLARE @Email VARCHAR(8000)
		DECLARE @Phone VARCHAR(8000)
		DECLARE @Vacancy_NR VARCHAR(8000)
		DECLARE @Work_Location VARCHAR(8000)
		DECLARE @Hide_Company VARCHAR(8000)
		DECLARE @Schow_Apply_Button VARCHAR(8000)
		DECLARE @Custom_Template_ID VARCHAR(8000)
		DECLARE @Tasks VARCHAR(8000)
		DECLARE @Additional_Info VARCHAR(8000)
		DECLARE @Recruiter_Info VARCHAR(8000)
		DECLARE @Recruiter_ID VARCHAR(8000) 
		DECLARE @Recruiter_email VARCHAR(8000) 
		DECLARE @Recruiter_Felvado VARCHAR(8000) 
		DECLARE @Map_Job VARCHAR(8000) 
		DECLARE @CV VARCHAR(8000) 
		DECLARE @Subsidiary VARCHAR(8000) 
		DECLARE @Industry VARCHAR(8000) 
		DECLARE @Hierarchy_Level VARCHAR(8000) 
		DECLARE @Education_Type VARCHAR(8000) 
		DECLARE @Education_Field VARCHAR(8000) 
		DECLARE @Field_Of_Study VARCHAR(8000) 
		DECLARE @Reference_Number VARCHAR(8000) 
		DECLARE @Approval_Date VARCHAR(8000) 
		DECLARE @Number_Of_Positions VARCHAR(8000) 
		DECLARE @Created DATETIME 
		DECLARE @Deleted TINYINT

		--DECLARE @Msk_Kex_AdvertlistchangelogID_log INT 
		--DECLARE @AdvertListID_log INT 
		--DECLARE @WebAdvertsID_log INT 
		DECLARE @AdvertID_log varchar(8000) 
		DECLARE @Company_log varchar(8000) 
		DECLARE @Title_log varchar(8000) 
		DECLARE @Description_log varchar(8000) 
		DECLARE @Locations_log varchar(8000) 
		DECLARE @Categories_log varchar(8000) 
		DECLARE @CompanyID_log varchar(8000) 
		DECLARE @Department_log VARCHAR(8000) 
		DECLARE @Requirements_log VARCHAR(8000) 
		DECLARE @Qualities_log VARCHAR(8000) 
		DECLARE @Benefits_log VARCHAR(8000) 
		DECLARE @Min_Experience_log VARCHAR(8000) 
		DECLARE @Min_Education_log VARCHAR(8000) 
		DECLARE @Driver_Licence_log VARCHAR(8000) 
		DECLARE @Link_log VARCHAR(8000) 
		DECLARE @Activation_Date_log VARCHAR(8000) 
		DECLARE @Expiraton_Date_log VARCHAR(8000) 
		DECLARE @Contract_log VARCHAR(8000) 
		DECLARE @Schedule_log VARCHAR(8000) 
		DECLARE @Company_Name_log VARCHAR(8000) 
		DECLARE @Email_log VARCHAR(8000) 
		DECLARE @Phone_log VARCHAR(8000) 
		DECLARE @Vacancy_NR_log VARCHAR(8000) 
		DECLARE @Work_Location_log VARCHAR(8000) 
		DECLARE @Hide_Company_log VARCHAR(8000) 
		DECLARE @Schow_Apply_Button_log VARCHAR(8000) 
		DECLARE @Custom_Template_ID_log VARCHAR(8000) 
		DECLARE @Tasks_log VARCHAR(8000) 
		DECLARE @Additional_Info_log VARCHAR(8000) 
		DECLARE @Recruiter_Info_log VARCHAR(8000) 
		DECLARE @Recruiter_id_log VARCHAR(8000) 
		DECLARE @Recruiter_Email_log VARCHAR(8000) 
		DECLARE @Recruiter_Felvado_log VARCHAR(8000) 
		DECLARE @Map_Job_log VARCHAR(8000) 
		DECLARE @CV_log VARCHAR(8000) 
		DECLARE @Subsidiary_log VARCHAR(8000) 
		DECLARE @Industry_log VARCHAR(8000) 
		DECLARE @Hierarchy_Level_log VARCHAR(8000) 
		DECLARE @Education_Type_log VARCHAR(8000) 
		DECLARE @Education_Field_log VARCHAR(8000) 
		DECLARE @Field_Of_Study_log VARCHAR(8000) 
		DECLARE @Reference_Number_log VARCHAR(8000) 
		DECLARE @Approval_Date_log VARCHAR(8000) 
		DECLARE @Number_Of_Positions_log VARCHAR(8000) 
		DECLARE @Created_log DATETIME 
		DECLARE @Deleted_log TINYINT 

		--Aktuális Keresési kérelem és álláshirdetés lekérdezése
		SELECT 
		-- @Msk_Kex_AdvertlistchangelogID
		--,@AdvertListID
		--,@WebAdvertsID
		 @AdvertID = ah.Msk_tob_allashirdetesekID
		,@Company = c.Name
		,@Title = ah.Targy
		,@Description = ah.Vallalatibemutatkozo
		,@Locations = CONCAT('<LOCATION>', t.Telepules, '</LOCATION>')
		,@Categories = k.SzakteruletID
		,@CompanyID = k.Idceg
		,@Department = k.SzakteruletID
		,@Requirements = ah.Elvarasok
		,@Qualities = ah.Elonytjelent
		,@Benefits = ah.Juttatasok
		,@Min_Experience = NULL
		,@Min_Education = NULL
		,@Driver_Licence = 'False'
		,@Link = ah.Link
		,@Activation_Date = ah.Datum_publikalas
		,@Expiraton_Date = ah.Datum_lejarat
		,@Contract = szf.Szerzodesfajta
		,@Schedule = k.FoglalkoztatasifokID
		,@Company_Name = NULL
		,@Email = NULL
		,@Phone = NULL
		,@Vacancy_NR = k.Pozicioszam
		,@Work_Location = t.Telepules
		,@Hide_Company = 'False'
		,@Schow_Apply_Button = 'False'
		,@Custom_Template_ID = NULL
		,@Tasks = ah.Feladatok
		,@Additional_Info = ah.Fejlecszoveg
		,@Recruiter_Info = ah.Toborzotelefonszam
		,@Recruiter_ID = p.PERNR
		,@Recruiter_email = p.Email 
		,@Recruiter_Felvado = ah.VideoURL
		,@Map_Job = k.Map_job 
		,@CV = k.Cv 
		,@Subsidiary = NULL
		,@Industry = k.TeruletiigazgatosagID
		,@Hierarchy_Level = k.MunkakorcsoportID
		,@Education_Type = k.Kepzes_fajtaID
		,@Education_Field = k.Kepzes_szakiranyID
		,@Field_Of_Study = ah.FenykepURL
		,@Reference_Number = k.Iktatoszam
		,@Approval_Date = k.Engedelyezesidatum
		,@Number_Of_Positions = k.Pozicioszam

		FROM dbo.msk_tob_keresesikerelem k 
		LEFT JOIN dbo.msk_tob_allashirdetesek ah ON ah.Idkeresesikerelem=k.Msk_tob_keresesikerelemID
		LEFT JOIN dbo.msk_tob_telepulesek t ON t.Msk_tob_telepulesekID=k.MunkavegzeshelyeID
		LEFT JOIN dbo.orn_SZI_Company c ON c.AllasVallalatKod=k.Idceg
		LEFT JOIN dbo.msk_tob_szerzodesfajta szf ON szf.Msk_tob_szerzodesfajtaID = k.SzerzodesfajtaID
		LEFT JOIN dbo.msk_tob_foglalkoztatasifok ff ON ff.Msk_tob_foglalkoztatasifokID=k.FoglalkoztatasifokID
		LEFT JOIN dbo.People AS p ON k.Idtoborzo1 = p.PeopleID
		WHERE ah.Msk_tob_allashirdetesekID=@AllasID
		
		--Legutolsó advertlog id kinyerése 
		DECLARE @MaxAdvertlistchangelogID INT
		SET @MaxAdvertlistchangelogID = (SELECT MAX(Msk_Kex_AdvertlistchangelogID) FROM dbo.msk_kex_advertlistchangelog WHERE AdvertID=@AdvertID)
		
		--Legutolsó advertlog lekérdezése
		SELECT
		--,@Msk_Kex_AdvertlistchangelogID_log INT 
		--,@AdvertListID_log INT 
		--,@WebAdvertsID_log INT 
		 @AdvertID_log = AdvertID
		,@Company_log = Company
		,@Title_log = Title
		,@Description_log = Description
		,@Locations_log = Locations
		,@Categories_log = Categories
		,@CompanyID_log = CompanyID
		,@Department_log = Department
		,@Requirements_log = Requirements
		,@Qualities_log = Qualities
		,@Benefits_log = Benefits
		,@Min_Experience_log = Min_Experience
		,@Min_Education_log = Min_Education
		,@Driver_Licence_log = Driver_Licence
		,@Link_log = Link
		,@Activation_Date_log = Activation_Date
		,@Expiraton_Date_log = Expiraton_Date
		,@Contract_log = Contract
		,@Schedule_log = Schedule
		,@Company_Name_log = Company_Name
		,@Email_log = Email
		,@Phone_log = Phone
		,@Vacancy_NR_log = Vacancy_NR
		,@Work_Location_log = Work_Location
		,@Hide_Company_log = Hide_Company
		,@Schow_Apply_Button_log = Schow_Apply_Button
		,@Custom_Template_ID_log = Custom_Template_ID
		,@Tasks_log = Tasks
		,@Additional_Info_log = Additional_Info
		,@Recruiter_Info_log = Recruiter_Info
		,@Recruiter_id_log = Recruiter_ID
		,@Recruiter_Email_log = Recruiter_Email
		,@Recruiter_Felvado_log = Recruiter_Felvado
		,@Map_Job_log = Map_Job
		,@CV_log = CV
		,@Subsidiary_log = Subsidiary
		,@Industry_log = Industry
		,@Hierarchy_Level_log = Hierarchy_Level
		,@Education_Type_log = Education_Type
		,@Education_Field_log = Education_Field
		,@Field_Of_Study_log = Field_Of_Study
		,@Reference_Number_log = Reference_Number
		,@Approval_Date_log = Approval_Date
		,@Number_Of_Positions_log = Number_Of_Positions
		FROM dbo.msk_kex_advertlistchangelog
		WHERE Msk_Kex_AdvertlistchangelogID = @MaxAdvertlistchangelogID

		--"Történt-e módosítás?" vizsgálat
		IF
			ISNULL(@Title,'') <> ISNULL(@Title_log,'') OR
			ISNULL(@Description,'') <> ISNULL(@Description_log,'') OR
			ISNULL(@Categories,'') <> ISNULL(@Categories_log,'') OR
			ISNULL(@CompanyID ,'') <> ISNULL(@CompanyID_log,'') OR
			ISNULL(@Department,'') <> ISNULL(@Department_log,'') OR
			ISNULL(@Requirements,'') <> ISNULL(@Requirements_log,'') OR
			ISNULL(@Qualities,'') <> ISNULL(@Qualities_log,'') OR
			ISNULL(@Benefits,'') <> ISNULL(@Benefits_log,'') OR
			ISNULL(@Link,'') <> ISNULL(@Link_log,'') OR
			ISNULL(@Expiraton_Date,'') <> ISNULL(@Expiraton_Date_log,'') OR
			ISNULL(@Contract,'') <> ISNULL(@Contract_log,'') OR
			ISNULL(@Schedule,'') <> ISNULL(@Schedule_log,'') OR
			ISNULL(@Vacancy_NR,'') <> ISNULL(@Vacancy_NR_log,'') OR
			ISNULL(@Work_Location,'') <> ISNULL(@Work_Location_log,'') OR
			ISNULL(@Tasks,'') <> ISNULL(@Tasks_log,'') OR
			ISNULL(@Additional_Info,'') <> ISNULL(@Additional_Info_log,'') OR
			ISNULL(@Recruiter_Info,'') <> ISNULL(@Recruiter_Info_log,'') OR
			ISNULL(@Recruiter_ID,'') <> ISNULL(@Recruiter_id_log,'') OR
			ISNULL(@Recruiter_email,'') <> ISNULL(@Recruiter_Email_log,'') OR
			ISNULL(@Recruiter_Felvado,'') <> ISNULL(@Recruiter_Felvado_log,'') OR
			ISNULL(@Map_Job,'') <> ISNULL(@Map_Job_log,'') OR
			ISNULL(@CV,'') <> ISNULL(@CV_log,'') OR
			ISNULL(@Industry,'') <> ISNULL(@Industry_log,'') OR
			ISNULL(@Hierarchy_Level,'') <> ISNULL(@Hierarchy_Level_log,'') OR
			ISNULL(@Education_Type,'') <> ISNULL(@Education_Type_log,'') OR
			ISNULL(@Education_Field,'') <> ISNULL(@Education_Field_log,'') OR
			ISNULL(@Field_Of_Study,'') <> ISNULL(@Field_Of_Study_log,'') OR
			ISNULL(@Reference_Number,'') <> ISNULL(@Reference_Number_log,'') OR
			ISNULL(@Approval_Date,'') <> ISNULL(@Approval_Date_log,'') OR
			ISNULL(@Number_Of_Positions,'') <> ISNULL(@Number_Of_Positions_log,'')
			OR NOT EXISTS (SELECT * FROM dbo.msk_kex_advertlistchangelog WHERE AdvertID=@AdvertID)
		BEGIN
			INSERT INTO dbo.msk_kex_advertlistchangelog (AdvertListID, Deleted) VALUES (0, 0)

			DECLARE @Uj_msk_kex_advertlistchangelogID INT
			SET @Uj_msk_kex_advertlistchangelogID = SCOPE_IDENTITY()

			UPDATE dbo.msk_kex_advertlistchangelog SET
				AdvertListID = (@Uj_msk_kex_advertlistchangelogID + 4000000),
				AdvertID = @AdvertID,
				Company = @Company,
				Title = @Title,
				Description = @Description,
				Locations = @Locations,
				Categories = @Categories,
				CompanyID = @CompanyID,
				Department = @Department,
				Requirements = @Requirements,
				Qualities = @Qualities,
				Benefits = @Benefits,
				Min_Experience = @Min_Experience,
				Min_Education = @Min_Education,
				Driver_Licence = @Driver_Licence,
				Link = @Link,
				Activation_Date = @Activation_Date,
				Expiraton_Date = @Expiraton_Date,
				Contract = @Contract,
				Schedule = @Schedule,
				Company_Name = @Company_Name,
				Email = @Email,
				Phone = @Phone,
				Vacancy_NR = @Vacancy_NR,
				Work_Location = @Work_Location,
				Hide_Company = @Hide_Company,
				Schow_Apply_Button = @Schow_Apply_Button,
				Custom_Template_ID = @Custom_Template_ID,
				Tasks = @Tasks,
				Additional_Info = @Additional_Info,
				Recruiter_Info = @Recruiter_Info,
				Recruiter_ID = @Recruiter_ID,
				Recruiter_Email = @Recruiter_email,
				Recruiter_Felvado = @Recruiter_Felvado,
				Map_Job = @Map_Job,
				CV = @CV,
				Subsidiary = @Subsidiary,
				Industry = @Industry,
				Hierarchy_Level = @Hierarchy_Level,
				Education_Type = @Education_Type,
				Education_Field = @Education_Field,
				Field_Of_Study = @Field_Of_Study,
				Reference_Number = @Reference_Number,
				Approval_Date = @Approval_Date,
				Number_Of_Positions = @Number_Of_Positions,
				Created = GETDATE()
			WHERE Msk_Kex_AdvertlistchangelogID = @Uj_msk_kex_advertlistchangelogID
		END

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msp_kex_gdpr_feltoltes.sql =====

CREATE PROCEDURE [dbo].[msp_kex_gdpr_feltoltes] @JelentkezoID INT
AS
BEGIN
					DECLARE @updated TINYINT = ISNULL((SELECT TOP 1 Updated FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID),0)

					IF (SELECT nev FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) <> '' --AND @updated < 1)
					  BEGIN																	 	
					  	INSERT INTO dbo.msk_log
						(
							name,
							value,
							created
						)
						VALUES
						(   'tigger',           -- name - varchar(100)
							CONCAT(@JelentkezoID,@updated),           -- value - varchar(max)
							SYSDATETIME() -- created - datetime2(7)
							)

						/*Jelentkezõk Hash kitötltése és GDPR tábla feltöltése - az INSERT triggeren lévõ UPDATE utasítás hivja meg a tábla feltöltését*/
						declare @idallasajanlat INT = (SELECT TOP 1 idallasajanlat FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @allasDeleted TINYINT = (Select top 1 Deleted FROM msk_kex_allasajanlatok where msk_kex_allasajanlatokID = @idallasajanlat)
						declare @iddrupal INT = (SELECT TOP 1 iddrupal FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @targy varchar(255) = (SELECT top 1 targy FROM msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@idallasajanlat)
						declare @hp_torzsszam varchar(10) = (SELECT top 1 toborzo_torzsszam FROM msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID=@idallasajanlat)
						declare @hp_nev varchar(255) = (SELECT top 1 p.Name FROM People p LEFT JOIN msk_kex_allasajanlatok a ON p.PERNR = a.toborzo_torzsszam WHERE a.msk_kex_allasajanlatokID=@idallasajanlat)
						declare @nev varchar(255) = (SELECT TOP 1 nev FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @email varchar(255) = (SELECT TOP 1 email FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @telefonszam varchar(50) = (SELECT TOP 1 telefonszam FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából 
						declare @cvlink varchar(2000) = (SELECT TOP 1 cvlink FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából 
						declare @cvtartalom varchar(max) =  (SELECT TOP 1 cvtartalom FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából 
						declare @gdpr tinyint = (SELECT TOP 1 gdpr FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából 
						DECLARE @ajanlo_nev varchar(255) = (SELECT TOP 1 ajanlo_nev FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @datum datetime2(7) = (SELECT TOP 1 datum FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @honnanertesult varchar(255) = (SELECT TOP 1 honnanertesult FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @Deleted tinyint = (SELECT TOP 1 deleted FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						declare @cvlinkid INT = (SELECT TOP 1 cvlinkid FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @jelentkezesi INT = (SELECT TOP 1 JelentkezesiDokID FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @adatkezelesi INT = (SELECT TOP 1 AdatkezelesiDokID FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @motivacios INT = (SELECT TOP 1 MotivaciosDokID FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @munkavallaloi INT = (SELECT TOP 1 MunkavallaloiDokID FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @MAPCompany VARCHAR(10) = (SELECT TOP 1 MAPCompany FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @map_beerkezes DATE = (SELECT TOP 1 map_beerkezes FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @idmap_dokumentacio INT = (SELECT TOP 1 idmap_dokumentacio FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @megorzesi_ido INT = (SELECT TOP 1 [FAS].[CodeValue] FROM [dbo].[FSYS_ApplicationSetup] [FAS] WHERE [FAS].[Code]='GDPR_megorzesi_ido' AND [FAS].[Deleted]=0 ORDER BY 1 DESC)
						DECLARE @gdpr_vege DATE = (SELECT TOP 1 IIF(@iddrupal = -1, gdpr_vege, DATEADD(YEAR,@megorzesi_ido,@datum)) FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából						
						DECLARE @MAPEmail VARCHAR(255) = (SELECT TOP 1 MAPEmail FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @map_hatarido DATE = (SELECT TOP 1 map_hatarido FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @MAPPeopleID VARCHAR(10) = (SELECT TOP 1 MAPPeopleID FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @MAPAjanloszelvenyForrasa INT = (SELECT TOP 1 MAPAjanloszelvenyForrasa FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából
						DECLARE @MAPErvenyes BIT = (SELECT TOP 1 MAPErvenyes FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) --dbo.msk_kex_jelentkezok táblából

						--hashID
						--DECLARE @emailcc VARCHAR(255) = @email 
						IF ISNULL(@cvlinkid,0) > 0
							SET @updated = @updated + 1

						DECLARE @idceg INT = (SELECT TOP 1 a.idceg FROM dbo.msk_kex_jelentkezok i LEFT JOIN dbo.msk_kex_allasajanlatok a ON a.msk_kex_allasajanlatokID=i.idallasajanlat WHERE msk_kex_jelentkezokID=@JelentkezoID) --aktuális ajánlathoz tartozó idceg
						DECLARE @aktualis_Hash VARBINARY(100) = [dbo].[msk_kex_get_hash](@email,@idceg)	-- aktuális "email+|+cegid" hash kód. Ez biztosítja a vállalatonkénti egyediséget a gdpr táblában
						DECLARE @aktualis_HashID INT = (SELECT TOP 1 Msk_kex_hashID FROM dbo.msk_kex_hash WHERE Hash=@aktualis_Hash AND Deleted=0) --aktuális aktív email hashID
						
						DECLARE @oldhashid INT = (SELECT TOP 1 hashid FROM dbo.msk_kex_jelentkezok WHERE msk_kex_jelentkezokID=@JelentkezoID) 
						if ISNULL(@oldhashid,0)=0 AND isnull(dbo.msk_kex_getSetup('AK10109'),'')='' begin
							declare @cnt int = (select cnt from dbo.msk_kex_jelentkezesek where hash=@aktualis_Hash and deleted=0)		
							if isnull(@cnt,0)>0 begin
								EXEC dbo.msk_log_insert @Name = 'AK10109', -- varchar(max)
								                        @Value = @cnt -- varchar(max)
								
								update dbo.msk_kex_jelentkezesek set cnt=@cnt+1 where hash=@aktualis_Hash
							END ELSE begin																						
								EXEC dbo.msk_log_insert @Name = 'AK10109', -- varchar(max)
								                        @Value = @cnt -- varchar(max)
								
								INSERT INTO dbo.msk_kex_jelentkezesek (cnt,Hash,Deleted) values (1,@aktualis_Hash,0)
							END
                            END
					
							IF @aktualis_HashID > 0 --van-e ilyen aktív hash a hash táblában
								BEGIN
									IF @gdpr = 1
										BEGIN
											SET @aktualis_HashID = (SELECT TOP 1 Msk_kex_hashID FROM dbo.msk_kex_hash WHERE Hash=@aktualis_Hash AND Deleted=0)
										END
									ELSE
										BEGIN
											INSERT INTO msk_kex_hash (Hash, Deleted) VALUES (@aktualis_Hash, 1)
											SET @aktualis_HashID = SCOPE_IDENTITY()
										END
								END

							IF ISNULL(@aktualis_HashID,0) = 0
								BEGIN
									IF @gdpr = 1
										BEGIN
											INSERT INTO msk_kex_hash (Hash, Deleted) VALUES (@aktualis_Hash, 0)
											SET @aktualis_HashID = SCOPE_IDENTITY()
										END
									ELSE
										BEGIN
											INSERT INTO msk_kex_hash (Hash, Deleted) VALUES (@aktualis_Hash, 1)
											SET @aktualis_HashID = SCOPE_IDENTITY()
										END
								END
							
							/*Jelentkezõk Hash kitöltése vége*/

							--fenti számítások futtatása
							UPDATE dbo.msk_kex_jelentkezok SET HashID=@aktualis_HashID, Updated = @updated, targy=@targy, hp_torzsszam=@hp_torzsszam, hp_nev=@hp_nev, gdpr_vege=@gdpr_vege
									WHERE msk_kex_jelentkezokID = @JelentkezoID
					
						END

						/*GDPR tábla töltése*/
	
						IF @allasDeleted = 0
							BEGIN
							  IF @gdpr = 1
								BEGIN
--									IF (@iddrupal IS NULL OR @iddrupal = 0) --nem az interfészen jön át
--										BEGIN
											IF EXISTS(SELECT HashID FROM dbo.msk_kex_gdpr_jelentkezok WHERE Deleted=0 AND HashID=@aktualis_HashID)
												BEGIN
													UPDATE msk_kex_gdpr_jelentkezok SET idallasajanlat=@idallasajanlat,iddrupal=@iddrupal,targy=@targy,
															nev=@nev,telefonszam=@telefonszam,cvlink=@cvlink,cvtartalom=@cvtartalom,gdpr=@gdpr,datum=@datum,honnanertesult=@honnanertesult,Deleted=@Deleted,
															cvlinkid=@cvlinkid,JelentkezesiDokID=@jelentkezesi,AdatkezelesiDokID=@adatkezelesi,MotivaciosDokID=@motivacios,
															HashID=@aktualis_HashID, gdpr_vege=@gdpr_vege, map_beerkezes=@map_beerkezes
													WHERE Deleted=0 AND HashID = @aktualis_HashID

													/* MAP modul bevezétésénél módosúlt a mûködés */
													--IF ((SELECT ISNULL(ajanlo_nev,'') FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID=@aktualis_HashID AND Deleted=0) = 'xxx' 
													--	OR (SELECT ISNULL(ajanlo_nev,'') FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID=@aktualis_HashID AND Deleted=0) = '')
													--	OR
													--	((SELECT ISNULL(ajanlo_nev,'') FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID=@aktualis_HashID AND Deleted=0) <> 'xxx' 
													--	AND (SELECT ISNULL(ajanlo_nev,'') FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID=@aktualis_HashID AND Deleted=0) <> ''
													--	AND (SELECT ISNULL(MunkavallaloiDokID,0) FROM dbo.msk_kex_gdpr_jelentkezok WHERE HashID=@aktualis_HashID AND Deleted=0) = 0)
													--	UPDATE msk_kex_gdpr_jelentkezok SET ajanlo_nev=@ajanlo_nev,MunkavallaloiDokID=@munkavallaloi,map_beerkezes=@map_beerkezes,idmap_dokumentacio=@idmap_dokumentacio
													--	WHERE Deleted=0 AND HashID = @aktualis_HashID

													INSERT INTO dbo.msk_log VALUES('GDPR=1 benne volt a gdpr táblában',CONCAT('HashID:',@aktualis_HashID, '-jelentkezoID:', @JelentkezoID, '-cvlinkid:', @cvlinkid),SYSDATETIME())
												END
											ELSE
												BEGIN
													INSERT INTO msk_kex_gdpr_jelentkezok (idallasajanlat,iddrupal,targy,nev,email,telefonszam,cvlink,cvtartalom,gdpr,ajanlo_nev,datum,honnanertesult,Deleted,cvlinkid,JelentkezesiDokID,AdatkezelesiDokID,MotivaciosDokID,MunkavallaloiDokID,HashID,gdpr_vege,MAPCompany,map_beerkezes,idmap_dokumentacio,MAPEmail,map_hatarido,MAPPeopleID,MAPAjanloszelvenyForrasa,MAPErvenyes)
													VALUES (@idallasajanlat,@iddrupal,@targy,@nev,@email,@telefonszam,@cvlink,@cvtartalom,@gdpr,@ajanlo_nev,@datum,@honnanertesult,@Deleted,@cvlinkid,@jelentkezesi,@adatkezelesi,@motivacios,@munkavallaloi,@aktualis_HashID,@gdpr_vege,@MAPCompany,@map_beerkezes,@idmap_dokumentacio,@MAPEmail,@map_hatarido,@MAPPeopleID,@MAPAjanloszelvenyForrasa,@MAPErvenyes)
													INSERT INTO dbo.msk_log VALUES('GDPR=1 nem nem volt benne a gdpr táblában',CONCAT('HashID:',@aktualis_HashID, '-jelentkezoID:', @JelentkezoID, '-cvlinkid:', @cvlinkid),SYSDATETIME())
												END
--										END
									--ELSE
									--	BEGIN
									--		INSERT INTO msk_kex_gdpr_jelentkezok (idallasajanlat,iddrupal,targy,hp_torzsszam,hp_nev,nev,email,telefonszam,cvlink,cvtartalom,gdpr,ajanlo_nev,datum,honnanertesult,Deleted,cvlinkid,JelentkezesiDokID,AdatkezelesiDokID,MotivaciosDokID,MunkavallaloiDokID,HashID)
									--		VALUES (@idallasajanlat,@iddrupal,@targy,@hp_torzsszam,@hp_nev,@nev,@email,@telefonszam,@cvlink,@cvtartalom,@gdpr,@ajanlo_nev,@datum,@honnanertesult,@Deleted,@cvlinkid,@jelentkezesi,@adatkezelesi,@motivacios,@munkavallaloi,@aktualis_HashID)
									--	END
								END
							ELSE
								BEGIN
								 INSERT INTO dbo.msk_log VALUES('GDPR=0',CONCAT('HashID:',@aktualis_HashID, '-jelentkezoID:', @JelentkezoID, '-cvlinkid:', @cvlinkid),SYSDATETIME())
								END

						END
						
						/*GDPR tábla feltötlés vége*/
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\msp_kex_szum_osszefoglaloriport.sql =====

CREATE PROCEDURE [dbo].[msp_kex_szum_osszefoglaloriport] @AllasID INT = NULL
                                                      , @tol DATETIME
                                                      , @ig DATETIME
AS
BEGIN
	DROP TABLE IF EXISTS #ttszum

    CREATE TABLE #ttszum (
                             [AllasID] INT NOT NULL
                           , [jfo] INT NULL
                           , [CVmegfelelt] INT NULL
                           , [ifo] INT NULL
                           , [tfo] INT NULL
                           , [osszesinterju] INT NULL
                           , [ofo] INT NULL
                           , [oefo] INT NULL
                           , [omfo] INT NULL
                           , [offo] INT NULL
                           , [afo] INT NULL
                           , [adatum] DATE NULL
                           , [aefo] INT NULL
                           , [vfo] INT NULL
                           , [efo] INT NULL
                           , [kezdettfo] INT NULL
                           , PRIMARY KEY ( [AllasID] )
                         )

    INSERT INTO #ttszum ( [AllasID], [jfo], [CVmegfelelt] )
                SELECT [j].[idallasajanlat]
                     , COUNT( * ) [jfo]
                     , SUM(   CASE
                                   WHEN [j].[idcv_toborzo] IN ( 1, 3 ) THEN 1
                                   ELSE 0
                              END
                          ) [CVmegfelelt]
                FROM [dbo].[msk_kex_jelentkezok] [j]
                WHERE (
                          (
                              @AllasID IS NOT NULL AND [j].[idallasajanlat] = @AllasID
                          ) OR ( @AllasID IS NULL )
                      ) AND [j].[datum] BETWEEN @Tol AND @Ig AND [j].[Deleted] IN ( 0, 1 )
					  AND j.msk_kex_jelentkezokID NOT IN (SELECT JelentkezokID FROM dbo.msk_kex_teszt_jelentkezok)
                GROUP BY [j].[idallasajanlat]

    UPDATE [tsz]
    SET [ifo] = [tsz1].[ifo]
      , [osszesinterju] = [tsz1].[osszesinterju]
    FROM #ttszum [tsz]
        INNER JOIN (
                       SELECT [j].[idallasajanlat]
                            , COUNT( * ) [ifo]
                            , COUNT( * ) [osszesinterju]
                       FROM #ttszum [tsz]
                           INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [tsz].[AllasID] = [j].[idallasajanlat] AND [j].[datum] BETWEEN @Tol AND @Ig
                           INNER JOIN [dbo].[msk_kex_interju] [i] ON [i].[idjelentkezo] = [j].[msk_kex_jelentkezokID] AND [i].[Deleted] = 0
                       GROUP BY [j].[idallasajanlat]
                   ) [tsz1] ON [tsz].[AllasID] = [tsz1].[idallasajanlat]

    UPDATE [tsz]
    SET [tfo] = [tsz1].[tfo]
    FROM #ttszum [tsz]
        INNER JOIN (
                       SELECT [j].[idallasajanlat]
                            , COUNT( * ) [tfo]
                       FROM #ttszum [tsz]
                           INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [tsz].[AllasID] = [j].[idallasajanlat] AND [j].[datum] BETWEEN @Tol AND @Ig
                           INNER JOIN [dbo].[msk_kex_teszt] [t] ON [t].[idjelentkezo] = [j].[msk_kex_jelentkezokID] AND [t].[Deleted] = 0
                       GROUP BY [j].[idallasajanlat]
                   ) [tsz1] ON [tsz].[AllasID] = [tsz1].[idallasajanlat]

    UPDATE [tsz]
    SET [ofo] = [tsz1].[ofo]
      , [oefo] = [tsz1].[oefo]
      , [omfo] = [tsz1].[omfo]
      , [offo] = [tsz1].[offo]
    FROM #ttszum [tsz]
        INNER JOIN (
                       SELECT [j].[idallasajanlat]
                            , COUNT( * ) [ofo]
                            , SUM(   CASE
                                          WHEN [o].[idelkezdte] = 4 THEN 1
                                          ELSE 0
                                     END
                                 ) [oefo]
                            , SUM(   CASE
                                          WHEN [o].[ideredmeny] = 4 THEN 1
                                          ELSE 0
                                     END
                                 ) [omfo]
                            , SUM(   CASE
                                          WHEN [o].[ideredmeny] = 4 AND ISNULL( [o].[ideredmeny], 0 ) = 0 THEN 1
                                          ELSE 0
                                     END
                                 ) [offo]
                       FROM #ttszum [tsz]
                           INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [tsz].[AllasID] = [j].[idallasajanlat] AND [j].[datum] BETWEEN @Tol AND @Ig
                           INNER JOIN [dbo].[msk_kex_orvosi] [o] ON [o].[idjelentkezo] = [j].[msk_kex_jelentkezokID] AND [o].[Deleted] = 0
                       GROUP BY [j].[idallasajanlat]
                   ) [tsz1] ON [tsz].[AllasID] = [tsz1].[idallasajanlat]

    UPDATE [tsz]
    SET [afo] = [tsz1].[afo]
      , [adatum] = [tsz1].[adatum]
      , [aefo] = [tsz1].[aefo]
    FROM #ttszum [tsz]
        INNER JOIN (
                       SELECT [j].[idallasajanlat]
                            , COUNT( * ) [afo]
                            , MAX( [a].[datum] ) [adatum]
                            , SUM(   CASE
                                          WHEN [a].[idelfogadva] = 4 THEN 1
                                          ELSE 0
                                     END
                                 ) [aefo]
                       FROM #ttszum [tsz]
                           INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [tsz].[AllasID] = [j].[idallasajanlat] AND [j].[datum] BETWEEN @Tol AND @Ig
                           INNER JOIN [dbo].[msk_kex_ajanlat] [a] ON [a].[idjelentkezo] = [j].[msk_kex_jelentkezokID] AND [a].[Deleted] = 0
                       GROUP BY [j].[idallasajanlat]
                   ) [tsz1] ON [tsz].[AllasID] = [tsz1].[idallasajanlat]

    UPDATE [tsz]
    SET [vfo] = [tsz1].[vfo]
      , [efo] = [tsz1].[efo]
      , [kezdettfo] = [tsz1].[kezdettfo]
    FROM #ttszum [tsz]
        INNER JOIN (
                       SELECT [j].[idallasajanlat]
                            , SUM(   CASE
                                          WHEN [MKF].[Idfelvstatusz] = 8 THEN 1
                                          ELSE 0
                                     END
                                 ) [vfo]
                            , SUM(   CASE
                                          WHEN [MKF].[Idfelvstatusz] = 7 THEN 1
                                          ELSE 0
                                     END
                                 ) [efo]
                            , SUM(   CASE
                                          WHEN [MKF].[Idfelvstatusz] = 6 THEN 1
                                          ELSE 0
                                     END
                                 ) [kezdettfo]
                       FROM #ttszum [tsz]
                           INNER JOIN [dbo].[msk_kex_jelentkezok] [j] ON [tsz].[AllasID] = [j].[idallasajanlat] AND [j].[datum] BETWEEN @Tol AND @Ig
                           INNER JOIN [dbo].[msk_kex_AktualisFelveteliStatusz] [MKF] ON [MKF].[Idjelentkezo] = [j].[msk_kex_jelentkezokID] AND [MKF].[Deleted] = 0
                       GROUP BY [j].[idallasajanlat]
                   ) [tsz1] ON [tsz].[AllasID] = [tsz1].[idallasajanlat]


                SELECT [TS].[AllasID]
                     , ISNULL( [TS].[jfo], 0 ) [jfo]
                     , [TS].[CVmegfelelt]
                     , ISNULL( [TS].[ifo], 0 ) [ifo]
                     , ISNULL( [TS].[tfo], 0 ) [tfo]
                     , ISNULL( [TS].[osszesinterju], 0 ) [osszesinterju]
                     , ISNULL( [TS].[ofo], 0 ) [ofo]
                     , ISNULL( [TS].[oefo], 0 ) [oefo]
                     , ISNULL( [TS].[omfo], 0 ) [omfo]
                     , ISNULL( [TS].[offo], 0 ) [offo]
                     , ISNULL( [TS].[afo], 0 ) [afo]
                     , [TS].[adatum]
                     , ISNULL( [TS].[aefo], 0 ) [aefo]
                     , ISNULL( [TS].[vfo], 0 ) [vfo]
                     , ISNULL( [TS].[efo], 0 ) [efo]
                     , ISNULL( [TS].[kezdettfo], 0 ) [kezdettfo]
                FROM #ttszum [TS]

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\osp_kex_wrk_WS_PublishAllasraJelentkezes_1.sql =====

CREATE PROCEDURE [dbo].[osp_kex_wrk_WS_PublishAllasraJelentkezes]
	@Guid varchar(42)
AS
BEGIN
	declare
		@EntitasVerzio varchar(20),
		@SAPID int,
		@DrupID int,
		@AdName varchar(300),
		@HPNr varchar(10),
		@HPName varchar(300),
		@CanName varchar(300),
		@CanEmail varchar(300),
		@CanPhone varchar(60),
		@CanCVLink varchar(300),
		@StatGDPR bit,
		@MAPName varchar(300),
		@WhereFrom varchar(300),
		@AppDate datetime,
		@GrSalary int,
		@MAPCompany varchar(20)

	/* Collect new IDs */
	DECLARE @IDs TABLE
	(
		 [ID] INT
		,[Link] VARCHAR(MAX)
	)

	declare jelentkezoCursor cursor local forward_only fast_forward read_only for
		select
			ajl.EntitasVerzio, 
			cast(ajl.SAPID as int), 
			cast(ajl.DrupID as int), 
			left(ajl.AdName, 255), 
			left(ajl.HPNr, 10), 
			left(ajl.HPName, 255), 
			left(ajl.CanName, 255), 
			left(ajl.CanEmail, 255), 
			left(ajl.CanPhone, 50), 
			left(ajl.CanCVLink, 2000), 
			ajl.StatGDPR, 
			left(ajl.MAPName, 255), 
			left(ajl.WhereFrom, 255), 
			cast(ajl.AppDate as datetime2(7)),
			cast(ajl.GrSalary as int),
			left(ajl.MAPCompany, 10)
		from
			orn_kex_LandingZone_AllasraJelentkezes aj with(readpast)
		join
			orn_kex_LandingZone_AllasraJelentkezesLista ajl with(readpast)
				on ajl.Deleted = 0 and aj.AllasraJelentkezesID = ajl.AllasraJelentkezesID
		where
			aj.Deleted = 0 and aj.GUID = @Guid
		
	open jelentkezoCursor

	fetch next from 
		jelentkezoCursor 
	into 
		@EntitasVerzio,
		@SAPID,
		@DrupID,
		@AdName,
		@HPNr,
		@HPName,
		@CanName,
		@CanEmail,
		@CanPhone,
		@CanCVLink,
		@StatGDPR,
		@MAPName,
		@WhereFrom,
		@AppDate,
		@GrSalary,
		@MAPCompany

	while @@fetch_status <> -1
	begin
		insert
			msk_kex_jelentkezok (idallasajanlat, iddrupal, targy, hp_torzsszam, hp_nev, nev, email, telefonszam, cvlink, gdpr, ajanlo_nev, datum, honnanertesult, Deleted, berigeny, MAPCompany)
		select 
			@SAPID,
			@DrupID,
			@AdName,
			@HPNr,
			@HPName,
			@CanName,
			@CanEmail,
			@CanPhone,
			@CanCVLink,
			@StatGDPR,
			@MAPName,
			@AppDate,
			@WhereFrom,
			0,
			@GrSalary,
			@MAPCompany
			
		/* Collect new IDs */
		INSERT INTO @IDs ([ID], [Link]) VALUES (SCOPE_IDENTITY(), @CanCVLink)
			
		--if isnull(@StatGDPR, 0) <> 0
		--begin
		--	insert
		--		msk_kex_gdpr_jelentkezok (idallasajanlat, iddrupal, targy, hp_torzsszam, hp_nev, nev, email, telefonszam, cvlink, gdpr, ajanlo_nev, datum, honnanertesult, Deleted)
		--	select
		--		@SAPID,
		--		@DrupID,
		--		@AdName,
		--		@HPNr,
		--		@HPName,
		--		@CanName,
		--		@CanEmail,
		--		@CanPhone,
		--		@CanCVLink,
		--		@StatGDPR,
		--		@MAPName,
		--		@AppDate,
		--		@WhereFrom,
		--		0
		--end --end of instert of new gdpr data
		fetch next from 
			jelentkezoCursor 
		into 
			@EntitasVerzio,
			@SAPID,
			@DrupID,
			@AdName,
			@HPNr,
			@HPName,
			@CanName,
			@CanEmail,
			@CanPhone,
			@CanCVLink,
			@StatGDPR,
			@MAPName,
			@WhereFrom,
			@AppDate,
			@GrSalary,
			@MAPCompany
	end --end of fetch of IF data
	close jelentkezoCursor
	deallocate jelentkezoCursor

	/* Collect new IDs */
	SELECT [ID], [Link] FROM @IDs
END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\osp_szi_wrk_kex_allasajanlatok_CheckDuplicate.sql =====



/*Létrehozta:	Gulyás Dóra
				2019.05.27.
				Karrier Excel állásajánlatokID ellenõrzése, hogy csak 1 legyen a táblában.
*/

--------------------------------------------------
CREATE PROCEDURE [dbo].[osp_szi_wrk_kex_allasajanlatok_CheckDuplicate] 
AS BEGIN
	SET NOCOUNT ON
	

--Duplikált ID-k kinyerése
DECLARE @tmp_Duplikalt_msk_kex_allasajanlatokID TABLE(
msk_kex_allasajanlatokID VARCHAR(250)
)

--Lementjük temptáblákba a kinyert ID-kat, hogy máshol is lehessen használni
insert into @tmp_Duplikalt_msk_kex_allasajanlatokID
select msk_kex_allasajanlatokID
from msk_kex_allasajanlatok
where Deleted=0
group by msk_kex_allasajanlatokID
having count(msk_kex_allasajanlatokID)>1

DECLARE @TEMP TABLE (
		command VARCHAR(max)
		)
		declare @Comm varchar(max)

		;WITH cteMaxDate AS (
			SELECT msk_kex_allasajanlatokID, Deleted, Created, 
				   ROW_NUMBER() OVER(PARTITION BY msk_kex_allasajanlatokID ORDER BY created DESC) AS RowNum
				from msk_kex_allasajanlatok
				where Deleted=0 and msk_kex_allasajanlatokID in (select msk_kex_allasajanlatokID from @tmp_Duplikalt_msk_kex_allasajanlatokID )
		)
		INSERT INTO @TEMP
		SELECT 'update msk_kex_allasajanlatok set Deleted=1 output inserted.msk_kex_allasajanlatokID, deleted.Deleted, inserted.Deleted into msk_kex_allasajanlatok_log (msk_kex_allasajanlatokID,Deleted_old,Deleted_new) where msk_kex_allasajanlatokID=' + cast(msk_kex_allasajanlatokID as varchar(250)) + ' and Deleted=0 and Created!='''+(SELECT cast(convert(varchar(25), Created, 121) as varchar(250)))+''' '
		FROM cteMaxDate
		WHERE RowNum = 1;

		SET @Comm = (
					SELECT DISTINCT ' ' + cast(command AS VARCHAR(max))
					FROM @TEMP
					FOR XML PATH('')
					)

		EXECUTE (@Comm)
		--select @Comm


END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Stored Procedures\osp_szi_wrk_kex_allasajanlatok_Insert_1.sql =====


/*Létrehozta:	Gulyás Dóra
				2018.08.25.
				Karrier Excel állásajánlatok eltárolása Landing Zone táblából.
				2.VERZIÓ
*/

--------------------------------------------------
CREATE PROCEDURE [dbo].[osp_szi_wrk_kex_allasajanlatok_Insert] (
    @GUID VARCHAR(100)	
)
AS BEGIN
	SET NOCOUNT ON
	

	DECLARE --@InsertedRows INT = 0,
			--@UpdatedRows INT = 0,
			@Error varchar(100) = '',
			@Success bit =0 
			--@CountToInsert INT = 0,
			--@CountToUpdate INT = 0

--Biztonsági mentés
	DECLARE @tmp_msk_kex_allasajanlatok TABLE
   (   
	[msk_kex_allasajanlatokID] [int] NULL,
	[uzletag] [varchar](100) NULL,
	[targy] [varchar](255) NULL,
	[leiras] [varchar](max) NULL,
	[hely] [varchar](255) NULL,
	[idkategoria] [int] NULL,
	[idceg] [int] NULL,
	[reszleg] [varchar](255) NULL,
	[elvarasok] [varchar](max) NULL,
	[elonytjelent] [varchar](max) NULL,
	[juttatasok] [varchar](max) NULL,
	[datum_aktivalas] [date] NULL,
	[datum_lejarat] [date] NULL,
	[szerzodes_fajta] [varchar](255) NULL,
	[foglalkoztatasi_fok] [varchar](50) NULL,
	[poziciok_szama] [int] NULL,
	[munkavegzes_helye] [varchar](255) NULL,
	[feladatok] [varchar](max) NULL,
	[tovabbi_info] [varchar](max) NULL,
	[toborzo_info] [varchar](max) NULL,
	[toborzo_torzsszam] [varchar](10) NULL,
	[vallalat] [varchar](3) NULL,
	[igazgatosag] [varchar](4) NULL,
	[munkakor_csoport] [varchar](4) NULL,
	[kepzes_fajta] [varchar](4) NULL,
	[kepzes_szakirany] [varchar](4) NULL,
	[szak] [varchar](255) NULL,
	[idegen_nyelv] [varchar](max) NULL,
	[informatika] [varchar](max) NULL,
	[szakmai_tapasztalat] [varchar](max) NULL,
	[jogositvany] [varchar](max) NULL,
	[link] [varchar](2000) NULL,
	[toborzo_feluliras_flag] [tinyint] NULL,
	[idszin] [int] NULL,
	[idtoborzo1] [int] NULL,
	[idtoborzo2] [int] NULL,
	[idvezeto] [int] NULL,
	[datum_tanfolyam] [date] NULL,
	[idtanfolyamhely] [int] NULL,
	[idtanfolyamtipus] [int] NULL,
	[datum_lezaras] [date] NULL,
	[aktiv] [tinyint] NULL,	
	[datum_tanfolyam_szoveges] [nchar](7) NULL,
	[min_tapasztalat] [int] NULL,
	[min_vegzettseg] [int] NULL,
	[vezetoi_engedely] [bit] NULL,
	[alt_ceg_nev] [varchar](50) NULL,
	[alt_email] [varchar](50) NULL,
	[alt_telefon] [varchar](50) NULL,
	[ceg_elrejtese] [bit] NULL,
	[jelentkezes_gomb] [bit] NULL,
	[idfogado] [int] NULL,
	[toborzo_email] [varchar](255) NULL,
	[toborzo_felvado] [varchar](255) NULL,
	[map_job] [int] NULL,
	[cv] [int] NULL,
	[kvalifikacio] [varchar](255) NULL,
	[engedely_iktatoszama] [varchar](255) NULL,
	[engedely_datuma] [date] NULL,
	[pozicio_szama] [int] NULL,
	[Deleted] [tinyint] NULL,
	[idmunkaltato] [int] NULL
   ) 

   INSERT INTO @tmp_msk_kex_allasajanlatok
   SELECT 	[msk_kex_allasajanlatokID],
	[uzletag],
	[targy],
	[leiras],
	[hely],
	[idkategoria],
	[idceg],
	[reszleg],
	[elvarasok],
	[elonytjelent],
	[juttatasok],
	[datum_aktivalas],
	[datum_lejarat],
	[szerzodes_fajta],
	[foglalkoztatasi_fok],
	[poziciok_szama],
	[munkavegzes_helye],
	[feladatok],
	[tovabbi_info],
	[toborzo_info],
	[toborzo_torzsszam],
	[vallalat],
	[igazgatosag],
	[munkakor_csoport],
	[kepzes_fajta],
	[kepzes_szakirany],
	[szak],
	[idegen_nyelv],
	[informatika],
	[szakmai_tapasztalat],
	[jogositvany],
	[link],
	[toborzo_feluliras_flag],
	[idszin],
	[idtoborzo1],
	[idtoborzo2],
	[idvezeto],
	[datum_tanfolyam],
	[idtanfolyamhely],
	[idtanfolyamtipus],
	[datum_lezaras],
	[aktiv],	
	[datum_tanfolyam_szoveges],
	[min_tapasztalat],
	[min_vegzettseg],
	[vezetoi_engedely],
	[alt_ceg_nev],
	[alt_email],
	[alt_telefon],
	[ceg_elrejtese],
	[jelentkezes_gomb],
	[idfogado],
	[toborzo_email],
	[toborzo_felvado],
	[map_job],
	[cv],
	[kvalifikacio],
	[engedely_iktatoszama],
	[engedely_datuma],
	[pozicio_szama],
	[Deleted],
	[idmunkaltato]
	FROM msk_kex_allasajanlatok WITH (NOLOCK)

	--SET @CountToUpdate =
	--	(
	--	SELECT COUNT(*)
	--	FROM orn_kex_LandingZone_WebAdverts wa
	--		INNER JOIN orn_kex_LandingZone_AdvertList al on wa.WebAdvertsID = al.WebAdvertsID
	--		LEFT JOIN orn_kex_LandingZone_Qualifications q on q.AdvertListID = al.AdvertListID and q.Deleted = 0
	--		INNER JOIN msk_kex_allasajanlatok ka on al.AdvertID = ka.msk_kex_allasajanlatokID
	--	WHERE [GUID]=@GUID and wa.Deleted=0 and al.Deleted = 0 and ka.Deleted = 0
	--	)

	--SET @CountToInsert =
	--	(
	--	SELECT COUNT(*)
	--	FROM orn_kex_LandingZone_WebAdverts wa
	--		INNER JOIN orn_kex_LandingZone_AdvertList al on wa.WebAdvertsID = al.WebAdvertsID
	--		LEFT JOIN orn_kex_LandingZone_Qualifications q on q.AdvertListID = al.AdvertListID and q.Deleted = 0
	--		LEFT JOIN msk_kex_allasajanlatok ka on al.AdvertID = ka.msk_kex_allasajanlatokID and ka.Deleted=0
	--	WHERE [GUID]=@GUID and wa.Deleted=0 and al.Deleted = 0 and ka.msk_kex_allasajanlatokID is null
	--	)

	begin try

	--Frissítés
		UPDATE msk_kex_allasajanlatok 
		SET
		[uzletag] = al.Company,
		[targy] = al.title,
		[leiras] = al.[Description],
		[hely] = al.Locations,
		[idkategoria] = al.Categories,
		[idceg] = al.CompanyID,
		[reszleg] = al.Department,
		[elvarasok] = al.Requirements,
		[elonytjelent] = al.Qualities,
		[juttatasok] = al.Benefits,
		[datum_aktivalas] =  cast(substring(REPLACE(al.Activation_Date, ' ', ''), 1,10) as date),
		[datum_lejarat] = cast(substring(REPLACE(al.Expiraton_Date, ' ', ''), 1,10) as date),
		[szerzodes_fajta] = al.[Contract],
		[foglalkoztatasi_fok] = al.Schedule,
		[poziciok_szama] = al.Number_Of_Positions,
		[munkavegzes_helye] = al.Work_Location,
		[feladatok] = al.Tasks,
		[tovabbi_info] = al.Additional_Info,
		[toborzo_info] = al.Recruiter_Info,
		[toborzo_torzsszam] = al.Recruiter_ID,
		[toborzo_email] = al.Recruiter_Email,
		[toborzo_felvado] = SUBSTRING(al.Recruiter_Felvado, 0, 255),
		[map_job] = al.Map_Job,
		[cv] = al.CV,
		[vallalat] = al.Subsidiary,
		[igazgatosag] = al.Industry,
		[munkakor_csoport] = al.Hierarchy_Level,
		[kepzes_fajta] = al.Education_Type,
		[kepzes_szakirany] = al.Education_Field,
		[szak] = al.Field_Of_Study,
		-- [kvalifikacio] = ISNULL('<LANGUAGES>' + q.Languages + '<LANGUAGES/>', '') +
		-- 	ISNULL('<ITKNOWLEDGES>' + q.ITKnowledges + '<ITKNOWLEDGES/>', '') +
		-- 	ISNULL('<MIN_EXPERIENCES>' + q.Min_Experiences + '<MIN_EXPERIENCES/>', '') +
		-- 	ISNULL('<DRIVER_LICENSES>' + q.Driver_Licenses + '<DRIVER_LICENSES/>', ''),
		[idegen_nyelv] = q.Languages,
		[informatika] = q.ITKnowledges,
		[szakmai_tapasztalat] = q.Min_Experiences,
		[jogositvany] = q.Driver_Licenses,
		[engedely_iktatoszama] = al.Reference_Number,
		[engedely_datuma] = cast(substring(REPLACE(al.Approval_Date, ' ', ''), 1,10) as date),
		[pozicio_szama] = al.Number_Of_Positions,
		[link] = al.Link,
		[vezetoi_engedely] = [al].[Driver_Licence],
		[idtoborzo1] =
			CASE
				WHEN ISNULL([toborzo_feluliras_flag], 0) <> 1
					THEN (SELECT TOP 1 [pe].[PeopleID] FROM [People] AS [pe] WITH (NOLOCK) WHERE [pe].[PERNR] = [al].[Recruiter_ID] and [pe].[Deleted]=0)
				ELSE [idtoborzo1]
			END
		--[toborzo_feluliras_flag],[idszin],[idtoborzo1],[idtoborzo2],[idvezeto],[datum_tanfolyam] ,[idtanfolyamhely],[idtanfolyamtipus],[datum_lezaras],[aktiv],[datum_tanfolyam_szoveges]
		FROM orn_kex_LandingZone_WebAdverts wa WITH (NOLOCK)
			INNER JOIN orn_kex_LandingZone_AdvertList al WITH (NOLOCK)
				on wa.WebAdvertsID = al.WebAdvertsID
			LEFT JOIN orn_kex_LandingZone_Qualifications q WITH (NOLOCK)
				on q.AdvertListID = al.AdvertListID and q.Deleted = 0
			INNER JOIN msk_kex_allasajanlatok ka WITH (NOLOCK)
				on al.AdvertID = ka.msk_kex_allasajanlatokID
		WHERE [GUID]=@GUID and wa.Deleted=0 and al.Deleted = 0 and ka.Deleted = 0

		--SET @UpdatedRows = @@ROWCOUNT

	--Beszúrás
		INSERT INTO msk_kex_allasajanlatok (
		[msk_kex_allasajanlatokID],[uzletag],[targy],[leiras],[hely],[idkategoria],[idceg],[reszleg],[elvarasok],[elonytjelent],[juttatasok],[datum_aktivalas],[datum_lejarat],[szerzodes_fajta]
		  ,[foglalkoztatasi_fok],[poziciok_szama],[munkavegzes_helye],[feladatok],[tovabbi_info],[toborzo_info],[toborzo_torzsszam],[toborzo_email],[toborzo_felvado],[map_job],[cv],[vallalat],[igazgatosag],[munkakor_csoport],[kepzes_fajta]
		  ,[kepzes_szakirany],[szak],[kvalifikacio],[idegen_nyelv],[informatika],[szakmai_tapasztalat],[jogositvany],[engedely_iktatoszama],[engedely_datuma],[pozicio_szama],[link],[Deleted]
		  ,[idtoborzo1]
		  --[toborzo_feluliras_flag],[idszin],[idtoborzo1],[idtoborzo2],[idvezeto],[datum_tanfolyam] ,[idtanfolyamhely],[idtanfolyamtipus],[datum_lezaras],[aktiv],[datum_tanfolyam_szoveges]
		  )
		output inserted.msk_kex_allasajanlatokID, inserted.Deleted into msk_kex_allasajanlatok_log (msk_kex_allasajanlatokID,Deleted_new)
		SELECT al.AdvertID, al.Company, al.title, al.[Description], al.Locations, al.Categories, al.CompanyID, al.Department, al.Requirements, al.Qualities, al.Benefits,  cast(substring(REPLACE(al.Activation_Date, ' ', ''), 1,10) as date),  cast(substring(REPLACE(al.Expiraton_Date, ' ', ''), 1,10) as date), al.[Contract],
		al.Schedule, al.Number_Of_Positions, al.Work_Location, al.Tasks, al.Additional_Info, al.Recruiter_Info, al.Recruiter_ID,al.Recruiter_Email,SUBSTRING(al.Recruiter_Felvado, 0, 255),al.Map_Job,al.CV, al.Subsidiary, al.Industry, al.Hierarchy_Level, al.Education_Type,
		al.Education_Field, al.Field_Of_Study,ISNULL('<LANGUAGES>' + q.Languages + '<LANGUAGES/>', '') +
			ISNULL('<ITKNOWLEDGES>' + q.ITKnowledges + '<ITKNOWLEDGES/>', '') +
			ISNULL('<MIN_EXPERIENCES>' + q.Min_Experiences + '<MIN_EXPERIENCES/>', '') +
			ISNULL('<DRIVER_LICENSES>' + q.Driver_Licenses + '<DRIVER_LICENSES/>', ''), q.Languages, q.ITKnowledges, q.Min_Experiences, q.Driver_Licenses,al.Reference_Number,cast(substring(REPLACE(al.Approval_Date, ' ', ''), 1,10) as date),al.Number_Of_Positions, al.Link, 0
		,(SELECT TOP 1 [pe].[PeopleID] FROM [People] AS [pe] WITH (NOLOCK) WHERE [pe].[PERNR] = [al].[Recruiter_ID] and [pe].[Deleted]=0)
		FROM orn_kex_LandingZone_WebAdverts wa WITH (NOLOCK)
			INNER JOIN orn_kex_LandingZone_AdvertList al WITH (NOLOCK)
				on wa.WebAdvertsID = al.WebAdvertsID
			LEFT JOIN orn_kex_LandingZone_Qualifications q WITH (NOLOCK)
				on q.AdvertListID = al.AdvertListID and q.Deleted = 0
			LEFT JOIN msk_kex_allasajanlatok ka WITH (NOLOCK)
				on al.AdvertID = ka.msk_kex_allasajanlatokID and ka.Deleted=0
		WHERE [GUID]=@GUID and wa.Deleted=0 and al.Deleted = 0 and ka.msk_kex_allasajanlatokID is null

		--SET @InsertedRows = @@ROWCOUNT

		exec [dbo].[osp_szi_wrk_kex_allasajanlatok_CheckDuplicate] 

		SET @Success = 1
		SELECT @Success


	end try
	begin catch
		--SET @Error = 'hiba'
		SET @Success = 0

		TRUNCATE TABLE msk_kex_allasajanlatok

		INSERT INTO msk_kex_allasajanlatok (
					[msk_kex_allasajanlatokID],[uzletag],[targy],[leiras],[hely],[idkategoria],[idceg],[reszleg],[elvarasok],[elonytjelent],[juttatasok],[datum_aktivalas],
					[datum_lejarat],[szerzodes_fajta],[foglalkoztatasi_fok],[poziciok_szama],[munkavegzes_helye],[feladatok],[tovabbi_info],[toborzo_info],[toborzo_torzsszam],
					[vallalat],[igazgatosag],[munkakor_csoport],[kepzes_fajta],[kepzes_szakirany],[szak],[idegen_nyelv],[informatika],[szakmai_tapasztalat],[jogositvany],
					[link],[toborzo_feluliras_flag],[idszin],[idtoborzo1],[idtoborzo2],[idvezeto],[datum_tanfolyam],[idtanfolyamhely],[idtanfolyamtipus],[datum_lezaras],
					[aktiv],[datum_tanfolyam_szoveges],[min_tapasztalat],[min_vegzettseg],[vezetoi_engedely],[alt_ceg_nev],[alt_email],[alt_telefon],[ceg_elrejtese],
					[jelentkezes_gomb],[idfogado],[toborzo_email],[toborzo_felvado],[map_job],[cv],[kvalifikacio],[engedely_iktatoszama],[engedely_datuma],
					[pozicio_szama],[Deleted],[idmunkaltato]
		)
		SELECT [msk_kex_allasajanlatokID],[uzletag],[targy],[leiras],[hely],[idkategoria],[idceg],[reszleg],[elvarasok],[elonytjelent],[juttatasok],[datum_aktivalas],
					[datum_lejarat],[szerzodes_fajta],[foglalkoztatasi_fok],[poziciok_szama],[munkavegzes_helye],[feladatok],[tovabbi_info],[toborzo_info],[toborzo_torzsszam],
					[vallalat],[igazgatosag],[munkakor_csoport],[kepzes_fajta],[kepzes_szakirany],[szak],[idegen_nyelv],[informatika],[szakmai_tapasztalat],[jogositvany],
					[link],[toborzo_feluliras_flag],[idszin],[idtoborzo1],[idtoborzo2],[idvezeto],[datum_tanfolyam],[idtanfolyamhely],[idtanfolyamtipus],[datum_lezaras],
					[aktiv],[datum_tanfolyam_szoveges],[min_tapasztalat],[min_vegzettseg],[vezetoi_engedely],[alt_ceg_nev],[alt_email],[alt_telefon],[ceg_elrejtese],
					[jelentkezes_gomb],[idfogado],[toborzo_email],[toborzo_felvado],[map_job],[cv],[kvalifikacio],[engedely_iktatoszama],[engedely_datuma],
					[pozicio_szama],[Deleted],[idmunkaltato]
		FROM @tmp_msk_kex_allasajanlatok

		select @Success
	end catch

	
		
	
	

END

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_advertlistchangelog_1.sql =====

CREATE TABLE [dbo].[msk_kex_advertlistchangelog] (
    [Msk_Kex_AdvertlistchangelogID] INT            IDENTITY (1, 1) NOT NULL,
    [AdvertListID]                  INT            NULL,
    [WebAdvertsID]                  INT            NULL,
    [AdvertID]                      INT NULL,
    [Company]                       VARCHAR (8000) NULL,
    [Title]                         VARCHAR (256) NULL,
    [Description]                   VARCHAR (8000) NULL,
    [Locations]                     VARCHAR (8000) NULL,
    [Categories]                    VARCHAR (8000) NULL,
    [CompanyID]                     VARCHAR (8000) NULL,
    [Department]                    VARCHAR (8000) NULL,
    [Requirements]                  VARCHAR (8000) NULL,
    [Qualities]                     VARCHAR (8000) NULL,
    [Benefits]                      VARCHAR (8000) NULL,
    [Min_Experience]                VARCHAR (8000) NULL,
    [Min_Education]                 VARCHAR (8000) NULL,
    [Driver_Licence]                VARCHAR (8000) NULL,
    [Link]                          VARCHAR (8000) NULL,
    [Activation_Date]               DATE NULL,
    [Expiraton_Date]                DATE NULL,
    [Contract]                      VARCHAR (8000) NULL,
    [Schedule]                      VARCHAR (8000) NULL,
    [Company_Name]                  VARCHAR (8000) NULL,
    [Email]                         VARCHAR (8000) NULL,
    [Phone]                         VARCHAR (8000) NULL,
    [Vacancy_NR]                    VARCHAR (8000) NULL,
    [Work_Location]                 VARCHAR (8000) NULL,
    [Hide_Company]                  VARCHAR (8000) NULL,
    [Schow_Apply_Button]            VARCHAR (8000) NULL,
    [Custom_Template_ID]            VARCHAR (8000) NULL,
    [Tasks]                         VARCHAR (8000) NULL,
    [Additional_Info]               VARCHAR (8000) NULL,
    [Recruiter_Info]                VARCHAR (8000) NULL,
    [Recruiter_ID]                  VARCHAR (8000) NULL,
    [Recruiter_Email]               VARCHAR (8000) NULL,
    [Recruiter_Felvado]             VARCHAR (8000) NULL,
    [Map_Job]                       VARCHAR (8000) NULL,
    [CV]                            VARCHAR (8000) NULL,
    [Subsidiary]                    VARCHAR (8000) NULL,
    [Industry]                      VARCHAR (8000) NULL,
    [Hierarchy_Level]               VARCHAR (8000) NULL,
    [Education_Type]                VARCHAR (8000) NULL,
    [Education_Field]               VARCHAR (8000) NULL,
    [Field_Of_Study]                VARCHAR (8000) NULL,
    [Reference_Number]              VARCHAR (8000) NULL,
    [Approval_Date]                 VARCHAR (8000) NULL,
    [Number_Of_Positions]           VARCHAR (8000) NULL,
    [Created]                       DATETIME       NULL,
    [Deleted]                       TINYINT        NULL, 
    CONSTRAINT [PK_msk_kex_advertlistchangelog(Msk_Kex_AdvertlistchangelogID)] PRIMARY KEY ([Msk_Kex_AdvertlistchangelogID])
);
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_advertlistchangelog(Created)_INCLUDE(Msk_Kex_AdvertlistchangelogID)]
    ON [dbo].[msk_kex_advertlistchangelog] ( [Created] )
    INCLUDE ( [Msk_Kex_AdvertlistchangelogID] )
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_advertlistchangelog(AdvertID)_INCLUDE(Msk_Kex_AdvertlistchangelogID,AdvertListID,Title)]
    ON [dbo].[msk_kex_advertlistchangelog] ( [AdvertID] )
    INCLUDE ( [Msk_Kex_AdvertlistchangelogID], [AdvertListID], [Title], [Activation_Date], [Expiraton_Date] )
GO


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_ajanlat.sql =====

CREATE TABLE [dbo].[msk_kex_ajanlat] (
    [msk_kex_ajanlatID]     INT IDENTITY (1, 1) NOT NULL,
    [idjelentkezo]          INT NULL,
    [datum]                 DATE NULL,
    [idelfogadva]           INT NULL,
    [idtovabbi_egyeztetes]  INT NULL,
    [Deleted]               TINYINT NULL,
    [PozicioID]             INT NULL, 
    [PozicioIDLast]         INT NULL
    CONSTRAINT [PK_msk_kex_ajanlat] PRIMARY KEY CLUSTERED ([msk_kex_ajanlatID] ASC)
);
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_ajanlat(idjelentkezo,Deleted)_INCLUDE(msk_kex_ajanlatID,Datum)]
    ON [dbo].[msk_kex_ajanlat] ( [idjelentkezo], [Deleted] )
    INCLUDE ( [msk_kex_ajanlatID], [datum] )

GO
-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2018.11.23
-- Description:	X-el való kilépéskor a jelentkezõk felületrõl a kártya színe miatt update-lni kell a táblát.
-- =============================================
create TRIGGER [dbo].[jelentkezok_update_ajanlat]
   ON  [dbo].[msk_kex_ajanlat]
   AFTER INSERT, UPDATE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @jelentkezoID int
	set @jelentkezoID = (select top 1 idjelentkezo from inserted)
    update msk_kex_jelentkezok set Deleted = 0
	WHERE msk_kex_jelentkezokID = @jelentkezoID

END
GO


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_ajanloszelvenyforrasa.sql =====

CREATE TABLE [dbo].[msk_kex_ajanloszelvenyforrasa]
(
	[AjanloszelvenyforrasaID] INT IDENTITY (1, 1) NOT NULL , 
    [nev] VARCHAR(255) NULL, 
    [Deleted] TINYINT NULL
    CONSTRAINT [PK_msk_kex_ajanloszelvenyforrasaID] PRIMARY KEY CLUSTERED ([AjanloszelvenyforrasaID] ASC)
)


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_allasajanlatok.sql =====

CREATE TABLE [dbo].[msk_kex_allasajanlatok] (
    [msk_kex_allasajanlatokID] INT            NOT NULL,
    [uzletag]                  VARCHAR (100)  NULL,
    [targy]                    VARCHAR (255)  NULL,
    [leiras]                   VARCHAR (MAX)  NULL,
    [hely]                     VARCHAR (255)  NULL,
    [idkategoria]              INT            NULL,
    [idceg]                    INT            NULL,
    [reszleg]                  VARCHAR (255)  NULL,
    [elvarasok]                VARCHAR (MAX)  NULL,
    [elonytjelent]             VARCHAR (MAX)  NULL,
    [juttatasok]               VARCHAR (MAX)  NULL,
    [datum_aktivalas]          DATE           NULL,
    [datum_lejarat]            DATE           NULL,
    [szerzodes_fajta]          VARCHAR (255)  NULL,
    [foglalkoztatasi_fok]      VARCHAR (50)   NULL,
    [poziciok_szama]           INT            NULL,
    [munkavegzes_helye]        VARCHAR (255)  NULL,
    [feladatok]                VARCHAR (MAX)  NULL,
    [tovabbi_info]             VARCHAR (MAX)  NULL,
    [toborzo_info]             VARCHAR (MAX)  NULL,
    [toborzo_torzsszam]        VARCHAR (10)   NULL,
    [vallalat]                 VARCHAR (3)    NULL,
    [igazgatosag]              VARCHAR (4)    NULL,
    [munkakor_csoport]         VARCHAR (4)    NULL,
    [kepzes_fajta]             VARCHAR (4)    NULL,
    [kepzes_szakirany]         VARCHAR (4)    NULL,
    [szak]                     VARCHAR (255)  NULL,
    [idegen_nyelv]             VARCHAR (MAX)  NULL,
    [informatika]              VARCHAR (MAX)  NULL,
    [szakmai_tapasztalat]      VARCHAR (MAX)  NULL,
    [jogositvany]              VARCHAR (MAX)  NULL,
    [link]                     VARCHAR (2000) NULL,
    [toborzo_feluliras_flag]   TINYINT        NULL,
    [idszin]                   INT            NULL,
    [idtoborzo1]               INT            NULL,
    [idtoborzo2]               INT            NULL,
    [idvezeto]                 INT            NULL,
    [datum_tanfolyam]          DATE           NULL,
    [idtanfolyamhely]          INT            NULL,
    [idtanfolyamtipus]         INT            NULL,
    [datum_lezaras]            DATE           NULL,
    [aktiv]                    TINYINT        NULL,
    [datum_tanfolyam_szoveges] NCHAR (7)      NULL,
    [min_tapasztalat]          INT            NULL,
    [min_vegzettseg]           INT            NULL,
    [vezetoi_engedely]         BIT            NULL,
    [alt_ceg_nev]              VARCHAR (50)   NULL,
    [alt_email]                VARCHAR (50)   NULL,
    [alt_telefon]              VARCHAR (50)   NULL,
    [ceg_elrejtese]            BIT            NULL,
    [jelentkezes_gomb]         BIT            NULL,
    [idfogado]                 INT            NULL,
    [toborzo_email]            VARCHAR (255)  NULL,
    [toborzo_felvado]          VARCHAR (255)  NULL,
    [map_job]                  INT            NULL,
    [cv]                       INT            NULL,
    [kvalifikacio]             VARCHAR (255)  NULL,
    [engedely_iktatoszama]     VARCHAR (255)  NULL,
    [engedely_datuma]          DATE           NULL,
    [pozicio_szama]            INT            NULL,
    [Deleted]                  TINYINT        NULL,
    [idmunkaltato]             INT            NULL,
    [Created]                  DATETIME       DEFAULT (getdate()) NULL,
    [Idlezarasindok]           INT            NULL,
    [Tulajdonsagok]            VARCHAR (MAX)  NULL, 
    CONSTRAINT [PK_msk_kex_allasajanlatok(msk_kex_allasajanlatokID)] PRIMARY KEY ([msk_kex_allasajanlatokID])
);
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_allasajanlatok(idceg)]
    ON [dbo].[msk_kex_allasajanlatok]([idceg] ASC)
    INCLUDE([idtanfolyamtipus], [datum_lezaras], [engedely_iktatoszama], [engedely_datuma], [idmunkaltato], [Idlezarasindok], [munkavegzes_helye], [idtoborzo1], [idtoborzo2], [idvezeto], [datum_tanfolyam], [idtanfolyamhely], [msk_kex_allasajanlatokID], [uzletag], [targy], [reszleg], [datum_aktivalas], [poziciok_szama]);


GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_allasajanlatok(Deleted)_INCLUDE(msk_kex_allasajanlatokID)]
    ON [dbo].[msk_kex_allasajanlatok]([Deleted] ASC)
    INCLUDE([msk_kex_allasajanlatokID]);


GO
CREATE NONCLUSTERED INDEX [IX_dbo.msk_kex_allasajanlatok(uzletag)_INCLUDE(msk_kex_allasajanlatokID,igazgatosag)]
    ON [dbo].[msk_kex_allasajanlatok]([uzletag] ASC)
    INCLUDE([msk_kex_allasajanlatokID], [igazgatosag]);
GO




===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_allasajanlatok_log.sql =====

CREATE TABLE [dbo].[msk_kex_allasajanlatok_log] (
    [msk_kex_allasajanlatok_logID] INT           IDENTITY (1, 1) NOT NULL,
    [msk_kex_allasajanlatokID]     VARCHAR (250) NULL,
    [Deleted_old]                  TINYINT       NULL,
    [Deleted_new]                  TINYINT       NULL,
    [Created]                      DATETIME      DEFAULT (getdate()) NULL,
    PRIMARY KEY CLUSTERED ([msk_kex_allasajanlatok_logID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_allasajanlat_vezetok.sql =====

CREATE TABLE [dbo].[msk_kex_allasajanlat_vezetok] (
    [msk_kex_allasajanlat_vezetokID] INT     IDENTITY (1, 1) NOT NULL,
    [Idvezeto]                       INT     NULL,
    [Idallasajanlat]                 INT     NULL,
    [Mjgy]                           INT     NULL,
    [Deleted]                        TINYINT NULL,
    [Statuszolovezeto]               BIT CONSTRAINT [DF_msk_kex_allasajanlat_vezetok_Statuszolovezeto] DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([msk_kex_allasajanlat_vezetokID] ASC)
);

GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE TRIGGER [dbo].[STvezetoNullazo]
   ON  [dbo].[msk_kex_allasajanlat_vezetok]
   AFTER UPDATE, INSERT
AS 
BEGIN
	-- Ha a törölt vezetõ egybe STvezetõ is akkor nulláza az idvezetõt
	SET NOCOUNT ON;
	DECLARE @newAZ int;
	DECLARE @newIdvezeto int;
	DECLARE @newIdallasajanlat int;
	DECLARE @newMjgy int;
	DECLARE @newStatuszolovezeto tinyint;
	DECLARE @newDeleted int;
	DECLARE @MJGYtsz varchar(10);
	SELECT 
	@newAZ= msk_kex_allasajanlat_vezetokID, 
	@newIdvezeto = Idvezeto, 
	@newIdallasajanlat = Idallasajanlat,
	@newMjgy = Mjgy,
	@newStatuszolovezeto = Statuszolovezeto,
	@newDeleted=Deleted 
	FROM inserted

	IF @newStatuszolovezeto = 1 
	BEGIN
	  UPDATE msk_kex_allasajanlat_vezetok
	  SET Statuszolovezeto = 0
	  WHERE Idallasajanlat = @newIdallasajanlat AND NOT idvezeto = @newIdvezeto
	END

	IF @newStatuszolovezeto = 0
	BEGIN
	  UPDATE msk_kex_allasajanlat_vezetok
	  SET Statuszolovezeto = 0
	  WHERE msk_kex_allasajanlat_vezetokID=@newAZ
	END

	INSERT dbo.msk_log
	(
	    name,
	    value,
	    created
	)
	VALUES
	(   'statuszoló',           -- name - varchar(100)
	    @newStatuszolovezeto,           -- value - varchar(max)
	    SYSDATETIME() -- created - datetime2(7)
	    )


	IF @newDeleted = 1 
	BEGIN
		-- Ha a törölt vezetõ egybe STvezetõ is akkor nulláza az idvezetõt
--		IF @newMjgy = 9  
--		BEGIN
--			UPDATE msk_kex_allasajanlatok SET idvezeto = NULL  WHERE msk_kex_allasajanlatokID = @newIdallasajanlat AND idvezeto = @newIdvezeto
--		END
		-- Ha a törölt vezetõ munkáltatójogkör gyakorló akkor törli a fiú vezetõket
		IF @newMjgy = 10 
		BEGIN
			SELECT @MJGYtsz = PERNR FROM People WHERE Deleted = 0 AND PeopleID = @newIdvezeto
			UPDATE msk_kex_allasajanlat_vezetok SET Deleted = 1  
			WHERE idallasajanlat = @newIdallasajanlat AND Idvezeto in (SELECT PeopleID FROM People WHERE PSTLZ=@MJGYtsz)
		END
	END


END

GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_allasajanlat_vezetok(Idvezeto,Idallasajanlat,Deleted)_INCLUDE(Statuszolovezeto)]
    ON [dbo].[msk_kex_allasajanlat_vezetok]([Idvezeto] ASC, [Idallasajanlat] ASC, [Deleted] ASC)
    INCLUDE([Statuszolovezeto]);
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_allasajanlat_vezetok(Mjgy,Deleted)_INCLUDE(Idvezeto,Idallasajanlat)]
    ON [dbo].[msk_kex_allasajanlat_vezetok] ( [Mjgy], [Deleted] )
    INCLUDE ( [Idvezeto], [Idallasajanlat] )
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_allasajanlat_vezetok(Idallasajanlat,Deleted)_INCLUDE(idvezeto,Statuszolovezeto)]
    ON [dbo].[msk_kex_allasajanlat_vezetok] ( [Idallasajanlat], [Deleted] )
    INCLUDE ( [Idvezeto], [Statuszolovezeto] )
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_allasajanlat_vezetok(Idvezeto,Deleted)_INCLUDE(Idallasajanlat)]
    ON [dbo].[msk_kex_allasajanlat_vezetok] ( [Idvezeto], [Deleted] )
    INCLUDE ( [Idallasajanlat], [Mjgy] )
GO


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_elutasitasindokok.sql =====

CREATE TABLE [dbo].[msk_kex_elutasitasindokok] (
    [msk_kex_elutasitasindokokID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]                         VARCHAR (255) NULL,
    [Deleted]                     TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_elutasitasindokokID] PRIMARY KEY CLUSTERED ([msk_kex_elutasitasindokokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_emailalairas_1.sql =====

CREATE TABLE [dbo].[msk_kex_emailalairas] (
    [msk_kex_emailalairasID] INT           IDENTITY (1, 1) NOT NULL,
    [PeopleID]               INT           NULL,
    [Alairas]                VARCHAR (MAX) NULL,
    [Deleted]                TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_emailalairas] PRIMARY KEY CLUSTERED ([msk_kex_emailalairasID] ASC)
);






GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_emailalairas(PeopleID,Deleted)]
    ON [dbo].[msk_kex_emailalairas]([PeopleID] ASC)
    INCLUDE([Deleted]);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_ertesuleshelyek.sql =====

CREATE TABLE [dbo].[msk_kex_ertesuleshelyek] (
    [msk_kex_ertesuleshelyekID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]                       VARCHAR (255) NULL,
    [Deleted]                   TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_ertesuleshelyekID] PRIMARY KEY CLUSTERED ([msk_kex_ertesuleshelyekID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_felvstatusz.sql =====

CREATE TABLE [dbo].[msk_kex_felvstatusz] (
    [Msk_kex_felvstatuszID] INT          IDENTITY (1, 1) NOT NULL,
    [Idjelentkezo]          INT          NULL,
    [Idfelvstatusz]         INT          NULL,
    [Datum]                 DATE         NULL,
    [Belepesdatum]          DATE         NULL,
    [Idelutasitasindok]     INT          NULL,
    [Idvisszalepesindok]    INT          NULL,
    [Deleted]               TINYINT      NULL,
    [PERNR]                 VARCHAR (10) NULL,
    [PeopleID]              INT          NULL,
    [VallalatonBeluli]      BIT          NULL,
    PRIMARY KEY CLUSTERED ([Msk_kex_felvstatuszID] ASC) WITH (FILLFACTOR = 80)
);


GO

GO
CREATE TRIGGER [dbo].[mapfelvstatusz_insertupdate]
   ON  [dbo].[msk_kex_felvstatusz]
   AFTER UPDATE,INSERT
AS 
BEGIN
	SET NOCOUNT ON;  --MAPTODO Kell ez a Trigger??


	DECLARE @ID int
	select top 1 @ID=AjanlasID from msk_map_ajanlas where deleted=0 and Msk_kex_jelentkezokID = (select TOP 1 Idjelentkezo FROM Inserted)        
    declare @lastID int 
    set @lastid = (select top 1 Msk_kex_felvstatuszID from msk_kex_felvstatusz where deleted=0 and Idjelentkezo = (select TOP 1 Idjelentkezo FROM Inserted)  order by Datum desc )

    declare @Idfelvstatusz int 
    declare @sajatvall bit
    declare @JeloltPERNR varchar(10)
    declare @JeloltNEV varchar(255)
    select TOP 1
         @sajatvall = VallalatonBeluli, 
         @Idfelvstatusz=case when Idfelvstatusz=6 then 1 else 2 end 
        ,@JeloltPERNR = (select PERNR from people where peopleid=msk_kex_felvstatusz.PeopleID)
        ,@JeloltNEV = (select name from people where peopleid=msk_kex_felvstatusz.PeopleID)
    FROM msk_kex_felvstatusz where msk_kex_felvstatusz.Msk_kex_felvstatuszID=@lastID
    
    if @ID is not null begin
        --kapcsolÃ³dtunk a a MAP hoz
        if @Idfelvstatusz=1
            update msk_map_ajanlas 
                set FelveteliStatusz=@Idfelvstatusz 
                ,JeloltPERNR=@JeloltPERNR
                ,JeloltNev=iif(isnull(@JeloltNEV,'')='',JeloltNev,@JeloltNev)
                ,VallalatonBeluli=@sajatvall
                where AjanlasID=@ID
        else
            update msk_map_ajanlas 
                set FelveteliStatusz=@Idfelvstatusz 
                ,VallalatonBeluli=@sajatvall
                where AjanlasID=@ID
           
        exec msk_map_daily_one @ID

	    --UPDATE msk_map_ajanlas SET Statuszok=(SELECT 'A'+STUFF((
	    --SELECT CHAR(ID+64)+ltrim(str(Statusz,10,0))+';' FROM msk_map_ajanlasfilter(@ID) WHERE deleted=0 ORDER BY ID
	   -- FOR XML PATH('')) ,1,1,'') ) where deleted=0 and AjanlasID=@ID
    end
END

GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_felvstatusz(Idjelentkezo,Deleted)_INCLUDE(Msk_kex_felvstatuszID,Idfelvstatusz)]
    ON [dbo].[msk_kex_felvstatusz]([Idjelentkezo], [Deleted])
    INCLUDE ([Msk_kex_felvstatuszID], [Idfelvstatusz]);
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_felvstatusz(Deleted,Idfelvstatusz)_INCLUDE(Msk_kex_felvstatuszID,Idjelentkezo,Belepesdatum)]
    ON [dbo].[msk_kex_felvstatusz] ( [Deleted], [Idfelvstatusz] )
    INCLUDE ( [Msk_kex_felvstatuszID], [Idjelentkezo], [Belepesdatum] )
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_felvstatusz(Idfelvstatusz,Deleted)_INCLUDE(Idjelentkezo,PeopleID)]
    ON [dbo].[msk_kex_felvstatusz]([Idfelvstatusz] ASC, [Deleted] ASC)
    INCLUDE([Idjelentkezo], [PeopleID]);


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_gdpr_jelentkezok.sql =====

CREATE TABLE [dbo].[msk_kex_gdpr_jelentkezok] (
    [msk_kex_gdpr_jelentkezokID] INT            IDENTITY (1, 1) NOT NULL,
    [idallasajanlat]             VARCHAR (255)  NULL,
    [iddrupal]                   INT            NULL,
    [targy]                      VARCHAR (255)  NULL,
    [nev]                        VARCHAR (255)  NULL,
    [email]                      VARCHAR (255)  NULL,
    [telefonszam]                VARCHAR (50)   NULL,
    [cvlink]                     VARCHAR (2000) NULL,
    [cvtartalom]                 VARCHAR (MAX)  NULL,
    [gdpr]                       TINYINT        NULL,
    [ajanlo_nev]                 VARCHAR (255)  NULL,
    [datum]                      DATETIME2 (7)  NULL,
    [honnanertesult]             VARCHAR (255)  NULL,
    [Deleted]                    TINYINT        NULL,
    [cvlinkid]                   INT            NULL,
    [JelentkezesiDokID]          INT            NULL,
    [AdatkezelesiDokID]          INT            NULL,
    [MotivaciosDokID]            INT            NULL,
    [MunkavallaloiDokID]         INT            NULL,
    [HashID]                     INT            NULL,
    [EmailCC]                    VARCHAR (255)  NULL,
    [Idanonindok]                INT            NULL,
    [gdpr_vege]                  DATETIME2 (7)  NULL,
    [MAPCompany]                 VARCHAR (10)   NULL,
    [map_beerkezes]              DATE           NULL,
    [idmap_dokumentacio]         INT            NULL,
    [MAPEmail]                   VARCHAR (255)  NULL,
    [MAPPeopleID]                INT            NULL,
    [map_hatarido]               DATE           NULL,
    [MAPAjanloszelvenyForrasa]   INT            NULL,
    [MAPErvenyes]                BIT            NULL,
    [JelentkezokID]              INT            NULL,
    CONSTRAINT [PK_msk_kex_gdpr_jelentkezokID] PRIMARY KEY CLUSTERED ([msk_kex_gdpr_jelentkezokID] ASC) WITH (FILLFACTOR = 80)
);


GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_gdpr_jelentkezok(HashID)_INCLUDE(msk_kex_gdpr_jelentkezokID,ajanlo_nev,MunkavallaloiDokID)]
    ON [dbo].[msk_kex_gdpr_jelentkezok]([HashID] ASC)
    INCLUDE([msk_kex_gdpr_jelentkezokID], [ajanlo_nev], [MunkavallaloiDokID]);
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted)_INCLUDE(HashID,cvlinkid)]
    ON [dbo].[msk_kex_gdpr_jelentkezok]([Deleted] ASC)
    INCLUDE([HashID], [cvlinkid]);
GO

CREATE INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted,MunkavallaloiDokID)_INCLUDE(msk_kex_gdpr_jelentkezokID)]
    ON [dbo].[msk_kex_gdpr_jelentkezok] ( [Deleted], [MunkavallaloiDokID] )
    INCLUDE ( [msk_kex_gdpr_jelentkezokID] )
GO

CREATE INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted,MotivaciosDokID)_INCLUDE(msk_kex_gdpr_jelentkezokID)]
    ON [dbo].[msk_kex_gdpr_jelentkezok] ( [Deleted], [MotivaciosDokID] )
    INCLUDE ( [msk_kex_gdpr_jelentkezokID] )
GO

CREATE INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted,AdatkezelesiDokID)_INCLUDE(msk_kex_gdpr_jelentkezokID)]
    ON [dbo].[msk_kex_gdpr_jelentkezok] ( [Deleted], [AdatkezelesiDokID] )
    INCLUDE ( [msk_kex_gdpr_jelentkezokID] )
GO

CREATE INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted,JelentkezesiDokID)_INCLUDE(msk_kex_gdpr_jelentkezokID)]
    ON [dbo].[msk_kex_gdpr_jelentkezok] ( [Deleted], [JelentkezesiDokID] )
    INCLUDE ( [msk_kex_gdpr_jelentkezokID] )
GO

CREATE INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted,cvlinkid)_INCLUDE(msk_kex_gdpr_jelentkezokID)]
    ON [dbo].[msk_kex_gdpr_jelentkezok] ( [Deleted], [cvlinkid] )
    INCLUDE ( [msk_kex_gdpr_jelentkezokID] )
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_gdpr_jelentkezok(Deleted,nev)_INCLUDE(msk_kex_gdpr_jelentkezokID,gdpr_vege)]
    ON [dbo].[msk_kex_gdpr_jelentkezok]([Deleted] ASC, [nev] ASC)
    INCLUDE([msk_kex_gdpr_jelentkezokID], [gdpr_vege]);


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_hash.sql =====

CREATE TABLE [dbo].[msk_kex_hash] (
    [Msk_kex_hashID] INT             IDENTITY (1, 1) NOT NULL,
    [Hash]           VARBINARY (100) NOT NULL,
    [Deleted]        TINYINT         NOT NULL,
    CONSTRAINT [PK__msk_kex___F355A4F89ED2A7F6] PRIMARY KEY CLUSTERED ([Msk_kex_hashID] ASC)
);





GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_hash(Hash,Deleted)]
    ON [dbo].[msk_kex_hash]([Hash] ASC, [Deleted] ASC);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_interju.sql =====

CREATE TABLE [dbo].[msk_kex_interju] (
    [msk_kex_interjuID] INT           IDENTITY (1, 1) NOT NULL,
    [idjelentkezo]      INT           NOT NULL,
    [datum]             DATE          NULL,
    [idbehivva]         INT           NULL,
    [ideredmeny]        INT           NULL,
    [iddolgozik]        INT           NULL,
    [idmegjelent]       INT           NULL,
    [megjegyzes]        VARCHAR (MAX) NULL,
    [Deleted]           TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_interjuID] PRIMARY KEY CLUSTERED ([msk_kex_interjuID] ASC)
);
GO

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2018.11.23
-- Description:	X-el való kilépéskor a jelentkezõk felületrõl a kártya színe miatt update-lni kell a táblát.
-- =============================================
create TRIGGER [dbo].[jelentkezok_update_interju]
   ON  [dbo].[msk_kex_interju]
   AFTER INSERT, UPDATE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @jelentkezoID int
	set @jelentkezoID = (select top 1 idjelentkezo from inserted)
    update msk_kex_jelentkezok set Deleted = 0
	WHERE msk_kex_jelentkezokID = @jelentkezoID

END
GO

CREATE NONCLUSTERED INDEX [idjelentkezo_Deleted]
    ON [dbo].[msk_kex_interju]([idjelentkezo] ASC, [Deleted] ASC);
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_interju(idjelentkezo,Deleted)_INCLUDE(datum,ideredmeny,idmegjelent,megjegyzes)]
    ON [dbo].[msk_kex_interju] ( [idjelentkezo], [Deleted] )
    INCLUDE ( [datum], [ideredmeny], [idmegjelent], [megjegyzes] )
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_interju(Deleted,idjelentkezo)_INCLUDE(datum,ideredmeny,idmegjelent,megjegyzes)]
    ON [dbo].[msk_kex_interju] ( [Deleted], [idjelentkezo] )
    INCLUDE ( [datum], [ideredmeny], [idmegjelent], [megjegyzes] )
GO




===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_jelentkezesek.sql =====

CREATE TABLE [dbo].[msk_kex_jelentkezesek]
(
	[Msk_kex_jelentkezesekID] INT IDENTITY (1, 1) NOT NULL,
    [Cnt] INT NULL, 
    [Hash]           VARBINARY (100) NOT NULL,
    [Deleted]        TINYINT         NOT NULL,
    CONSTRAINT [PK_msk_kex_jelentkezesek(Msk_kex_jelentkezesekID)] PRIMARY KEY CLUSTERED ([Msk_kex_jelentkezesekID] ASC)
)
GO

CREATE INDEX [IX_msk_kex_jelentkezesek(Hash,Deleted)_INCLUDE(Msk_kex_jelentkezesekID)]
    ON [dbo].[msk_kex_jelentkezesek] ( [Hash], [Deleted] )
    INCLUDE ( [Msk_kex_jelentkezesekID] )
GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_jelentkezok.sql =====

CREATE TABLE [dbo].[msk_kex_jelentkezok] (
    [msk_kex_jelentkezokID]    INT            IDENTITY (1, 1) NOT NULL,
    [idallasajanlat]           INT            NOT NULL,
    [iddrupal]                 INT            NULL,
    [targy]                    VARCHAR (255)  NULL,
    [hp_torzsszam]             VARCHAR (10)   NULL,
    [hp_nev]                   VARCHAR (255)  NULL,
    [nev]                      VARCHAR (255)  NULL,
    [email]                    VARCHAR (255)  NULL,
    [telefonszam]              VARCHAR (50)   NULL,
    [cvlink]                   VARCHAR (2000) NULL,
    [cvtartalom]               VARCHAR (MAX)  NULL,
    [gdpr]                     BIT            NULL,
    [ajanlo_nev]               VARCHAR (255)  NULL,
    [datum]                    DATETIME2 (7)  NULL,
    [honnanertesult]           VARCHAR (255)  NULL,
    [idcv_toborzo]             INT            NULL,
    [idcv_vezeto]              INT            NULL,
    [cv_toborzo_megj]          VARCHAR (MAX)  NULL,
    [cv_vezeto_megj]           VARCHAR (MAX)  NULL,
    [idtanfolyamos]            INT            NULL,
    [idtanfolyamhely]          INT            NULL,
    [idtanfolyamtipus]         INT            NULL,
    [map_hatarido]             DATE           NULL,
    [idmap_dokumentacio]       INT            NULL,
    [idfelveve]                INT            NULL,
    [datum_elutasitas]         DATE           NULL,
    [idelutasitasindok]        INT            NULL,
    [datum_visszalepes]        DATE           NULL,
    [idvisszalepesindok]       INT            NULL,
    [berigeny]                 INT            NULL,
    [idszin]                   INT            NULL,
    [Deleted]                  TINYINT        NULL,
    [datum_tanfolyam]          VARCHAR (7)    NULL,
    [tanfolyamos]              BIT            NULL,
    [cvlinkid]                 INT            NULL,
    [JelentkezesiDokID]        INT            NULL,
    [AdatkezelesiDokID]        INT            NULL,
    [MotivaciosDokID]          INT            NULL,
    [MunkavallaloiDokID]       INT            NULL,
    [HashID]                   INT            NULL,
    [EmailCC]                  VARCHAR (255)  NULL,
    [Updated]                  TINYINT        NULL,
    [map_beerkezes]            DATE           NULL,
    [gdpr_vege]                DATE           NULL,
    [MAPCompany]               VARCHAR (10)   NULL,
    [MAPEmail]                 VARCHAR (255)  NULL,
    [MAPPeopleID]              INT            NULL,
    [MAPAjanloszelvenyForrasa] INT            NULL,
    [MAPErvenyes]              BIT            NULL,
    [Statuszok]                VARCHAR (100)  NULL,
    CONSTRAINT [PK_msk_kex_jelentkezokID] PRIMARY KEY CLUSTERED ([msk_kex_jelentkezokID] ASC) WITH (FILLFACTOR = 80)
);


GO

CREATE NONCLUSTERED INDEX [NonClusteredIndex-20200921-114403]
    ON [dbo].[msk_kex_jelentkezok]([datum] ASC, [ajanlo_nev] ASC, [map_hatarido] ASC, [idmap_dokumentacio] ASC, [map_beerkezes] ASC, [MAPCompany] ASC);


GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(idallasajanlat,datum,idcv_toborzo,Deleted)]
    ON [dbo].[msk_kex_jelentkezok]([idallasajanlat] ASC, [datum] ASC, [idcv_toborzo] ASC, [Deleted] ASC);

GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(HashID)_INCLUDE(msk_kex_jelentkezokID,idallasajanlat)]
    ON [dbo].[msk_kex_jelentkezok]([HashID] ASC)
    INCLUDE([msk_kex_jelentkezokID], [idallasajanlat]);

GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(datum,Deleted)_INCLUDE(msk_kex_jelentkezokID,idallasajanlat,hp_nev,nev,ajanlo_nev,idmap_dokumentacio)]
    ON [dbo].[msk_kex_jelentkezok] ( [datum], [Deleted] )
    INCLUDE ([msk_kex_jelentkezokID], [idallasajanlat], [hp_nev], [nev], [ajanlo_nev], [idmap_dokumentacio], [map_beerkezes] )
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(idallasajanlat,Deleted)_INCLUDE(msk_kex_jelentkezokID,nev,email,telefonszam,datum,idszin,cvlinkid)]
    ON [dbo].[msk_kex_jelentkezok] ( [idallasajanlat], [Deleted] )
    INCLUDE
( [msk_kex_jelentkezokID]
, [nev]
, [email]
, [telefonszam]
, [datum]
, [idszin]
, [cvlinkid]
, [JelentkezesiDokID]
, [AdatkezelesiDokID]
, [MotivaciosDokID]
, [MunkavallaloiDokID]
, [EmailCC]
)
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(msk_kex_jelentkezokID,Deleted)_INCLUDE(idallasajanlat,nev,datum)]
    ON [dbo].[msk_kex_jelentkezok] ( [msk_kex_jelentkezokID], [Deleted] )
    INCLUDE ( [idallasajanlat], [nev], [datum] )
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(idallasajanlat,Deleted)_INCLUDE(msk_kex_jelentkezokID,nev,datum)]
    ON [dbo].[msk_kex_jelentkezok] ( [idallasajanlat], [Deleted] )
    INCLUDE ( [msk_kex_jelentkezokID], [nev], [datum] )
GO

CREATE INDEX [IX_msk_kex_jelentkezok(Deleted,MunkavallaloiDokID,idallasajanlat)_INCLUDE(msk_kex_jelentkezokID)]
    ON [dbo].[msk_kex_jelentkezok] ( [Deleted], [MunkavallaloiDokID], [idallasajanlat] )
    INCLUDE ( [msk_kex_jelentkezokID] )
GO

CREATE INDEX [IX_msk_kex_jelentkezok(Deleted,cvlinkid,idallasajanlat)_INCLUDE(msk_kex_jelentkezokID)]
    ON [dbo].[msk_kex_jelentkezok] ( [Deleted], [cvlinkid], [idallasajanlat] )
    INCLUDE ( [msk_kex_jelentkezokID] )
GO

CREATE NONCLUSTERED INDEX IX_msk_kex_jelentkezok_MAPErvenyes
ON [dbo].[msk_kex_jelentkezok] ([MAPErvenyes])
INCLUDE ([msk_kex_jelentkezokID])
GO

CREATE TRIGGER [dbo].[jelentkezo_after_update]
   ON  [dbo].[msk_kex_jelentkezok]
   AFTER UPDATE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	declare @original table (ID INT,csoport int,name varchar(100),Deleted tinyint,Statusz varchar(10),code char) 

	DECLARE @ID_table TABLE(
	ID INT
	)

	INSERT INTO @ID_table SELECT msk_kex_jelentkezokID FROM Inserted

	DECLARE @MyCursor CURSOR;
	DECLARE @JelentkezoID INT;

			SET @MyCursor = CURSOR FOR
			select ID from @ID_table

				OPEN @MyCursor 
				FETCH NEXT FROM @MyCursor 
				INTO @JelentkezoID

				WHILE @@FETCH_STATUS = 0
				BEGIN
						delete from @original
						declare @statuszok varchar(100) = (select TOP 1 statuszok from inserted WHERE msk_kex_jelentkezokID=@JelentkezoID) /*123*/

						/* 1,2,3 Igen/nem/talán*/
						/* 4,5 Igen/Nem*/
						/* 6,7,8 Felvéve/Elutasítva/Visszalépett*/

						declare @color int
						set @color=8 /*szürke*/
						insert into @original select * from dbo.[msk_kex_jelentkezokfilterdirect]( @color, @statuszok)

						
						declare @toborzo INT --inserted táblából
						DECLARE @vezeto INT
						declare @interju INT
						declare @orvosi INT
						declare @teszt INT
						declare @elfogad INT
						declare @felveve INT --inserted táblából


						set @toborzo = (select TOP 1 idcv_toborzo from inserted WHERE msk_kex_jelentkezokID=@JelentkezoID) /*123*/
						set @vezeto = (select TOP 1 idcv_vezeto from inserted WHERE msk_kex_jelentkezokID=@JelentkezoID) /*123*/

						IF (SELECT Count(ideredmeny) FROM dbo.msk_kex_interju where idjelentkezo=@JelentkezoID and deleted=0) > 0
						BEGIN
							set @interju = (select CASE WHEN 1 IN (SELECT ISNULL(ideredmeny,1) FROM dbo.msk_kex_interju where idjelentkezo=@JelentkezoID and deleted=0 AND 
																	msk_kex_interjuID = (SELECT MAX(msk_kex_interjuID) FROM dbo.msk_kex_interju WHERE idjelentkezo=@JelentkezoID and deleted=0))

												OR 3 IN (SELECT ISNULL(ideredmeny,3) FROM dbo.msk_kex_interju where idjelentkezo=@JelentkezoID and deleted=0 AND 
																	msk_kex_interjuID = (SELECT MAX(msk_kex_interjuID) FROM dbo.msk_kex_interju WHERE idjelentkezo=@JelentkezoID and deleted=0)) THEN 1 ELSE 2 END) /*123*/
						END

						IF (SELECT Count(ideredmeny) FROM dbo.msk_kex_teszt where idjelentkezo=@JelentkezoID and deleted=0) > 0
						BEGIN
							set @teszt = (select CASE WHEN 4 IN (SELECT ISNULL(ideredmeny,4) FROM dbo.msk_kex_teszt where idjelentkezo=@JelentkezoID and deleted=0 AND 
																	msk_kex_tesztID = (SELECT MAX(msk_kex_tesztID) FROM dbo.msk_kex_teszt WHERE idjelentkezo=@JelentkezoID and deleted=0)) THEN 4 ELSE 5 END)  /*45*/
						END

						IF (SELECT Count(ideredmeny) FROM dbo.msk_kex_orvosi where idjelentkezo=@JelentkezoID and deleted=0) > 0
						BEGIN
							set @orvosi = (select CASE WHEN 4 IN (SELECT ISNULL(ideredmeny,4) FROM dbo.msk_kex_orvosi where idjelentkezo=@JelentkezoID and deleted=0 AND 
																	msk_kex_orvosiID = (SELECT MAX(msk_kex_orvosiID) FROM dbo.msk_kex_orvosi WHERE idjelentkezo=@JelentkezoID and deleted=0)) THEN 4 ELSE 5 END)  /*45*/
						END

						IF (SELECT Count(idelfogadva) FROM dbo.msk_kex_ajanlat where idjelentkezo=@JelentkezoID and deleted=0) > 0
						BEGIN
							set @elfogad = (select CASE WHEN 4 IN (SELECT ISNULL(idelfogadva,4) FROM dbo.msk_kex_ajanlat where idjelentkezo=@JelentkezoID and deleted=0 AND 
																	msk_kex_ajanlatID = (SELECT MAX(msk_kex_ajanlatID) FROM dbo.msk_kex_ajanlat WHERE idjelentkezo=@JelentkezoID and deleted=0)) THEN 4 ELSE 5 END) /*45*/	
						END

						set @felveve = (select TOP 1 Idfelvstatusz from msk_kex_AktualisFelveteliStatusz WHERE Idjelentkezo=@JelentkezoID) /*678*/


						IF @toborzo=1 BEGIN
							set @color=13 /*narancs*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=13))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=14))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=15))				
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=3))				
							--select @color as 'Toborzo_CV_igen'
						END

						IF @toborzo=2 BEGIN
							--set @color=15 /*szürke*/
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=13))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=14))				
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=15))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=3))				
							--select @color as 'Toborzo_CV_nem'
						END
						IF @toborzo=3 BEGIN
							set @color=14 /*narancs*/
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=13))				
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=14))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=15))				
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=3))				
							--select @color as 'Toborzo_CV_talan'
						END

						
						IF @vezeto=1 BEGIN
							--set @color=16 /*narancs*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=16))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=17))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=18))				
							--select @color as 'Vezeto_CV_igen'
						END

						IF @vezeto=2 BEGIN
							--set @color=18 /*szürke****/
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=16))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=17))				
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=18))				
							--select @color as 'Vezeto_CV_nem'
						END

						IF @vezeto=3 BEGIN
							--set @color=17 /*narancs*/
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=16))				
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=17))				
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=18))				
							--select @color as 'Vezeto_CV_talan'
						END
						
						IF @interju=1 BEGIN
							set @color=4 /*barna*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Interju_igen'
						END else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=4))				
						end

						IF @teszt=4 BEGIN
							set @color=7 /*bordó*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Teszt_igen'
						END else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=7))				
						end

						IF @orvosi=4 BEGIN
							set @color=10 /*lila*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Orvosi_igen'
						END else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=10))				
							--select @color as 'Orvosi_igen'
						END

						IF @elfogad=4 BEGIN
							set @color=2 /*kék*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Ajanlat_igen'
						END else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=2))				
							--select @color as 'Ajanlat_igen'
						END

						if (
							--@interju=2 or @orvosi=5 or @elfogad=5 or @felveve=7 or @felveve=8 or @teszt=5
							@interju=2 or @orvosi=5 or @elfogad=5 or @teszt=5
						) begin
							set @color=8 /*szürke*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Nincs_felveve'
						end else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=8))				
							--select @color as 'Nincs_felveve'
						end

						if ( @felveve=7 ) begin
							set @color=11 /*szürke*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Elutasítva'
						end else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=11))				
							--select @color as 'Elutasítva'
						end 

						if (@felveve=8 ) begin
							set @color=12 /*szürke*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Visszalépett'
						end else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=12))				
							--select @color as 'Visszalépett'
						end
	
						if ( 
							--(ISNULL(@toborzo,-1)=-1)
							--and (ISNULL(@interju,-1)=-1)
							--and (ISNULL(@teszt,-1)=-1)
							--and (ISNULL(@orvosi,-1)=-1)
							--and (ISNULL(@elfogad,-1)=-1)
							--and (ISNULL(@felveve,-1)=-1)
							(@toborzo IS NULL OR @toborzo = 0) AND
							(@interju IS NULL OR @interju = 0) AND
							(@orvosi IS NULL OR @orvosi = 0) AND
							(@teszt IS NULL OR @teszt = 0) AND
							(@elfogad IS NULL OR @elfogad = 0) AND
							(@felveve IS NULL OR @felveve = 0)	
							)	
						BEGIN
							set @color=5 /*fehér*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Uj_jelentkezo'
						END else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=5))				
							--select @color as 'Uj_jelentkezo'
						END

						IF @felveve=6 BEGIN
							set @color=6 /*zöld*/
update @original set Statusz=1 where code=char((select ID from msk_kex_szin where msk_kex_szinID=@color))				
							--select @color as 'Felveve'
						END else begin
update @original set Statusz=0 where code=char((select ID from msk_kex_szin where msk_kex_szinID=6))				
							--select @color as 'Felveve'
						END

						--select @color as 'Finish'

						--fenti számítások futtatása
						UPDATE dbo.msk_kex_jelentkezok SET idszin=@color
								WHERE msk_kex_jelentkezokID = @JelentkezoID

						UPDATE msk_kex_jelentkezok SET Statuszok=(SELECT 'A'+STUFF((
						SELECT Code+ltrim(str(Statusz,10,0))+';' FROM @original 
						FOR XML PATH('')) ,1,1,'') ) 
						WHERE msk_kex_jelentkezokID = @JelentkezoID

						--map határidõ beállítása. de csak 6 hónapig
						IF (SELECT Inserted.datum FROM Inserted WHERE Inserted.msk_kex_jelentkezokID=@JelentkezoID) > DATEADD(MONTH, -6, GETDATE())
						UPDATE dbo.msk_kex_jelentkezok SET map_hatarido = dbo.msk_addMunkanapSzam(datum, 10) --DATEADD(day, 10, datum)
								WHERE msk_kex_jelentkezokID = @JelentkezoID

				  	
				  FETCH NEXT FROM @MyCursor
				  INTO @JelentkezoID 
				END

				CLOSE @MyCursor;
				DEALLOCATE @MyCursor;			

END
GO

-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2018.10.31
-- Description:	Interfészen át érkezõ jelentkezõk esetében tanfolyamos mezõk kitöltése és szín beállítása
-- =============================================
CREATE TRIGGER [dbo].[jelentkezo_after_insert]
   ON  [dbo].[msk_kex_jelentkezok]
   AFTER INSERT
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	--Új jelenztkezõ rögzítésekor kitölti a tanfolyamos, idszin és Hash mezõket

	DECLARE @temp TABLE(
	idallasajanlat INT,
	idjelentkezo INT
	)

	INSERT INTO @temp
	(
	    idjelentkezo,
		idallasajanlat
	)
	(SELECT Inserted.msk_kex_jelentkezokID, Inserted.idallasajanlat FROM Inserted)

	

	DECLARE @idallasajanlat INT
	DECLARE @idjelentkezo INT

	DECLARE @datum_tanfolyam VARCHAR(7)
	DECLARE @idtanfolyamhely INT
	DECLARE @idtanfolyamtipus INT

	DECLARE @MyCursor CURSOR
		BEGIN
			SET @MyCursor = CURSOR FOR
			select idjelentkezo from @temp

				OPEN @MyCursor 
				FETCH NEXT FROM @MyCursor 
				INTO @idjelentkezo

				WHILE @@FETCH_STATUS = 0
				BEGIN
					
					set @idallasajanlat = (SELECT TOP 1 idallasajanlat FROM @temp WHERE idjelentkezo = @idjelentkezo)
					
					set @datum_tanfolyam = (SELECT TOP 1  datum_tanfolyam_szoveges FROM msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID = @idallasajanlat)

					set @idtanfolyamtipus = (SELECT TOP 1 idtanfolyamtipus FROM msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID = @idallasajanlat)

					set @idtanfolyamhely = (SELECT TOP 1 idtanfolyamhely FROM msk_kex_allasajanlatok WHERE msk_kex_allasajanlatokID = @idallasajanlat)

					-- tanfolyamos adatok beállítása
					if (@datum_tanfolyam IS NOT NULL OR @idtanfolyamhely IS NOT NULL OR @idtanfolyamtipus IS NOT NULL)
						BEGIN
							Update msk_kex_jelentkezok set 
							datum_tanfolyam = @datum_tanfolyam,
							idtanfolyamtipus = @idtanfolyamtipus,
							idtanfolyamhely = @idtanfolyamhely,
							tanfolyamos = 1
							WHERE msk_kex_jelentkezokID = @idjelentkezo
						END				

					-- id szin beállítása (Ez hívja meg az UPDATE triggert)
					UPDATE msk_kex_jelentkezok SET idszin = 5 WHERE msk_kex_jelentkezokID = @idjelentkezo

				  FETCH NEXT FROM @MyCursor
				  INTO @idjelentkezo
				END; 

				CLOSE @MyCursor;
				DEALLOCATE @MyCursor;
			END;


END
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(idszin,Deleted)_INCLUDE(msk_kex_jelentkezokID)]
    ON [dbo].[msk_kex_jelentkezok]([idszin] ASC, [Deleted] ASC)
    INCLUDE([msk_kex_jelentkezokID]);


GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(iddrupal)]
    ON [dbo].[msk_kex_jelentkezok]([iddrupal] ASC);


GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_jelentkezok(ajanlo_nev,MAPErvenyes)_INCLUDE(msk_kex_jelentkezokID)]
    ON [dbo].[msk_kex_jelentkezok]([ajanlo_nev] ASC, [MAPErvenyes] ASC)
    INCLUDE([msk_kex_jelentkezokID]);


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_lezarasindokok.sql =====

CREATE TABLE [dbo].[msk_kex_lezarasindokok] (
    [Msk_kex_lezarasindokokID] INT            IDENTITY (1, 1) NOT NULL,
    [Indokok]                  VARCHAR (4000) NULL,
    [Deleted]                  TINYINT        NULL,
    PRIMARY KEY CLUSTERED ([Msk_kex_lezarasindokokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_LookupList.sql =====

CREATE TABLE [dbo].[msk_kex_LookupList] (
    [LookupListID]  INT            IDENTITY (1, 1) NOT NULL,
    [GroupNum]      INT            NULL,
    [LookupValue]   VARCHAR (255)  NULL,
    [Department]    INT            NULL,
    [Deleted]       TINYINT        NULL,
    [sort]          INT            NULL,
    [TechnicalName] VARCHAR (1000) NULL
);
GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_LookupList(LookupListID)_INCLUDE(GroupNum,LookupValue,Department,Deleted,sort,TechnicalName)]
    ON [dbo].[msk_kex_LookupList] ( [LookupListID] )
    INCLUDE ( [GroupNum], [LookupValue], [Department], [Deleted], [sort], [TechnicalName] )
GO


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_mananonindokok.sql =====

CREATE TABLE [dbo].[msk_kex_mananonindokok] (
    [Msk_kex_mananonindokokID] INT            IDENTITY (1, 1) NOT NULL,
    [Indokok]                  VARCHAR (4000) NULL,
    [Deleted]                  TINYINT        NULL,
    PRIMARY KEY CLUSTERED ([Msk_kex_mananonindokokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_orvosi.sql =====

CREATE TABLE [dbo].[msk_kex_orvosi] (
    [msk_kex_orvosiID] INT     IDENTITY (1, 1) NOT NULL,
    [idjelentkezo]     INT     NOT NULL,
    [datum]            DATE    NULL,
    [idorvositipus]    INT     NULL,
    [idelkezdte]       INT     NULL,
    [ideredmeny]       INT     NULL,
    [Deleted]          TINYINT NULL,
    [igenylesdatuma]   DATE    NULL,
    [kiallitasdatuma]  DATE    NULL,
    CONSTRAINT [PK_msk_kex_orvosiID(msk_kex_orvosiID)] PRIMARY KEY CLUSTERED ([msk_kex_orvosiID] ASC)
);
GO

CREATE NONCLUSTERED INDEX [IX_msk_kex_orvosi(idjelentkezo,Deleted)_INCLUDE()]
    ON [dbo].[msk_kex_orvosi] ( [idjelentkezo], [Deleted] )
    INCLUDE ( [msk_kex_orvosiID], [idelkezdte], [ideredmeny] )
GO


GO
-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2018.11.23
-- Description:	X-el való kilépéskor a jelentkezõk felületrõl a kártya színe miatt update-lni kell a táblát.
-- =============================================
create TRIGGER [dbo].[jelentkezok_update_orvosi]
   ON  [dbo].[msk_kex_orvosi]
   AFTER INSERT, UPDATE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @jelentkezoID int
	set @jelentkezoID = (select top 1 idjelentkezo from inserted)
    update msk_kex_jelentkezok set Deleted = 0
	WHERE msk_kex_jelentkezokID = @jelentkezoID

END
GO
CREATE NONCLUSTERED INDEX [idjelentkezo_Deleted]
    ON [dbo].[msk_kex_orvosi]([idjelentkezo] ASC, [Deleted] ASC);


GO
CREATE NONCLUSTERED INDEX [ideredmeny_Deleted]
    ON [dbo].[msk_kex_orvosi]([ideredmeny] ASC, [Deleted] ASC)
    INCLUDE([idjelentkezo]);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_orvositipusok.sql =====

CREATE TABLE [dbo].[msk_kex_orvositipusok] (
    [msk_kex_orvositipusokID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]                     VARCHAR (255) NULL,
    [Deleted]                 TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_orvositipusokID] PRIMARY KEY CLUSTERED ([msk_kex_orvositipusokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_szin.sql =====

CREATE TABLE [dbo].[msk_kex_szin] (
    [msk_kex_szinID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]            VARCHAR (100) NULL,
    [szin]           VARCHAR (50)  NULL,
    [Deleted]        TINYINT       NULL,
    [order]          INT           NULL,
    [ID] VARCHAR(10) NULL, 
    CONSTRAINT [PK_msk_kex_szinID] PRIMARY KEY CLUSTERED ([msk_kex_szinID] ASC)
);





===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_tanfolyamhelyek.sql =====

CREATE TABLE [dbo].[msk_kex_tanfolyamhelyek] (
    [msk_kex_tanfolyamhelyekID] INT           IDENTITY (1, 1) NOT NULL,
    [csoport]                   VARCHAR (45)  NULL,
    [nev]                       VARCHAR (255) NULL,
    [Deleted]                   TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_tanfolyamhelyekID] PRIMARY KEY CLUSTERED ([msk_kex_tanfolyamhelyekID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_tanfolyamtipusok.sql =====

CREATE TABLE [dbo].[msk_kex_tanfolyamtipusok] (
    [msk_kex_tanfolyamtipusokID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]                        VARCHAR (255) NULL,
    [Deleted]                    TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_tanfolyamtipusokID] PRIMARY KEY CLUSTERED ([msk_kex_tanfolyamtipusokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_teszt.sql =====

CREATE TABLE [dbo].[msk_kex_teszt] (
    [msk_kex_tesztID] INT           IDENTITY (1, 1) NOT NULL,
    [idjelentkezo]    INT           NOT NULL,
    [datum]           DATE          NULL,
    [idteszttipus]    INT           NULL,
    [idbehivva]       INT           NULL,
    [idmegirta]       INT           NULL,
    [ideredmeny]      INT           NULL,
    [megjegyzes]      VARCHAR (MAX) NULL,
    [Deleted]         TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_tesztID] PRIMARY KEY CLUSTERED ([msk_kex_tesztID] ASC)
);






GO
-- =============================================
-- Author:		Najdanovszki Krisztián
-- Create date: 2018.11.23
-- Description:	X-el való kilépéskor a jelentkezõk felületrõl a kártya színe miatt update-lni kell a táblát.
-- =============================================
create TRIGGER [dbo].[jelentkezok_update_teszt]
   ON  [dbo].[msk_kex_teszt]
   AFTER INSERT, UPDATE
AS 
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	DECLARE @jelentkezoID int
	set @jelentkezoID = (select top 1 idjelentkezo from inserted)
    update msk_kex_jelentkezok set Deleted = 0
	WHERE msk_kex_jelentkezokID = @jelentkezoID

END
GO
CREATE NONCLUSTERED INDEX [idjelentkezo_Deleted]
    ON [dbo].[msk_kex_teszt]([idjelentkezo] ASC, [Deleted] ASC);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_teszttipusok.sql =====

CREATE TABLE [dbo].[msk_kex_teszttipusok] (
    [msk_kex_teszttipusokID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]                    VARCHAR (255) NULL,
    [Deleted]                TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_teszttipusokID] PRIMARY KEY CLUSTERED ([msk_kex_teszttipusokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_teszt_jelentkezok.sql =====

CREATE TABLE [dbo].[msk_kex_teszt_jelentkezok](
	[ID] [INT] IDENTITY(1,1) NOT NULL,
	[JelentkezokID] [INT] NOT NULL
 CONSTRAINT [PK_teszt_jelentkezok] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_toborzofeor.sql =====

CREATE TABLE [dbo].[msk_kex_toborzofeor]
(
	[msk_kex_toborzofeorID] INT NOT NULL PRIMARY KEY, 
    [feor] INT NULL, 
    [Deleted] TINYINT NULL
)


===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\msk_kex_visszalepesindokok.sql =====

CREATE TABLE [dbo].[msk_kex_visszalepesindokok] (
    [msk_kex_visszalepesindokokID] INT           IDENTITY (1, 1) NOT NULL,
    [nev]                          VARCHAR (255) NULL,
    [Deleted]                      TINYINT       NULL,
    CONSTRAINT [PK_msk_kex_visszalepesindokokID] PRIMARY KEY CLUSTERED ([msk_kex_visszalepesindokokID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingTable_Log_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingTable_Log] (
    [ID]        INT            IDENTITY (1, 1) NOT NULL,
    [OccuredAt] VARCHAR (500)  NULL,
    [Message]   VARCHAR (8000) NULL,
    [Exception] VARCHAR (8000) NULL,
    [Date]      DATETIME       DEFAULT (getdate()) NULL,
    [Deleted]   TINYINT        DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([ID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_AdvertList_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_AdvertList] (
    [AdvertListID]        INT            IDENTITY (1, 1) NOT NULL,
    [WebAdvertsID]        INT            NULL,
    [AdvertID]            VARCHAR (8000) NULL,
    [Company]             VARCHAR (8000) NULL,
    [Title]               VARCHAR (8000) NULL,
    [Description]         VARCHAR (8000) NULL,
    [Locations]           VARCHAR (8000) NULL,
    [Categories]          VARCHAR (8000) NULL,
    [CompanyID]           VARCHAR (8000) NULL,
    [Department]          VARCHAR (8000) NULL,
    [Requirements]        VARCHAR (8000) NULL,
    [Qualities]           VARCHAR (8000) NULL,
    [Benefits]            VARCHAR (8000) NULL,
    [Min_Experience]      VARCHAR (8000) NULL,
    [Min_Education]       VARCHAR (8000) NULL,
    [Driver_Licence]      VARCHAR (8000) NULL,
    [Link]                VARCHAR (8000) NULL,
    [Activation_Date]     VARCHAR (8000) NULL,
    [Expiraton_Date]      VARCHAR (8000) NULL,
    [Contract]            VARCHAR (8000) NULL,
    [Schedule]            VARCHAR (8000) NULL,
    [Company_Name]        VARCHAR (8000) NULL,
    [Email]               VARCHAR (8000) NULL,
    [Phone]               VARCHAR (8000) NULL,
    [Vacancy_NR]          VARCHAR (8000) NULL,
    [Work_Location]       VARCHAR (8000) NULL,
    [Hide_Company]        VARCHAR (8000) NULL,
    [Schow_Apply_Button]  VARCHAR (8000) NULL,
    [Custom_Template_ID]  VARCHAR (8000) NULL,
    [Tasks]               VARCHAR (8000) NULL,
    [Additional_Info]     VARCHAR (8000) NULL,
    [Recruiter_Info]      VARCHAR (8000) NULL,
    [Recruiter_ID]        VARCHAR (8000) NULL,
    [Recruiter_Email]     VARCHAR (8000) NULL,
    [Recruiter_Felvado]   VARCHAR (8000) NULL,
    [Map_Job]             VARCHAR (8000) NULL,
    [CV]                  VARCHAR (8000) NULL,
    [Subsidiary]          VARCHAR (8000) NULL,
    [Industry]            VARCHAR (8000) NULL,
    [Hierarchy_Level]     VARCHAR (8000) NULL,
    [Education_Type]      VARCHAR (8000) NULL,
    [Education_Field]     VARCHAR (8000) NULL,
    [Field_Of_Study]      VARCHAR (8000) NULL,
    [Reference_Number]    VARCHAR (8000) NULL,
    [Approval_Date]       VARCHAR (8000) NULL,
    [Number_Of_Positions] VARCHAR (8000) NULL,
    [Created]             DATETIME       DEFAULT (getdate()) NULL,
    [Deleted]             TINYINT        DEFAULT ((0)) NULL
);




GO
CREATE NONCLUSTERED INDEX [NonClusteredIndex-20190724-134625]
    ON [dbo].[orn_kex_LandingZone_AdvertList]([AdvertID] ASC, [Created] ASC);


GO
CREATE CLUSTERED INDEX [ClusteredIndex-20190724-134610]
    ON [dbo].[orn_kex_LandingZone_AdvertList]([AdvertListID] ASC);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_AllasraJelentkezesLista_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_AllasraJelentkezesLista] (
    [AllasraJelentkezesListaID] INT           IDENTITY (1, 1) NOT NULL,
    [AllasraJelentkezesID]      INT           NOT NULL,
    [EntitasVerzio]             VARCHAR (50)  NULL,
    [SAPID]                     VARCHAR (300) NULL,
    [DrupID]                    BIGINT        NULL,
    [AdName]                    VARCHAR (300) NULL,
    [HPNr]                      VARCHAR (10)  NULL,
    [HPName]                    VARCHAR (300) NULL,
    [CanName]                   VARCHAR (300) NULL,
    [CanEmail]                  VARCHAR (300) NULL,
    [CanPhone]                  VARCHAR (60)  NULL,
    [CanCVLink]                 VARCHAR (300) NULL,
    [StatGDPR]                  BIT           NULL,
    [MAPName]                   VARCHAR (300) NULL,
    [WhereFrom]                 VARCHAR (300) NULL,
    [AppDate]                   DATETIME      NULL,
    [Deleted]                   TINYINT       DEFAULT ((0)) NULL,
    [GrSalary]                  VARCHAR (20)  NULL,
    [MAPCompany]                VARCHAR (20)  NULL,
    PRIMARY KEY CLUSTERED ([AllasraJelentkezesListaID] ASC),
    CONSTRAINT [FK_orn_kex_LandingZone_AllasraJelentkezesLista_AllasraJelentkezes] FOREIGN KEY ([AllasraJelentkezesID]) REFERENCES [dbo].[orn_kex_LandingZone_AllasraJelentkezes] ([AllasraJelentkezesID])
);






GO
CREATE NONCLUSTERED INDEX [IX_orn_kex_LandingZone_AllasraJelentkezesLista]
    ON [dbo].[orn_kex_LandingZone_AllasraJelentkezesLista]([Deleted] ASC, [AllasraJelentkezesID] ASC);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_AllasraJelentkezesResponse_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_AllasraJelentkezesResponse] (
    [AllasraJelentkezesResponseID] INT          IDENTITY (1, 1) NOT NULL,
    [GUID]                         VARCHAR (42) NOT NULL,
    [Created]                      DATETIME     DEFAULT (getdate()) NULL,
    [Deleted]                      TINYINT      DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([AllasraJelentkezesResponseID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_AllasraJelentkezes_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_AllasraJelentkezes] (
    [AllasraJelentkezesID] INT          IDENTITY (1, 1) NOT NULL,
    [GUID]                 VARCHAR (42) NOT NULL,
    [Created]              DATETIME     DEFAULT (getdate()) NULL,
    [Deleted]              TINYINT      DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([AllasraJelentkezesID] ASC)
);




GO
CREATE NONCLUSTERED INDEX [IX_orn_kex_LandingZone_AllasraJelentkezes]
    ON [dbo].[orn_kex_LandingZone_AllasraJelentkezes]([Deleted] ASC, [AllasraJelentkezesID] ASC);


GO
CREATE NONCLUSTERED INDEX [IX_orn_kex_LandingZone_AllasraJelentkezes(GUID,Deleted)]
    ON [dbo].[orn_kex_LandingZone_AllasraJelentkezes]([GUID] ASC, [Deleted] ASC);


GO
CREATE NONCLUSTERED INDEX [IX_orn_kex_LandingZone_AllasraJelentkezes(Created)]
    ON [dbo].[orn_kex_LandingZone_AllasraJelentkezes]([Created] ASC);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_HeaderESBInfo_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_HeaderESBInfo] (
    [HeaderESBInfoID] INT           IDENTITY (1, 1) NOT NULL,
    [HeaderID]        INT           NULL,
    [Key]             VARCHAR (MAX) NULL,
    [Value]           VARCHAR (MAX) NULL,
    [Deleted]         TINYINT       DEFAULT ((0)) NULL,
    CONSTRAINT [PK_KEX_LZ_HESBI] PRIMARY KEY CLUSTERED ([HeaderESBInfoID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_Header_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_Header] (
    [HeaderID]           INT           IDENTITY (1, 1) NOT NULL,
    [ParentType]         VARCHAR (MAX) NULL,
    [ParentID]           INT           NULL,
    [ClientTimeoutInSec] VARCHAR (MAX) NULL,
    [UserName]           VARCHAR (MAX) NULL,
    [TraceType]          VARCHAR (MAX) NULL,
    [ApplicationId]      VARCHAR (MAX) NULL,
    [CorrelationId]      VARCHAR (MAX) NULL,
    [FlowId]             VARCHAR (MAX) NULL,
    [FlowSeqId]          VARCHAR (MAX) NULL,
    [FlowStepId]         VARCHAR (MAX) NULL,
    [RequestSeqId]       VARCHAR (MAX) NULL,
    [SenderTimestamp]    DATETIME      NULL,
    [ServiceId]          VARCHAR (MAX) NULL,
    [Deleted]            TINYINT       DEFAULT ((0)) NULL,
    CONSTRAINT [PK_KEX_LZ_Header] PRIMARY KEY CLUSTERED ([HeaderID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_Qualifications_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_Qualifications] (
    [QualificationID] INT            IDENTITY (1, 1) NOT NULL,
    [AdvertListID]    INT            NULL,
    [Languages]       VARCHAR (8000) NULL,
    [ITKnowledges]    VARCHAR (8000) NULL,
    [Min_Experiences] VARCHAR (8000) NULL,
    [Driver_Licenses] VARCHAR (8000) NULL,
    [Created]         DATETIME       DEFAULT (getdate()) NULL,
    [Deleted]         TINYINT        DEFAULT ((0)) NULL
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_ServiceFault_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_ServiceFault] (
    [ServiceFaultID]   INT            IDENTITY (1, 1) NOT NULL,
    [ParentID]         INT            NOT NULL,
    [ParentType]       VARCHAR (300)  NULL,
    [ErrorMessage]     VARCHAR (8000) NULL,
    [ExceptionClass]   VARCHAR (8000) NULL,
    [FaultCode]        VARCHAR (8000) NULL,
    [FaultSubCode]     VARCHAR (8000) NULL,
    [FaultTimestamp]   DATETIME       NOT NULL,
    [Originator]       VARCHAR (8000) NULL,
    [StacktraceString] VARCHAR (8000) NULL,
    [Deleted]          TINYINT        DEFAULT ((0)) NULL,
    PRIMARY KEY CLUSTERED ([ServiceFaultID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Tables\orn_kex_LandingZone_WebAdverts_1.sql =====

CREATE TABLE [dbo].[orn_kex_LandingZone_WebAdverts] (
    [WebAdvertsID] INT          IDENTITY (1, 1) NOT NULL,
    [GUID]         VARCHAR (38) NULL,
    [Deleted]      TINYINT      DEFAULT ((0)) NULL,
    [Created]      DATETIME     DEFAULT (getdate()) NULL,
    CONSTRAINT [KEX_LZ_WebAdverts] PRIMARY KEY CLUSTERED ([WebAdvertsID] ASC)
);



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_AktualisFelveteliStatusz.sql =====

CREATE VIEW dbo.msk_kex_AktualisFelveteliStatusz
AS
SELECT fs.* FROM 
(SELECT MAX(Msk_kex_felvstatuszID) AS MAXFelvastatuszID, Idjelentkezo AS Idjelentkezo FROM dbo.msk_kex_felvstatusz
WHERE Deleted=0
GROUP BY Idjelentkezo) a
INNER JOIN dbo.msk_kex_felvstatusz fs ON fs.Msk_kex_felvstatuszID=a.MAXFelvastatuszID

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_allasajanlatok_alap.sql =====


/*
Módosítás:
    - 2022.11.28 Tóth László
        - A dbo.People tábla kötés módosítása
*/
CREATE VIEW [dbo].[msk_kex_allasajanlatok_alap]
AS
    SELECT [A].[msk_kex_allasajanlatokID]
         , [A].[uzletag]
         , [A].[reszleg]
         , [A].[targy]
         , [A].[munkavegzes_helye]
         , [A].[datum_lejarat]
         , [A].[toborzo_info]
         , [P].[Name]
         , [P].[Mobile]
         , [A].[idmunkaltato]
         , [A].[idvezeto]
         , [A].[idtoborzo1]
         , [A].[idtoborzo2]
         , [A].[idceg]
         , [MKL].[Indokok]
         , [A].[datum_lezaras]
         , [A].[link]
    FROM [dbo].[msk_kex_allasajanlatok] [A]
        LEFT OUTER JOIN [dbo].[People] [P] ON [P].[PERNR] = [A].[toborzo_torzsszam] AND [P].[Deleted] = 0
        LEFT OUTER JOIN [dbo].[msk_kex_lezarasindokok] [MKL] ON [A].[Idlezarasindok] = [MKL].[Msk_kex_lezarasindokokID]
GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_JelentkezoBelepes.sql =====

CREATE VIEW dbo.msk_kex_JelentkezoBelepes
AS
SELECT        j.msk_kex_jelentkezokID, fv.Belepesdatum
FROM          dbo.msk_kex_AktualisFelveteliStatusz AS fv
            INNER JOIN dbo.msk_kex_jelentkezok AS j ON fv.Idjelentkezo = j.msk_kex_jelentkezokID



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_map_riport.sql =====

CREATE VIEW dbo.msk_kex_map_riport
AS
SELECT        J.msk_kex_jelentkezokID, J.datum, J.hp_nev, J.ajanlo_nev, A.targy, J.nev, F.LookupValue AS felveve, B.Ddatum AS ujfelveteldatum, A.idceg, A.reszleg, A.munkavegzes_helye, A.idvezeto, A.idtoborzo1, A.idtoborzo2, 
                         J.idallasajanlat, p2.Name AS toborzo_name2, p1.Name AS toborzo_name1, J.map_beerkezes, m.LookupValue AS map_dokumentacionev
FROM            dbo.msk_kex_jelentkezok AS J LEFT JOIN
                         dbo.msk_kex_AktualisFelveteliStatusz AS fs ON fs.Idjelentkezo = J.msk_kex_jelentkezokID LEFT JOIN
                         dbo.msk_kex_LookupList AS F ON F.LookupListID = fs.Idfelvstatusz LEFT JOIN
                         dbo.msk_kex_LookupList AS m ON J.idmap_dokumentacio = m.LookupListID LEFT JOIN
                         dbo.msk_kex_allasajanlatok AS A ON J.idallasajanlat = A.msk_kex_allasajanlatokID LEFT JOIN
                         dbo.People AS p1 ON A.idtoborzo1 = p1.PeopleID LEFT JOIN
                         dbo.People AS p2 ON p2.PeopleID = A.idtoborzo2 LEFT JOIN
                             (SELECT        Idjelentkezo, CASE idfelvstatusz WHEN 6 THEN Belepesdatum ELSE NULL END AS Ddatum
                               FROM            dbo.msk_kex_AktualisFelveteliStatusz
                               WHERE        (Msk_kex_felvstatuszID IN
                                                             (SELECT        MAX(Msk_kex_felvstatuszID) AS ID
                                                               FROM            dbo.msk_kex_AktualisFelveteliStatusz AS msk_kex_felvstatusz_1
                                                               WHERE        (Deleted = 0) AND (Idfelvstatusz BETWEEN 6 AND 8)
                                                               GROUP BY Idjelentkezo))) AS B ON J.msk_kex_jelentkezokID = B.Idjelentkezo
WHERE        (J.Deleted = 0 OR j.Deleted=1) AND (LEN(J.ajanlo_nev) > 2) AND fs.Msk_kex_felvstatuszID IN
                             (SELECT        MAX(Msk_kex_felvstatuszID) AS ID
                               FROM            dbo.msk_kex_AktualisFelveteliStatusz AS msk_kex_felvstatusz_1
                               WHERE        (Deleted = 0) AND (Idfelvstatusz BETWEEN 6 AND 8)
                               GROUP BY Idjelentkezo)
UNION
SELECT        J.msk_kex_jelentkezokID, J.datum, J.hp_nev, J.ajanlo_nev, A.targy, J.nev, F.LookupValue AS felveve, B.Ddatum AS ujfelveteldatum, A.idceg, A.reszleg, A.munkavegzes_helye, A.idvezeto, A.idtoborzo1, A.idtoborzo2, 
                         J.idallasajanlat, p2.Name AS toborzo_name2, p1.Name AS toborzo_name1, J.map_beerkezes, m.LookupValue AS map_dokumentacionev
FROM            dbo.msk_kex_jelentkezok AS J LEFT JOIN
                         dbo.msk_kex_AktualisFelveteliStatusz AS fs ON fs.Idjelentkezo = J.msk_kex_jelentkezokID LEFT JOIN
                         dbo.msk_kex_LookupList AS F ON F.LookupListID = fs.Idfelvstatusz LEFT JOIN
                         dbo.msk_kex_LookupList AS m ON J.idmap_dokumentacio = m.LookupListID LEFT JOIN
                         dbo.msk_kex_allasajanlatok AS A ON J.idallasajanlat = A.msk_kex_allasajanlatokID LEFT JOIN
                         dbo.People AS p1 ON A.idtoborzo1 = p1.PeopleID LEFT JOIN
                         dbo.People AS p2 ON p2.PeopleID = A.idtoborzo2 LEFT JOIN
                             (SELECT        Idjelentkezo, CASE idfelvstatusz WHEN 6 THEN Belepesdatum ELSE NULL END AS Ddatum
                               FROM            dbo.msk_kex_AktualisFelveteliStatusz
                               WHERE        (Msk_kex_felvstatuszID IN
                                                             (SELECT        Msk_kex_felvstatuszID AS ID
                                                               FROM            dbo.msk_kex_AktualisFelveteliStatusz AS msk_kex_felvstatusz_1
                                                               ))) AS B ON J.msk_kex_jelentkezokID = B.Idjelentkezo
WHERE        (J.Deleted = 0 OR j.Deleted=1) AND (LEN(J.ajanlo_nev) > 2) AND fs.Msk_kex_felvstatuszID IS NULL
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 2, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_map_riport';




GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "J"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 457
               Right = 246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "F"
            Begin Extent = 
               Top = 327
               Left = 371
               Bottom = 456
               Right = 543
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "A"
            Begin Extent = 
               Top = 114
               Left = 620
               Bottom = 340
               Right = 855
            End
            DisplayFlags = 280
            TopColumn = 31
         End
         Begin Table = "B"
            Begin Extent = 
               Top = 6
               Left = 621
               Bottom = 101
               Right = 791
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "p2"
            Begin Extent = 
               Top = 166
               Left = 1021
               Bottom = 296
               Right = 1221
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "p1"
            Begin Extent = 
               Top = 30
               Left = 1025
               Bottom = 159
               Right = 1225
            End
            DisplayFlags = 280
            TopColumn = 1
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 18
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         W', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_map_riport';






GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane2', @value = N'idth = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_map_riport';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_osszefoglalo.sql =====


GO





GO











GO






===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_rip_elutasitas.sql =====

CREATE VIEW dbo.msk_kex_rip_elutasitas
AS
SELECT        'elutasítási' AS tipus, D.nev AS OK, A.datum_aktivalas, A.idtoborzo1, A.idtoborzo2, A.idceg, A.msk_kex_allasajanlatokID
FROM            dbo.msk_kex_jelentkezok AS J LEFT OUTER JOIN
                         dbo.msk_kex_allasajanlatok AS A ON J.idallasajanlat = A.msk_kex_allasajanlatokID LEFT OUTER JOIN
                         dbo.msk_kex_elutasitasindokok AS D ON J.idelutasitasindok = D.msk_kex_elutasitasindokokID
WHERE        (J.Deleted = 0) AND (A.Deleted = 0) AND (J.idelutasitasindok > 0)
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_elutasitas';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "J"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 135
               Right = 246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "A"
            Begin Extent = 
               Top = 6
               Left = 284
               Bottom = 135
               Right = 519
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "D"
            Begin Extent = 
               Top = 6
               Left = 557
               Bottom = 118
               Right = 798
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_elutasitas';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_rip_jelentkezok.sql =====

CREATE VIEW dbo.msk_kex_rip_jelentkezok
AS
SELECT        a.msk_kex_allasajanlatokID, a.targy, j.nev, j.email, j.telefonszam, j.berigeny, j.ajanlo_nev, j.datum, j.honnanertesult, 
                         ISNULL(toborzoID.LookupValue, 'Nincs értékelve') AS toborzovelemenye, j.cv_toborzo_megj, ISNULL(vezetoID.LookupValue, 'Nincs értékelve') AS vezetovelemenye, j.cv_vezeto_megj, 
                         ISNULL(felvetelID.LookupValue, 'Nincs kitöltve') AS felvetelistatusz, a.idceg, a.idtoborzo1, p.Name AS toborzo1nev, a.munkavegzes_helye, ei.nev AS elutasitasnev, 
                         vi.nev AS visszalepesnev
FROM
dbo.msk_kex_jelentkezok j
LEFT JOIN dbo.msk_kex_allasajanlatok AS a ON a.msk_kex_allasajanlatokID=j.idallasajanlat
--LEFT JOIN dbo.msk_kex_felvstatusz f ON f.Idjelentkezo=j.msk_kex_jelentkezokID AND f.Deleted = 0
LEFT JOIN dbo.msk_kex_AktualisFelveteliStatusz f ON f.Idjelentkezo = j.msk_kex_jelentkezokID
LEFT JOIN dbo.msk_kex_visszalepesindokok vi ON vi.msk_kex_visszalepesindokokID=f.Idvisszalepesindok
LEFT JOIN dbo.msk_kex_elutasitasindokok ei ON ei.msk_kex_elutasitasindokokID=f.Idelutasitasindok
LEFT JOIN dbo.msk_kex_LookupList felvetelID ON f.Idfelvstatusz = felvetelID.LookupListID
LEFT JOIN dbo.People p ON a.idtoborzo1 = p.PeopleID 
LEFT JOIN dbo.msk_kex_LookupList toborzoID ON j.idcv_toborzo = toborzoID.LookupListID 
LEFT JOIN dbo.msk_kex_LookupList AS vezetoID ON j.idcv_vezeto = vezetoID.LookupListID

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_rip_jelentkezokforrasa.sql =====

CREATE VIEW dbo.msk_kex_rip_jelentkezokforrasa
AS
SELECT        J.idszin AS jelentkezotipusa, J.honnanertesult, A.datum_aktivalas, A.idtoborzo1, A.idtoborzo2, A.idceg, A.msk_kex_allasajanlatokID, COUNT(*) AS fo, A.targy
FROM            dbo.msk_kex_jelentkezok AS J LEFT OUTER JOIN
                         dbo.msk_kex_allasajanlatok AS A ON J.idallasajanlat = A.msk_kex_allasajanlatokID
WHERE        (J.Deleted = 0) AND (A.Deleted = 0)
GROUP BY J.idszin, J.honnanertesult, A.datum_aktivalas, A.idtoborzo1, A.idtoborzo2, A.idceg, A.msk_kex_allasajanlatokID, A.targy
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_jelentkezokforrasa';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "J"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 262
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "A"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 289
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_jelentkezokforrasa';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_rip_kivalasztasi_fazisok_1.sql =====

CREATE VIEW dbo.msk_kex_rip_kivalasztasi_fazisok
AS
SELECT        jel.[msk_kex_jelentkezokID], jel.[nev] AS jelentkezoNeve, allas.[targy] AS pozicio, p.Name AS toborzo1name, 'Interjú' AS fazis, inte.[datum] AS datum, look.[LookupValue] AS interjunMegjelent, 
                         look2.[LookupValue] AS interjuEredmenye, inte.[megjegyzes] AS interjuMegjegyzes, NULL AS tesztTipusa, NULL AS tesztetMegirta, NULL AS tesztEredmenye, NULL AS tesztMegjegyzes, NULL AS orvosiTipusa, NULL 
                         AS orvositMegkezdte, NULL AS orvosinMegfelelt, allas.[idceg] AS vallalatFilter, allas.[targy] AS allasajanlatFilter, allas.[idvezeto] AS statuszolovezetoFilter, allas.[msk_kex_allasajanlatokID] AS mjgyFilter, 
                         allas.[idtoborzo1] AS toborzo1Filter, allas.[idtoborzo2] AS toborzo2Filter, jel.datum AS jel_datum
FROM            [dbo].[msk_kex_jelentkezok] jel INNER JOIN
                         [dbo].[msk_kex_interju] inte ON inte.[idjelentkezo] = jel.[msk_kex_jelentkezokID] LEFT JOIN
                         [dbo].[msk_kex_allasajanlatok] allas ON jel.[idallasajanlat] = allas.[msk_kex_allasajanlatokID] LEFT JOIN
                         [dbo].[msk_kex_Lookuplist] look ON look.[LookupListID] = inte.[idmegjelent] LEFT JOIN
                         [dbo].[msk_kex_Lookuplist] look2 ON look2.[LookupListID] = inte.[ideredmeny] LEFT JOIN
                         [dbo].[People] p ON p.PeopleID = allas.idtoborzo1
WHERE        (inte.Deleted = 0)
UNION
SELECT        jel.[msk_kex_jelentkezokID], jel.[nev] AS jelentkezoNeve, allas.[targy] AS pozicio, p.Name AS toborzo1name, 'Teszt' AS fazis, teszt.[datum] AS datum, NULL AS interjunMegjelent, NULL AS interjuEredmenye, NULL 
                         AS interjuMegjegyzes, tesztt.[nev] AS tesztTipusa, look.[LookupValue] AS tesztMegirta, look2.[LookupValue] AS tesztEredmenye, teszt.[megjegyzes] AS tesztMegjegyzes, NULL AS orvosiTipusa, NULL AS orvositMegkezdte, NULL
                          AS orvosinMegfelelt, allas.[idceg] AS vallalatFilter, allas.[targy] AS allasajanlatFilter, allas.[idvezeto] AS statuszolovezetoFilter, allas.[msk_kex_allasajanlatokID] AS mjgyFilter, allas.[idtoborzo1] AS toborzo1Filter, 
                         allas.[idtoborzo2] AS toborzo2Filter, jel.datum AS jel_datum
FROM            [dbo].[msk_kex_jelentkezok] jel INNER JOIN
                         [dbo].[msk_kex_teszt] teszt ON teszt.[idjelentkezo] = jel.[msk_kex_jelentkezokID] LEFT JOIN
                         [dbo].[msk_kex_teszttipusok] tesztt ON tesztt.[msk_kex_teszttipusokID] = teszt.[idteszttipus] LEFT JOIN
                         [dbo].[msk_kex_allasajanlatok] allas ON jel.[idallasajanlat] = allas.[msk_kex_allasajanlatokID] LEFT JOIN
                         [dbo].[msk_kex_Lookuplist] look ON look.[LookupListID] = teszt.[idmegirta] LEFT JOIN
                         [dbo].[msk_kex_Lookuplist] look2 ON look2.[LookupListID] = teszt.[ideredmeny] LEFT JOIN
                         [dbo].[People] p ON p.PeopleID = allas.idtoborzo1
WHERE        (teszt.Deleted = 0)
UNION
SELECT        jel.[msk_kex_jelentkezokID], jel.[nev] AS jelentkezoNeve, allas.[targy] AS pozicio, p.Name AS toborzo1name, 'Orvosi' AS fazis, orv.[datum] AS datum, NULL AS interjunMegjelent, NULL AS interjuEredmenye, NULL 
                         AS interjuMegjegyzes, NULL AS tesztTipusa, NULL AS tesztMegirta, NULL AS tesztEredmenye, NULL AS tesztMegjegyzes, orvt.[nev] AS orvosiTipusa, look.[LookupValue] AS orvositMegkezdte, 
                         look2.[LookupValue] AS orvosinMegfelelt, allas.[idceg] AS vallalatFilter, allas.[targy] AS allasajanlatFilter, allas.[idvezeto] AS statuszolovezetoFilter, allas.[msk_kex_allasajanlatokID] AS mjgyFilter, 
                         allas.[idtoborzo1] AS toborzo1Filter, allas.[idtoborzo2] AS toborzo2Filter, jel.datum AS jel_datum
FROM            [dbo].[msk_kex_jelentkezok] jel INNER JOIN
                         [dbo].[msk_kex_orvosi] orv ON orv.[idjelentkezo] = jel.[msk_kex_jelentkezokID] LEFT JOIN
                         [dbo].[msk_kex_orvositipusok] orvt ON orvt.[msk_kex_orvositipusokID] = orv.[idorvositipus] LEFT JOIN
                         [dbo].[msk_kex_allasajanlatok] allas ON jel.[idallasajanlat] = allas.[msk_kex_allasajanlatokID] LEFT JOIN
                         [dbo].[msk_kex_Lookuplist] look ON look.[LookupListID] = orv.[idelkezdte] LEFT JOIN
                         [dbo].[msk_kex_Lookuplist] look2 ON look2.[LookupListID] = orv.[ideredmeny] LEFT JOIN
                         [dbo].[People] p ON p.PeopleID = allas.idtoborzo1
WHERE        (orv.Deleted = 0)
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_kivalasztasi_fazisok';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[16] 4[9] 2[23] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = -192
      End
      Begin Tables = 
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 22
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_kivalasztasi_fazisok';





===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_rip_kpiszk.sql =====


CREATE VIEW [dbo].[msk_kex_rip_kpiszk]
AS
SELECT DISTINCT 
                         a.[msk_kex_allasajanlatokID] AS msk_kex_allasajanlatokID, a.[engedely_iktatoszama] AS engedely_iktatoszama, a.[engedely_datuma] AS engedely_datuma, a.[targy] AS targy, a.[poziciok_szama] AS poziciok_szama, 
                         a.[reszleg] AS reszleg, a.[idtoborzo1] AS idtoborzo1, p.[Name] AS Name,
                             (SELECT        CASE WHEN Deleted = 1 THEN 'Lezárt' WHEN CAST(GETDATE() AS DATE) > CAST(datum_lejarat AS DATE) THEN 'Kiválasztás' WHEN CAST(GETDATE() AS DATE) <= CAST(datum_lejarat AS DATE) 
                                                         THEN 'Toborzás' END
                               FROM            dbo.msk_kex_allasajanlatok
                               WHERE        msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID) AS statusz, aj.[datum] AS ajanlattetel_datum,
                             (SELECT        CASE WHEN EXISTS
                                                             (SELECT        *
                                                               FROM            dbo.msk_kex_allasajanlatok aa INNER JOIN
                                                                                         dbo.msk_kex_lezarasindokok ll ON ll.Msk_kex_lezarasindokokID = aa.Idlezarasindok
                                                               WHERE        aa.msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID AND (ll.Indokok LIKE '%em volt megfelelõ jelölt%' OR
                                                                                         ll.Indokok LIKE '%pozíció visszavonásra került%')) THEN
                                                             (SELECT        aa.datum_lezaras
                                                               FROM            dbo.msk_kex_allasajanlatok aa INNER JOIN
                                                                                         dbo.msk_kex_lezarasindokok ll ON ll.Msk_kex_lezarasindokokID = aa.Idlezarasindok
                                                               WHERE        aa.msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID AND (ll.Indokok LIKE '%em volt megfelelõ jelölt%' OR
                                                                                         ll.Indokok LIKE '%pozíció visszavonásra került%')) ELSE NULL END
                               FROM            dbo.msk_kex_allasajanlatok
                               WHERE        msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID) AS lezaras_datum, a.[idceg] AS idceg, [dbo].[msk_kex_get_MJGYNeve] (a.msk_kex_allasajanlatokID) AS Idvezeto_neve, j.nev
FROM            dbo.msk_kex_allasajanlatok a LEFT JOIN
                         dbo.People p ON p.PeopleID = a.idtoborzo1 LEFT JOIN
                         dbo.msk_kex_jelentkezok j ON j.idallasajanlat = a.msk_kex_allasajanlatokID LEFT JOIN
                         dbo.msk_kex_ajanlat aj ON aj.idjelentkezo = j.msk_kex_jelentkezokID 
						 --LEFT JOIN dbo.msk_kex_allasajanlat_vezetok v ON a.msk_kex_allasajanlatokID = v.Idallasajanlat
WHERE        aj.datum IS NOT NULL --AND v.Deleted = 0 AND v.Mjgy = 10
UNION ALL
SELECT DISTINCT a.[msk_kex_allasajanlatokID], a.[engedely_iktatoszama], a.[engedely_datuma], a.[targy], a.[poziciok_szama], a.[reszleg], a.[idtoborzo1] AS idtoborzo1, p.[Name],
                             (SELECT        CASE WHEN Deleted = 1 THEN 'Lezárt' WHEN CAST(GETDATE() AS DATE) > CAST(datum_lejarat AS DATE) THEN 'Kiválasztás' WHEN CAST(GETDATE() AS DATE) <= CAST(datum_lejarat AS DATE) 
                                                         THEN 'Toborzás' END
                               FROM            dbo.msk_kex_allasajanlatok
                               WHERE        msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID) AS statusz, aj.[datum] AS ajanlattetel_datum,
                             (SELECT        CASE WHEN EXISTS
                                                             (SELECT        *
                                                               FROM            dbo.msk_kex_allasajanlatok aa INNER JOIN
                                                                                         dbo.msk_kex_lezarasindokok ll ON ll.Msk_kex_lezarasindokokID = aa.Idlezarasindok
                                                               WHERE        aa.msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID AND (ll.Indokok LIKE '%em volt megfelelõ jelölt%' OR
                                                                                         ll.Indokok LIKE '%pozíció visszavonásra került%')) THEN
                                                             (SELECT        aa.datum_lezaras
                                                               FROM            dbo.msk_kex_allasajanlatok aa INNER JOIN
                                                                                         dbo.msk_kex_lezarasindokok ll ON ll.Msk_kex_lezarasindokokID = aa.Idlezarasindok
                                                               WHERE        aa.msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID AND (ll.Indokok LIKE '%em volt megfelelõ jelölt%' OR
                                                                                         ll.Indokok LIKE '%pozíció visszavonásra került%')) ELSE NULL END
                               FROM            dbo.msk_kex_allasajanlatok
                               WHERE        msk_kex_allasajanlatokID = a.msk_kex_allasajanlatokID) AS lezaras_datum, a.idceg, [dbo].[msk_kex_get_MJGYNeve] (a.msk_kex_allasajanlatokID) AS Idvezeto_neve, j.nev
FROM            dbo.msk_kex_allasajanlatok a LEFT JOIN
                         dbo.People p ON p.PeopleID = a.idtoborzo1 LEFT JOIN
                         dbo.msk_kex_jelentkezok j ON j.idallasajanlat = a.msk_kex_allasajanlatokID LEFT JOIN
                         dbo.msk_kex_ajanlat aj ON aj.idjelentkezo = j.msk_kex_jelentkezokID
						 --LEFT JOIN dbo.msk_kex_allasajanlat_vezetok v ON a.msk_kex_allasajanlatokID =v.Idallasajanlat
WHERE        aj.datum IS NULL AND a.msk_kex_allasajanlatokID NOT IN
                             (SELECT        aa.[msk_kex_allasajanlatokID]
                               FROM            dbo.msk_kex_allasajanlatok aa LEFT JOIN
                                                         dbo.People p ON p.PeopleID = aa.idtoborzo1 LEFT JOIN
                                                         dbo.msk_kex_jelentkezok j ON j.idallasajanlat = aa.msk_kex_allasajanlatokID LEFT JOIN
                                                         dbo.msk_kex_ajanlat aj ON aj.idjelentkezo = j.msk_kex_jelentkezokID
                               WHERE        aj.datum IS NOT NULL)
			--AND v.Deleted=0 AND v.Mjgy=10GO

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_rip_visszalepes.sql =====

CREATE VIEW dbo.msk_kex_rip_visszalepes
AS
SELECT        'visszalépési' AS tipus, D.nev AS OK, A.datum_aktivalas, A.idtoborzo1, A.idtoborzo2, A.idceg, A.msk_kex_allasajanlatokID
FROM            dbo.msk_kex_jelentkezok AS J LEFT OUTER JOIN
                         dbo.msk_kex_allasajanlatok AS A ON J.idallasajanlat = A.msk_kex_allasajanlatokID LEFT OUTER JOIN
                         dbo.msk_kex_visszalepesindokok AS D ON J.idvisszalepesindok = D.msk_kex_visszalepesindokokID
WHERE        (J.Deleted = 0) AND (A.Deleted = 0) AND (J.idvisszalepesindok > 0)
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_visszalepes';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "J"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 135
               Right = 246
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "A"
            Begin Extent = 
               Top = 6
               Left = 284
               Bottom = 135
               Right = 519
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "D"
            Begin Extent = 
               Top = 6
               Left = 557
               Bottom = 118
               Right = 806
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_rip_visszalepes';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_stvezeto.sql =====

CREATE VIEW dbo.msk_kex_stvezeto
AS
SELECT        P.PeopleID, P.Name, P.PERNR, P.STLTX, V.Idallasajanlat
FROM            dbo.msk_kex_allasajanlat_vezetok AS V LEFT OUTER JOIN
                         dbo.People AS P ON V.Idvezeto = P.PeopleID
WHERE        (V.Deleted = 0) AND (P.Deleted = 0) AND (V.Mjgy = 9) AND dbo.msk_aktivPeopleID(p.PeopleID)='true'
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_stvezeto';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "V"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 135
               Right = 290
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "P"
            Begin Extent = 
               Top = 6
               Left = 328
               Bottom = 135
               Right = 528
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 11
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_stvezeto';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_ajanlat.sql =====

CREATE VIEW dbo.msk_kex_szum_ajanlat
AS
SELECT        j.idallasajanlat, COUNT(*) AS afo, MAX(a.datum) AS adatum
FROM            dbo.msk_kex_ajanlat AS a LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON a.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (a.Deleted = 0)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_ajanlatelfogadva.sql =====

CREATE VIEW dbo.msk_kex_szum_ajanlatelfogadva
AS
SELECT        j.idallasajanlat, COUNT(*) AS afo
FROM            dbo.msk_kex_ajanlat AS a LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON a.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (a.Deleted = 0) AND (a.idelfogadva = 4)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_cvmegfelelt.sql =====

CREATE VIEW dbo.msk_kex_szum_cvmegfelelt
AS
SELECT        idallasajanlat, COUNT(*) AS CVmegfelelt
FROM            dbo.msk_kex_jelentkezok
WHERE        (Deleted = 0) AND (idcv_toborzo = 1 OR
                         idcv_toborzo = 3)
GROUP BY idallasajanlat
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_szum_cvmegfelelt';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "msk_kex_jelentkezok"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 262
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 1200
         Table = 2835
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_szum_cvmegfelelt';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_elutasitva.sql =====

CREATE VIEW dbo.msk_kex_szum_elutasitva
AS
SELECT        dbo.msk_kex_jelentkezok.idallasajanlat, COUNT(*) AS efo
FROM            dbo.msk_kex_jelentkezok INNER JOIN
                         dbo.msk_kex_AktualisFelveteliStatusz ON dbo.msk_kex_jelentkezok.msk_kex_jelentkezokID = dbo.msk_kex_AktualisFelveteliStatusz.Idjelentkezo
WHERE        (dbo.msk_kex_AktualisFelveteliStatusz.Idfelvstatusz = 7)
GROUP BY dbo.msk_kex_jelentkezok.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_interjufo.sql =====

CREATE VIEW dbo.msk_kex_szum_interjufo
AS
SELECT        j.idallasajanlat, COUNT(*) AS ifo
FROM            dbo.msk_kex_interju AS i LEFT OUTER JOIN
                             (SELECT DISTINCT idallasajanlat, msk_kex_jelentkezokID
                               FROM            dbo.msk_kex_jelentkezok) AS j ON i.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (i.Deleted = 0)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_interjuosszes.sql =====

CREATE VIEW dbo.msk_kex_szum_interjuosszes
AS
SELECT        j.idallasajanlat, COUNT(*) AS iofo
FROM            dbo.msk_kex_interju AS i LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON i.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (i.Deleted = 0)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_jelentkezok.sql =====

CREATE VIEW dbo.msk_kex_szum_jelentkezok
AS
SELECT        idallasajanlat, COUNT(*) AS fo
FROM            dbo.msk_kex_jelentkezok
WHERE        (Deleted = 0) OR
                         (Deleted = 1)
GROUP BY idallasajanlat
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_szum_jelentkezok';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "msk_kex_jelentkezok"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 262
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
      Begin ColumnWidths = 9
         Width = 284
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
         Width = 1500
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_szum_jelentkezok';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_kezdettjelolt.sql =====

CREATE VIEW dbo.msk_kex_szum_kezdettjelolt
AS
SELECT        j.idallasajanlat, COUNT(*) AS fvfo
FROM            dbo.msk_kex_AktualisFelveteliStatusz AS fv
                INNER JOIN
                dbo.msk_kex_jelentkezok AS j ON fv.Idjelentkezo = j.msk_kex_jelentkezokID
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_orvosi.sql =====

CREATE VIEW dbo.msk_kex_szum_orvosi
AS
SELECT        j.idallasajanlat, COUNT(*) AS ofo
FROM            dbo.msk_kex_orvosi AS o LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON o.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (o.Deleted = 0)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_orvosielkezdve.sql =====

CREATE VIEW dbo.msk_kex_szum_orvosielkezdve
AS
SELECT        j.idallasajanlat, COUNT(*) AS ofo
FROM            dbo.msk_kex_orvosi AS o LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON o.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (o.Deleted = 0) AND (o.idelkezdte = 4)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_orvosifolyamatban.sql =====

CREATE VIEW dbo.msk_kex_szum_orvosifolyamatban
AS
SELECT        j.idallasajanlat, COUNT(*) AS ofo
FROM            dbo.msk_kex_orvosi AS o LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON o.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (o.Deleted = 0) AND (o.idelkezdte = 4) AND (ISNULL(o.ideredmeny, 0) = 0)
GROUP BY j.idallasajanlat
GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPaneCount', @value = 1, @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_szum_orvosifolyamatban';


GO
EXECUTE sp_addextendedproperty @name = N'MS_DiagramPane1', @value = N'[0E232FF0-B466-11cf-A24F-00AA00A3EFFF, 1.00]
Begin DesignProperties = 
   Begin PaneConfigurations = 
      Begin PaneConfiguration = 0
         NumPanes = 4
         Configuration = "(H (1[40] 4[20] 2[20] 3) )"
      End
      Begin PaneConfiguration = 1
         NumPanes = 3
         Configuration = "(H (1 [50] 4 [25] 3))"
      End
      Begin PaneConfiguration = 2
         NumPanes = 3
         Configuration = "(H (1 [50] 2 [25] 3))"
      End
      Begin PaneConfiguration = 3
         NumPanes = 3
         Configuration = "(H (4 [30] 2 [40] 3))"
      End
      Begin PaneConfiguration = 4
         NumPanes = 2
         Configuration = "(H (1 [56] 3))"
      End
      Begin PaneConfiguration = 5
         NumPanes = 2
         Configuration = "(H (2 [66] 3))"
      End
      Begin PaneConfiguration = 6
         NumPanes = 2
         Configuration = "(H (4 [50] 3))"
      End
      Begin PaneConfiguration = 7
         NumPanes = 1
         Configuration = "(V (3))"
      End
      Begin PaneConfiguration = 8
         NumPanes = 3
         Configuration = "(H (1[56] 4[18] 2) )"
      End
      Begin PaneConfiguration = 9
         NumPanes = 2
         Configuration = "(H (1 [75] 4))"
      End
      Begin PaneConfiguration = 10
         NumPanes = 2
         Configuration = "(H (1[66] 2) )"
      End
      Begin PaneConfiguration = 11
         NumPanes = 2
         Configuration = "(H (4 [60] 2))"
      End
      Begin PaneConfiguration = 12
         NumPanes = 1
         Configuration = "(H (1) )"
      End
      Begin PaneConfiguration = 13
         NumPanes = 1
         Configuration = "(V (4))"
      End
      Begin PaneConfiguration = 14
         NumPanes = 1
         Configuration = "(V (2))"
      End
      ActivePaneConfig = 0
   End
   Begin DiagramPane = 
      Begin Origin = 
         Top = 0
         Left = 0
      End
      Begin Tables = 
         Begin Table = "o"
            Begin Extent = 
               Top = 6
               Left = 38
               Bottom = 136
               Right = 235
            End
            DisplayFlags = 280
            TopColumn = 0
         End
         Begin Table = "j"
            Begin Extent = 
               Top = 138
               Left = 38
               Bottom = 268
               Right = 262
            End
            DisplayFlags = 280
            TopColumn = 0
         End
      End
   End
   Begin SQLPane = 
   End
   Begin DataPane = 
      Begin ParameterDefaults = ""
      End
   End
   Begin CriteriaPane = 
      Begin ColumnWidths = 12
         Column = 1440
         Alias = 900
         Table = 1170
         Output = 720
         Append = 1400
         NewValue = 1170
         SortType = 1350
         SortOrder = 1410
         GroupBy = 1350
         Filter = 1350
         Or = 1350
         Or = 1350
         Or = 1350
      End
   End
End
', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'VIEW', @level1name = N'msk_kex_szum_orvosifolyamatban';



===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_orvosimegfelelt.sql =====

CREATE VIEW dbo.msk_kex_szum_orvosimegfelelt
AS
SELECT        j.idallasajanlat, COUNT(*) AS ofo
FROM            dbo.msk_kex_orvosi AS o LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON o.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (o.Deleted = 0) AND (o.ideredmeny = 4)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_teszt.sql =====

CREATE VIEW dbo.msk_kex_szum_teszt
AS
SELECT        j.idallasajanlat, COUNT(*) AS tfo
FROM            dbo.msk_kex_teszt AS t LEFT OUTER JOIN
                         dbo.msk_kex_jelentkezok AS j ON t.idjelentkezo = j.msk_kex_jelentkezokID
WHERE        (t.Deleted = 0)
GROUP BY j.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_szum_visszalepett.sql =====

CREATE VIEW dbo.msk_kex_szum_visszalepett
AS
SELECT        dbo.msk_kex_jelentkezok.idallasajanlat, COUNT(*) AS vfo
FROM            dbo.msk_kex_jelentkezok INNER JOIN
                         dbo.msk_kex_AktualisFelveteliStatusz ON dbo.msk_kex_jelentkezok.msk_kex_jelentkezokID = dbo.msk_kex_AktualisFelveteliStatusz.Idjelentkezo
WHERE        (dbo.msk_kex_AktualisFelveteliStatusz.Idfelvstatusz = 8)
GROUP BY dbo.msk_kex_jelentkezok.idallasajanlat

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_UtolsoFS.sql =====

CREATE VIEW dbo.[msk_kex_UtolsoFS]
AS
SELECT        MAX(Msk_kex_felvstatuszID) AS ID, Idjelentkezo
FROM            dbo.msk_kex_felvstatusz
WHERE        (Deleted = 0)
GROUP BY Idjelentkezo

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Views\msk_kex_view_ajanlat.sql =====

CREATE VIEW [dbo].[msk_kex_view_ajanlat]
WITH SCHEMABINDING
AS
SELECT [msk_kex_ajanlatID]
      ,[idjelentkezo]
      ,[datum]
      ,[idelfogadva]
      ,[idtovabbi_egyeztetes]
      ,CASE WHEN PozicioID IS NULL THEN [PozicioIDLast] ELSE [PozicioID] END AS [PozicioID]
  FROM [dbo].[msk_kex_ajanlat]
  WHERE deleted=0
GO
CREATE UNIQUE CLUSTERED INDEX [IX_msk_kex_fixajanlatID]
    ON [dbo].[msk_kex_view_ajanlat]([msk_kex_ajanlatID] ASC) WITH (STATISTICS_NORECOMPUTE = ON);


GO
CREATE NONCLUSTERED INDEX [IX_msk_kex_fixajanlatPozicioID]
    ON [dbo].[msk_kex_view_ajanlat]([PozicioID] ASC) WITH (FILLFACTOR = 80, STATISTICS_NORECOMPUTE = ON);


/* teszt:
select * from dbo.msk_kex_view_ajanlat
*/

===== FILE: C:\hop2\src\Hrportal-Root\HRPortalDB\dbo\Functions\Max2.sql =====

create function Max2(@val1 int, @val2 int)
returns int
as
begin
  if @val1 > @val2
    return @val1
  return isnull(@val2,@val1)
end

